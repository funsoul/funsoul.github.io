<!DOCTYPE html>
<html lang=ch>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="写在前使用Laravel有段时间了，也做了大大小小好几个系统。得益于其优雅的设计理念、大而全的工具集，开发系统起来非常迅速，代码结构也十分整洁。利用点时间，探讨一下内部实现，看看Laravel到底做了什么。 我们知道，Laravel的核心就是服务容器，也是本文想着重探讨的。一开始看到这个名词，很晦涩。不要紧，一步一步来，先看看什么是服务？什么又是容器？最后再来结合看服务容器？ 服务日常生活中，谈到">
<meta name="keywords" content="PHP,设计模式,学习笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="谈谈服务容器">
<meta property="og:url" content="http://funsoul.org/2018/05/03/谈谈服务容器/index.html">
<meta property="og:site_name" content="funsoul">
<meta property="og:description" content="写在前使用Laravel有段时间了，也做了大大小小好几个系统。得益于其优雅的设计理念、大而全的工具集，开发系统起来非常迅速，代码结构也十分整洁。利用点时间，探讨一下内部实现，看看Laravel到底做了什么。 我们知道，Laravel的核心就是服务容器，也是本文想着重探讨的。一开始看到这个名词，很晦涩。不要紧，一步一步来，先看看什么是服务？什么又是容器？最后再来结合看服务容器？ 服务日常生活中，谈到">
<meta property="og:locale" content="chinese">
<meta property="og:updated_time" content="2019-06-21T03:15:13.782Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="谈谈服务容器">
<meta name="twitter:description" content="写在前使用Laravel有段时间了，也做了大大小小好几个系统。得益于其优雅的设计理念、大而全的工具集，开发系统起来非常迅速，代码结构也十分整洁。利用点时间，探讨一下内部实现，看看Laravel到底做了什么。 我们知道，Laravel的核心就是服务容器，也是本文想着重探讨的。一开始看到这个名词，很晦涩。不要紧，一步一步来，先看看什么是服务？什么又是容器？最后再来结合看服务容器？ 服务日常生活中，谈到">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>谈谈服务容器</title>
    <!-- styles -->
    <link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/lib/meslo-LG/styles.css">
    <link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <!-- rss -->
    
    
    <!-- jquery -->
    <script src="/lib/jquery/jquery.min.js"></script>
</head>

<body>
    <div class="banner">
<div id="blogtitel" class="blogtitel">funsoul</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    <div class="background">
      
        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/funsoul">Projects</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/05/03/PHP返回对象的公有属性和值/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
        
        
        <li><a class="icon" href="/2018/04/23/Duck-Typing-in-PHP/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://funsoul.org/2018/05/03/谈谈服务容器/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://funsoul.org/2018/05/03/谈谈服务容器/&text=谈谈服务容器"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://funsoul.org/2018/05/03/谈谈服务容器/&is_video=false&description=谈谈服务容器"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=谈谈服务容器&body=Check out this article: http://funsoul.org/2018/05/03/谈谈服务容器/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://funsoul.org/2018/05/03/谈谈服务容器/&name=谈谈服务容器&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#写在前"><span class="toc-number">1.</span> <span class="toc-text">写在前</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务"><span class="toc-number">2.</span> <span class="toc-text">服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖"><span class="toc-number">3.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单工厂模式，依赖转移"><span class="toc-number">4.</span> <span class="toc-text">简单工厂模式，依赖转移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖注入"><span class="toc-number">5.</span> <span class="toc-text">依赖注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务容器"><span class="toc-number">6.</span> <span class="toc-text">服务容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用魔术方法构建服务容器"><span class="toc-number">6.1.</span> <span class="toc-text">使用魔术方法构建服务容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用反射构建服务容器"><span class="toc-number">6.2.</span> <span class="toc-text">使用反射构建服务容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#为什么我们需要服务容器呢？"><span class="toc-number">6.3.</span> <span class="toc-text">为什么我们需要服务容器呢？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Laravel服务容器"><span class="toc-number">7.</span> <span class="toc-text">Laravel服务容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>
  </span>
</div>

      
      <div class="content index width mx-auto px2 my4">
          
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        谈谈服务容器
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">funsoul</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-05-02T16:00:00.000Z" itemprop="datePublished">2018-05-03</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/PHP/">PHP</a>, <a class="tag-link" href="/tags/学习笔记/">学习笔记</a>, <a class="tag-link" href="/tags/设计模式/">设计模式</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="写在前"><a href="#写在前" class="headerlink" title="写在前"></a>写在前</h3><p>使用Laravel有段时间了，也做了大大小小好几个系统。得益于其优雅的设计理念、大而全的工具集，开发系统起来非常迅速，代码结构也十分整洁。利用点时间，探讨一下内部实现，看看Laravel到底做了什么。</p>
<p>我们知道，Laravel的核心就是服务容器，也是本文想着重探讨的。一开始看到这个名词，很晦涩。不要紧，一步一步来，先看看什么是服务？什么又是容器？最后再来结合看服务容器？</p>
<h3 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h3><p>日常生活中，谈到服务，自然会联想到“银行办卡”、“外卖配送”、“洗车”等等这些都是服务，这里我们看看，<strong>服务的概念是建立在双方的基础上</strong>，我去银行办卡，银行服务于我。我和银行之间构成了关系。</p>
<p>举个例子，一辆汽车有很多的配件（引擎、轮子、沙发..），这些配件组合成汽车，汽车有各种配件提供服务，配件服务于汽车，汽车与配件构成了关系。</p>
<p>再来个栗子，我去北京玩，可以坐大巴、坐飞机，还可以坐火车。我选择交通工具，交通工具服务于我，我和交通工具构成了关系。</p>
<p>你发现了，我在每个例子后面都写了“构成关系”，这个关系到底是什么？这就是依赖。汽车依赖配件，我依赖交通工具。</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>开始写写代码吧，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"hello "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj = <span class="keyword">new</span> A();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client</span></span><br><span class="line">$b = <span class="keyword">new</span> B();</span><br><span class="line">$b-&gt;saySomething();</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello world</span></span><br></pre></td></tr></table></figure>
<p>在上面的代码中，我们做了这样一件事，输出“hello world”。我们知道A的功能是输出”hello “，那么为了不更改A的代码，我们新增了一个B，然后依赖于A，在构造函数里面把A组合进来，然后在B输出“world”之前，先调用A的方法输出“hello ”。</p>
<p>是的，我们的代码完成了预期的想法，成功输出“hello world”。现在，我不想输出“hello world”了，而是输出“bye world”。怎么做呢？</p>
<p>和前面一样，为了不改变A类的功能，我们新增一个C，功能是输出“bye”，如下所示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"bye "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，我们碰到了一个困难，如果想要输出“bye world”，必须改掉 B 的依赖 A，让 B 依赖 C，也就是需要改这一行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;obj = <span class="keyword">new</span> B();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Todo 改成依赖 C</span></span><br><span class="line"><span class="comment">// $this-&gt;obj = new C();</span></span><br></pre></td></tr></table></figure>
<p>这时候，我们陷入了沉思，现在改一下，好像也没什么，但是如果改完了，又叫我改回去，或者改成别的什么D、E、F、G怎么办？况且，现在只是依赖一个，如果以后依赖多了，那不是要吐血…比如下面这种情况</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $obj1 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $obj2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $obj3 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj1 = <span class="keyword">new</span> X();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj2 = <span class="keyword">new</span> Y();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj3 = <span class="keyword">new</span> Z();</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj1-&gt;saySomething();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj2-&gt;saySomething();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj3-&gt;saySomething();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client</span></span><br><span class="line">$b = <span class="keyword">new</span> B();</span><br><span class="line">$b-&gt;saySomething();</span><br></pre></td></tr></table></figure>
<p>还有一种情况，如果这个类是通过远程方法调用的，根本就改不了。<br>细思极恐啊，每天加班加点就为了改这个，和咸鱼有什么区别!</p>
<h3 id="简单工厂模式，依赖转移"><a href="#简单工厂模式，依赖转移" class="headerlink" title="简单工厂模式，依赖转移"></a>简单工厂模式，依赖转移</h3><p>为了不改这个 B，我们想到了一个办法，这些依赖能不能放在一个统一的地方，我需要的时候就去这个地方拿，改也是改这里，根本不用动原来的代码，看看怎么写</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SayFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $obj1 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $obj2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> $obj3 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj1 = <span class="keyword">new</span> X();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj2 = <span class="keyword">new</span> Y();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj3 = <span class="keyword">new</span> Z();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj1-&gt;saySomething();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj2-&gt;saySomething();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj3-&gt;saySomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj = <span class="keyword">new</span> SayFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client</span></span><br><span class="line">$b = <span class="keyword">new</span> B();</span><br><span class="line">$b-&gt;saySomething();</span><br></pre></td></tr></table></figure>
<p>这下，终于不用改 B 了，我们创建了一个简单工厂，让这个工厂依赖于 B，把依赖转移到了 sayFactory 工厂上。以后，管你什么需求，我只需要改这个工厂类就行了！</p>
<p>等等，问题解决了吗？虽然我们不用改 B 了，但是，还是要改这个 sayFactory。一个功能业务改动或许很轻，但是，如果所有的功能业务都这样写，还不是和咸鱼无差？</p>
<p>上面我们说，现实生活中，到底是不是这样的，举个例子，有时候，我们身上只有工行的卡，但是附近只有农行的ATM机，这时候会发生什么？农行ATM机可以识别工行的卡！</p>
<p>回来继续看，如果按照刚刚的思路，建立一个简单工厂来组合依赖项，那么工行的卡接入农行的ATM机，农行ATM应该要改一下代码才可以接入啊，为什么ATM可以识别呢？</p>
<h3 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h3><p><strong>面向接口，而不是面向实现编程</strong></p>
<p>这段话，是用来镇楼的，看不懂没关系，当你读完本文再回过头看自然会有所体会 :)</p>
<p>前面说这么多，总结一下就是</p>
<p><strong>依赖不好维护，客户端动代码(改需求)，内部实现也要改</strong></p>
<p>（<strong>注意这个排比句</strong>）</p>
<p>能不能</p>
<ul>
<li>让客户端掌握控制权</li>
<li>让客户端来决定加载的依赖</li>
<li>让客户端和服务遵守相同的协议</li>
</ul>
<p>一句一句来看，什么叫<strong>让客户端掌握控制权</strong>。原来啊，我们的控制权一直掌握在<strong>服务</strong>的手上，服务自己来<strong>控制</strong>依赖的<strong>目标</strong>，这些都是隐藏在服务背后的，看之前的例子，<strong>B</strong> 一直掌控着依赖的目标（A、X、Y、Z..），客户端改需求了，服务内部就要更改，这无疑是痛苦的。于是我们把<strong>控制权反转（IoC）</strong>，让客户端来掌握控制权。</p>
<p><strong>让客户端来决定加载的依赖</strong>，既然控制权反转到了客户端，客户端就可以自由的搭配依赖项，想加载什么依赖就加载什么，比如这样</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Z</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">" hello "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Z $obg)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj = $obg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> B(<span class="keyword">new</span> Z());</span><br><span class="line">$b-&gt;saySomething();</span><br></pre></td></tr></table></figure>
<p>这样的想法很好，客户端决定加载依赖。可是，这样的代码还是存在问题，如果我想加载别的依赖（比如Y、Z…），那岂不是还是需要更改 B 的构造函数中的类名？</p>
<p>又想到工行卡可以适配农行ATM那个例子，现在我们明白了，因为这张卡遵守了银联的协议，这个协议就是我们说的<strong>让客户端和服务遵守相同的协议</strong>，因为这张卡实现的接口和ATM提供的接口是一致的，所以它们可以适配。</p>
<p>完整代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ISay</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span> <span class="keyword">implements</span> <span class="title">ISay</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">" hello "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Y</span> <span class="keyword">implements</span> <span class="title">ISay</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">" hello "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Z</span> <span class="keyword">implements</span> <span class="title">ISay</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">" hello "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ISay $obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj = $obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Client</span></span><br><span class="line">$b = <span class="keyword">new</span> B(<span class="keyword">new</span> X());</span><br><span class="line">$b-&gt;saySomething();</span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> B(<span class="keyword">new</span> Y());</span><br><span class="line">$b-&gt;saySomething();</span><br><span class="line"></span><br><span class="line"><span class="comment">// X hello world</span></span><br><span class="line"><span class="comment">// Y hello world</span></span><br></pre></td></tr></table></figure>
<p>我们终于解决了这个问题，通过接口，我们把依赖注入到服务中，实现控制反转。</p>
<blockquote>
<p>依赖倒置原则(DIP)是软件设计的一种思想，控制反转（IoC）则是基于DIP衍生出的一种软件设计模式。依赖注入(DI)是IoC的具体实现方式之一，使用最为广泛。IoC容器是DI构造依赖注入的框架，它管理着依赖项的生命周期以及映射关系。</p>
</blockquote>
<h3 id="服务容器"><a href="#服务容器" class="headerlink" title="服务容器"></a>服务容器</h3><p>前面我们把服务讲清楚了，接下来讲讲容器。容器在日常生活中也不难理解，泳池、杯子、地球、乃至人都可以说是容器，就是可以装东西的东西。在程序中，变量、对象、数组、队列、栈、堆都是容器。</p>
<h4 id="使用魔术方法构建服务容器"><a href="#使用魔术方法构建服务容器" class="headerlink" title="使用魔术方法构建服务容器"></a>使用魔术方法构建服务容器</h4><p>先看看代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ISay</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span> <span class="keyword">implements</span> <span class="title">ISay</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">" hello "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Y</span> <span class="keyword">implements</span> <span class="title">ISay</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">" hello "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Z</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span> . <span class="string">" hello "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $obj = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(ISay $obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj = $obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saySomething</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $register = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($k, $c)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;register[$k] = $c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($k)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;register[$k](<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务容器</span></span><br><span class="line">$c = <span class="keyword">new</span> Container();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 X 服务到容器</span></span><br><span class="line">$c-&gt;x = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> X();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册 B 服务到容器</span></span><br><span class="line">$c-&gt;b = <span class="function"><span class="keyword">function</span> <span class="params">($c)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// B 服务依赖 X</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> B($c-&gt;x);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从容器中取得 B</span></span><br><span class="line">$b = $c-&gt;b;</span><br><span class="line">$b-&gt;saySomething();</span><br><span class="line"></span><br><span class="line"><span class="comment">// X hello world</span></span><br></pre></td></tr></table></figure>
<p>这段代码前面没有什么不同，把一个个服务声明清楚。后面我们声明了一个<strong>容器(Containter)</strong>，这个容器使用属性来保存服务，所以它是一个服务容器。我们使用了魔术方法，在给不可访问属性赋值时，<strong>set() 会被调用。读取不可访问属性的值时，</strong>get() 会被调用。</p>
<p>接下来，我们把所需的服务注册到容器中，属性名是服务名，属性值是一个闭包，这个闭包做真正的服务实例化工作。</p>
<h4 id="使用反射构建服务容器"><a href="#使用反射构建服务容器" class="headerlink" title="使用反射构建服务容器"></a>使用反射构建服务容器</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $register = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($k, $c)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;register[$k] = $c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($k)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;build(<span class="keyword">$this</span>-&gt;register[$k]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动绑定（Autowiring）自动解析（Automatic Resolution）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $className</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">($className)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 如果是匿名函数（Anonymous functions），也叫闭包函数（closures）</span></span><br><span class="line">        <span class="keyword">if</span> ($className <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">            <span class="comment">// 执行闭包函数，并将结果返回</span></span><br><span class="line">            <span class="keyword">return</span> $className(<span class="keyword">$this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取得类的反射</span></span><br><span class="line">        $reflector = <span class="keyword">new</span> ReflectionClass($className);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查类是否可实例化, 排除抽象类abstract和对象接口interface</span></span><br><span class="line">        <span class="keyword">if</span> (! $reflector-&gt;isInstantiable()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Can't instantiate this."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取类的构造函数</span></span><br><span class="line">        $constructor = $reflector-&gt;getConstructor();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若无构造函数，直接实例化并返回</span></span><br><span class="line">        <span class="keyword">if</span> (is_null($constructor)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> $className;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取构造函数参数,通过 ReflectionParameter 数组返回参数列表</span></span><br><span class="line">        $parameters = $constructor-&gt;getParameters();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 递归解析构造函数的参数</span></span><br><span class="line">        $dependencies = <span class="keyword">$this</span>-&gt;getDependencies($parameters);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个类的新实例，给出的参数将传递到类的构造函数。</span></span><br><span class="line">        <span class="keyword">return</span> $reflector-&gt;newInstanceArgs($dependencies);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $parameters</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDependencies</span><span class="params">($parameters)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $dependencies = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反射类的构造函数参数</span></span><br><span class="line">        <span class="keyword">foreach</span> ($parameters <span class="keyword">as</span> $parameter) &#123;</span><br><span class="line">            <span class="comment">/** <span class="doctag">@var</span> ReflectionClass $dependency */</span></span><br><span class="line">            $dependency = $parameter-&gt;getClass();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (is_null($dependency)) &#123;</span><br><span class="line">                <span class="comment">// 是变量,有默认值则设置默认值</span></span><br><span class="line">                $dependencies[] = <span class="keyword">$this</span>-&gt;resolveNonClass($parameter);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 是一个类，递归解析</span></span><br><span class="line">                $dependencies[] = <span class="keyword">$this</span>-&gt;build($dependency-&gt;name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $dependencies;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ReflectionParameter $parameter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveNonClass</span><span class="params">($parameter)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 有默认值则返回默认值</span></span><br><span class="line">        <span class="keyword">if</span> ($parameter-&gt;isDefaultValueAvailable()) &#123;</span><br><span class="line">            <span class="keyword">return</span> $parameter-&gt;getDefaultValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'I have no idea what to do here.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">new</span> Container();</span><br><span class="line"></span><br><span class="line">$c-&gt;x = <span class="string">'X'</span>;</span><br><span class="line">$c-&gt;b = <span class="function"><span class="keyword">function</span> <span class="params">($c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> B($c-&gt;x);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从容器中取得 B</span></span><br><span class="line">$foo = $c-&gt;b;</span><br><span class="line">$foo-&gt;saySomething();</span><br></pre></td></tr></table></figure>
<h4 id="为什么我们需要服务容器呢？"><a href="#为什么我们需要服务容器呢？" class="headerlink" title="为什么我们需要服务容器呢？"></a>为什么我们需要服务容器呢？</h4><p>在使用服务容器之前，我们在客户端需要对服务进行实例化并加载相应的依赖，对于客户端来说，做的事情太多了，既要实例化服务，又要处理依赖关系，这是耦合的。所以，我们把服务注册到服务容器中，让服务容器替我们做这些事情，我们不必要关心细节，容器负责实例化，注入依赖，处理依赖关系等工作，客户端只需要使用就好了。</p>
<h3 id="Laravel服务容器"><a href="#Laravel服务容器" class="headerlink" title="Laravel服务容器"></a>Laravel服务容器</h3><p>Laravel的核心就是服务容器，它的功能更多，我们前面写的<strong>使用反射来实现服务容器</strong>，可以说是Laravel服务容器的缩小版，实际上，我们只做了服务实现（build），服务解析的过程还有一个服务查找（make）我们没有做，我们的做法比较搓，直接就是服务容器的一个属性 $c-&gt;b 。</p>
<p>Laravel的服务容器源码在 <strong>Illuminate\Container</strong> 下，可以看到，它还实现了 ArrayAccess 接口，可以通过 $c[‘b’] 这种形式来访问服务。它还支持绑定一个 singeton (单例) ，虽然PHP是一次请求的生命周期，但是也会出现一次请求多次实例化单个对象的时候，这个时候，单例模式就很好，服务容器还能提供一个单例对象，避免多次解析。你也可以使用 instance 方法绑定一个已经存在的对象至容器中。后面的调用都会从容器中返回指定的实例。既然是容器，除了绑定类，对象，接口，当然还可以绑定数据，通过情景绑定注入需要的任何值。还可以注册容器事件，做一些监听的工作，比作监听某个类对象的解析，这时候，可以动态的设置额外属性到对象中，非常强大！</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>认识服务（组件或者依赖）的概念</li>
<li>依赖注入，面向接口编程</li>
<li>认识服务容器的作用与实现简单的服务容器</li>
<li>学习Laravel服务容器的强大之处</li>
</ul>

  </div>
</article>



      </div>
      
       <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/funsoul">Projects</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#写在前"><span class="toc-number">1.</span> <span class="toc-text">写在前</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务"><span class="toc-number">2.</span> <span class="toc-text">服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖"><span class="toc-number">3.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单工厂模式，依赖转移"><span class="toc-number">4.</span> <span class="toc-text">简单工厂模式，依赖转移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖注入"><span class="toc-number">5.</span> <span class="toc-text">依赖注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务容器"><span class="toc-number">6.</span> <span class="toc-text">服务容器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用魔术方法构建服务容器"><span class="toc-number">6.1.</span> <span class="toc-text">使用魔术方法构建服务容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用反射构建服务容器"><span class="toc-number">6.2.</span> <span class="toc-text">使用反射构建服务容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#为什么我们需要服务容器呢？"><span class="toc-number">6.3.</span> <span class="toc-text">为什么我们需要服务容器呢？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Laravel服务容器"><span class="toc-number">7.</span> <span class="toc-text">Laravel服务容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://funsoul.org/2018/05/03/谈谈服务容器/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://funsoul.org/2018/05/03/谈谈服务容器/&text=谈谈服务容器"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://funsoul.org/2018/05/03/谈谈服务容器/&is_video=false&description=谈谈服务容器"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=谈谈服务容器&body=Check out this article: http://funsoul.org/2018/05/03/谈谈服务容器/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://funsoul.org/2018/05/03/谈谈服务容器/&title=谈谈服务容器"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://funsoul.org/2018/05/03/谈谈服务容器/&name=谈谈服务容器&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

      
      <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 funsoul
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="https://github.com/funsoul">Projects</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

      <script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-118289850-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Disqus Comments -->


    </div>
</body>
</html>
