[{"title":"【leetcode】0026.remove-duplicates-from-sorted-array.md","url":"http://funsoul.org/2019/07/02/【leetcode】0026.remove-duplicates-from-sorted-array/","content":"<h2 id=\"题目描述\"><a href=\"#题目描述\" class=\"headerlink\" title=\"题目描述\"></a>题目描述</h2><p>给定一个排序数组，你需要在原地删除重复出现的元素，使得每个元素只出现一次，返回移除后数组的新长度。</p>\n<p>不要使用额外的数组空间，你必须在原地修改输入数组并在使用 O(1) 额外空间的条件下完成。</p>\n<p>示例 1:</p>\n<p>给定数组 nums = [1,1,2], </p>\n<p>函数应该返回新的长度 2, 并且原数组 nums 的前两个元素被修改为 1, 2。 </p>\n<p>你不需要考虑数组中超出新长度后面的元素。<br>示例 2:</p>\n<p>给定 nums = [0,0,1,1,1,2,2,3,3,4],</p>\n<p>函数应该返回新的长度 5, 并且原数组 nums 的前五个元素被修改为 0, 1, 2, 3, 4。</p>\n<p>你不需要考虑数组中超出新长度后面的元素。<br>说明:</p>\n<p>为什么返回数值是整数，但输出的答案是数组呢?</p>\n<p>请注意，输入数组是以“引用”方式传递的，这意味着在函数里修改输入数组对于调用者是可见的。</p>\n<p>你可以想象内部操作如下:</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// nums 是以“引用”方式传递的。也就是说，不对实参做任何拷贝</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> len = removeDuplicates(nums);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 在函数里修改输入数组对于调用者是可见的。</span></span><br><span class=\"line\"><span class=\"comment\">// 根据你的函数返回的长度, 它会打印出数组中该长度范围内的所有元素。</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; len; i++) &#123;</span><br><span class=\"line\">    print(nums[i]);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><p>使用快慢指针</p>\n<ul>\n<li>如果两个指针指的数字相同，则快指针向前走一步</li>\n<li>如果不同，则两个指针都向前走一步</li>\n<li>当快指针走完整个数组后，慢指针当前的坐标加1就是数组中不同数字的个数</li>\n</ul>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Solution</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> Integer[] $nums</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> Integer</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">removeDuplicates</span><span class=\"params\">(&amp;$nums)</span> </span>&#123;</span><br><span class=\"line\">        $len = count($nums);</span><br><span class=\"line\">        $slow = $fast = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (; $fast &lt; $len; $fast++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($nums[$slow] != $nums[$fast]) &#123;</span><br><span class=\"line\">                $slow++;</span><br><span class=\"line\">                $nums[$slow] = $nums[$fast];</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $slow + <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"复杂度分析\"><a href=\"#复杂度分析\" class=\"headerlink\" title=\"复杂度分析\"></a>复杂度分析</h2><ul>\n<li>时间复杂度O(n)，在原数组上遍历</li>\n<li>空间复杂度O(1)，在原数组上遍历，不能使用额外的空间</li>\n</ul>\n","categories":["技术"],"tags":["PHP","leetcode"]},{"title":"【leetcode】0020.Valid Parentheses","url":"http://funsoul.org/2019/07/01/【leetcode】0020.valid-parentheses/","content":"<h2 id=\"题目描述\"><a href=\"#题目描述\" class=\"headerlink\" title=\"题目描述\"></a>题目描述</h2><p>给定一个只包括 ‘(‘，’)’，’{‘，’}’，’[‘，’]’ 的字符串，判断字符串是否有效。</p>\n<p>有效字符串需满足：</p>\n<ul>\n<li>左括号必须用相同类型的右括号闭合。</li>\n<li>左括号必须以正确的顺序闭合。</li>\n<li>注意空字符串可被认为是有效字符串。</li>\n</ul>\n<p>示例 1:</p>\n<p>输入: “()”<br>输出: true<br>示例 2:</p>\n<p>输入: “()[]{}”<br>输出: true<br>示例 3:</p>\n<p>输入: “(]”<br>输出: false<br>示例 4:</p>\n<p>输入: “([)]”<br>输出: false<br>示例 5:</p>\n<p>输入: “{[]}”<br>输出: true</p>\n<h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><ul>\n<li>哈希表存储括号</li>\n<li>栈存储<code>左半边</code>括号集</li>\n</ul>\n<p>遍历输入字符串，如果当前字符为左半边括号时，则将其压入栈中</p>\n<p>如果遇到右半边括号时：</p>\n<ol>\n<li>若此时为空栈，则直接返回false</li>\n<li>若栈不为空且为对应的左半边括号，则取出栈顶元素，继续循环</li>\n<li>若不为对应的左半边括号，反之返回false</li>\n<li>遍历完后，若栈已清空，返回true，否则返回false</li>\n</ol>\n<h2 id=\"代码\"><a href=\"#代码\" class=\"headerlink\" title=\"代码\"></a>代码</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Solution</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> String $s</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@return</span> Boolean</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isValid</span><span class=\"params\">($s)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">empty</span>($s)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        $map = [</span><br><span class=\"line\">            <span class=\"string\">'('</span> =&gt; <span class=\"string\">')'</span>,</span><br><span class=\"line\">            <span class=\"string\">'['</span> =&gt; <span class=\"string\">']'</span>,</span><br><span class=\"line\">            <span class=\"string\">'&#123;'</span> =&gt; <span class=\"string\">'&#125;'</span></span><br><span class=\"line\">        ];</span><br><span class=\"line\"></span><br><span class=\"line\">        $stack = [];</span><br><span class=\"line\">        $lefts = array_keys($map);</span><br><span class=\"line\"></span><br><span class=\"line\">        $len = strlen($s);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; $len; $i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (in_array($s[$i], $lefts)) &#123;</span><br><span class=\"line\">                $stack[] = $s[$i];</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                $left = array_pop($stack);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($map[$left]) &amp;&amp; $map[$left] == $s[$i]) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">empty</span>($stack) ? <span class=\"keyword\">true</span> : <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"复杂度分析\"><a href=\"#复杂度分析\" class=\"headerlink\" title=\"复杂度分析\"></a>复杂度分析</h2><ul>\n<li>时间复杂度O(n)，主要时间花在遍历输入字符串的长度n。</li>\n<li>空间复杂度O(n)，主要使用了一个一维数组结构来存储左半边括号。</li>\n</ul>\n","categories":["技术"],"tags":["PHP","leetcode"]},{"title":"顺序编程与并发编程","url":"http://funsoul.org/2019/07/01/顺序编程与并发编程/","content":"<h2 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h2><p>假设有一个连接数据库添加新表的操作需要耗费的时间为1秒，顺序遍历100个数据库执行加表操作，将需要100秒才能完成，也就是<strong>顺序编程</strong>。</p>\n<h2 id=\"顺序编程\"><a href=\"#顺序编程\" class=\"headerlink\" title=\"顺序编程\"></a>顺序编程</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">timeDiff</span><span class=\"params\">($startTime)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> microtime(<span class=\"keyword\">true</span>) - $startTime;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">addTable</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/** 模拟耗时 */</span></span><br><span class=\"line\">    sleep(<span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    $startTime = microtime(<span class=\"keyword\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; <span class=\"number\">100</span>; $i++) &#123;</span><br><span class=\"line\">        addTable();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">echo</span> timeDiff($startTime) . <span class=\"string\">'s'</span> . PHP_EOL;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 100.25194597244s</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"进程与线程\"><a href=\"#进程与线程\" class=\"headerlink\" title=\"进程与线程\"></a>进程与线程</h2><p>进程是资源分配的最小单位，线程是CPU调度的最小单位。</p>\n<h2 id=\"多任务处理\"><a href=\"#多任务处理\" class=\"headerlink\" title=\"多任务处理\"></a>多任务处理</h2><p>在现代操作系统中，多任务解决方案有很多种（<strong>以下的线程无特别说明均指内核态线程</strong>）：</p>\n<ol>\n<li>单进程单线程(事件循环)</li>\n<li>多进程单线程</li>\n<li>swoole4 协程（多进程单线程）</li>\n<li>golang 协程（单进程多线程）</li>\n</ol>\n<h3 id=\"单进程单线程-事件循环\"><a href=\"#单进程单线程-事件循环\" class=\"headerlink\" title=\"单进程单线程(事件循环)\"></a>单进程单线程(事件循环)</h3><p><img src=\"/images/顺序编程与并发编程/单进程单线程（事件循环）.png\" alt=\"单进程单线程（事件循环）- 图片引自网络\"></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getCurrentDate</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> now = <span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> year = now.getFullYear();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> month = now.getMonth();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> date = now.getDate();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> day = now.getDay();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> hour = now.getHours();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> minu = now.getMinutes();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> sec = now.getSeconds();</span><br><span class=\"line\"></span><br><span class=\"line\">    month = month + <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (month &lt; <span class=\"number\">10</span>) month = <span class=\"string\">\"0\"</span> + month;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (date &lt; <span class=\"number\">10</span>) date = <span class=\"string\">\"0\"</span> + date;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hour &lt; <span class=\"number\">10</span>) hour = <span class=\"string\">\"0\"</span> + hour;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (minu &lt; <span class=\"number\">10</span>) minu = <span class=\"string\">\"0\"</span> + minu;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sec &lt; <span class=\"number\">10</span>) sec = <span class=\"string\">\"0\"</span> + sec;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> year + <span class=\"string\">\"-\"</span> + month + <span class=\"string\">\"-\"</span> + date+ <span class=\"string\">\" \"</span> + hour + <span class=\"string\">\":\"</span> + minu + <span class=\"string\">\":\"</span> + sec;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">sleep</span> (<span class=\"params\">second</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> setTimeout(resolve, second * <span class=\"number\">1000</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">addTable</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'finished at '</span> + getCurrentDate());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'start at '</span> + getCurrentDate());</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">100</span>; i++) &#123;</span><br><span class=\"line\">        sleep(<span class=\"number\">1</span>).then(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> addTable());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">'end at '</span> + getCurrentDate());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">main();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// start at 2019-06-30 11:11:17</span></span><br><span class=\"line\"><span class=\"comment\">// end at 2019-06-30 11:11:17</span></span><br><span class=\"line\"><span class=\"comment\">// finished at 2019-06-30 11:11:18</span></span><br><span class=\"line\"><span class=\"comment\">// finished at 2019-06-30 11:11:18</span></span><br><span class=\"line\"><span class=\"comment\">// finished at 2019-06-30 11:11:18</span></span><br><span class=\"line\"><span class=\"comment\">// ..</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"多进程单线程\"><a href=\"#多进程单线程\" class=\"headerlink\" title=\"多进程单线程\"></a>多进程单线程</h3><p>php可以使用PCNTL或者swoole的<a href=\"https://wiki.swoole.com/wiki/page/p-process.html\" target=\"_blank\" rel=\"noopener\">Process模块</a>，通过fork子进程与相关进程间通信方式（管道、FIFO、消息队列..）具体使用方法可以看下<a href=\"https://github.com/funsoul/funtask\" target=\"_blank\" rel=\"noopener\">funtask</a>的demo。</p>\n<h3 id=\"协程（多进程单线程：swoole4）\"><a href=\"#协程（多进程单线程：swoole4）\" class=\"headerlink\" title=\"协程（多进程单线程：swoole4）\"></a>协程（多进程单线程：swoole4）</h3><p><img src=\"/images/顺序编程与并发编程/协程（多进程单线程：swoole4）.png\" alt=\"协程（多进程单线程：swoole4）- 图片引自网络\"></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getCurrentDate</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> date(<span class=\"string\">'Y-m-d H:i:s'</span>, time());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">addTable</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    Co::sleep(<span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"coroutine \"</span> . Co::getuid() .  <span class=\"string\">\" finished at \"</span> . getCurrentDate() . PHP_EOL;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'start at '</span> . getCurrentDate() . PHP_EOL;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; <span class=\"number\">100</span>; $i++) &#123;</span><br><span class=\"line\">    go(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        addTable();</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'end at '</span> . getCurrentDate() . PHP_EOL;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// start at 2019-06-30 11:23:16</span></span><br><span class=\"line\"><span class=\"comment\">// end at 2019-06-30 11:23:16</span></span><br><span class=\"line\"><span class=\"comment\">// coroutine 1 finished at 2019-06-30 11:23:17</span></span><br><span class=\"line\"><span class=\"comment\">// coroutine 2 finished at 2019-06-30 11:23:17</span></span><br><span class=\"line\"><span class=\"comment\">// coroutine 4 finished at 2019-06-30 11:23:17</span></span><br><span class=\"line\"><span class=\"comment\">// coroutine 8 finished at 2019-06-30 11:23:17</span></span><br><span class=\"line\"><span class=\"comment\">// ..</span></span><br></pre></td></tr></table></figure>\n<p>这段程序不能很好的说明这是多进程单线程模型的，之所以说swoole4采用该模型，是把场景放在<code>swoole server</code>下的时候，swoole通过开启<strong>多个worker</strong>的方式来处理请求，而每个worker是单线程（<strong>内核态</strong>），在单线程的基础上使用协程（<strong>用户态</strong>）。</p>\n<h3 id=\"协程（单进程多线程：golang）\"><a href=\"#协程（单进程多线程：golang）\" class=\"headerlink\" title=\"协程（单进程多线程：golang）\"></a>协程（单进程多线程：golang）</h3><p><img src=\"/images/顺序编程与并发编程/协程（多进程多线程：golang）.jpeg\" alt=\"协程（多进程多线程：golang）- 图片引自网络\"></p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> main</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">\t<span class=\"string\">\"fmt\"</span></span><br><span class=\"line\">\t<span class=\"string\">\"time\"</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">addTable</span><span class=\"params\">(i <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\ttime.Sleep(<span class=\"number\">1</span> * time.Second)</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"goroutine %d finished at %s \\n\"</span>, i, getCurrentDate())</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getCurrentDate</span><span class=\"params\">()</span> <span class=\"title\">time</span>.<span class=\"title\">Time</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> time.Now()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>  &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"start at %s \\n\"</span>, getCurrentDate())</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"number\">0</span>; i &lt; <span class=\"number\">100</span>; i++ &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">go</span> addTable(i);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">\"end at %s \\n\"</span>, getCurrentDate())</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// main函数也是一个goroutine，这里是为了让任务的goroutine执行完</span></span><br><span class=\"line\">\ttime.Sleep(<span class=\"number\">2</span> * time.Second)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// start at 2019-06-30 19:16:41.905093 +0800 CST m=+0.000270723 </span></span><br><span class=\"line\"><span class=\"comment\">// end at 2019-06-30 19:16:41.905521 +0800 CST m=+0.000699248 </span></span><br><span class=\"line\"><span class=\"comment\">// goroutine 79 finished at 2019-06-30 19:16:42.909839 +0800 CST m=+1.005007866 </span></span><br><span class=\"line\"><span class=\"comment\">// goroutine 27 finished at 2019-06-30 19:16:42.909775 +0800 CST m=+1.004944053 </span></span><br><span class=\"line\"><span class=\"comment\">// goroutine 99 finished at 2019-06-30 19:16:42.909779 +0800 CST m=+1.004948541</span></span><br><span class=\"line\"><span class=\"comment\">// ..</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>PHP的目标一直都是简单为主，php-fpm很受欢迎的一大原因就是多进程单线程模型（没有线程或进程间IPC）、生命周期短暂，写代码不需要手动管理内存，减少心智负担。而多线程一直令人诟病的地方是<strong>data race</strong>（数据竞争），因为线程间通信的方式为<strong>共享变量</strong>，这需要开发者提高警惕，通过加锁等方式来解决。</p>\n<p>本文介绍顺序编程与并发编程，探索在并发编程上各语言在不同模型上的支持度，在选择并发模型前，应该综合考虑业务类型是IO密集还是CPU密集型。前面介绍的几种并发模型中，node的事件循环、swoole4协程、golang协程都适用于IO密集型应用，其中golang的协程还适用于CPU密集型应用，在多核支持上更好。不过swoole4新版本中，引入的<strong>协程抢占式调度</strong>避免<strong>cpu饿死问题</strong>，值得一试！</p>\n<h2 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h2><ul>\n<li><a href=\"https://book.douban.com/subject/4118577/\" target=\"_blank\" rel=\"noopener\">《unix网络编程 卷2》</a></li>\n<li><a href=\"https://www.cnblogs.com/onepixel/p/7143769.html\" target=\"_blank\" rel=\"noopener\">node 时间循环机制</a></li>\n<li><a href=\"https://wiki.swoole.com/\" target=\"_blank\" rel=\"noopener\">swoole wiki</a></li>\n<li><a href=\"https://segmentfault.com/a/1190000019089997\" target=\"_blank\" rel=\"noopener\">swoole 协程</a></li>\n<li><a href=\"https://segmentfault.com/a/1190000018150987\" target=\"_blank\" rel=\"noopener\">golang goroutine理解</a></li>\n</ul>\n","categories":["技术"],"tags":["PHP","Swoole","Golang","Node"]},{"title":"一段诡异的文本（notepad++）","url":"http://funsoul.org/2019/04/21/一段诡异的文本（notepad++）/","content":"<p><img src=\"/images/一段诡异的文本.png\" alt></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">上图，红色文本为诡异文段，绿色文本为正常文档。无论怎么做（格式刷、改变字体、修改段间距等）都无法将红色文段的样式改为绿色文档的。</span><br><span class=\"line\"></span><br><span class=\"line\">如果将其复制到记事本，另存为时，会出现下面的提示，因此可以判断，红色文段含有“特殊字符”。</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/一段诡异的文本二.png\" alt></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用notepad++打开，在红色文段使用“人肉搜索法”可以发现，确实是这样的。将其删除，并改为正常标点即可。</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/一段诡异的文本三.png\" alt></p>\n","categories":["技术"],"tags":["工具"]},{"title":"redis的对端心跳检测","url":"http://funsoul.org/2019/03/24/redis的对端心跳检测/","content":"<h2 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h2><p>这段时间在做<code>基于Redis的发布订阅</code>时遇到一个有意思的问题，客户端无论使用php扩展<code>phpredis</code>还是原生php写的库<code>predis</code>做subscribe时，都会在一段时间后（30min左右），当发生一次<code>publish</code>后，redis-server断开客户端的socket连接，而客户端没有任何异常（仍为ESTABLISH）</p>\n<p>一开始我以为是客户端的问题，但是在一系列的测试后，确认应该是服务端的问题，最后在师兄在帮助下，找到了redis-server的一个配置<code>tcp-keepalive</code>，这个值当时为0，后来我们设置为300，程序正常了。</p>\n<h2 id=\"基于redis的发布订阅程序\"><a href=\"#基于redis的发布订阅程序\" class=\"headerlink\" title=\"基于redis的发布订阅程序\"></a>基于redis的发布订阅程序</h2><p><img src=\"/images/发布订阅.png\" alt=\"发布订阅\"></p>\n<p>这个服务非常简单，从上图可知，以Redis-Server为界分为上下两部分，上部分通过Web程序下指令，发布消息到指定的Channel，下部分是一个常驻进程服务，在Redis-Server订阅了某个Channel，并阻塞在Subscribe事件回调中，当有消息来，进行消息处理。</p>\n<h2 id=\"php实现订阅者-Subscriber-php\"><a href=\"#php实现订阅者-Subscriber-php\" class=\"headerlink\" title=\"php实现订阅者(Subscriber.php)\"></a>php实现订阅者(Subscriber.php)</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$channel = <span class=\"string\">'test'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">process</span><span class=\"params\">($redis, $chan, $msg)</span></span>&#123;</span><br><span class=\"line\">    var_dump(date(<span class=\"string\">'Y-m-d H:i:s'</span>, time()), $msg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$redis = <span class=\"keyword\">new</span> \\Redis();</span><br><span class=\"line\">$redis-&gt;connect($config[<span class=\"string\">'host'</span>], $config[<span class=\"string\">'port'</span>]);</span><br><span class=\"line\">$redis-&gt;auth($config[<span class=\"string\">'password'</span>]);</span><br><span class=\"line\">$redis-&gt;select($config[<span class=\"string\">'db'</span>]);</span><br><span class=\"line\">$redis-&gt;setOption(Redis::OPT_READ_TIMEOUT, <span class=\"number\">-1</span>);</span><br><span class=\"line\">$redis-&gt;subscribe([$channel], <span class=\"string\">'process'</span>);</span><br></pre></td></tr></table></figure>\n<p>为了减少<code>变量</code>，说明问题，上面是一段非常简单的代码。简单说明下，这是一段cli程序，运行在前台，订阅channel为test，并阻塞在process函数中，当有消息过来，会在前台打印当前时间以及消息。</p>\n<h2 id=\"php实现发布者-Publisher-php\"><a href=\"#php实现发布者-Publisher-php\" class=\"headerlink\" title=\"php实现发布者(Publisher.php)\"></a>php实现发布者(Publisher.php)</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$channel = <span class=\"string\">'test'</span>;</span><br><span class=\"line\">$message = <span class=\"string\">'hello'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$redis = <span class=\"keyword\">new</span> \\Redis();</span><br><span class=\"line\">$redis-&gt;connect($config[<span class=\"string\">'host'</span>], $config[<span class=\"string\">'port'</span>]);</span><br><span class=\"line\">$redis-&gt;auth($config[<span class=\"string\">'password'</span>]);</span><br><span class=\"line\">$redis-&gt;select($config[<span class=\"string\">'db'</span>]);</span><br><span class=\"line\">$redis-&gt;publish($channel, $message);</span><br></pre></td></tr></table></figure>\n<h2 id=\"为什么我说不是客户端的问题\"><a href=\"#为什么我说不是客户端的问题\" class=\"headerlink\" title=\"为什么我说不是客户端的问题\"></a>为什么我说不是客户端的问题</h2><p>Subscriber执行后，找到Redis的连接socket</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 找到进程ID</span></span><br><span class=\"line\">ps -ef | grep Subscriber</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 找到进程ID占用的端口号</span></span><br><span class=\"line\">sudo netstat -nap | grep pid</span><br></pre></td></tr></table></figure>\n<p>由于前面设置的是<code>$config[&#39;port&#39;]</code>，所以可以看到这个端口下的状态是<code>ESTABLISH</code>。</p>\n<p>这时，还可以做一个小操作，前面我们知道了进程ID，strace一下</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo strace -p pid</span><br></pre></td></tr></table></figure>\n<p>这样一来，当有消息过来，我们可以更清楚地看到整个调用过程，这里可以排除一个问题 —— 客户端主动断开。有些网上的文章会告诉你，这是客户端的问题，订阅端需要设置一些长连接的参数，比如php的</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ini_set(<span class=\"string\">'default_socket_timeout'</span>, <span class=\"number\">-1</span>)</span><br></pre></td></tr></table></figure>\n<p>又比如，phpredis的</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$redis-&gt;setOption(Redis::OPT_READ_TIMEOUT, <span class=\"number\">-1</span>);</span><br></pre></td></tr></table></figure>\n<p>因为phpredis默认的超时时间是60秒，所以这里需要一些配置，上面两者选一种即可，都可以去掉超时限制，我这里用的就是第二种。</p>\n<p>接下来就是等待了，前言说了，大约在30分钟后，当我发布一次消息后，Redis-Server的客户端socket会自动断开，导致没有消息到达订阅端。在此之前，我需要确保Redis-Server是有我们这个客户端存活着的，也就是说，我们需要知道事件发生前后，client的状态。这里可以通过<code>redis-cli</code>来看</p>\n<p>假设Subscriber所在的机器与订阅端口为<code>192.168.8.8:6379</code>，这是假设的情况，实际上端口是不一样的。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-cli -h xxx -p 6379 -a xxx -n 1 client list | grep 192.168.8.8:6379</span><br></pre></td></tr></table></figure>\n<p>这个命令可以知道Redis-Server的客户端连接状态，包括连接时间、空闲时间、内存、事件等等。Subscriber程序的事件当然就是subscribe了，可以很容易看出来。运行这个命令后，我们发现这个client socket是非常健康的。</p>\n<p>经过一段时间的等待，我们再回来一一检查过、确认过：</p>\n<ol>\n<li>客户端Subscriber并没有down掉</li>\n<li>客户端连接socket的状态是ESTABLISH，也是正常的</li>\n<li>Redis-Server的client list下也能查到我们的客户端状态</li>\n</ol>\n<p>然后，我们执行一次Publisher程序，问题出现了：</p>\n<ol>\n<li>Subscriber程序没有如期打印出当前日期和消息，但是也没有报错</li>\n<li>客户端连接socket的状态是ESTABLISH，仍是正常的</li>\n<li>Redis-Server的client list下，多打印几次后，我们的客户端就断开了、消失了</li>\n</ol>\n<p>以上就是问题的全部了:)</p>\n<h2 id=\"phpredis扩展的问题？\"><a href=\"#phpredis扩展的问题？\" class=\"headerlink\" title=\"phpredis扩展的问题？\"></a>phpredis扩展的问题？</h2><p>一开始我也怀疑过，于是换成了php原生写的<code>predis</code>库，写了几乎一样的代码，然而并没有用，还是一样的问题。</p>\n<h2 id=\"转移目标\"><a href=\"#转移目标\" class=\"headerlink\" title=\"转移目标\"></a>转移目标</h2><p>既然客户端没问题，会不会是我们的客户端连接socket在Redis所在机器被别的程序kill掉了，有可能。重来一遍，这一次我不等30分钟了，直接在Redis服务端把我的客户端kill掉试试看</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">redis-cli -h xxx -p 6379 -a xxx -n 1 client <span class=\"built_in\">kill</span> 192.168.8.8:6379</span><br></pre></td></tr></table></figure>\n<p>这时，Subscriber报了异常，然后退出了！！这种情况说明，如果服务端有程序想要把我的客户端kill掉，客户端是会响应的，但是现在的情况并不是这样，还要继续看。</p>\n<h2 id=\"TCP心跳检测\"><a href=\"#TCP心跳检测\" class=\"headerlink\" title=\"TCP心跳检测\"></a>TCP心跳检测</h2><p>大胆的猜测：如果程序端有断开的行为，那么Redis-Server会做出相应的行为来告知客户端，但如果是网络层的断开呢？</p>\n<p>后来在师兄的帮助下，逐一排查了redis.conf的配置，找到了一个参数<code>tcp-keepalive</code>。我们知道TCP的<code>keep-alive</code>和HTTP的<code>keepalive</code>是两个东西。TCP的keep-alive是<code>socket对端心跳检测</code>，用来预防客户端断开后服务端资源浪费的问题。</p>\n<p>redis.conf中，tcp-keepalive为0，这里的意思是不做对端心跳检测，那么在一定时间后，服务端就会回收这些idle的socket资源。</p>\n<p>后来我们改为300，意思是每隔300秒，发送一个心跳包（TCP控制包），如果客户端返回ACK，那么服务端就认为你是正常的健康的客户端，可以留着。实际上情况没那么简单，如果写过网络编程的可以知道，还有另外两个参数在控制着</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tcp_keepalive_time // 距离上次传送数据多少时间未收到判断为开始检测</span><br><span class=\"line\">tcp_keepalive_intvl // 检测开始每多少时间发送心跳包</span><br><span class=\"line\">tcp_keepalive_probes // 发送几次心跳包对方未响应则close连接</span><br></pre></td></tr></table></figure>\n<h2 id=\"再说发布订阅\"><a href=\"#再说发布订阅\" class=\"headerlink\" title=\"再说发布订阅\"></a>再说发布订阅</h2><p>前面我们的发布订阅写的非常简单，真实情况还需要考虑更多的问题，简单说一个，如果订阅者无故down了，还在重连中时，发布者发了一个消息，如果没有其他的订阅者，那这个消息就发布失败了，看起来非常不健壮。</p>\n<p>这里可以考虑利用redis加一个消息队列做<code>持久化</code>，每一次发消息时，都push一个消息进队列，如果订阅者没有及时重连也没关系，重连成功后，可以去队列中把消息pop出来继续处理。</p>\n<p><img src=\"/images/发布订阅-消息队列.png\" alt=\"发布订阅-消息队列\"></p>\n<h2 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h2><ul>\n<li>redis发布订阅可能会遇到的问题</li>\n<li>排查进程间通信问题的小工具</li>\n<li>TCP心跳机制</li>\n<li>发布订阅的一点健壮性思考</li>\n</ul>\n","categories":["技术"],"tags":["PHP","Redis","TCP"]},{"title":"下载大文件时不得不了解nginx的一个配置","url":"http://funsoul.org/2019/02/14/【nginx】fastcgi_max_tmp_file_size/","content":"<h2 id=\"问题背景\"><a href=\"#问题背景\" class=\"headerlink\" title=\"问题背景\"></a>问题背景</h2><p>laravel下载大文件服务，浏览器无法承载大文件下载，会崩溃。改为提供api，外部使用curl或者wget等工具下载。为什么没用scp呢？因为服务器权限问题，这个功能是为了解决浏览器下载大文件崩溃而生的。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>大文件下载遇到的问题，每次下载到1024M的时候，就自动停了。</p>\n<h2 id=\"解决过程\"><a href=\"#解决过程\" class=\"headerlink\" title=\"解决过程\"></a>解决过程</h2><ol>\n<li>curl的问题，加上-C参数，提供断点续传。无效</li>\n<li>wget，同上，到了1024M就自动停了</li>\n<li>laravel的问题，并不是，symfony有很好的文件响应组件</li>\n<li>php的问题，没有这样的配置</li>\n<li>php-fpm的问题，同上，没有这样的配置</li>\n<li>nginx的问题，是的！</li>\n</ol>\n<h2 id=\"fastcgi-max-temp-file-size默认为1024M\"><a href=\"#fastcgi-max-temp-file-size默认为1024M\" class=\"headerlink\" title=\"fastcgi_max_temp_file_size默认为1024M\"></a>fastcgi_max_temp_file_size默认为1024M</h2><p>配置说明</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">When buffering of responses from the FastCGI server is enabled, and the whole response does not fit into the buffers set by the fastcgi_buffer_size and fastcgi_buffers directives, a part of the response can be saved to a temporary file. This directive sets the maximum size of the temporary file. The size of data written to the temporary file at a time is set by the fastcgi_temp_file_write_size directive.</span><br><span class=\"line\">The zero value disables buffering of responses to temporary files.</span><br><span class=\"line\">This restriction does not apply to responses that will be cached or stored on disk.</span><br></pre></td></tr></table></figure>\n<p>改大一点，解决~</p>\n","categories":["技术"],"tags":["nginx"]},{"title":"用shc保护你的敏感信息","url":"http://funsoul.org/2019/02/14/【shell】shc加密/","content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>有个功能是在web下载大文件，但是太大的文件，在浏览器下载会崩溃。想了下，能不能改为API的方式，使用CURL来下载？</p>\n<p>一开始不想暴露api，这个api不常用，因为绕过了用户会话（不用登陆），并不安全，如果被恶意利用：数据会被泄露，服务器会被拖慢等等安全隐患。</p>\n<p>于是想过把通过shell文件，把api放在里面，然后使用shc来加密shell文件为二进制文件。这样一来，api就“看不到”了，有一定的安全性，只要不被反编译，应该是目前最可靠的方法。</p>\n<h2 id=\"安装shc\"><a href=\"#安装shc\" class=\"headerlink\" title=\"安装shc\"></a>安装shc</h2><p>root用户</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># wget http://www.datsi.fi.upm.es/~frosal/sources/shc-3.8.3.tgz</span><br><span class=\"line\"># tar -zxvf shc-3.8.3.tgz</span><br><span class=\"line\"># cd shc-3.8.3</span><br><span class=\"line\"># make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n<p><strong>这里会让你确认，千万别直接enter，而是输入y，enter</strong></p>\n<h2 id=\"使用shc\"><a href=\"#使用shc\" class=\"headerlink\" title=\"使用shc\"></a>使用shc</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shc -v -r -T -f xxx.sh</span><br></pre></td></tr></table></figure>\n<p>这里也有坑，不用-T的话，是没办法执行的。</p>\n<p>然后会生成两个文件</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xxx.sh.x  --- 二进制文件</span><br><span class=\"line\">xxx.sh.x.c  --- C文件，可删除</span><br></pre></td></tr></table></figure>\n<h2 id=\"使用二进制\"><a href=\"#使用二进制\" class=\"headerlink\" title=\"使用二进制\"></a>使用二进制</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod +x xxx.sh.x</span><br><span class=\"line\">rname xxx.sh （重命名）</span><br><span class=\"line\">./xxx.sh</span><br></pre></td></tr></table></figure>\n<p>windows下，是执行不了这个二进制文件的，需要使用cygwin或者windows子系统才可以。想过直接用gcc编译c文件，但是会报错，应该是格式原因，还是得在windows下执行shc。</p>\n<h2 id=\"curl注意事项\"><a href=\"#curl注意事项\" class=\"headerlink\" title=\"curl注意事项\"></a>curl注意事项</h2><p>如果想要在windows下执行curl，如果链接里面有&amp;符号是有问题的，需要把整个链接用引号包起来才可以</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl &quot;https://aa.com/api/excel/download?token=xx&amp;file=xx.csv&quot; &gt;&gt; xx.csv</span><br></pre></td></tr></table></figure>","categories":["技术"],"tags":["shell"]},{"title":"【打脸】php5解决laravel队列中的超时重试问题","url":"http://funsoul.org/2019/01/19/【打脸】php5解决laravel队列中的超时重试问题/","content":"<h2 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h2><p>上一篇文章<a href=\"http://funsoul.org/2018/12/29/%E3%80%90Laravel%E3%80%91laravel%E9%98%9F%E5%88%97%E4%B8%AD%E7%9A%84timeout%E5%8F%82%E6%95%B0%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8php7.1/\">laravel队列中的timeout参数需要使用php7.1</a>，最后结论时，我说这个问题只能升级php7.1才能解决，在今天的思考和实验中发现，还可以“曲线救国”！！啪啪打脸。</p>\n<p>上一篇文章，在读了laravel源码知道，在异步队列中，laravel使用了一个php7.1才有的函数<a href=\"http://php.net/manual/en/function.pcntl-async-signals.php\" target=\"_blank\" rel=\"noopener\">pcntl_async_signals</a>，这让我瞬间失去了所有想法，虽然升级PHP7是大趋势，但是有些依赖库可能在支持上还不完善。当然，大部分时候建议是升级的，PHP5很快就不进行安全维护了啊。</p>\n<h2 id=\"再探索\"><a href=\"#再探索\" class=\"headerlink\" title=\"再探索\"></a>再探索</h2><p>这个离线队列到底是怎么运行的？有兴趣的朋友可以看下陈昊写的<a href=\"https://blogoss.yinghualuo.cn/blog/2017/08/Laravel框架关键技术解析-陈昊.pdf\" target=\"_blank\" rel=\"noopener\">《laravel框架关键技术解析》</a>中13章【消息队列】，能够大致明白laravel程序消息队列的“前半部分”，为什么我说前半部分？接着看</p>\n<p>这部书讲了<strong>同步类型</strong>和<strong>数据库类型</strong>消息队列，接下来我要讲的是数据库类型里面的<strong>redis驱动类型</strong>以及<strong>worker处理程序</strong>这里面到底发生了什么事。</p>\n<p>laravel优秀的设计与机制给我们提供了很多最佳实践，这也意味着<strong>隐藏了不少黑盒子</strong>，有时候让人不痛快、不明所以。只能一边看源码、一边做实验、一边感叹XX。</p>\n<p>如果你已经了解了laravel队列的机制或者看完了<a href=\"https://blogoss.yinghualuo.cn/blog/2017/08/Laravel框架关键技术解析-陈昊.pdf\" target=\"_blank\" rel=\"noopener\">《laravel框架关键技术解析》</a>这本书，我想你已经明白消息的生成和发送。着重看下消息的处理</p>\n<p>如果你使用supervisor来管理队列程序，一般会开启多个worker</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">numprocs=8</span><br></pre></td></tr></table></figure>\n<p>假设有8个worker(1000，1001，…，1007)，后面再说下只有一个worker会发生什么</p>\n<p>当一个消息来了，会先在redis生成一个list，假设你的队列名称为queueA，就会生成一个名为<strong>queue:queueA</strong>的list，此时，worker1000就会从list中pop一个消息出来处理，把这个消息放入一个名为<strong>queues:queueA:reserved</strong>的zset中，即“保留消息有序集”。</p>\n<p>这时会有一堆信号注册，其中就包括timeout超时信号检测，如上篇文章所说，由于背景是php5，所以并不会注册异步信号，timeout参数就没用了，看下面的源码得知</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Enable async signals for the process.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> void</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">listenForSignals</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">$this</span>-&gt;supportsAsyncSignals()) &#123;</span><br><span class=\"line\">            pcntl_async_signals(<span class=\"keyword\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            pcntl_signal(SIGTERM, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;shouldQuit = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            pcntl_signal(SIGUSR2, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;paused = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            pcntl_signal(SIGCONT, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;paused = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Register the worker timeout handler (PHP 7.1+).</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span>  \\Illuminate\\Contracts\\Queue\\Job|null  $job</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span>  WorkerOptions  $options</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> void</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">registerTimeoutHandler</span><span class=\"params\">($job, WorkerOptions $options)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">$this</span>-&gt;supportsAsyncSignals()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// We will register a signal handler for the alarm signal so that we can kill this</span></span><br><span class=\"line\">            <span class=\"comment\">// process if it is running too long because it has frozen. This uses the async</span></span><br><span class=\"line\">            <span class=\"comment\">// signals supported in recent versions of PHP to accomplish it conveniently.</span></span><br><span class=\"line\">            pcntl_signal(SIGALRM, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">$this</span>-&gt;kill(<span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">            pcntl_alarm(</span><br><span class=\"line\">                max(<span class=\"keyword\">$this</span>-&gt;timeoutForJob($job, $options), <span class=\"number\">0</span>)</span><br><span class=\"line\">            );</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Determine if \"async\" signals are supported.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> bool</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">supportsAsyncSignals</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> version_compare(PHP_VERSION, <span class=\"string\">'7.1.0'</span>) &gt;= <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">               extension_loaded(<span class=\"string\">'pcntl'</span>);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>上篇文章就讲到了这里，我们接着看，既然timeout信号无效，任务过时了自然就不会终止，可是时间还在继续，走到了另一个参数retry_after到期要做的事情。</p>\n<blockquote>\n<p>为了避免任务被执行多次，retry_after参数要比timeout参数的值大一些</p>\n</blockquote>\n<p>这里假设<strong>timeout为10s，retry_after为15s，tries为3次</strong></p>\n<blockquote>\n<p>tries是max_tries，即任务执行次数</p>\n</blockquote>\n<p>worker1000检测到tries为3，也就是说，这任务能执行3次，就把任务信息中<strong>attempts改为1，原先是0</strong>，重新释放回队列中，看下面的代码。还没完，这任务还在执行呢….</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Get the Lua script for releasing reserved jobs.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * KEYS[1] - The \"delayed\" queue we release jobs onto, for example: queues:foo:delayed</span></span><br><span class=\"line\"><span class=\"comment\">     * KEYS[2] - The queue the jobs are currently on, for example: queues:foo:reserved</span></span><br><span class=\"line\"><span class=\"comment\">     * ARGV[1] - The raw payload of the job to add to the \"delayed\" queue</span></span><br><span class=\"line\"><span class=\"comment\">     * ARGV[2] - The UNIX timestamp at which the job should become available</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> string</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">release</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&lt;&lt;&lt;'LUA'</span></span><br><span class=\"line\"><span class=\"string\">-- Remove the job from the current queue...</span></span><br><span class=\"line\"><span class=\"string\">redis.call('zrem', KEYS[2], ARGV[1])</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">-- Add the job onto the \"delayed\" queue...</span></span><br><span class=\"line\"><span class=\"string\">redis.call('zadd', KEYS[1], ARGV[2], ARGV[1])</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">return true</span></span><br><span class=\"line\"><span class=\"string\">LUA;</span></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>worker1001等呀等，终于等到了一个消息，就拿了执行了，和worker1000一样，到了retry_after的时候，把attempts改为2，又释放回去。</p>\n<p>worker1002同上，把attempts改为3，又释放回去。</p>\n<p>worker1003拿到后，一看，tries为3啊，已经不能再执行了，就抛异常<strong>Illuminate\\Queue\\MaxAttemptsExceededException</strong>，并说</p>\n<blockquote>\n<p>A queued job has been attempted too many times. The job may have previously timed out.</p>\n</blockquote>\n<p>然后，worker1003回调任务里面的failed方法，并终止任务逻辑</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 任务失败回调方法</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span>  Exception  $exception</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@return</span> void</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">failed</span><span class=\"params\">(Exception $exception)</span></span></span><br><span class=\"line\"><span class=\"function\">   </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>注意，此时worker1000、worker1001、worker1002还在执行….这是很可怕的，很容易引起<strong>资源泄露、依赖服务负载过大</strong>等问题。</p>\n<h2 id=\"“曲线救国”\"><a href=\"#“曲线救国”\" class=\"headerlink\" title=\"“曲线救国”\"></a>“曲线救国”</h2><p>上面介绍了laravel队列中worker运行原理，但是问题并没有得到解决。这么说来，升级PHP7应该是最好的办法，确实是的，但是根据laravel worker的运行机制，还能这么做，接着看</p>\n<p>利用laravel的<strong>重试</strong>机制和<strong>异常</strong>机制，我们可以这样设置</p>\n<ul>\n<li>tries=1</li>\n<li>timeout=10 (不变)</li>\n<li>retry_after=15 (不变)</li>\n</ul>\n<p>这样一来，worker1000在执行任务时，我们记录该进程的ID，保存起来，能够让别的进程获取到。在worker1001重试的时候，会报异常，因为tries已经是最大值了。此时，在异常回调函数中，我们把worker1000的进程ID取出来，kill掉，supervisor会重新拉起一个新的worker，问题就解决了！</p>\n<p>这个解决方案是不是特别有趣？:)</p>\n<h2 id=\"特殊情况：只有一个worker\"><a href=\"#特殊情况：只有一个worker\" class=\"headerlink\" title=\"特殊情况：只有一个worker\"></a>特殊情况：只有一个worker</h2><p>上面的解决方案是可行的，但是，这是建立在supervisor能维护worker池的前提下，如果打从一开始，就只有一个worker，这怎么办呢？</p>\n<p>这个问题让人吐血，因为真实的情况是，只有一个worker的情况下，会忽略掉retry_after，并不会释放任务，更别提报异常了，一股脑的往下执行….</p>\n","categories":["技术"],"tags":["PHP","Laravel"]},{"title":"laravel队列中的timeout参数需要使用php7.1","url":"http://funsoul.org/2018/12/29/【Laravel】laravel队列中的timeout参数需要使用php7.1/","content":"<h2 id=\"timeout解释\"><a href=\"#timeout解释\" class=\"headerlink\" title=\"timeout解释\"></a>timeout解释</h2><p><a href=\"https://laravel-china.org/docs/laravel/5.4/queues/1256#job-expirations-and-timeouts\" target=\"_blank\" rel=\"noopener\">job-expirations-and-timeouts</a></p>\n<h3 id=\"任务过期-amp-超时\"><a href=\"#任务过期-amp-超时\" class=\"headerlink\" title=\"任务过期 &amp; 超时\"></a>任务过期 &amp; 超时</h3><h4 id=\"任务过期\"><a href=\"#任务过期\" class=\"headerlink\" title=\"任务过期\"></a>任务过期</h4><blockquote>\n<p>config/queue.php 配置文件里，每一个队列连接都定义了一个 retry_after 选项。这个选项指定了任务最多处理多少秒后就被当做失败重试了。比如说，如果这个选项设置为 90，那么当这个任务持续执行了 90 秒而没有被删除，那么它将被释放回队列。通常情况下，你应该把 retry_after 设置为最长耗时的任务所对应的时间。<br>{note} 唯一没有 retry_after 选项的连接是 Amazon SQS。当用 Amazon SQS 时，你必须通过 Amazon 命令行来配置这个重试阈值。</p>\n</blockquote>\n<h2 id=\"版本\"><a href=\"#版本\" class=\"headerlink\" title=\"版本\"></a>版本</h2><ul>\n<li>php 5.6.30</li>\n<li>laravel 5.4.*</li>\n</ul>\n<h2 id=\"laravel5-4源码\"><a href=\"#laravel5-4源码\" class=\"headerlink\" title=\"laravel5.4源码\"></a>laravel5.4源码</h2><p><a href=\"https://github.com/laravel/framework/blob/5.4/src/Illuminate/Queue/Worker.php\" target=\"_blank\" rel=\"noopener\">Worker</a></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">* Register the worker timeout handler (PHP 7.1+).</span></span><br><span class=\"line\"><span class=\"comment\">*</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> \\Illuminate\\Contracts\\Queue\\Job|null $job</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> WorkerOptions $options</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@return</span> void</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">registerTimeoutHandler</span><span class=\"params\">($job, WorkerOptions $options)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"keyword\">$this</span>-&gt;supportsAsyncSignals()) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// We will register a signal handler for the alarm signal so that we can kill this</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// process if it is running too long because it has frozen. This uses the async</span></span><br><span class=\"line\">\t\t<span class=\"comment\">// signals supported in recent versions of PHP to accomplish it conveniently.</span></span><br><span class=\"line\">\t\tpcntl_signal(SIGALRM, <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;kill(<span class=\"number\">1</span>);</span><br><span class=\"line\">\t\t&#125;);</span><br><span class=\"line\">\t\tpcntl_alarm(</span><br><span class=\"line\">\t\t\tmax(<span class=\"keyword\">$this</span>-&gt;timeoutForJob($job, $options), <span class=\"number\">0</span>)</span><br><span class=\"line\">\t\t);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">* Determine if \"async\" signals are supported.</span></span><br><span class=\"line\"><span class=\"comment\">*</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@return</span> bool</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">supportsAsyncSignals</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> version_compare(PHP_VERSION, <span class=\"string\">'7.1.0'</span>) &gt;= <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">\textension_loaded(<span class=\"string\">'pcntl'</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"测试结论\"><a href=\"#测试结论\" class=\"headerlink\" title=\"测试结论\"></a>测试结论</h2><ol>\n<li>php5.6，无法使用timeout属性</li>\n<li>任务进入重试后，相关参数就全部失效了，如tries，因此长耗时任务会一直跑</li>\n<li>tries为0时，会陷入无限重试。此时，必须要把redis中“queues:【这里是你的queue名称】:reserved”删除才能终止</li>\n<li>上面的设置中，retry_after比timeout大一些，在timeout无效后，任务会进行retry（丢回队列，由其他worker接管执行，这时会出现第2点的问题），当重试次数达到设定值时，原进程就会异常退出，报【A queued job has been attempted too many times. The job may have previously timed out】错误。</li>\n</ol>\n<p>上面的问题都是因为，php5不支持timeout……..看来要使用这个参数，必须要升级到php7.1了….</p>\n","categories":["技术"],"tags":["PHP","Laravel"]},{"title":"从前慢","url":"http://funsoul.org/2018/10/28/【读书】查令十字街84号/","content":"<p>不记得什么时候看过《北京遇上西雅图之不二情书》，又或者是没看过？记忆中依稀有这样的情节：两个人互相写信写了许久却一直没有见面。</p>\n<p>周六正巧去了西西弗书店，想着买一本小书，能在任何时候翻阅几页，本来想买《给忙碌者看的天体物理学》，对于浩瀚的宇宙，从小学就开始充满好奇，常常去书店看关于宇宙、太阳系的科普书，完了找小伙伴吹嘘，“你知道太阳系最大的星球是哪个吗？”，“诶你知道黑洞吗？”，“是的，我也相信外星人”。由于不能拆书，我对这本书有期待，逛了两圈后，看到推荐书架上这本书，还是开封的，赶忙去翻一翻，结果是让我失望的，不但没有精美的插图，讲述也略微生硬，兴趣骤减。</p>\n<p>于是，《查令十字街84号》成了我的“囊中之物”，满心欢喜地走了。在回家的地铁上，再加上两个小时的睡前时间就读完了这本小书。</p>\n<p>全书描述了落魄纽约女作家和英国古书店找书人的故事，20年的书信来往，书籍和礼物的传递，饱含情谊。大多数时候围绕着找书来开展线索，前面大部分的书籍成了现在爱书人的“圣经”。在那个小说时代，女作家不随大流，对自己的喜爱坚定不移。书店主的优雅绅士，对女作家的诉求铭记于心。在最后，由于生活的窘迫，他们也没能如约见面。</p>\n<p>书店里几个老员工一个一个的相继去世，最后也没能等来海莲。</p>\n<blockquote>\n<p>我们都还健在，可不是吗。</p>\n</blockquote>\n<p>20年，弗兰克因病去世了，书信才停止了来往。</p>\n<blockquote>\n<p>如果你们刚好路过查令十字街84号，请代我献上一吻，我亏欠它良多···</p>\n</blockquote>\n<p>这里是全书最让我感动的地方。二十年缘悭一面，相隔万里莫逆于心。人生有一知己，便不再活得像一座孤岛吧。</p>\n<blockquote>\n<p>我们活在一个诡异的世界，这么漂亮，又能终生厮守的书，只须花相当于看场电影的代价就能拥有。</p>\n</blockquote>\n<p>关于读书，我有轻微的藏书癖，即使是生日礼物，相比昂贵的电子产品、包装精美的巧克力、又抑或是酷炫的自行车，我更愿意收到书。无论是丹布朗的《数字城堡》，还是纳兰性德的《人生若只如初见》，我都照收不误，哈哈，我也算个伪爱书人吧。</p>\n<p>在西西弗书店看书的时候，翻到一本海子的诗集，里面藏着一张有些泛黄的白色纸片，纸片上有几种不同笔迹的文字。在这本书上，这张纸就像一封信，感动着所有翻到这一页的爱书人。</p>\n<blockquote>\n<p>有着一条街，它比整个世界还大。</p>\n</blockquote>\n<p>有一种交流方式 —— 写信，它比任何其他形式都让人温暖。</p>\n","categories":["读书"],"tags":["读书"]},{"title":"PHP查询impala超时处理","url":"http://funsoul.org/2018/10/23/PHP查询impala超时处理/","content":"<h2 id=\"问题还原\"><a href=\"#问题还原\" class=\"headerlink\" title=\"问题还原\"></a>问题还原</h2><p>在<a href=\"http://funsoul.org/2017/12/27/【重构Hue】大数据处理的一些总结/\" title=\"【重构Hue】大数据处理的一些总结\">【重构Hue】大数据处理的一些总结</a> 之后，又发现了新的问题。问题出现在php-fpm的 <strong>request_terminate_timeout</strong> 参数，当设置为0时，worker进程在处理请求时就没有超时处理，0表示无限制，也就是说，用户在查询SQL时，如果该条SQL耗时非常久，worker也不会主动关闭该请求。这里就会出现一种常见的情况：用户看到一直不响应，那就刷新重来，重复查询操作。由于前一个worker还在等待impala服务返回数据，没执行完毕，不能恢复空闲状态，所以master只会把该请求分配给其他worker执行。长此以来，impala服务面对这么多耗时SQL，CPU和内存疯长，处理速度下降。fpm的“僵死”worker越来越多，web服务被拖慢。</p>\n<p>优化过程如下：</p>\n<h2 id=\"request-terminate-timeout设置一个大于0的常数值\"><a href=\"#request-terminate-timeout设置一个大于0的常数值\" class=\"headerlink\" title=\"request_terminate_timeout设置一个大于0的常数值\"></a>request_terminate_timeout设置一个大于0的常数值</h2><p>既然worker不会主动结束与impala的连接，那就设置一个大于0的常数值，比如60s，那么当请求到了60s还没结束那就主动关闭掉。（<strong>这里的请求指的web请求</strong>）看起来是没问题的，既保证了impala服务稳定，又释放了worker的压力。但是，有两个小问题也很容易想到：一、worker主动关闭返回504 gateway timeout，这个异常是无法在php捕获的，所以没办法争对做处理。二、修改php-fpm的配置，可能会影响其他web程序的正常执行。</p>\n<h2 id=\"odbc配置设置\"><a href=\"#odbc配置设置\" class=\"headerlink\" title=\"odbc配置设置\"></a>odbc配置设置</h2><p>我们使用的连接方案是<strong>odbc</strong>，从php到impala，整个调用栈大约如此：php-&gt;phpodbc-&gt;unixodbc-&gt;impalaodbc。由于是cgi程序，所以对进程操作会产生各种奇怪的情况，这里就不做分析了，可能性不大。</p>\n<p>1、 odbc_setoption()</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 2. Option 0 of SQLSetStmtOption() is SQL_QUERY_TIMEOUT.</span></span><br><span class=\"line\"><span class=\"comment\">//    This example sets the query to timeout after 30 seconds.</span></span><br><span class=\"line\">$result = odbc_prepare($conn, $sql);</span><br><span class=\"line\">odbc_setoption($result, <span class=\"number\">2</span>, <span class=\"number\">0</span>, <span class=\"number\">30</span>);</span><br><span class=\"line\">odbc_execute($result);</span><br></pre></td></tr></table></figure>\n<p>看了下官网手册，发现了这个函数<a href=\"http://php.net/manual/zh/function.odbc-setoption.php\" target=\"_blank\" rel=\"noopener\">odbc_setoption</a>，但是并没有用，因为impalaodbc并没有实现这个接口。</p>\n<p>2、odbc.ini中SocketTimeout参数</p>\n<blockquote>\n<p>The number of seconds that the TCP socket waits for a response from the server before timing out the request and returning an error message</p>\n</blockquote>\n<p>看了下<a href=\"https://www.cloudera.com/documentation/other/connectors/impala-odbc/latest/Cloudera-ODBC-Driver-for-Impala-Install-Guide.pdf\" target=\"_blank\" rel=\"noopener\">文档</a>，这里是指TCP socket的闲置连接超时，而不是查询超时。也没用，这个参数和我们的需求没什么关系。</p>\n<h2 id=\"thrift查询impala\"><a href=\"#thrift查询impala\" class=\"headerlink\" title=\"thrift查询impala\"></a>thrift查询impala</h2><p>前面都是用odbc来连接impala，换个思路，使用thrift来试试看。上github找了两个库，<a href=\"https://github.com/tranch/php-thrift-impala\" target=\"_blank\" rel=\"noopener\">tranch/php-thrift-impala</a>,<a href=\"https://github.com/Automattic/php-thrift-sql\" target=\"_blank\" rel=\"noopener\">Automattic/php-thrift-sql</a>。开源万岁:)</p>\n<p>由于我们的项目使用laravel来写，Automattic/php-thrift-sql就不太适合了（composer下载要账密是什么鬼= =），难道要我把仓库拉下来改一下？都8102年了，不支持composer，没有namespace的代码要你何用！于是，我用了这个tranch/php-thrift-impala。但是，这个仓库有bug！它自己封装的超时设置无效的！怪不得没有几个星星啊~没办法，然后，我结合Automattic/php-thrift-sql这个仓库的例子写了一个，完美执行。以后有空我封装一下开源吧~ :)</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$socket = <span class=\"keyword\">new</span> \\Thrift\\Transport\\TSocket( config(<span class=\"string\">'hadoop.host'</span>), config(<span class=\"string\">'hadoop.thrift_port'</span>) );</span><br><span class=\"line\">$socket-&gt;setRecvTimeout(config(<span class=\"string\">'hadoop.timeout'</span>));</span><br></pre></td></tr></table></figure>\n<p>上面两行是关键！</p>\n<h2 id=\"注意点\"><a href=\"#注意点\" class=\"headerlink\" title=\"注意点\"></a>注意点</h2><p>thrift查询impala超时处理是可行的，在php层就可以处理超时。但是，毕竟是php代码，查询会慢一些，我简单对比了一下，同一个查询，thrift和odbc相比有一倍多的差异。所以在这个系统中，并不是只用thrift或者odbc，而是看场景，混合着用。</p>\n<p>thanks :)</p>\n","categories":["技术"],"tags":["问题排查","PHP","ODBC","impala","thrift"]},{"title":"平凡一生，温暖纯良，不舍爱与自由","url":"http://funsoul.org/2018/10/14/【读书】平凡的世界/","content":"<p>前夜终于读完了路遥先生的《平凡的世界》，在近一个月中，我每天都从中收获温暖。奇怪的是，我很想下手写点什么类似读后感的东西却不知从何着手，那种淡淡的感觉很妙。直到今天，心里想还是写点吧，趁热乎~</p>\n<p>抛开时代背景谈社会状况是片面的，尤其是1975到1985年间，那个时代发生了什么不深入讨论了。在历史的长河中，有些东西伴随时间流逝，有些东西终将让人铭记。历史总是惊人的相似，在整个大环境流动中，如何顺着上升面前进，更值得我们深思吧。世事在不断的变化中，如果不想遭遇像田福堂、孙玉亭那样惨淡的晚年，在世事中寻找契机并拥有变革的勇气可能会拔得头筹。</p>\n<p>孙玉厚是我在书中非常喜欢的角色之一，他是这个家的顶梁柱。早年供弟弟孙玉亭上学，借钱给弟弟结婚，还把自己的房子给了弟弟。耕耘数十载，为了这个家（上有老，下有小）无怨无悔，终日殚精竭虑谋生活，他是千千万万平凡劳动者的代表。然而，最让人感动的是，他那颗始终慈祥的心：替大女儿忧愁、支持少安变革、为了少安的幸福，支持分家、在少安事业上升期，始终放不下心、支持少平出去闯荡，支持小女儿上大学。是的，他没有什么文化，为了这个家，他能做的微乎其微，但是，他是这个家真正的精神脊梁！从他的孩子们身上都能看到他的特质，固执、自尊、仁慈、善良、温暖与爱。</p>\n<p>孙少安是最残忍的人，也是最有爱的人。我佩服他的果敢，对家庭的热爱大于他自身。青梅竹马不羡仙，跑马汉子狠斩缘（哎呀，这句子工整吗~）。润叶是少安的知音，少安也爱着润叶。由于家庭的差距，少安竟然残忍割断情丝，有一种爱叫做放手（啊呸）。他有自己信仰——家庭，他不愿让润叶也掉入这泥淖中。可是，润叶呢，唉~为了自己的大伯，这不，也学着少安，嫁给了一个不喜欢的人，罪孽啊~大清不是亡了吗，怎么还有政治婚姻啊~当然，到了后面，少安和润叶都过着幸福的生活，无论是少安与秀莲携手共度跌宕起伏的生活，还是润叶与向前凄厉悲壮的爱情，都让人敬佩。人生啊，爱情与现实是个永恒的主观题。</p>\n<p>田福军是很多读者喜爱的角色，这就是人们常说的，穿越回来的人，注定要闹一番世事的人物啊。历史上，不乏有这样的英雄大家，他们总是先人一步，做出不平凡的事情，这本书《平凡的世界》中，说这个人是个bug也不为过，勇于变革，推陈出新，深谋远虑，还拥有一颗慈悲之心，救苦救难。这种人，不就是英雄吗。在田晓霞给孙少平借书时，我注意到《牛虻》这本书就是田福军买回来的，他的书架上有各种各样的书籍，田晓霞在他父亲的影响下，也是个英雄啊（这个后面详细说说）。</p>\n<p>孙少平让我感动颇深，所以我决定放在最后来讲。孙少平作为全书的主角，从头到尾，我都找不到一个能用主角光环来概括的地方，可是谈到他，却拥有极其复杂的情感，那是一种捏在喉咙很不畅快的感觉。每当我以为主角该出场收拾一切、解决残局的时候，他竟然没有任何存在感！姐姐兰花的丈夫因为卖老鼠药被抓去批斗，他没有出现。哥哥的婚姻出现问题愁眉苦脸，他没有出现。读个高中，成绩竟然没有拔尖，相反理科非常差。读完书被迫回家务农，还是叔叔帮他成为村里的老师，当然，当老师期间也是平平无奇，没什么特别的。这是主角？后来，我终于明白，为什么这本书叫做《平凡的世界》，主角就是这么平凡的一个人，应该说，这世界就是这么平凡，哪有那么多英雄史诗，是啊，英雄看多了，没人关注普通人到底是怎么生活的。而作为普通人中，孙少平的一生，或许，这大抵就是作者想要给我们呈现的，所谓平凡。</p>\n<p>孙少平在初中期间，无意中获读《钢铁是怎样炼成的》这本书，自此之后，他有机会就去借书阅读，读书成为了他生活中不可或缺的一部分，极致到什么程度？后面在黄原做小工的时候，每天晚上一个人，身上顶着各种各样的伤痕，一根微弱的烛光，趴在四面无窗门的危房地面上，常常就是一整夜啊。他酷爱外国文学，即使没有去过很远的地方，但是他的精神已经漫游在世界各地。以前我把这种行为当作简单的“排斥外界的诱惑，一心只读圣贤书”。后来，我知道这是一种叫做“慎独”的精神状态。人生在一切诸如繁华、掌声、群体、沟通交流之后，长久陪伴你的是落寞和空虚。这时的你，需要的是慎独慎行来默默的应对，用微笑来善待生命，珍惜生命，享受生命，超越生命！在岁月的风霜雨雪中，去深刻地感受生命的醇厚绵长，让心境坦然，生命淡然！</p>\n<p>孙少平的“苦难治疗”，超乎常人。他本可呆在舒适的家，和兄长一起变革，发展实业。然而，他却毅然决然地闯荡未知的世界，面对未知的生活。依靠自己的双手，从低做起。于他而言，这是生活。他不愿在既定的已知的道路中行走，他要走出自己的“道”。面对与田晓霞的关系，他早就有了最坏的结局，是啊，就像他的兄长一样的结局，家庭的差异性迫使他“低头”。他只能在劳动中治疗自己，麻痹自己。还有师傅的离世，最后是田晓霞的相继离别。生命中最重要的亲近的人纷纷远去对他的沉痛打击，他最多允许自己休息一会儿，然后就继续投入到无尽的劳动中去。这是属于孙少平的“苦难救赎”，唯有劳动，才能修建起最坚实的壳保护着他。唯有劳动，才能让他找到自己不平凡的内心。</p>\n<p>孙少平和田晓霞的爱情，大抵是路遥先生心目中最高级的爱情的模样。两个人没有所谓的一见钟情，鸿沟般的社会地位差异，然而，这两个灵魂在一次次的交流中碰撞出火花。是啊，两个人过日子，维系在中间的那根线不就是“有话”吗？正如刘震云先生的《一句顶一万句》，两个人的生活，就是在“说话”啊。孙少平爱书，田晓霞把看过的书借来给他，两人一起交谈书中的内容。精神世界的碰撞带来的是灵魂的冲击，就像柏拉图式的恋爱，不需要言明就已经相知甚深。而让田晓霞真正动情的，可能是孙少平对于苦难的理解。田晓霞的认知中，还没有一个这样的人能让她如此新奇，甚至于崇拜？是啊，这不就是爱情最初始的状态吗——互相欣赏。这种欣赏超越社会阶级！超越认知！超越距离！这就是不平凡！大抵是这样的田晓霞过于完美，只能写死了（= =），坑啊！</p>\n<p>在全部书中，我们看到的都是生活中种种的苦难，这是人生的心酸，在我们短促而又漫长的一生中，我们在苦苦地寻找人生的幸福。可幸福往往又与我们失之交臂。当我们为此而耗尽宝贵的青春年华，皱纹也悄悄地爬上了眼角的时候，我们或许才能稍稍懂得生活实际上意味着什么。后来我在别处看到了一句话，幸运，是生活对你心慈手软，苦难，才是它本来的面目。正如书中说的，生活应该包含更广阔的意义，而不在于我们实际得到了什么，关键在于我们的内心是否充实。面对苦难，更强大的精神世界或许更有用。而对于生活理想，应该像宗教一样充满虔诚与热情。</p>\n<p>最后用《高晓松写给女儿》的信中的一句话来结尾</p>\n<blockquote>\n<p>一生温暖纯良，不舍爱与自由</p>\n</blockquote>\n","categories":["读书"],"tags":["读书"]},{"title":"【funtask】又一个多任务处理框架","url":"http://funsoul.org/2018/07/29/【funtask】又一个多任务处理框架/","content":"<h2 id=\"框架获取\"><a href=\"#框架获取\" class=\"headerlink\" title=\"框架获取\"></a>框架获取</h2><p><a href=\"https://github.com/funsoul/funtask\" title=\"funtask\" target=\"_blank\" rel=\"noopener\">funtask</a></p>\n<h2 id=\"更新日志\"><a href=\"#更新日志\" class=\"headerlink\" title=\"更新日志\"></a>更新日志</h2><ol>\n<li>2018-07-29 Swoole1.0简单版生产消费模型，采用多进程模式</li>\n<li>2019-04-25 采用Swoole4重构进程池（退出重启），增加进程组（退出不重启）</li>\n<li>2019-05-06 支持协程Coroutine</li>\n</ol>\n<h2 id=\"使用例子\"><a href=\"#使用例子\" class=\"headerlink\" title=\"使用例子\"></a>使用例子</h2><h3 id=\"耗时任务例子\"><a href=\"#耗时任务例子\" class=\"headerlink\" title=\"耗时任务例子\"></a>耗时任务例子</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Consumer</span> <span class=\"keyword\">implements</span> \\<span class=\"title\">Funsoul</span>\\<span class=\"title\">Funtask</span>\\<span class=\"title\">Process</span>\\<span class=\"title\">JobInterface</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * business job</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> bool [exit process or not]</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">()</span>: <span class=\"title\">bool</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $pid = getmypid();</span><br><span class=\"line\"></span><br><span class=\"line\">        $i = <span class=\"number\">0</span>;</span><br><span class=\"line\">        $running = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> ($running) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">\"&#123;$pid&#125;: \"</span> . $i++ . PHP_EOL;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($i == <span class=\"number\">5</span>)</span><br><span class=\"line\">                $running = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// exit current process</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"ProcessPool进程池\"><a href=\"#ProcessPool进程池\" class=\"headerlink\" title=\"ProcessPool进程池\"></a>ProcessPool进程池</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$task = <span class=\"keyword\">new</span> \\Funsoul\\Funtask\\Funtask();</span><br><span class=\"line\">$task-&gt;setType(<span class=\"string\">'POOL'</span>)</span><br><span class=\"line\">    -&gt;setJob(<span class=\"keyword\">new</span> Consumer())</span><br><span class=\"line\">    -&gt;setWorkerNum(<span class=\"number\">3</span>)</span><br><span class=\"line\">    -&gt;setWorkerName(<span class=\"string\">'myWorker'</span>)</span><br><span class=\"line\">    -&gt;start();</span><br></pre></td></tr></table></figure>\n<h3 id=\"ProcessGroup进程组\"><a href=\"#ProcessGroup进程组\" class=\"headerlink\" title=\"ProcessGroup进程组\"></a>ProcessGroup进程组</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$task = <span class=\"keyword\">new</span> \\Funsoul\\Funtask\\Funtask();</span><br><span class=\"line\">$task-&gt;setType(<span class=\"string\">'GROUP'</span>)</span><br><span class=\"line\">    -&gt;setJob(<span class=\"keyword\">new</span> Consumer())</span><br><span class=\"line\">    -&gt;setWorkerNum(<span class=\"number\">3</span>)</span><br><span class=\"line\">    -&gt;setWorkerName(<span class=\"string\">'myWorker'</span>)</span><br><span class=\"line\">    -&gt;start();</span><br></pre></td></tr></table></figure>\n<h3 id=\"Coroutine协程\"><a href=\"#Coroutine协程\" class=\"headerlink\" title=\"Coroutine协程\"></a>Coroutine协程</h3><h4 id=\"协程任务例子\"><a href=\"#协程任务例子\" class=\"headerlink\" title=\"协程任务例子\"></a>协程任务例子</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConsumerCo</span> <span class=\"keyword\">implements</span> \\<span class=\"title\">Funsoul</span>\\<span class=\"title\">Funtask</span>\\<span class=\"title\">Coroutine</span>\\<span class=\"title\">CoJobInterface</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> \\Swoole\\Http\\Request $request</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> mixed|void</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(\\Swoole\\Http\\Request $request)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $cid = Co::getuid();</span><br><span class=\"line\"></span><br><span class=\"line\">        $i = <span class=\"number\">0</span>;</span><br><span class=\"line\">        $running = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> ($running) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">\"&#123;$cid&#125;: \"</span> . $i++ . PHP_EOL;</span><br><span class=\"line\"></span><br><span class=\"line\">            Co::sleep(<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($i == <span class=\"number\">5</span>)</span><br><span class=\"line\">                $running = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"funtask统一接口\"><a href=\"#funtask统一接口\" class=\"headerlink\" title=\"funtask统一接口\"></a>funtask统一接口</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$task = <span class=\"keyword\">new</span> \\Funsoul\\Funtask\\Funtask();</span><br><span class=\"line\">$task-&gt;setType(<span class=\"string\">'CO'</span>)-&gt;setCoJob(<span class=\"keyword\">new</span> ConsumerCo())-&gt;setWorkerNum(<span class=\"number\">3</span>);</span><br><span class=\"line\"><span class=\"comment\">/** var \\Swoole\\Http\\Response $response */</span></span><br><span class=\"line\">$task-&gt;setFinishCallback(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">($response)</span> </span>&#123;</span><br><span class=\"line\">\t$response-&gt;end(<span class=\"string\">'finished'</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">$task-&gt;start();</span><br></pre></td></tr></table></figure>\n<h4 id=\"coroutine接口\"><a href=\"#coroutine接口\" class=\"headerlink\" title=\"coroutine接口\"></a>coroutine接口</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$co = <span class=\"keyword\">new</span> \\Funsoul\\Funtask\\Coroutine\\Coroutine();</span><br><span class=\"line\">$co-&gt;setHost(<span class=\"string\">'127.0.0.1'</span>)</span><br><span class=\"line\">    -&gt;setPort(<span class=\"number\">9501</span>)</span><br><span class=\"line\">    -&gt;setWorkerNum(<span class=\"number\">1</span>)</span><br><span class=\"line\">    -&gt;setCoNum(<span class=\"number\">3</span>)</span><br><span class=\"line\">    -&gt;setJob(<span class=\"keyword\">new</span> ConsumerCo());</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/** var \\Swoole\\Http\\Response $response */</span></span><br><span class=\"line\">$co-&gt;start(<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">($response)</span> </span>&#123;</span><br><span class=\"line\">\t$response-&gt;end(<span class=\"string\">\"finished!\\n\"</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>","categories":["项目"],"tags":["PHP","Swoole","多任务处理"]},{"title":"ImpalaODBC StringColumnLength导致的乱码问题","url":"http://funsoul.org/2018/07/02/探索ImpalaODBC字符串字段最大字符数限制导致的数据被截断问题/","content":"<h3 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h3><ul>\n<li>mhue:自研的类似hue的hadoop查询系统</li>\n</ul>\n<h3 id=\"这个字段有点大\"><a href=\"#这个字段有点大\" class=\"headerlink\" title=\"这个字段有点大\"></a>这个字段有点大</h3><p>有一个新表，记录游戏前端发来的appdata数据，这个appdata就是本次问题的主角，存储的是玩家手机里所有应用的安装信息（应用名称、安装时间等等）。在这里，刚开始我很惊讶，为什么这些数据如此容易就能获得，直觉告诉我，这些信息非常敏感。后来才知道，原来也是需要授权的，高版本的安卓系统更难获得，而苹果手机就不用想了。了解后才知道，原来这些数据是用来做机器学习的，或许能够通过这些数据，推测出玩家的兴趣、性格等等？看起来似乎有一定的研究价值。不过，这里有一个问题，就是这个app_data实在是太“大”了，一个字段就占了几K到几十K不止（目前的实际数据，最大约47K），而且，随着玩家手机里面的应用增加而增加，也就是说，有可能会更多。这些信息都使用json格式发送到数据库中。</p>\n<h3 id=\"乱码排查开始\"><a href=\"#乱码排查开始\" class=\"headerlink\" title=\"乱码排查开始\"></a>乱码排查开始</h3><p>前面说的乱码问题，正是这个表的appdata数据导致的，其他数据表不会出现这个问题。一开始报错的提示非常奇怪，第一，在mhue中直接查询并展示数据，appdata字段呈现“抖动”情况（整个页面都不太正常），后来才知道，这个数据太大了，页面要正常显示出来非常难，Element官方估计也会表示无奈= =。其次，直接点击页面上的“下载”按钮下载数据后，数据是乱码的。以前我有探讨过乱码产生的原因，无非是字符集对不上了，于是我把impala odbc取到的数据拿出来，看看是不是UTF8编码。果然不是！打印出来的结果是CP936，这是GBK的编码吧，于是我很高兴的说，这是编码的问题，看看是不是建表有误。但是，得到的回答并非如此，建库建表有非常完善的流程，基本不会出现编码的问题，都是统一的。</p>\n<h3 id=\"PHP缓冲区满导致的字段被截断\"><a href=\"#PHP缓冲区满导致的字段被截断\" class=\"headerlink\" title=\"PHP缓冲区满导致的字段被截断\"></a>PHP缓冲区满导致的字段被截断</h3><p>既然不是编码问题，也就是说，拿到数据后，这个字符串就是不完整的，而我是在PHP层检测编码的，那是不是说，PHP拿到impala odbc的数据时，并没有拿到完整的数据呢？为了印证我的想法，我把缓冲区变为无限制，默认的output buffer是4096个字符，再看看发现并没有用。其实细想之下，缓冲区只是一个“缓冲带”，解决不同设备的读写速度差异问题，只要及时把缓冲区写到内存，根本不会出现这种问题。而稳定重现乱码问题，说明操作系统调度没有问题，没有阻塞写内存的操作。接着看</p>\n<h3 id=\"odbc-longreadlen太短，导致字符串被截断\"><a href=\"#odbc-longreadlen太短，导致字符串被截断\" class=\"headerlink\" title=\"odbc longreadlen太短，导致字符串被截断\"></a>odbc longreadlen太短，导致字符串被截断</h3><p>翻查php odbc的文档可以发现一个配置，longreadlen，这个配置决定了每一行数据中字段的最大长度，咋一看应该是它了，而且文档说明，设置为0的时候，长字段限制将会去掉。设为0试试看，发现还是没有用。</p>\n<h3 id=\"impala-odbc-StringColumnLength太短，导致字符串被截断\"><a href=\"#impala-odbc-StringColumnLength太短，导致字符串被截断\" class=\"headerlink\" title=\"impala odbc StringColumnLength太短，导致字符串被截断\"></a>impala odbc StringColumnLength太短，导致字符串被截断</h3><p>既然PHP层的配置没有起效，那么还可能是别的模块出现了错误，由于mhue的查询使用的是impala odbc连接hadoop进行查询的，所以有可能是这里的问题。查一下odbc.ini，发现确实有一个这样的字段，StringColumnLength，这个字段和longreadlen的意思相近，不过没有0这种无限制的选项。按理说，字符串限制最大应该可以去到2G，我尝试改大一点，就1M吧，1024x1024，删掉原来的32767。再试试看，发现还是没有用，下载的长度只有40k左右，而实际大小为47k。</p>\n<h3 id=\"impala-odbc-StringColumnLength最大限制为32k，导致字符串被截断\"><a href=\"#impala-odbc-StringColumnLength最大限制为32k，导致字符串被截断\" class=\"headerlink\" title=\"impala odbc StringColumnLength最大限制为32k，导致字符串被截断\"></a>impala odbc StringColumnLength最大限制为32k，导致字符串被截断</h3><p>查阅了国外的一些帖子，看到有个开发者似乎很有权威，难道是官方开发者？先不管了，看看说了什么，他说，这个StringColumnLength是一个max limit，最大就是32k，当然根据操作系统位数、内存等因素决定，可能会大一点，但是呢，这个32k在性能考虑下，是一个最佳配置…..怪不得我改了没有用，估计代码里面写死了。给出的建议是，更改数据类型为varchar，并配置字符数长度。这样的建议并不适合于我们的需求，好吧，既然如此，那就不改了。</p>\n<h3 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h3><p>既然这个库有限制，可以联想到，其他库也会做相应的限制，而app_data字段是无限制的，这样搞肯定是不合理。那么如何优化呢？针对这个需求，可以有三个方案：</p>\n<ol>\n<li>给与权限，让客户端直接连接hadoop取数据。</li>\n<li>另外建库，订阅数据，给与权限。</li>\n<li>分库，把appdata数据分包发，不要一次性发一个很大的数据包，通过roleid等字段映射数据包</li>\n</ol>\n<p>方案一权限可能会很大，毕竟一不小心来个drop database and rm -rf /咋办？这个东西需要斟酌一下。</p>\n<p>方案二建个库给你订阅一份数据问题也不大，看成本。再者，机器学习那边如何能够更有效率的拿到数据做分析也需要考量在内，这一点，第三个方案可能略显粗鲁，毕竟，机器学习如果以excel做数据集，未免有点奇葩..</p>\n<p>方案三，联表查数据，做归并，导出excel，也就是mhue现在这套机制。</p>\n","categories":["技术"],"tags":["PHP","ODBC"]},{"title":"编写全局Vue辅助函数【urlEncode】","url":"http://funsoul.org/2018/05/14/写个Vue插件-urlEncode/","content":"<p>新建一个文件<strong>src/utils/Common.js</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span><br><span class=\"line\">  install(Vue, options) &#123;</span><br><span class=\"line\">    Vue.prototype.urlEncode = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">param, key, encode</span>) </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (param === <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">''</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> paramStr = <span class=\"string\">''</span>;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> t = <span class=\"keyword\">typeof</span> (param);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (t === <span class=\"string\">'string'</span> || t === <span class=\"string\">'number'</span> || t === <span class=\"string\">'boolean'</span>) &#123;</span><br><span class=\"line\">        paramStr += <span class=\"string\">'&amp;'</span> + key + <span class=\"string\">'='</span> + ((encode == <span class=\"literal\">null</span> || encode) ? <span class=\"built_in\">encodeURIComponent</span>(param) : param);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i <span class=\"keyword\">in</span> param) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">let</span> k = key == <span class=\"literal\">null</span> ? i : key + (param <span class=\"keyword\">instanceof</span> <span class=\"built_in\">Array</span> ? <span class=\"string\">'['</span> + i + <span class=\"string\">']'</span> : <span class=\"string\">'.'</span> + i);</span><br><span class=\"line\">          paramStr += <span class=\"keyword\">this</span>.urlEncode(param[i], k, encode);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> paramStr;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>在 <strong>main.js</strong> 引入并且全局注册</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> Common <span class=\"keyword\">from</span> <span class=\"string\">'./utils/Common.js'</span></span><br><span class=\"line\">Vue.use(Common);</span><br></pre></td></tr></table></figure>\n<p>接下来就可以直接在其他组件中使用</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> data = &#123;</span><br><span class=\"line\">\tnickName: <span class=\"string\">'funsoul'</span>,</span><br><span class=\"line\">\tage: <span class=\"number\">18</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">this</span>.urlEncode(data);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// &amp;nickName=funsoul&amp;age=18</span></span><br></pre></td></tr></table></figure>\n","categories":["技术"],"tags":["JS","Vue"]},{"title":"PHP原型模式之性能探索","url":"http://funsoul.org/2018/05/10/PHP原型模式之性能探索/","content":"<h3 id=\"原型模式\"><a href=\"#原型模式\" class=\"headerlink\" title=\"原型模式\"></a>原型模式</h3><p>有些时候，我们需要创建多个类似的大对象。如果直接通过new对象，开销很大，而且new完还得进行重复的初始化工作。可能把初始化工作封装起来的，但是对于系统来说，你封不封装，初始化工作还是要执行。</p>\n<p>原型模式则不同，原型模式是先创建好一个原型对象，然后通过clone这个原型对象来创建新的对象，这样就免去了重复的初始化工作，系统仅需内存拷贝即可。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IPrototype</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> <span class=\"keyword\">implements</span> <span class=\"title\">IPrototype</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_hobbies = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($name, $hobbies)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hobbies = $hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setName</span><span class=\"params\">($name)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setHobby</span><span class=\"params\">($hobbies)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hobbies = $hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">clone</span> <span class=\"keyword\">$this</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$Alan = <span class=\"keyword\">new</span> Student(<span class=\"string\">'Alan'</span>,[<span class=\"string\">'basketball'</span>,<span class=\"string\">'swimming'</span>]);</span><br><span class=\"line\">$Bob = $Alan-&gt;copy();</span><br><span class=\"line\">$Bob-&gt;setName(<span class=\"string\">'Bob'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$Alan-&gt;setHobby([<span class=\"string\">'traveling'</span>,<span class=\"string\">'chess'</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">var_dump($Alan);</span><br><span class=\"line\">var_dump($Bob);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//    object(Student)#1 (2) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//    [\"_name\":\"Student\":private]=&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//      string(4) \"Alan\"</span></span><br><span class=\"line\"><span class=\"comment\">//    [\"_hobbies\":\"Student\":private]=&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//      array(2) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//        [0]=&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//        string(9) \"traveling\"</span></span><br><span class=\"line\"><span class=\"comment\">//        [1]=&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//        string(5) \"chess\"</span></span><br><span class=\"line\"><span class=\"comment\">//      &#125;</span></span><br><span class=\"line\"><span class=\"comment\">//    &#125;</span></span><br><span class=\"line\"><span class=\"comment\">//    object(Student)#2 (2) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//    [\"_name\":\"Student\":private]=&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//      string(3) \"Bob\"</span></span><br><span class=\"line\"><span class=\"comment\">//    [\"_hobbies\":\"Student\":private]=&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//      array(2) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//        [0]=&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//        string(10) \"basketball\"</span></span><br><span class=\"line\"><span class=\"comment\">//        [1]=&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//        string(8) \"swimming\"</span></span><br><span class=\"line\"><span class=\"comment\">//      &#125;</span></span><br><span class=\"line\"><span class=\"comment\">//    &#125;</span></span><br></pre></td></tr></table></figure>\n<p>我对这里的性能差异有些兴趣，分别对new和clone做一些性能测试</p>\n<h3 id=\"clone方式\"><a href=\"#clone方式\" class=\"headerlink\" title=\"clone方式\"></a>clone方式</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define(<span class=\"string\">\"NEWLINE\"</span>,chr(<span class=\"number\">10</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IPrototype</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> <span class=\"keyword\">implements</span> <span class=\"title\">IPrototype</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_hobbies = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($name, $hobbies)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hobbies = $hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setName</span><span class=\"params\">($name)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setHobby</span><span class=\"params\">($hobbies)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hobbies = $hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">clone</span> <span class=\"keyword\">$this</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$bigArr = range(<span class=\"number\">1</span>,<span class=\"number\">100000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$m1 = memory_get_usage();</span><br><span class=\"line\"></span><br><span class=\"line\">$Alan = <span class=\"keyword\">new</span> Student(<span class=\"string\">'Alan'</span>, $bigArr);</span><br><span class=\"line\">$Bob = $Alan-&gt;copy();</span><br><span class=\"line\"></span><br><span class=\"line\">$m2 = memory_get_usage();</span><br><span class=\"line\">$memory = $m2 - $m1;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'内存占用：'</span> . $memory . NEWLINE;</span><br></pre></td></tr></table></figure>\n<h4 id=\"clone方式性能测试\"><a href=\"#clone方式性能测试\" class=\"headerlink\" title=\"clone方式性能测试\"></a>clone方式性能测试</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：664</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：664</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：664</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：664</span><br></pre></td></tr></table></figure>\n<h3 id=\"new方式\"><a href=\"#new方式\" class=\"headerlink\" title=\"new方式\"></a>new方式</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define(<span class=\"string\">\"NEWLINE\"</span>,chr(<span class=\"number\">10</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IPrototype</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> <span class=\"keyword\">implements</span> <span class=\"title\">IPrototype</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_hobbies = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($name, $hobbies)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hobbies = $hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setName</span><span class=\"params\">($name)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setHobby</span><span class=\"params\">($hobbies)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hobbies = $hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">clone</span> <span class=\"keyword\">$this</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$bigArr = range(<span class=\"number\">1</span>,<span class=\"number\">100000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$m1 = memory_get_usage();</span><br><span class=\"line\"></span><br><span class=\"line\">$Alan = <span class=\"keyword\">new</span> Student(<span class=\"string\">'Alan'</span>, $bigArr);</span><br><span class=\"line\">$Alan2 = <span class=\"keyword\">new</span> Student(<span class=\"string\">'Alan'</span>, $bigArr);</span><br><span class=\"line\"></span><br><span class=\"line\">$m2 = memory_get_usage();</span><br><span class=\"line\">$memory = $m2 - $m1;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'内存占用：'</span> . $memory . NEWLINE;</span><br></pre></td></tr></table></figure>\n<h4 id=\"new方式性能测试\"><a href=\"#new方式性能测试\" class=\"headerlink\" title=\"new方式性能测试\"></a>new方式性能测试</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：712</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：712</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：712</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：712</span><br></pre></td></tr></table></figure>\n<p>可以看出，clone确实比new消耗的内存更小，但是，回到上面，我们真正的业务是copy完这个对象后，要对这个对象做一些修改，比如修改这个clone完后的对象的name，看看会发生什么事情</p>\n<h3 id=\"业务场景下的clone\"><a href=\"#业务场景下的clone\" class=\"headerlink\" title=\"业务场景下的clone\"></a>业务场景下的clone</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define(<span class=\"string\">\"NEWLINE\"</span>,chr(<span class=\"number\">10</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IPrototype</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Student</span> <span class=\"keyword\">implements</span> <span class=\"title\">IPrototype</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_hobbies = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($name, $hobbies)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hobbies = $hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setName</span><span class=\"params\">($name)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setHobby</span><span class=\"params\">($hobbies)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_hobbies = $hobbies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">copy</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">clone</span> <span class=\"keyword\">$this</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$bigArr = range(<span class=\"number\">1</span>,<span class=\"number\">100000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$m1 = memory_get_usage();</span><br><span class=\"line\"></span><br><span class=\"line\">$Alan = <span class=\"keyword\">new</span> Student(<span class=\"string\">'Alan'</span>, $bigArr);</span><br><span class=\"line\">$Bob = $Alan-&gt;copy();</span><br><span class=\"line\">$Bob-&gt;setName(<span class=\"string\">'Bob'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$m2 = memory_get_usage();</span><br><span class=\"line\">$memory = $m2 - $m1;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'内存占用：'</span> . $memory . NEWLINE;</span><br></pre></td></tr></table></figure>\n<h4 id=\"业务场景下的clone性能测试\"><a href=\"#业务场景下的clone性能测试\" class=\"headerlink\" title=\"业务场景下的clone性能测试\"></a>业务场景下的clone性能测试</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：744</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：744</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：744</span><br><span class=\"line\">$ php index.php </span><br><span class=\"line\">内存占用：744</span><br></pre></td></tr></table></figure>\n<p>我们发现，对新对象做完名字重置的操作后，内存占用更大了，比new的操作更大！</p>\n<h3 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h3><ul>\n<li>clone一个对象带来的内存消耗比new一个对象更少</li>\n<li>在某些业务下，比如对新对象做属性修改时，直接new一个对象带来的内存消耗更少</li>\n</ul>\n","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP状态模式之天气热了把空调开开","url":"http://funsoul.org/2018/05/10/PHP状态模式之天气热了开个空调/","content":"<h3 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h3><p>夏天不可辜负的东西有三样：西瓜、海滩和冰淇淋。然而，单靠这三样还不足以度过炎炎夏日啊~</p>\n<h3 id=\"空调开开\"><a href=\"#空调开开\" class=\"headerlink\" title=\"空调开开\"></a>空调开开</h3><p>夏天到了，对于南方的同学来说，回到家第一件事就是找<strong>空调遥控器</strong>，这个遥控器是个好东西，按一下开关就可以让我们清凉一夏~</p>\n<p>那么，我们会想，遥控器是怎么保存开关的状态的呢？为什么我们按一下按钮就开，按一下就关，同一个按钮，两种状态，有点神奇~</p>\n<h3 id=\"状态\"><a href=\"#状态\" class=\"headerlink\" title=\"状态\"></a>状态</h3><p>无论是开，还是关。它们都是一种状态，所以，我们有一个状态接口，这个状态是遥控器控制的，所以它有一个handle方法。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"开关状态\"><a href=\"#开关状态\" class=\"headerlink\" title=\"开关状态\"></a>开关状态</h3><p>开、关状态都实现了状态接口，所以它们都要实现handle方法，这是具体的状态。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 开机状态</span></span><br><span class=\"line\"><span class=\"comment\"> * Class OnState</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OnState</span> <span class=\"keyword\">implements</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'开空调'</span>;</span><br><span class=\"line\">        $controller-&gt;setState(<span class=\"keyword\">new</span> <span class=\"keyword\">self</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 关机状态</span></span><br><span class=\"line\"><span class=\"comment\"> * Class OffState</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OffState</span> <span class=\"keyword\">implements</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'关空调'</span>;</span><br><span class=\"line\">        $controller-&gt;setState(<span class=\"keyword\">new</span> <span class=\"keyword\">self</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"遥控器\"><a href=\"#遥控器\" class=\"headerlink\" title=\"遥控器\"></a>遥控器</h3><p>我们还需要一个遥控器来保存这些状态，当然，这个遥控器有一个按钮给我们点击</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 遥控器</span></span><br><span class=\"line\"><span class=\"comment\"> * Class RemoteController</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RemoteController</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_state = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(IState $state)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state = $state;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setState</span><span class=\"params\">(IState $state)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state = $state;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onClick</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state-&gt;handle(<span class=\"keyword\">$this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define(<span class=\"string\">\"NEWLINE\"</span>,chr(<span class=\"number\">10</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 开机状态</span></span><br><span class=\"line\"><span class=\"comment\"> * Class OnState</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OnState</span> <span class=\"keyword\">implements</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'开空调'</span> . NEWLINE;</span><br><span class=\"line\">        $controller-&gt;setState(<span class=\"keyword\">new</span> <span class=\"keyword\">self</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 关机状态</span></span><br><span class=\"line\"><span class=\"comment\"> * Class OffState</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OffState</span> <span class=\"keyword\">implements</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'关空调'</span> . NEWLINE;</span><br><span class=\"line\">        $controller-&gt;setState(<span class=\"keyword\">new</span> <span class=\"keyword\">self</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 遥控器</span></span><br><span class=\"line\"><span class=\"comment\"> * Class RemoteController</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RemoteController</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_state = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(IState $state)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state = $state;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setState</span><span class=\"params\">(IState $state)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state = $state;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onClick</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state-&gt;handle(<span class=\"keyword\">$this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 默认开空调</span></span><br><span class=\"line\">$controller = <span class=\"keyword\">new</span> RemoteController(<span class=\"keyword\">new</span> OnState());</span><br><span class=\"line\">$controller-&gt;onClick();</span><br><span class=\"line\">$controller-&gt;onClick();</span><br><span class=\"line\">$controller-&gt;onClick();</span><br><span class=\"line\">$controller-&gt;onClick();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 开空调</span></span><br><span class=\"line\"><span class=\"comment\">// 关空调</span></span><br><span class=\"line\"><span class=\"comment\">// 开空调</span></span><br><span class=\"line\"><span class=\"comment\">// 关空调</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"最佳实践\"><a href=\"#最佳实践\" class=\"headerlink\" title=\"最佳实践\"></a>最佳实践</h3><p>上面，我们实现了一个遥控器来控制开关状态，但是细心的你会发现，每次点击按钮，我们都要重新做一个状态（new OnState() 或者 new OffState()）出来，这不太好。无论是开还是关状态，都应该在开机的时候就<strong>存在</strong>的，不需要我们重复去做。所以，我们使用<strong>单例模式</strong>，让开、关状态都只定义一次。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define(<span class=\"string\">\"NEWLINE\"</span>,chr(<span class=\"number\">10</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 开机状态</span></span><br><span class=\"line\"><span class=\"comment\"> * Class OnState</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OnState</span> <span class=\"keyword\">implements</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (is_null(<span class=\"keyword\">self</span>::$_instance)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">self</span>::$_instance = <span class=\"keyword\">new</span> <span class=\"keyword\">self</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$_instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'开空调'</span> . NEWLINE;</span><br><span class=\"line\">        $controller-&gt;setState(OffState::getInstance());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 关机状态</span></span><br><span class=\"line\"><span class=\"comment\"> * Class OffState</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OffState</span> <span class=\"keyword\">implements</span> <span class=\"title\">IState</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (is_null(<span class=\"keyword\">self</span>::$_instance)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">self</span>::$_instance = <span class=\"keyword\">new</span> <span class=\"keyword\">self</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$_instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">handle</span><span class=\"params\">(RemoteController $controller)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'关空调'</span> . NEWLINE;</span><br><span class=\"line\">        $controller-&gt;setState(OnState::getInstance());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 遥控器</span></span><br><span class=\"line\"><span class=\"comment\"> * Class RemoteController</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RemoteController</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_state = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(IState $state)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state = $state;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setState</span><span class=\"params\">(IState $state)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state = $state;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">onClick</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_state-&gt;handle(<span class=\"keyword\">$this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 默认开空调</span></span><br><span class=\"line\">$controller = <span class=\"keyword\">new</span> RemoteController(OnState::getInstance());</span><br><span class=\"line\">$controller-&gt;onClick();</span><br><span class=\"line\">$controller-&gt;onClick();</span><br><span class=\"line\">$controller-&gt;onClick();</span><br><span class=\"line\">$controller-&gt;onClick();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 开空调</span></span><br><span class=\"line\"><span class=\"comment\">// 关空调</span></span><br><span class=\"line\"><span class=\"comment\">// 开空调</span></span><br><span class=\"line\"><span class=\"comment\">// 关空调</span></span><br></pre></td></tr></table></figure>\n<p>done~</p>\n","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP返回对象的公有属性和值","url":"http://funsoul.org/2018/05/03/PHP返回对象的公有属性和值/","content":"<p>获取对象的公有属性和值，很自然的会想到 <strong>get_object_vars</strong> 这个函数，可以这样写，</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $age = <span class=\"number\">18</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $name = <span class=\"string\">'xxx'</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$user = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">$item = get_object_vars($user);</span><br><span class=\"line\">print_r($item);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Array</span></span><br><span class=\"line\"><span class=\"comment\">// (</span></span><br><span class=\"line\"><span class=\"comment\">//     [name] =&gt; xxx</span></span><br><span class=\"line\"><span class=\"comment\">// )</span></span><br></pre></td></tr></table></figure>\n<p>上面的代码是写在对象的外部的，可不可以提供一个 <strong>trait</strong> 使得每个对象都复用一个接口，供外部使用呢？这样一来，看上去更像是对象自己的方法，我们可以通过这个方法来取得对象的公有属性与其值。</p>\n<p>上面我们用 <strong>get_object_vars</strong> 函数在外部实现了这个想法，放到内部试试看，当然我们要结合<strong>trait</strong>来实现：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">trait</span> PrintPublic &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">publics</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> get_object_vars(<span class=\"keyword\">$this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $age = <span class=\"number\">18</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $name = <span class=\"string\">'xxx'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">use</span> <span class=\"title\">PrintPublic</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$user = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">$item = $user-&gt;publics();</span><br><span class=\"line\">print_r($item);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Array</span></span><br><span class=\"line\"><span class=\"comment\">// (</span></span><br><span class=\"line\"><span class=\"comment\">//     [age] =&gt; 18</span></span><br><span class=\"line\"><span class=\"comment\">//     [name] =&gt; xxx</span></span><br><span class=\"line\"><span class=\"comment\">// )</span></span><br></pre></td></tr></table></figure>\n<p>我们发现，把所有的属性都取出来了，无论是公有的还是私有的，这不对。为什么会这样呢？不难想象，因为这个方法是放在类内部的，作用域在内部。而之前这个方法是放在类的外部，作用域是全局的。思路有了，我们只需要想办法让作用域在类的外部就可以了，我们想到了 <strong>call_user_func</strong> 这个方法。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">trait</span> PrintPublic &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">publics</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> call_user_func(<span class=\"string\">'get_object_vars'</span>, <span class=\"keyword\">$this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $age = <span class=\"number\">18</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $name = <span class=\"string\">'xxx'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">use</span> <span class=\"title\">PrintPublic</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$user = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">$item = $user-&gt;publics();</span><br><span class=\"line\">print_r($item);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// version &lt; php 7</span></span><br><span class=\"line\"><span class=\"comment\">// Array</span></span><br><span class=\"line\"><span class=\"comment\">// (</span></span><br><span class=\"line\"><span class=\"comment\">//     [name] =&gt; xxx</span></span><br><span class=\"line\"><span class=\"comment\">// )</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// version &gt; php 7</span></span><br><span class=\"line\"><span class=\"comment\">// Array</span></span><br><span class=\"line\"><span class=\"comment\">// (</span></span><br><span class=\"line\"><span class=\"comment\">//     [name] =&gt; xxx</span></span><br><span class=\"line\"><span class=\"comment\">//     [age] =&gt; 18</span></span><br><span class=\"line\"><span class=\"comment\">// )</span></span><br></pre></td></tr></table></figure>\n<p>我们又发现了一个问题，这个方法在php7不能奏效，具体原因未知，有空探讨一下，既然这样也不是最好的办法，那就再换一个函数 <strong>create_function</strong>，试试看</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">trait</span> PrintPublic &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">publics</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $publicVars = create_function(<span class=\"string\">'$obj'</span>, <span class=\"string\">'return get_object_vars($obj);'</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $publicVars(<span class=\"keyword\">$this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> $name = <span class=\"string\">\"xxx\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_age = <span class=\"number\">30</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">use</span> <span class=\"title\">PrintPublic</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$User = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">$data = $User-&gt;publics();</span><br><span class=\"line\">print_r($data);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Array</span></span><br><span class=\"line\"><span class=\"comment\">// (</span></span><br><span class=\"line\"><span class=\"comment\">//     [name] =&gt; xxx</span></span><br><span class=\"line\"><span class=\"comment\">// )</span></span><br></pre></td></tr></table></figure>\n<p>没问题了，问题解决 :)</p>\n","categories":["技术"],"tags":["PHP"]},{"title":"谈谈服务容器","url":"http://funsoul.org/2018/05/03/谈谈服务容器/","content":"<h3 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h3><p>使用Laravel有段时间了，也做了大大小小好几个系统。得益于其优雅的设计理念、大而全的工具集，开发系统起来非常迅速，代码结构也十分整洁。利用点时间，探讨一下内部实现，看看Laravel到底做了什么。</p>\n<p>我们知道，Laravel的核心就是服务容器，也是本文想着重探讨的。一开始看到这个名词，很晦涩。不要紧，一步一步来，先看看什么是服务？什么又是容器？最后再来结合看服务容器？</p>\n<h3 id=\"服务\"><a href=\"#服务\" class=\"headerlink\" title=\"服务\"></a>服务</h3><p>日常生活中，谈到服务，自然会联想到“银行办卡”、“外卖配送”、“洗车”等等这些都是服务，这里我们看看，<strong>服务的概念是建立在双方的基础上</strong>，我去银行办卡，银行服务于我。我和银行之间构成了关系。</p>\n<p>举个例子，一辆汽车有很多的配件（引擎、轮子、沙发..），这些配件组合成汽车，汽车有各种配件提供服务，配件服务于汽车，汽车与配件构成了关系。</p>\n<p>再来个栗子，我去北京玩，可以坐大巴、坐飞机，还可以坐火车。我选择交通工具，交通工具服务于我，我和交通工具构成了关系。</p>\n<p>你发现了，我在每个例子后面都写了“构成关系”，这个关系到底是什么？这就是依赖。汽车依赖配件，我依赖交通工具。</p>\n<h3 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h3><p>开始写写代码吧，</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">A</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"hello \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">B</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj = <span class=\"keyword\">new</span> A();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"world\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Client</span></span><br><span class=\"line\">$b = <span class=\"keyword\">new</span> B();</span><br><span class=\"line\">$b-&gt;saySomething();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// hello world</span></span><br></pre></td></tr></table></figure>\n<p>在上面的代码中，我们做了这样一件事，输出“hello world”。我们知道A的功能是输出”hello “，那么为了不更改A的代码，我们新增了一个B，然后依赖于A，在构造函数里面把A组合进来，然后在B输出“world”之前，先调用A的方法输出“hello ”。</p>\n<p>是的，我们的代码完成了预期的想法，成功输出“hello world”。现在，我不想输出“hello world”了，而是输出“bye world”。怎么做呢？</p>\n<p>和前面一样，为了不改变A类的功能，我们新增一个C，功能是输出“bye”，如下所示：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">C</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"bye \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>但是，我们碰到了一个困难，如果想要输出“bye world”，必须改掉 B 的依赖 A，让 B 依赖 C，也就是需要改这一行：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">$this</span>-&gt;obj = <span class=\"keyword\">new</span> B();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Todo 改成依赖 C</span></span><br><span class=\"line\"><span class=\"comment\">// $this-&gt;obj = new C();</span></span><br></pre></td></tr></table></figure>\n<p>这时候，我们陷入了沉思，现在改一下，好像也没什么，但是如果改完了，又叫我改回去，或者改成别的什么D、E、F、G怎么办？况且，现在只是依赖一个，如果以后依赖多了，那不是要吐血…比如下面这种情况</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">B</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj1 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj2 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj3 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj1 = <span class=\"keyword\">new</span> X();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj2 = <span class=\"keyword\">new</span> Y();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj3 = <span class=\"keyword\">new</span> Z();</span><br><span class=\"line\">        <span class=\"comment\">// ....</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj1-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj2-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj3-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"world\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Client</span></span><br><span class=\"line\">$b = <span class=\"keyword\">new</span> B();</span><br><span class=\"line\">$b-&gt;saySomething();</span><br></pre></td></tr></table></figure>\n<p>还有一种情况，如果这个类是通过远程方法调用的，根本就改不了。<br>细思极恐啊，每天加班加点就为了改这个，和咸鱼有什么区别!</p>\n<h3 id=\"简单工厂模式，依赖转移\"><a href=\"#简单工厂模式，依赖转移\" class=\"headerlink\" title=\"简单工厂模式，依赖转移\"></a>简单工厂模式，依赖转移</h3><p>为了不改这个 B，我们想到了一个办法，这些依赖能不能放在一个统一的地方，我需要的时候就去这个地方拿，改也是改这里，根本不用动原来的代码，看看怎么写</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SayFactory</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj1 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj2 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj3 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj1 = <span class=\"keyword\">new</span> X();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj2 = <span class=\"keyword\">new</span> Y();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj3 = <span class=\"keyword\">new</span> Z();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj1-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj2-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj3-&gt;saySomething();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">B</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj = <span class=\"keyword\">new</span> SayFactory();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"world\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Client</span></span><br><span class=\"line\">$b = <span class=\"keyword\">new</span> B();</span><br><span class=\"line\">$b-&gt;saySomething();</span><br></pre></td></tr></table></figure>\n<p>这下，终于不用改 B 了，我们创建了一个简单工厂，让这个工厂依赖于 B，把依赖转移到了 sayFactory 工厂上。以后，管你什么需求，我只需要改这个工厂类就行了！</p>\n<p>等等，问题解决了吗？虽然我们不用改 B 了，但是，还是要改这个 sayFactory。一个功能业务改动或许很轻，但是，如果所有的功能业务都这样写，还不是和咸鱼无差？</p>\n<p>上面我们说，现实生活中，到底是不是这样的，举个例子，有时候，我们身上只有工行的卡，但是附近只有农行的ATM机，这时候会发生什么？农行ATM机可以识别工行的卡！</p>\n<p>回来继续看，如果按照刚刚的思路，建立一个简单工厂来组合依赖项，那么工行的卡接入农行的ATM机，农行ATM应该要改一下代码才可以接入啊，为什么ATM可以识别呢？</p>\n<h3 id=\"依赖注入\"><a href=\"#依赖注入\" class=\"headerlink\" title=\"依赖注入\"></a>依赖注入</h3><p><strong>面向接口，而不是面向实现编程</strong></p>\n<p>这段话，是用来镇楼的，看不懂没关系，当你读完本文再回过头看自然会有所体会 :)</p>\n<p>前面说这么多，总结一下就是</p>\n<p><strong>依赖不好维护，客户端动代码(改需求)，内部实现也要改</strong></p>\n<p>（<strong>注意这个排比句</strong>）</p>\n<p>能不能</p>\n<ul>\n<li>让客户端掌握控制权</li>\n<li>让客户端来决定加载的依赖</li>\n<li>让客户端和服务遵守相同的协议</li>\n</ul>\n<p>一句一句来看，什么叫<strong>让客户端掌握控制权</strong>。原来啊，我们的控制权一直掌握在<strong>服务</strong>的手上，服务自己来<strong>控制</strong>依赖的<strong>目标</strong>，这些都是隐藏在服务背后的，看之前的例子，<strong>B</strong> 一直掌控着依赖的目标（A、X、Y、Z..），客户端改需求了，服务内部就要更改，这无疑是痛苦的。于是我们把<strong>控制权反转（IoC）</strong>，让客户端来掌握控制权。</p>\n<p><strong>让客户端来决定加载的依赖</strong>，既然控制权反转到了客户端，客户端就可以自由的搭配依赖项，想加载什么依赖就加载什么，比如这样</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Z</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\" hello \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">B</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(Z $obg)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj = $obg;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"world\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$b = <span class=\"keyword\">new</span> B(<span class=\"keyword\">new</span> Z());</span><br><span class=\"line\">$b-&gt;saySomething();</span><br></pre></td></tr></table></figure>\n<p>这样的想法很好，客户端决定加载依赖。可是，这样的代码还是存在问题，如果我想加载别的依赖（比如Y、Z…），那岂不是还是需要更改 B 的构造函数中的类名？</p>\n<p>又想到工行卡可以适配农行ATM那个例子，现在我们明白了，因为这张卡遵守了银联的协议，这个协议就是我们说的<strong>让客户端和服务遵守相同的协议</strong>，因为这张卡实现的接口和ATM提供的接口是一致的，所以它们可以适配。</p>\n<p>完整代码如下：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ISay</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">X</span> <span class=\"keyword\">implements</span> <span class=\"title\">ISay</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\" hello \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Y</span> <span class=\"keyword\">implements</span> <span class=\"title\">ISay</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\" hello \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Z</span> <span class=\"keyword\">implements</span> <span class=\"title\">ISay</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\" hello \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">B</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(ISay $obj)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj = $obj;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"world\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Client</span></span><br><span class=\"line\">$b = <span class=\"keyword\">new</span> B(<span class=\"keyword\">new</span> X());</span><br><span class=\"line\">$b-&gt;saySomething();</span><br><span class=\"line\"></span><br><span class=\"line\">$b = <span class=\"keyword\">new</span> B(<span class=\"keyword\">new</span> Y());</span><br><span class=\"line\">$b-&gt;saySomething();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// X hello world</span></span><br><span class=\"line\"><span class=\"comment\">// Y hello world</span></span><br></pre></td></tr></table></figure>\n<p>我们终于解决了这个问题，通过接口，我们把依赖注入到服务中，实现控制反转。</p>\n<blockquote>\n<p>依赖倒置原则(DIP)是软件设计的一种思想，控制反转（IoC）则是基于DIP衍生出的一种软件设计模式。依赖注入(DI)是IoC的具体实现方式之一，使用最为广泛。IoC容器是DI构造依赖注入的框架，它管理着依赖项的生命周期以及映射关系。</p>\n</blockquote>\n<h3 id=\"服务容器\"><a href=\"#服务容器\" class=\"headerlink\" title=\"服务容器\"></a>服务容器</h3><p>前面我们把服务讲清楚了，接下来讲讲容器。容器在日常生活中也不难理解，泳池、杯子、地球、乃至人都可以说是容器，就是可以装东西的东西。在程序中，变量、对象、数组、队列、栈、堆都是容器。</p>\n<h4 id=\"使用魔术方法构建服务容器\"><a href=\"#使用魔术方法构建服务容器\" class=\"headerlink\" title=\"使用魔术方法构建服务容器\"></a>使用魔术方法构建服务容器</h4><p>先看看代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ISay</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">X</span> <span class=\"keyword\">implements</span> <span class=\"title\">ISay</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\" hello \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Y</span> <span class=\"keyword\">implements</span> <span class=\"title\">ISay</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\" hello \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Z</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\" hello \"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">B</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $obj = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(ISay $obj)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj = $obj;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">saySomething</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;obj-&gt;saySomething();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"world\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Container</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $register = <span class=\"keyword\">array</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__set</span><span class=\"params\">($k, $c)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;register[$k] = $c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__get</span><span class=\"params\">($k)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;register[$k](<span class=\"keyword\">$this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 服务容器</span></span><br><span class=\"line\">$c = <span class=\"keyword\">new</span> Container();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 注册 X 服务到容器</span></span><br><span class=\"line\">$c-&gt;x = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> X();</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 注册 B 服务到容器</span></span><br><span class=\"line\">$c-&gt;b = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">($c)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// B 服务依赖 X</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> B($c-&gt;x);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 从容器中取得 B</span></span><br><span class=\"line\">$b = $c-&gt;b;</span><br><span class=\"line\">$b-&gt;saySomething();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// X hello world</span></span><br></pre></td></tr></table></figure>\n<p>这段代码前面没有什么不同，把一个个服务声明清楚。后面我们声明了一个<strong>容器(Containter)</strong>，这个容器使用属性来保存服务，所以它是一个服务容器。我们使用了魔术方法，在给不可访问属性赋值时，<strong>set() 会被调用。读取不可访问属性的值时，</strong>get() 会被调用。</p>\n<p>接下来，我们把所需的服务注册到容器中，属性名是服务名，属性值是一个闭包，这个闭包做真正的服务实例化工作。</p>\n<h4 id=\"使用反射构建服务容器\"><a href=\"#使用反射构建服务容器\" class=\"headerlink\" title=\"使用反射构建服务容器\"></a>使用反射构建服务容器</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Container</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $register = <span class=\"keyword\">array</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__set</span><span class=\"params\">($k, $c)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;register[$k] = $c;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__get</span><span class=\"params\">($k)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;build(<span class=\"keyword\">$this</span>-&gt;register[$k]);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 自动绑定（Autowiring）自动解析（Automatic Resolution）</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> string $className</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> object</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">build</span><span class=\"params\">($className)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果是匿名函数（Anonymous functions），也叫闭包函数（closures）</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($className <span class=\"keyword\">instanceof</span> Closure) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 执行闭包函数，并将结果返回</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> $className(<span class=\"keyword\">$this</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 取得类的反射</span></span><br><span class=\"line\">        $reflector = <span class=\"keyword\">new</span> ReflectionClass($className);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 检查类是否可实例化, 排除抽象类abstract和对象接口interface</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (! $reflector-&gt;isInstantiable()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>(<span class=\"string\">\"Can't instantiate this.\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取类的构造函数</span></span><br><span class=\"line\">        $constructor = $reflector-&gt;getConstructor();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 若无构造函数，直接实例化并返回</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (is_null($constructor)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> $className;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 取构造函数参数,通过 ReflectionParameter 数组返回参数列表</span></span><br><span class=\"line\">        $parameters = $constructor-&gt;getParameters();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 递归解析构造函数的参数</span></span><br><span class=\"line\">        $dependencies = <span class=\"keyword\">$this</span>-&gt;getDependencies($parameters);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 创建一个类的新实例，给出的参数将传递到类的构造函数。</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> $reflector-&gt;newInstanceArgs($dependencies);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> array $parameters</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> array</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDependencies</span><span class=\"params\">($parameters)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $dependencies = [];</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 反射类的构造函数参数</span></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($parameters <span class=\"keyword\">as</span> $parameter) &#123;</span><br><span class=\"line\">            <span class=\"comment\">/** <span class=\"doctag\">@var</span> ReflectionClass $dependency */</span></span><br><span class=\"line\">            $dependency = $parameter-&gt;getClass();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (is_null($dependency)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 是变量,有默认值则设置默认值</span></span><br><span class=\"line\">                $dependencies[] = <span class=\"keyword\">$this</span>-&gt;resolveNonClass($parameter);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 是一个类，递归解析</span></span><br><span class=\"line\">                $dependencies[] = <span class=\"keyword\">$this</span>-&gt;build($dependency-&gt;name);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> $dependencies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> ReflectionParameter $parameter</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> mixed</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">resolveNonClass</span><span class=\"params\">($parameter)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 有默认值则返回默认值</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($parameter-&gt;isDefaultValueAvailable()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> $parameter-&gt;getDefaultValue();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>(<span class=\"string\">'I have no idea what to do here.'</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$c = <span class=\"keyword\">new</span> Container();</span><br><span class=\"line\"></span><br><span class=\"line\">$c-&gt;x = <span class=\"string\">'X'</span>;</span><br><span class=\"line\">$c-&gt;b = <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"params\">($c)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> B($c-&gt;x);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 从容器中取得 B</span></span><br><span class=\"line\">$foo = $c-&gt;b;</span><br><span class=\"line\">$foo-&gt;saySomething();</span><br></pre></td></tr></table></figure>\n<h4 id=\"为什么我们需要服务容器呢？\"><a href=\"#为什么我们需要服务容器呢？\" class=\"headerlink\" title=\"为什么我们需要服务容器呢？\"></a>为什么我们需要服务容器呢？</h4><p>在使用服务容器之前，我们在客户端需要对服务进行实例化并加载相应的依赖，对于客户端来说，做的事情太多了，既要实例化服务，又要处理依赖关系，这是耦合的。所以，我们把服务注册到服务容器中，让服务容器替我们做这些事情，我们不必要关心细节，容器负责实例化，注入依赖，处理依赖关系等工作，客户端只需要使用就好了。</p>\n<h3 id=\"Laravel服务容器\"><a href=\"#Laravel服务容器\" class=\"headerlink\" title=\"Laravel服务容器\"></a>Laravel服务容器</h3><p>Laravel的核心就是服务容器，它的功能更多，我们前面写的<strong>使用反射来实现服务容器</strong>，可以说是Laravel服务容器的缩小版，实际上，我们只做了服务实现（build），服务解析的过程还有一个服务查找（make）我们没有做，我们的做法比较搓，直接就是服务容器的一个属性 $c-&gt;b 。</p>\n<p>Laravel的服务容器源码在 <strong>Illuminate\\Container</strong> 下，可以看到，它还实现了 ArrayAccess 接口，可以通过 $c[‘b’] 这种形式来访问服务。它还支持绑定一个 singeton (单例) ，虽然PHP是一次请求的生命周期，但是也会出现一次请求多次实例化单个对象的时候，这个时候，单例模式就很好，服务容器还能提供一个单例对象，避免多次解析。你也可以使用 instance 方法绑定一个已经存在的对象至容器中。后面的调用都会从容器中返回指定的实例。既然是容器，除了绑定类，对象，接口，当然还可以绑定数据，通过情景绑定注入需要的任何值。还可以注册容器事件，做一些监听的工作，比作监听某个类对象的解析，这时候，可以动态的设置额外属性到对象中，非常强大！</p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><ul>\n<li>认识服务（组件或者依赖）的概念</li>\n<li>依赖注入，面向接口编程</li>\n<li>认识服务容器的作用与实现简单的服务容器</li>\n<li>学习Laravel服务容器的强大之处</li>\n</ul>\n","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"Duck Typing in PHP","url":"http://funsoul.org/2018/04/23/Duck-Typing-in-PHP/","content":"<p>先看看wiki是怎么描述Duck Typing的：<br>Duck Typing in PHP</p>\n<blockquote>\n<p>在程序设计中，鸭子类型（duck typing）是动态类型的一种风格。在这种风格中，一个对象有效的语义，不是由继承自特定的类或实现特定的接口，而是由”当前方法和属性的集合”决定。这个概念的名字来源于由James Whitcomb Riley提出的鸭子测试（见下面的“历史”章节），“鸭子测试”可以这样表述：</p>\n</blockquote>\n<blockquote>\n<p>“当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子。”<br>在鸭子类型中，关注点在于对象的行为，能作什么；而不是关注对象所属的类型。例如，在不使用鸭子类型的语言中，我们可以编写一个函数，它接受一个类型为”鸭子”的对象，并调用它的”走”和”叫”方法。在使用鸭子类型的语言中，这样的一个函数可以接受一个任意类型的对象，并调用它的”走”和”叫”方法。如果这些需要被调用的方法不存在，那么将引发一个运行时错误。任何拥有这样的正确的”走”和”叫”方法的对象都可被函数接受的这种行为引出了以上表述，这种决定类型的方式因此得名。</p>\n</blockquote>\n<h2 id=\"鸭子是什么？\"><a href=\"#鸭子是什么？\" class=\"headerlink\" title=\"鸭子是什么？\"></a>鸭子是什么？</h2><p>鸭子：脊索动物门，脊椎动物亚门，鸟纲雁形目，鸭科鸭属动物…</p>\n<p>这是从百度百科中查询到的，可见，鸭子有自己专门的定义，因此，如果我们想“正统”地描述一个鸭子，或许应该这样写：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">trait</span> 脊索动物门 &#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">trait</span> 脊椎动物亚门 &#123;&#125;</span><br><span class=\"line\"><span class=\"keyword\">trait</span> 鸟纲雁形目 &#123;&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> 鸭科鸭属动物 </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> 鸭子 <span class=\"keyword\">extends</span> 鸭科鸭属动物 </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">use</span> 脊索动物门,脊椎动物亚门,鸟纲雁形目;</span><br><span class=\"line\">\t...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们知道PHP是不支持多继承的，但是我们可以通过5.4起出现的新语法trait来复用代码。这样的代码不容易编写，更多时候，我们希望使用组合的方式来复用代码。</p>\n<h2 id=\"怎么才算一只鸭子？\"><a href=\"#怎么才算一只鸭子？\" class=\"headerlink\" title=\"怎么才算一只鸭子？\"></a>怎么才算一只鸭子？</h2><p>前面我们以正统的方式来追寻鸭子的定义，其实，<strong>鸭子在不同的人眼里有不同的呈现。</strong></p>\n<p>前段时间，广东出现了一只“大黄鸭”飘在水中，引起不少人去一睹真面目，这里就不放图了，大家可以借助搜索引擎查看相关资料。</p>\n<p>那么，对于我们来说，这只“大黄鸭”算是鸭子吗？前面说了，<strong>鸭子在不同的人眼里有不同的呈现。</strong>小孩子觉得，这就是鸭子，因为它拥有鸭子的形态，而且它可以飘在水中。有些吃货觉得，这不是鸭子，因为它煮熟了不能吃，没有鸭子的味道。</p>\n<h2 id=\"动态语言的鸭子\"><a href=\"#动态语言的鸭子\" class=\"headerlink\" title=\"动态语言的鸭子\"></a>动态语言的鸭子</h2><p>PHP是动态语言，它不像C、C++、Java那样在编译期间就可以知道变量的类型，在代码编写阶段，这样的特性可以为我们很快的排查出错误，在运行时也就可以避免出现类型相关的错误。PHP是解释型的，在运行时才能知道变量类型。</p>\n<p>通过下面一个简单的例子，学习Duck typing在PHP中是怎么编写的。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'NEWLINE'</span>,chr(<span class=\"number\">10</span>)); <span class=\"comment\">// &lt;br /&gt; on web</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Duck</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">quack</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> get_class(<span class=\"keyword\">$this</span>).<span class=\"string\">\" 呱呱\"</span>.NEWLINE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">feathers</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> get_class(<span class=\"keyword\">$this</span>).<span class=\"string\">\" 白色与灰色羽毛\"</span>.NEWLINE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Person</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">quack</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> get_class(<span class=\"keyword\">$this</span>).<span class=\"string\">\" 人模仿鸭子呱呱\"</span>.NEWLINE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">feathers</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> get_class(<span class=\"keyword\">$this</span>).<span class=\"string\">\" 拿起一根羽毛\"</span>.NEWLINE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">inTheForest</span><span class=\"params\">($duck)</span></span>&#123;</span><br><span class=\"line\">        $duck-&gt;quack();</span><br><span class=\"line\">        $duck-&gt;feathers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        $duck = <span class=\"keyword\">new</span> Duck();</span><br><span class=\"line\">        $person = <span class=\"keyword\">new</span> Person();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">static</span>::inTheForest($duck);</span><br><span class=\"line\">        <span class=\"keyword\">static</span>::inTheForest($person);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Duck 呱呱</span></span><br><span class=\"line\"><span class=\"comment\">// Duck 白色与灰色羽毛</span></span><br><span class=\"line\"><span class=\"comment\">// Person 人模仿鸭子呱呱</span></span><br><span class=\"line\"><span class=\"comment\">// Person 拿起一根羽毛</span></span><br></pre></td></tr></table></figure>\n<p>我们前面讲了这么多概念，一看代码，其实不就是一种<strong>编码风格</strong>吗？是的，如果我们使用接口来实现duck和person，使用的时候（inTheForest）通过接口来约束，不就没这些事情了。比如这样写：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">define(<span class=\"string\">'NEWLINE'</span>,chr(<span class=\"number\">10</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IType</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">quack</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">feathers</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Duck</span> <span class=\"keyword\">implements</span> <span class=\"title\">IType</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">quack</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> get_class(<span class=\"keyword\">$this</span>).<span class=\"string\">\" 呱呱\"</span>.NEWLINE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">feathers</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> get_class(<span class=\"keyword\">$this</span>).<span class=\"string\">\" 白色与灰色羽毛\"</span>.NEWLINE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Person</span> <span class=\"keyword\">implements</span> <span class=\"title\">IType</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">quack</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> get_class(<span class=\"keyword\">$this</span>).<span class=\"string\">\" 人模仿鸭子呱呱\"</span>.NEWLINE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">feathers</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> get_class(<span class=\"keyword\">$this</span>).<span class=\"string\">\" 拿起一根羽毛\"</span>.NEWLINE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">inTheForest</span><span class=\"params\">(IType $obj)</span></span>&#123;</span><br><span class=\"line\">        $obj-&gt;quack();</span><br><span class=\"line\">        $obj-&gt;feathers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">static</span>::inTheForest(<span class=\"keyword\">new</span> Duck());</span><br><span class=\"line\">        <span class=\"keyword\">static</span>::inTheForest(<span class=\"keyword\">new</span> Person());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br></pre></td></tr></table></figure>\n<p>这样的风格是可选的，需要<strong>依赖文档、清晰的代码和测试</strong>来确保正确使用。</p>\n<p>回到前面实现Duck Typing的代码，前面说了，小孩子觉得“大黄鸭”是鸭子，因为它可以飘在水中，并且拥有鸭子的形态，所以它就等同于鸭子。例子中，我们的实现者是inTheForest，它拥有quack和feathers方法，那么，只要调用者也拥有这两个方法，那么它等同于这个“类”。这就是所谓的Duck Typing。代码编写阶段，我们并不知道它是否拥有这两个方法，所以需要借助文档和测试，才能确保运行时无误。</p>\n<p>以上。 :)</p>\n","categories":["技术"],"tags":["PHP"]},{"title":"ngx_http_empty_gif_module在日志统计中的应用","url":"http://funsoul.org/2018/04/16/ngx_http_empty_gif_module在日志统计中的应用/","content":"<h2 id=\"日志统计分析架构\"><a href=\"#日志统计分析架构\" class=\"headerlink\" title=\"日志统计分析架构\"></a>日志统计分析架构</h2><p>在日志统计分析中，通常包括以下的模块</p>\n<ul>\n<li>前端日志上报（js上报url、user_agent等等）</li>\n<li>打点服务器（nginx）</li>\n<li>统计日志（access_log）</li>\n<li>分析日志（后端程序）</li>\n<li>保存分析结果（db）</li>\n</ul>\n<p>我们通常把日志上报和日志分析解耦，利用nginx的大并发承载力，接收前端上报的日志。在这里，我们不做协议转发到后端程序（PHP或者其他cgi程序）处理日志统计，而是利用nginx的access_log，约定好日志保存格式（format），由nginx帮助我们做日志统计。</p>\n<p>日志上报的并发量有可能非常巨大，举个例子，如果由PHP来处理，那么每一次日志上报都需要经过nginx的转发、PHP生命周期的五个阶段（MINIT、RINIT、代码处理、RSHUTDOWN、MSHUTDOWN），即使做了opcache，将预编译的脚本存储在共享内存中，也是需要不菲的消耗。1毫秒的处理时间不算什么，但是 1 X 100000n 那就需要引起关注了。</p>\n<p>我们还需要一个分析日志的守护进程，这时候可以利用php的cli或者别的语言实现，将分析结果（pv、uv等等）保存到数据库，然后提供一个web界面来展示结果。</p>\n<h2 id=\"ngx-http-empty-gif-module\"><a href=\"#ngx-http-empty-gif-module\" class=\"headerlink\" title=\"ngx_http_empty_gif_module\"></a>ngx_http_empty_gif_module</h2><p>http程序是请求-响应模式，日志上报完成后，后端需要返回一个值，告诉前端结果。一般来说，我们会使用json，上报一个日志，返回一个json串，比如</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tcode: 0,</span><br><span class=\"line\">\tmsg: 'sucess'</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>正如前文所说，这是有可能是一个大并发的程序，如果每次都返回一个json串，是不是有点太大了，为什么这里会说“大”，接着看，我尝试返回一个整型数字1,</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n<p>在浏览器中查看返回数据的大小为 268B ，一个数字的占用就有268B，如果包含状态码，状态值，岂不是更大。</p>\n<p>所以我们看看nginx有没有更好的解决方式，那就是ngx_http_empty_gif_module。</p>\n<p>这是一个由nginx生成的 1x1 像素的图片，通过查看源码可以知道，这是nginx自己拼接而成的完全内存级别的图片</p>\n<p>/path-to-nginx/src/http/modules/ngx_http_empty_gif_module.c</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> u_char  ngx_empty_gif[] = &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">'G'</span>, <span class=\"string\">'I'</span>, <span class=\"string\">'F'</span>, <span class=\"string\">'8'</span>, <span class=\"string\">'9'</span>, <span class=\"string\">'a'</span>,  <span class=\"comment\">/* header                                 */</span></span><br><span class=\"line\"></span><br><span class=\"line\">                                   <span class=\"comment\">/* logical screen descriptor              */</span></span><br><span class=\"line\">    <span class=\"number\">0x01</span>, <span class=\"number\">0x00</span>,                    <span class=\"comment\">/* logical screen width                   */</span></span><br><span class=\"line\">    <span class=\"number\">0x01</span>, <span class=\"number\">0x00</span>,                    <span class=\"comment\">/* logical screen height                  */</span></span><br><span class=\"line\">    <span class=\"number\">0x80</span>,                          <span class=\"comment\">/* global 1-bit color table               */</span></span><br><span class=\"line\">    <span class=\"number\">0x01</span>,                          <span class=\"comment\">/* background color #1                    */</span></span><br><span class=\"line\">    <span class=\"number\">0x00</span>,                          <span class=\"comment\">/* no aspect ratio                        */</span></span><br><span class=\"line\"></span><br><span class=\"line\">                                   <span class=\"comment\">/* global color table                     */</span></span><br><span class=\"line\">    <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>,              <span class=\"comment\">/* #0: black                              */</span></span><br><span class=\"line\">    <span class=\"number\">0xff</span>, <span class=\"number\">0xff</span>, <span class=\"number\">0xff</span>,              <span class=\"comment\">/* #1: white                              */</span></span><br><span class=\"line\"></span><br><span class=\"line\">                                   <span class=\"comment\">/* graphic control extension              */</span></span><br><span class=\"line\">    <span class=\"number\">0x21</span>,                          <span class=\"comment\">/* extension introducer                   */</span></span><br><span class=\"line\">    <span class=\"number\">0xf9</span>,                          <span class=\"comment\">/* graphic control label                  */</span></span><br><span class=\"line\">    <span class=\"number\">0x04</span>,                          <span class=\"comment\">/* block size                             */</span></span><br><span class=\"line\">    <span class=\"number\">0x01</span>,                          <span class=\"comment\">/* transparent color is given,            */</span></span><br><span class=\"line\">                                   <span class=\"comment\">/*     no disposal specified,             */</span></span><br><span class=\"line\">                                   <span class=\"comment\">/*     user input is not expected         */</span></span><br><span class=\"line\">    <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>,                    <span class=\"comment\">/* delay time                             */</span></span><br><span class=\"line\">    <span class=\"number\">0x01</span>,                          <span class=\"comment\">/* transparent color #1                   */</span></span><br><span class=\"line\">    <span class=\"number\">0x00</span>,                          <span class=\"comment\">/* block terminator                       */</span></span><br><span class=\"line\"></span><br><span class=\"line\">                                   <span class=\"comment\">/* image descriptor                       */</span></span><br><span class=\"line\">    <span class=\"number\">0x2c</span>,                          <span class=\"comment\">/* image separator                        */</span></span><br><span class=\"line\">    <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>,                    <span class=\"comment\">/* image left position                    */</span></span><br><span class=\"line\">    <span class=\"number\">0x00</span>, <span class=\"number\">0x00</span>,                    <span class=\"comment\">/* image top position                     */</span></span><br><span class=\"line\">    <span class=\"number\">0x01</span>, <span class=\"number\">0x00</span>,                    <span class=\"comment\">/* image width                            */</span></span><br><span class=\"line\">    <span class=\"number\">0x01</span>, <span class=\"number\">0x00</span>,                    <span class=\"comment\">/* image height                           */</span></span><br><span class=\"line\">    <span class=\"number\">0x00</span>,                          <span class=\"comment\">/* no local color table, no interlaced    */</span></span><br><span class=\"line\"></span><br><span class=\"line\">                                   <span class=\"comment\">/* table based image data                 */</span></span><br><span class=\"line\">    <span class=\"number\">0x02</span>,                          <span class=\"comment\">/* LZW minimum code size,                 */</span></span><br><span class=\"line\">                                   <span class=\"comment\">/*     must be at least 2-bit             */</span></span><br><span class=\"line\">    <span class=\"number\">0x02</span>,                          <span class=\"comment\">/* block size                             */</span></span><br><span class=\"line\">    <span class=\"number\">0x4c</span>, <span class=\"number\">0x01</span>,                    <span class=\"comment\">/* compressed bytes 01_001_100, 0000000_1 */</span></span><br><span class=\"line\">                                   <span class=\"comment\">/* 100: clear code                        */</span></span><br><span class=\"line\">                                   <span class=\"comment\">/* 001: 1                                 */</span></span><br><span class=\"line\">                                   <span class=\"comment\">/* 101: end of information code           */</span></span><br><span class=\"line\">    <span class=\"number\">0x00</span>,                          <span class=\"comment\">/* block terminator                       */</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"number\">0x3B</span>                           <span class=\"comment\">/* trailer                                */</span></span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<p>继续刚刚的问题，前端上报日志后，后端怎么返回这个图片呢？返回这个图片有什么好处？</p>\n<p>只需要在nginx中配置</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        server_name log.com;</span><br><span class=\"line\"></span><br><span class=\"line\">        location = /<span class=\"keyword\">dig</span> &#123;</span><br><span class=\"line\">           empty_gif;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这样一来，前端只需要把url、ua等信息提交到 log.com/dig 即可，后端就会返回一个1pixel的图片。</p>\n<p>通过查看浏览器信息可以发现，返回大小为 229B，是不是比返回json更快，占用更小呢 :)</p>\n","categories":["技术"],"tags":["Nginx"]},{"title":"今天玩了一款让我写代码的游戏","url":"http://funsoul.org/2018/04/13/今天玩了一款让我写代码的游戏/","content":"<h2 id=\"编程？游戏？\"><a href=\"#编程？游戏？\" class=\"headerlink\" title=\"编程？游戏？\"></a>编程？游戏？</h2><p>今天看到一个有趣的网站，这是个通过游戏的形式学习python的网站，玩到了第二关<a href=\"http://www.pythonchallenge.com/pc/def/map.html\" target=\"_blank\" rel=\"noopener\">pythonchallenge</a>，很有意思，虽然作者的本意是让玩家学习python，但是我决定用PHP…</p>\n<p>游戏中给出了一张图，图里面是这样的提示：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">E -&gt; G</span><br><span class=\"line\">K -&gt; M</span><br><span class=\"line\">O -&gt; Q</span><br></pre></td></tr></table></figure>\n<p>然后给出了一段”乱码”:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">g fmnc wms bgblr rpylqjyrc gr zw fylb. rfyrq ufyr amknsrcpq ypc dmp. bmgle gr gl zw fylb gq glcddgagclr ylb rfyr&apos;q ufw rfgq rcvr gq qm jmle. sqgle qrpgle.kyicrpylq() gq pcamkkclbcb. lmu ynnjw ml rfc spj.</span><br></pre></td></tr></table></figure>\n<p>显然，只要把“乱码”中每个字母往后移动两位即可…</p>\n<h2 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$str = <span class=\"string\">\"g fmnc wms bgblr rpylqjyrc gr zw fylb. rfyrq ufyr amknsrcpq ypc dmp. bmgle gr gl zw fylb gq glcddgagclr ylb rfyr'q ufw rfgq rcvr gq qm jmle. sqgle qrpgle.kyicrpylq() gq pcamkkclbcb. lmu ynnjw ml rfc spj.\"</span>;</span><br><span class=\"line\">$arr = str_split($str);</span><br><span class=\"line\">$res = [];</span><br><span class=\"line\">$filter = [<span class=\"string\">' '</span>,<span class=\"string\">'.'</span>,<span class=\"string\">'\\''</span>,<span class=\"string\">'('</span>,<span class=\"string\">')'</span>];</span><br><span class=\"line\"><span class=\"keyword\">foreach</span> ($arr <span class=\"keyword\">as</span> $item)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(in_array($item,$filter)) &#123;</span><br><span class=\"line\">        $res[] = $item;</span><br><span class=\"line\">        <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $tmp = ord($item);</span><br><span class=\"line\">    $res[] = $item == <span class=\"string\">'z'</span> ? <span class=\"string\">'b'</span> : ($item == <span class=\"string\">'y'</span> ? <span class=\"string\">'a'</span> : chr($tmp + <span class=\"number\">2</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$str = implode($res,<span class=\"string\">''</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $str;</span><br></pre></td></tr></table></figure>\n<h2 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h2><p>i hope you didnt translate it by hand. thats what computers are for. doing it in by hand is inefficient and that’s why this text is so long. using string.maketrans() is recommended. now apply on the url.</p>\n","categories":["技术"],"tags":["PHP","有趣"]},{"title":"PHP建造者模式之给志玲接生","url":"http://funsoul.org/2018/04/09/PHP建造者模式之给志玲接生/","content":"<h2 id=\"女主角范志玲\"><a href=\"#女主角范志玲\" class=\"headerlink\" title=\"女主角范志玲\"></a>女主角范志玲</h2><p>志玲是一只银渐层，她那几天待产（问题一：猫的平均生产时间是多少天呢？）<br><img src=\"/images/zhiling2-283x300.jpg\" alt></p>\n<h2 id=\"故事\"><a href=\"#故事\" class=\"headerlink\" title=\"故事\"></a>故事</h2><p>那天说来话长…</p>\n<h3 id=\"11-30\"><a href=\"#11-30\" class=\"headerlink\" title=\"11:30\"></a>11:30</h3><p>我刚想出门去买菜，志玲便横在门口，仰着大肚皮看着我（问题二：生产期如何安抚母猫？），好像在呢喃着什么~看着她老是仰着个大肚皮睡觉，也不知道肚子里到底有几只小猫，想必志玲也是相当难受吧…我也没注意，以为她只是肚子不太舒服…</p>\n<h3 id=\"20-00\"><a href=\"#20-00\" class=\"headerlink\" title=\"20:00\"></a>20:00</h3><p>志玲冲着我们大叫几声，声音中如泣如诉，似乎想告诉我们什么，作为21世纪的上进小青年，吃完饭当然要义不容辞地抢着洗碗啊，所以也没怎么在意…</p>\n<h3 id=\"21-30\"><a href=\"#21-30\" class=\"headerlink\" title=\"21:30\"></a>21:30</h3><p>Qi不太放心过去看了看纸皮箱（问题三：母猫生产环境如何准备？），起初没觉得什么，志玲很安静的躺在纸皮箱里，忽然发现，志玲躺着的毛巾上有一滩淡红色的“污渍”，我过去看了看，这滩淡红色“污渍”正在志玲的肚皮下方、纸皮箱的外出口前。由于纸皮箱放在阳台门靠里边的角落，通风凉爽而且那天也比较干燥，给志玲喝水的碗和纸皮箱有一定的距离，不可能产生这么大面积的“污渍”。Qi说，这张毛巾之前是干净的（没有染色），那么说明，这滩“污渍”是刚刚半小时到1小时左右志玲自己产生的！</p>\n<h3 id=\"22-00\"><a href=\"#22-00\" class=\"headerlink\" title=\"22:00\"></a>22:00</h3><p>这滩“污渍”就是羊水，羊水破了！我们翻开志玲，看到志玲胯下有个羊水球露出来一点点，周边的毛都是淡红色的，这里有个疑问，为什么第一个羊水破了，却不见小猫出来，难道被志玲压着？后来我们发现小猫在纸皮箱里面，我穿上手套（一定要用手套），把小猫弄出来，像只“小老鼠”似的，闭着眼睛。我们怕它死了（问题四：如何处理刚出生的小猫？），弄来一盆温水（40℃左右），把小猫放进去，轻轻搓着它的身体。这时候，志玲也过来了，它似乎看到了我们的努力，也在尽力生第二个小孩。可是，我们觉得这样不是办法，毕竟我们也是外行人，从来没有碰过这种事。后来，我们把它和小猫送到了宠物医院…</p>\n<h3 id=\"喜讯\"><a href=\"#喜讯\" class=\"headerlink\" title=\"喜讯\"></a>喜讯</h3><p>第二天，我们得知，志玲一共生了三只小猫，母子平安，后来分别被取名叫“佩奇”、“佐治”和“八千”</p>\n<p><img src=\"/images/zhiling1-225x300.jpg\" alt></p>\n<h3 id=\"问答环节\"><a href=\"#问答环节\" class=\"headerlink\" title=\"问答环节\"></a>问答环节</h3><h4 id=\"问题一：猫的平均生产时间是多少天呢？\"><a href=\"#问题一：猫的平均生产时间是多少天呢？\" class=\"headerlink\" title=\"问题一：猫的平均生产时间是多少天呢？\"></a>问题一：猫的平均生产时间是多少天呢？</h4><p>63天（60~68天）</p>\n<h4 id=\"问题二：生产期如何安抚母猫？\"><a href=\"#问题二：生产期如何安抚母猫？\" class=\"headerlink\" title=\"问题二：生产期如何安抚母猫？\"></a>问题二：生产期如何安抚母猫？</h4><p>尽量不要着急，大喊大叫，跑来跑去，轻轻抚摸母猫，揉肚子，陪伴左右，给予信心和安全感。</p>\n<h4 id=\"问题三：母猫生产环境如何准备？\"><a href=\"#问题三：母猫生产环境如何准备？\" class=\"headerlink\" title=\"问题三：母猫生产环境如何准备？\"></a>问题三：母猫生产环境如何准备？</h4><ul>\n<li>温暖舒适的产箱（家里可以用纸皮箱加毛巾，纸箱要注意通风）</li>\n<li>剪刀（猫生产的时候会自己咬断脐带并吃掉胎盘，有备无患）</li>\n<li>生理盐水（给母猫擦身）</li>\n<li>一次性手套（全程带着）</li>\n<li>加热垫，有条件最好有，那天去到医院，医生第一时间就给志玲垫了</li>\n<li>热水，毛巾肯定要有</li>\n</ul>\n<h4 id=\"问题四：如何处理刚出生的小猫？\"><a href=\"#问题四：如何处理刚出生的小猫？\" class=\"headerlink\" title=\"问题四：如何处理刚出生的小猫？\"></a>问题四：如何处理刚出生的小猫？</h4><p>温水，把小猫放进水里按摩心脏，搓身子</p>\n<h3 id=\"设计模式\"><a href=\"#设计模式\" class=\"headerlink\" title=\"设计模式\"></a>设计模式</h3><p>如果把医生接生的过程抽象出来看，那就是“建造者模式”。</p>\n<ul>\n<li>医生：Director</li>\n<li>志玲：具体建造者</li>\n<li>小猫：产品</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 产品类（小猫）</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Kitten</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 所有小猫</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_babies;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_babies = <span class=\"keyword\">array</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span><span class=\"params\">($part)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> array_push(<span class=\"keyword\">$this</span>-&gt;_babies, $part);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">show</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"有这些小猫:\"</span>;</span><br><span class=\"line\">        array_map(<span class=\"string\">'printf'</span>, <span class=\"keyword\">$this</span>-&gt;_babies);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 抽象建造者</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Builder</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 产品零件构造方法1</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">buildPart1</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 产品零件构造方法2</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">buildPart2</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 产品零件构造方法3</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">buildPart3</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 产品返还方法</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getResult</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 具体建造者（母猫：志玲）</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MotherCat</span> <span class=\"keyword\">extends</span> <span class=\"title\">Builder</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_babies;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_babies = <span class=\"keyword\">new</span> Kitten();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">buildPart1</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_babies-&gt;add(<span class=\"string\">\"佩奇\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">buildPart2</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_babies-&gt;add(<span class=\"string\">\"佐治\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">buildPart3</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_babies-&gt;add(<span class=\"string\">\"八千\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getResult</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;_babies;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 接生员</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Director</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(Builder $builder)</span> </span>&#123;</span><br><span class=\"line\">        $builder-&gt;buildPart1();</span><br><span class=\"line\">        $builder-&gt;buildPart2();</span><br><span class=\"line\">        $builder-&gt;buildPart3();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Main program.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $zhiling = <span class=\"keyword\">new</span> MotherCat();</span><br><span class=\"line\">        $director = <span class=\"keyword\">new</span> Director($zhiling);</span><br><span class=\"line\">        $kitten = $zhiling-&gt;getResult();</span><br><span class=\"line\">        $kitten-&gt;show();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br></pre></td></tr></table></figure>","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"【笔记】同步和异步、阻塞与非阻塞","url":"http://funsoul.org/2018/04/02/同步和异步、阻塞与非阻塞/","content":"<h2 id=\"先明白的事儿\"><a href=\"#先明白的事儿\" class=\"headerlink\" title=\"先明白的事儿\"></a>先明白的事儿</h2><p>当一个程序在执行的时候，一般会创建一个进程，也可以有多个进程。一个进程至少会创建一个线程，多个线程共享一个程序进程的内存。程序的运行最终是靠线程来完成操作的。线程的数量跟CPU核数有关，一个核最多能发出两个线程。</p>\n<p>线程的操作主要分为：</p>\n<ol>\n<li>给CPU进行程序命令的执行。</li>\n<li>IO的操作（读取或输出数据）或者请求网络数据。</li>\n</ol>\n<h2 id=\"阻塞\"><a href=\"#阻塞\" class=\"headerlink\" title=\"阻塞\"></a>阻塞</h2><p>就是线程在执行IO操作获取数据时，这个IO可能会需要一定的时间才能等到数据返回，然后才能接着执行下面的命令。那么，此时，这个线程的等待状态我们就把它称为阻塞。没有充分利用起cpu的资源。</p>\n<h2 id=\"非阻塞\"><a href=\"#非阻塞\" class=\"headerlink\" title=\"非阻塞\"></a>非阻塞</h2><p>还是这个线程在进行 IO操作时，无需等待数据的返回，可以接着往下执行代码命令。cpu资源一直在充分利用。</p>\n<p>但是总要知道数据什么时候返回吧，常见的两个解决方案：</p>\n<ul>\n<li>如果程序是单线程的情况下，在接着执行下面的代码过程中，需要额外不断的轮询查看这个IO请求的数据是否返回。</li>\n<li>使用多线程，一个进程继续等待数据返回，另一个线程继续操作执行下面的代码。cpu资源一直在充分利用。</li>\n</ul>\n<h2 id=\"同步和异步\"><a href=\"#同步和异步\" class=\"headerlink\" title=\"同步和异步\"></a>同步和异步</h2><p>同步指的当线程进行IO操作请求数据时，是你主动”关心”数据的返回。<br>异步是当前线程无需主动关心数据是否返回，当数据返回时，会有相关的事件通知你。</p>\n<h2 id=\"举个栗子\"><a href=\"#举个栗子\" class=\"headerlink\" title=\"举个栗子\"></a>举个栗子</h2><p>你打电话问书店老板有没有《分布式系统》这本书，如果是同步通信机制，书店老板会说，你稍等，”我查一下”，然后开始查啊查，等查好了（可能是5秒，也可能是一天）告诉你结果（返回结果）。<br>而异步通信机制，书店老板直接告诉你我查一下啊，查好了打电话给你，然后直接挂电话了（不返回结果）。然后查好了，他会主动打电话给你。在这里老板通过“回电”这种方式来回调。</p>\n<p>由此可见：阻塞并不等于同步，非阻塞也不等于异步。</p>\n<p>阻塞不阻塞的区别点在于：线程当遇到IO操作，需要等待IO返回数据时，是否能继续往下执行代码。<br>同步与异步的区别点在于：IO要返回的数据是需要线程主动等待，还是被动的等待数据处理完之后主动通知你。</p>\n<p>最好的理想方案就是：异步非阻塞。而nginx就使用的非阻塞+异步。apache使用的是同步阻塞。这也就是为什么nginx能比apache处理更多的请求更高的并发的原因。</p>\n<h2 id=\"apache与nginx的工作原理\"><a href=\"#apache与nginx的工作原理\" class=\"headerlink\" title=\"apache与nginx的工作原理\"></a>apache与nginx的工作原理</h2><p>假如下面是类似apache和nginx的伪代码：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">listen  //监听端口</span><br><span class=\"line\"></span><br><span class=\"line\">while(true)&#123; </span><br><span class=\"line\">\t$conn = accept() //一直循环接收连接</span><br><span class=\"line\">\t$read_content = read(conn)//读取请求的文件</span><br><span class=\"line\">\t$esponse = process(conn) # 执行业务逻辑</span><br><span class=\"line\">\techo $espnse //返回客户端内容 </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"apache\"><a href=\"#apache\" class=\"headerlink\" title=\"apache\"></a>apache</h4><p>每一个连接，apache就会创建一个进程，每个进程内单线程，apache最多能创建256个进程。对于一个负载相对较高的网站来说，256的进程，也就是256个线程，因为线程处理请求时，是同步阻塞模式，接收请求之后，会一直等待该请求读取程序文件（IO）（同步），执行业务逻辑，返回客户端，所有操作完成之后才能处理下一个请求（阻塞）如果服务器已经达到256的极限，那么接下去的访问就需要排队这也就是为什么某些服务器负载不高的原因了。</p>\n<h4 id=\"nginx\"><a href=\"#nginx\" class=\"headerlink\" title=\"nginx\"></a>nginx</h4><p>nginx接收一个请求后，不会等待这个请求的文件读取操作完成之后才接收下一个请求，它不会等待这个请求的后续的处理结果。而是会马上循环处理下一个请求（不阻塞）。请求的程序文件执行完成之后，会主动通知该线程，不用你主动去等待或者轮询查看（异步）。最后返回给客户端。这样做，每个请求过来就不需要等待很长的时间排队，而是马上就能接收，开始进行处理了。等处理完成之后，会主动通知回调这个线程进行数据返回。</p>\n","categories":["技术"],"tags":["网络编程","笔记"]},{"title":"PHP门面模式之网红进阶之路","url":"http://funsoul.org/2018/03/29/PHP门面模式之网红进阶之路/","content":"<h2 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h2><p>门面模式又称外观模式，既然如此，最容易联想到的就是化妆了。不要问我为什么知道怎么化妆 = =#</p>\n<p>有人说，关注我的文字是为了学习技术，我觉得这是对我赤果果的侮辱！今天我就教你如何化妆！</p>\n<h2 id=\"化妆\"><a href=\"#化妆\" class=\"headerlink\" title=\"化妆\"></a>化妆</h2><p>我简单总结了一下，化妆大致分为五大模块</p>\n<ul>\n<li>基础护肤</li>\n<li>隔离保护</li>\n<li>脸部美容</li>\n<li>眼部美容</li>\n<li>唇部美容</li>\n</ul>\n<p><strong>题外话（划重点）</strong>：这里的化妆步骤看起来很像模版方法模式，也是给定一个算法架构，然后让客户端去实现细节。其实，化妆除了前面两步（基础护肤和隔离保护）需要严格按顺序执行，其他部分并不需要强制按顺序，如果你有多个化妆师，也可以一遍画眉一遍抹口红，或者你觉得你不需要抹口红，纯天然水嫩！那少了唇部美容这一部分也无碍。所以，外观模式是最适合的，对于整个化妆而言，每个模块都是相对独立的。</p>\n<h4 id=\"基础护肤\"><a href=\"#基础护肤\" class=\"headerlink\" title=\"基础护肤\"></a>基础护肤</h4><p>众说周知（真的假的），化妆前不护肤？这脸是要毁掉了呀！</p>\n<blockquote>\n<p>化妆品主要成分是溶剂，其次是表面活性剂，另外就是林林总总的防腐剂、色素、香精、增色剂、稠化剂、络合剂等添加剂。</p>\n<ol>\n<li>溶剂、表面活性剂会软化表皮细胞，褪去角质层，一次当然不行，天天累积的效果，一定程度上弱化皮肤的防护作用（主要是表面活性剂的效果）;</li>\n<li>被弱化的表皮细胞和毛孔部位会渗透进各种添加剂，有些存在特殊结构的物质有可能会被细胞识别并拖进去，完成吸收——主要是小分子有机物，对于蛋白类，呵呵，你又不是欧米巴变形虫~;</li>\n<li>从来没有报道或研究指出此种途径对人体的影响，但是整体影响的相关报道时有见报，一般是医学杂志——其实是体系太复杂，不好研究，又没人会支持这项研究;</li>\n<li>过多的添加剂，在前两条途径存在的情况下，会整体上增大过敏的可能性，尤其是使防护能力减弱的皮肤暴露在空气中，会使皮肤变得敏感;</li>\n<li>重金属化合物往往是化妆品增色剂的主要成分，依靠其物理色泽产生美白等效果，在前两点的存在下，重金属积累的效果很有可能会产生，而且由于生物体缺乏对这种物质的代谢能力，其影响是深远的。另外，由于重金属运输效率其实不高，在皮肤积累会使得皮肤变得越来越差！</li>\n</ol>\n</blockquote>\n<p>有人又说了，生活中到处都是化学品，防不胜防啊，是啊，现在教你怎么防~</p>\n<ol>\n<li>洗脸</li>\n<li>爽肤</li>\n<li>精华 （促进吸收、美白、保湿）</li>\n<li>乳液</li>\n</ol>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 基础护肤</span></span><br><span class=\"line\"><span class=\"comment\"> * Class BasicSkinCare</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BasicSkinCare</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">washFace</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'洗脸'</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">toning</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'爽肤'</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eliteFluid</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'精华'</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">emulsion</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'乳液'</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"隔离保护\"><a href=\"#隔离保护\" class=\"headerlink\" title=\"隔离保护\"></a>隔离保护</h4><p>做完基础护肤，还不能直接往脸上抹化妆品，需要做隔离</p>\n<ol>\n<li>隔离霜</li>\n<li>粉底液</li>\n</ol>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 隔离保护</span></span><br><span class=\"line\"><span class=\"comment\"> * Class IsolationProtection</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">IsolationProtection</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">segregationFrost</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'隔离霜'</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">liquidFoundation</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'粉底液'</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"脸部美容\"><a href=\"#脸部美容\" class=\"headerlink\" title=\"脸部美容\"></a>脸部美容</h4><p>昨晚隔离后，可以开始化妆了，从脸部开始，</p>\n<ol>\n<li>定妆粉饼</li>\n<li>腮红</li>\n</ol>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 脸部美容</span></span><br><span class=\"line\"><span class=\"comment\"> * Class FacialBeauty</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FacialBeauty</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">calmMakeup</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'定妆粉饼'</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cheekRed</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'腮红'</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"眼部美容\"><a href=\"#眼部美容\" class=\"headerlink\" title=\"眼部美容\"></a>眼部美容</h4><p>眼睛是心灵的窗户，拥有一双明眸会让你增色不少</p>\n<ol>\n<li>画眉</li>\n<li>眼影</li>\n<li>眼线</li>\n<li>睫毛膏</li>\n</ol>\n<p>这里还可以加美瞳，因人而异啦吼吼~</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 眼部美容</span></span><br><span class=\"line\"><span class=\"comment\"> * Class EyeBeauty</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EyeBeauty</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">thrush</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'画眉'</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eyeShadow</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'眼影'</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eyeliner</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'眼线'</span>; &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">eyelashCream</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'睫毛膏'</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"唇部美容\"><a href=\"#唇部美容\" class=\"headerlink\" title=\"唇部美容\"></a>唇部美容</h4><p>在某些男生眼中，判断一个女生是否化妆的标准是 —— 有没有口红….我的兄dei…</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 唇部美容</span></span><br><span class=\"line\"><span class=\"comment\"> * Class LipsBeauty</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LipsBeauty</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lipstick</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">echo</span> <span class=\"string\">'唇彩或唇膏'</span>; &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"化妆门面类\"><a href=\"#化妆门面类\" class=\"headerlink\" title=\"化妆门面类\"></a>化妆门面类</h2><p>刚刚介绍了化妆的五大模块，把这个五个模块组装在一起，就形成了化妆门面类。当然，你也可以少一些模块，并不强制要求，也不需要严格按照步骤执行。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 化妆门面类</span></span><br><span class=\"line\"><span class=\"comment\"> * Class SecurityFacade</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MakeupFacade</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_basicSkinCare;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_isolationProtection;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_facialBeauty;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_eyeBeauty;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_lipsBeauty;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_basicSkinCare = <span class=\"keyword\">new</span> BasicSkinCare();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_isolationProtection = <span class=\"keyword\">new</span> IsolationProtection();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_facialBeauty = <span class=\"keyword\">new</span> FacialBeauty();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_eyeBeauty = <span class=\"keyword\">new</span> EyeBeauty();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_lipsBeauty = <span class=\"keyword\">new</span> LipsBeauty();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">start</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_basicSkinCare-&gt;washFace();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_basicSkinCare-&gt;toning();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_basicSkinCare-&gt;eliteFluid();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_basicSkinCare-&gt;emulsion();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_isolationProtection-&gt;segregationFrost();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_isolationProtection-&gt;liquidFoundation();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_facialBeauty-&gt;calmMakeup();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_facialBeauty-&gt;cheekRed();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_eyeBeauty-&gt;thrush();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_eyeBeauty-&gt;eyeShadow();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_eyeBeauty-&gt;eyeliner();</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_eyeBeauty-&gt;eyelashCream();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_lipsBeauty-&gt;lipstick();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"开始化妆\"><a href=\"#开始化妆\" class=\"headerlink\" title=\"开始化妆\"></a>开始化妆</h2><p>一般而言，门面只需要一个对象，所以这里声明为静态变量，下次使用不需要再重新申请。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 客户端</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_makeupFacade;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Main program.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">self</span>::$_makeupFacade = <span class=\"keyword\">new</span> MakeupFacade();</span><br><span class=\"line\">        <span class=\"keyword\">self</span>::$_makeupFacade-&gt;start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br></pre></td></tr></table></figure>","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP适配器模式之找不到合适的接口","url":"http://funsoul.org/2018/03/28/PHP适配器模式之找不到合适的接口/","content":"<h2 id=\"诡异的现象\"><a href=\"#诡异的现象\" class=\"headerlink\" title=\"诡异的现象\"></a>诡异的现象</h2><p>不知道大家是否有过一个疑问，当你想把USB插进接口的时候，总是会这样：</p>\n<ol>\n<li>第一次插进去，不行</li>\n<li>反过来（旋转180度），再插，还是不行</li>\n<li>再反过来（回到最开始），进去了！</li>\n</ol>\n<p>这个接口结合的过程，是建立在双方遵循一致协议的情况下才会发生的，今天讨论的情况是，</p>\n<ol>\n<li>第一次插进去，不行</li>\n<li>反过来（旋转180度），再插，还是不行</li>\n<li>再反过来（回到最开始），仍旧不行！</li>\n<li>我擦，是不是拿错接口了！</li>\n</ol>\n<h2 id=\"接口适配\"><a href=\"#接口适配\" class=\"headerlink\" title=\"接口适配\"></a>接口适配</h2><ul>\n<li>既然接口不合适，那怎么办？买一个？可以~ 请关闭此文章~</li>\n<li>利用现有接口进行适配</li>\n</ul>\n<p><img src=\"/images/adapter-300x159.jpg\" alt></p>\n<p><strong>可以看出，现有插座只有三口的，而我的插头是两口的，这表示，接口不兼容。这种情况下，可以通过第三方（三口中间件）来进行适配。这个适配器其实就是在原来的基础上增加了额外的功能，是对原有功能的一种扩展，在不改变原来接口的基础上，使得两个互不兼容的接口可以一起工作。</strong></p>\n<p>适配器模式有两种实现方式，一种是<strong>类适配器</strong>，另一种是<strong>对象适配器</strong>。</p>\n<h2 id=\"类适配器\"><a href=\"#类适配器\" class=\"headerlink\" title=\"类适配器\"></a>类适配器</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 目标角色</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Target</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 两口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo2plug</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 一口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo1plug</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 两口插头</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TwoPlug</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 两口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo2plug</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'2 plug'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 三口适配器</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ThreePlugAdapter</span> <span class=\"keyword\">extends</span> <span class=\"title\">TwoPlug</span> <span class=\"keyword\">implements</span> <span class=\"title\">Target</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 新增一口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo1plug</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'1 plug'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Main program.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $adapter = <span class=\"keyword\">new</span> ThreePlugAdapter();</span><br><span class=\"line\">        $adapter-&gt;echo2plug();</span><br><span class=\"line\">        $adapter-&gt;echo1plug();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br></pre></td></tr></table></figure>\n<p>如上代码所示，类适配器使用继承，三口插头继承于两口插头。</p>\n<h2 id=\"对象适配器\"><a href=\"#对象适配器\" class=\"headerlink\" title=\"对象适配器\"></a>对象适配器</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 目标角色</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Target</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 两口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo2plug</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 一口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo1plug</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 两口插头</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TwoPlug</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 两口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo2plug</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'2 plug'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 三口适配器</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ThreePlugAdapter</span> <span class=\"keyword\">implements</span> <span class=\"title\">Target</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_twoPlug;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(TwoPlug $twoPlug)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_twoPlug = $twoPlug;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 两口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo2plug</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_twoPlug-&gt;echo2plug();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">echo1plug</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'1 plug'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Main program.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $adapter = <span class=\"keyword\">new</span> ThreePlugAdapter(<span class=\"keyword\">new</span> TwoPlug);</span><br><span class=\"line\">        $adapter-&gt;echo2plug();</span><br><span class=\"line\">        $adapter-&gt;echo1plug();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br></pre></td></tr></table></figure>\n<p>如上代码所示，对象适配器使用的是依赖注入，对于三口插头适配器而言，可一次性给多个两口插头添加一口（添加功能）。</p>\n","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP策略模式之多功能折叠小刀","url":"http://funsoul.org/2018/03/27/PHP策略模式之多功能折叠小刀/","content":"<h2 id=\"多功能折叠小刀\"><a href=\"#多功能折叠小刀\" class=\"headerlink\" title=\"多功能折叠小刀\"></a>多功能折叠小刀</h2><p><img src=\"/images/xiaodao1.jpg\" alt></p>\n<p>从小，我们就对这个不陌生，甚至觉得，拥有一把这样的小刀，是一件很酷的事情。这样一把小刀，实在是居家旅行，必备工具，只需要一把，即可变成水果刀、剪刀或者钢锯等等，而且不占地方。</p>\n<p>现在回想起来，这样的设计简直是大智慧有木有？一个接口响应不同策略，这正是策略模式啊~</p>\n<h2 id=\"同一接口\"><a href=\"#同一接口\" class=\"headerlink\" title=\"同一接口\"></a>同一接口</h2><p>我们需要一把多功能的小刀，那么，所有的功能都是从这把小刀体现的，同一接口：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 抽象策略角色，以接口实现</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Strategy</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 算法接口</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">algorithmInterface</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"不同实现\"><a href=\"#不同实现\" class=\"headerlink\" title=\"不同实现\"></a>不同实现</h2><p>我们需要哪些实现，那就实现这个接口：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 具体策略角色：小刀</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Knife</span> <span class=\"keyword\">implements</span> <span class=\"title\">Strategy</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">algorithmInterface</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'小刀'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 具体策略角色：剪刀</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Scissors</span> <span class=\"keyword\">implements</span> <span class=\"title\">Strategy</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">algorithmInterface</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'剪刀'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 具体策略角色：钢锯</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Hacksaw</span> <span class=\"keyword\">implements</span> <span class=\"title\">Strategy</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">algorithmInterface</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'钢锯'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"具体载体（context）\"><a href=\"#具体载体（context）\" class=\"headerlink\" title=\"具体载体（context）\"></a>具体载体（context）</h2><p>前面我们准备好了这把小刀所需要的功能，然后我们开始打造这把小刀：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 多功能折叠小刀</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FoldingKnife</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/* 引用的策略 */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_strategy;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(Strategy $strategy)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_strategy = $strategy;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">contextInterface</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_strategy-&gt;algorithmInterface();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"如何使用\"><a href=\"#如何使用\" class=\"headerlink\" title=\"如何使用\"></a>如何使用</h2><p>有了这把利器，我们就可以按需使用想要的工具：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 客户端</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Main program.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 打开小刀</span></span><br><span class=\"line\">        $context = <span class=\"keyword\">new</span> FoldingKnife(<span class=\"keyword\">new</span> Knife());</span><br><span class=\"line\">        $context-&gt;contextInterface();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 打开剪刀</span></span><br><span class=\"line\">        $context = <span class=\"keyword\">new</span> FoldingKnife(<span class=\"keyword\">new</span> Scissors());</span><br><span class=\"line\">        $context-&gt;contextInterface();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 打开钢锯</span></span><br><span class=\"line\">        $context = <span class=\"keyword\">new</span> FoldingKnife(<span class=\"keyword\">new</span> Hacksaw());</span><br><span class=\"line\">        $context-&gt;contextInterface();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br></pre></td></tr></table></figure>","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP模版方法模式之炒黄瓜","url":"http://funsoul.org/2018/03/26/PHP模版方法模式之炒黄瓜/","content":"<h2 id=\"生命不息，学习不止！\"><a href=\"#生命不息，学习不止！\" class=\"headerlink\" title=\"生命不息，学习不止！\"></a>生命不息，学习不止！</h2><p>又到了让人充满感激的周末，和往常一样，我一如既往地被“请”去学做菜，作为21世纪的五好青年（吃喝拉撒睡？），我表示毫无压力可言，区区一道炒黄瓜，还不是“洒洒水”。</p>\n<h2 id=\"炒菜的步骤\"><a href=\"#炒菜的步骤\" class=\"headerlink\" title=\"炒菜的步骤\"></a>炒菜的步骤</h2><p>在拿起铲子那一刻，脑子里回顾了一遍老祖宗传下来的“陈家菜”菜谱 —— 要煮熟，少放盐。心里已经大定，其实炒菜和写程序一样：</p>\n<ul>\n<li>输入指令：放食材放进去锅内</li>\n<li>处理指令：煎、炒、烹、炸 ……</li>\n<li>输出结果：熟了、出锅</li>\n</ul>\n<p>于是，我们建立一套炒菜的模版</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 抽象模板角色</span></span><br><span class=\"line\"><span class=\"comment\">* 定义抽象方法作为顶层逻辑的组成部分，由子类实现</span></span><br><span class=\"line\"><span class=\"comment\">* 定义模板方法作为顶层逻辑的架子，调用基本方法组装顶层逻辑</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">AbstractCooking</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 模板方法 调用基本方法组装顶层逻辑</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cook</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t  <span class=\"keyword\">echo</span> <span class=\"string\">'begin'</span>;</span><br><span class=\"line\">\t  <span class=\"keyword\">$this</span>-&gt;PutinMaterials();</span><br><span class=\"line\">\t  <span class=\"keyword\">$this</span>-&gt;ProcessingMaterial();</span><br><span class=\"line\">\t  <span class=\"keyword\">$this</span>-&gt;TakeoutProduct();</span><br><span class=\"line\">\t  <span class=\"keyword\">echo</span> <span class=\"string\">'end'</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 投放材料</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  <span class=\"keyword\">abstract</span> <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">PutinMaterials</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 处理材料</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  <span class=\"keyword\">abstract</span> <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ProcessingMaterial</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 取出产品</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  <span class=\"keyword\">abstract</span> <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">TakeoutProduct</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"炒黄瓜\"><a href=\"#炒黄瓜\" class=\"headerlink\" title=\"炒黄瓜\"></a>炒黄瓜</h2><p>有了这套模版，可以说，已经掌握了做菜的最高心法（呸！），无论是煎、炒、烹、炸，还是做饭、煲汤，都遵循这套模版。</p>\n<p>今天拿炒黄瓜来举个例子：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 具体模板角色</span></span><br><span class=\"line\"><span class=\"comment\">* 实现父类的抽象方法</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FriedCucumber</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractCooking</span></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">PutinMaterials</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\t  <span class=\"keyword\">echo</span> <span class=\"string\">'开火'</span>;</span><br><span class=\"line\">\t  <span class=\"keyword\">echo</span> <span class=\"string\">'滤干锅里的水'</span>;</span><br><span class=\"line\">\t  <span class=\"keyword\">echo</span> <span class=\"string\">'倒油'</span>;</span><br><span class=\"line\">\t  <span class=\"keyword\">echo</span> <span class=\"string\">'投入蒜蓉并爆香'</span>;</span><br><span class=\"line\">\t  <span class=\"keyword\">echo</span> <span class=\"string\">'投入准备好的黄瓜切片'</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">ProcessingMaterial</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">\t  <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>;$i &lt; <span class=\"number\">10</span>;$i++)&#123;</span><br><span class=\"line\">\t  \t<span class=\"keyword\">echo</span> <span class=\"string\">'翻炒'</span>;</span><br><span class=\"line\">\t  &#125;</span><br><span class=\"line\">\t  <span class=\"keyword\">echo</span> <span class=\"string\">'放调味料'</span>；</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">TakeoutProduct</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  \t<span class=\"keyword\">echo</span> <span class=\"string\">'装盘、上菜'</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"开始\"><a href=\"#开始\" class=\"headerlink\" title=\"开始\"></a>开始</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 客户端</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * Main program.</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t  $class = <span class=\"keyword\">new</span> FriedCucumber();</span><br><span class=\"line\">\t  $class-&gt;cook();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br></pre></td></tr></table></figure>\n<h2 id=\"过程\"><a href=\"#过程\" class=\"headerlink\" title=\"过程\"></a>过程</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">begin</span><br><span class=\"line\">开火</span><br><span class=\"line\">滤干锅里的水</span><br><span class=\"line\">倒油</span><br><span class=\"line\">投入蒜蓉并爆香</span><br><span class=\"line\">投入准备好的黄瓜切片</span><br><span class=\"line\">翻炒</span><br><span class=\"line\">翻炒</span><br><span class=\"line\">翻炒</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">放调味料</span><br><span class=\"line\">装盘、上菜</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP观察者模式之一二三木头人","url":"http://funsoul.org/2018/03/23/PHP观察者模式之一二三木头人/","content":"<h2 id=\"一二三木头人\"><a href=\"#一二三木头人\" class=\"headerlink\" title=\"一二三木头人\"></a>一二三木头人</h2><p>大多数小孩子都玩过这个游戏，游戏人数为N&gt;=2就可以玩，规则很简单，考虑到小孩子的体积，粗略需要1平方米的占地面积，那么N个小孩子就是N平方米，场地出来了，在一个占地面积小于等于N平方米（为什么是小于等于？你懂的）的空地上，一个孩子王站前面背对着大家，游戏开始后，其他小孩子以风雷之势起跑试图超越孩子王所站的位置，最后拍到孩子王的肩膀，即为胜出。但是，在不定时间间隔内，孩子王有意或无意的掉头并喊出“一二三木头人”用以阻碍其他小孩子的来势汹汹，如果看到有人动了（站不稳、小动作），即可淘汰出局！</p>\n<p>如这份草图：<br><img src=\"/images/mutouren-300x131.png\" alt></p>\n<h2 id=\"模式抽象\"><a href=\"#模式抽象\" class=\"headerlink\" title=\"模式抽象\"></a>模式抽象</h2><p>万万没想到，这个孩提时代的游戏竟体现了观察者模式，细思极恐：</p>\n<ul>\n<li>孩子王，被观察者，负责维护一个已注册的观察者新增、删除、发通知</li>\n<li>其他小孩子，观察者，负责应对被观察者所发出的事件变化而变化</li>\n</ul>\n<h3 id=\"被观察者\"><a href=\"#被观察者\" class=\"headerlink\" title=\"被观察者\"></a>被观察者</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 抽象主题（被观察者）</span></span><br><span class=\"line\"><span class=\"comment\"> * Interface Subject</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ISubject</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 新增观察者</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> IObserver $observer</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> mixed</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">attach</span><span class=\"params\">(IObserver $observer)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 删除已订阅的观察者</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> IObserver $observer</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> mixed</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">detach</span><span class=\"params\">(IObserver $observer)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 通知所有已订阅的观察者对象</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">notifyObservers</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"观察者\"><a href=\"#观察者\" class=\"headerlink\" title=\"观察者\"></a>观察者</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 抽象观察者</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IObserver</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 更新方法</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"被观察者实体\"><a href=\"#被观察者实体\" class=\"headerlink\" title=\"被观察者实体\"></a>被观察者实体</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 孩子王（负责喊“一二三木头人”）</span></span><br><span class=\"line\"><span class=\"comment\"> * Class Boss</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Boss</span> <span class=\"keyword\">implements</span> <span class=\"title\">ISubject</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_kids;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_kids = <span class=\"keyword\">array</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">attach</span><span class=\"params\">(IObserver $observer)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> array_push(<span class=\"keyword\">$this</span>-&gt;_kids, $observer);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">detach</span><span class=\"params\">(IObserver $observer)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        $index = array_search($observer, <span class=\"keyword\">$this</span>-&gt;_kids);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($index === <span class=\"keyword\">false</span> || ! array_key_exists($index, <span class=\"keyword\">$this</span>-&gt;_kids)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">unset</span>(<span class=\"keyword\">$this</span>-&gt;_kids[$index]);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 通知所有注册过的观察者对象</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">notifyObservers</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!is_array(<span class=\"keyword\">$this</span>-&gt;_kids)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"keyword\">$this</span>-&gt;_kids <span class=\"keyword\">as</span> $observer) &#123;</span><br><span class=\"line\">            $observer-&gt;update();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"观察者实体\"><a href=\"#观察者实体\" class=\"headerlink\" title=\"观察者实体\"></a>观察者实体</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 观察者</span></span><br><span class=\"line\"><span class=\"comment\"> * Class Kid</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Kid</span> <span class=\"keyword\">implements</span> <span class=\"title\">IObserver</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 观察者的名称</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@var</span> &lt;type&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> $_name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;_name = $name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 更新方法</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"keyword\">$this</span>-&gt;_name, <span class=\"string\">' 向前一步'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"游戏开始\"><a href=\"#游戏开始\" class=\"headerlink\" title=\"游戏开始\"></a>游戏开始</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 客户端</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Client</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Main program.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">main</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 游戏开始</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 从孩子们中选出一个Boss，负责喊“一二三木头人”</span></span><br><span class=\"line\">        $subject = <span class=\"keyword\">new</span> Boss();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 小明参加游戏</span></span><br><span class=\"line\">        $observer1 = <span class=\"keyword\">new</span> Kid(<span class=\"string\">'小明'</span>);</span><br><span class=\"line\">        $subject-&gt;attach($observer1);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 小张参加游戏</span></span><br><span class=\"line\">        $observer2 = <span class=\"keyword\">new</span> Kid(<span class=\"string\">'小张'</span>);</span><br><span class=\"line\">        $subject-&gt;attach($observer2);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 小张他妈喊他回家吃饭，不玩了</span></span><br><span class=\"line\">        $subject-&gt;detach($observer2);</span><br><span class=\"line\"></span><br><span class=\"line\">        $subject-&gt;notifyObservers();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Client::main();</span><br></pre></td></tr></table></figure>","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP装饰器模式之去年买了条狗","url":"http://funsoul.org/2018/03/23/PHP装饰器模式之去年买了条狗/","content":"<h2 id=\"去年买了条狗\"><a href=\"#去年买了条狗\" class=\"headerlink\" title=\"去年买了条狗\"></a>去年买了条狗</h2><p>小明去年想买条狗，于是他搭公交去宠物店逛了逛，看到了很多种狗。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Dog</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p>他看了看，哈士奇要888，秋田犬比哈士奇还要更贵，需要1298。</p>\n<p><img src=\"/images/Husky.jpg\" alt=\"哈士奇\"><br>[ 哈士奇 - 888￥ ]</p>\n<p><img src=\"/images/Akitas.jpg\" alt=\"秋田犬\"><br>[ 秋田犬 - 1298￥ ]</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Husky</span> <span class=\"keyword\">extends</span> <span class=\"title\">Dog</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cost</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"number\">888</span>;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDescribe</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"string\">'灰白'</span>;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Akitas</span> <span class=\"keyword\">extends</span> <span class=\"title\">Dog</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cost</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"number\">1298</span>;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDescribe</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"string\">'黄白'</span>;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>看着自己腰包上仅有的1024.5，一阵凉风吹过，充满了唏嘘和无奈…</p>\n<p>交完钱，顺手买了一根狗链10块，还有一包狗粮20块。</p>\n<p>其实，他内心更喜欢黄色的秋田犬，无奈太贵了，<strong>这狗自己就长这样，没办法自己变成黄色啊~</strong></p>\n<p>正要回家，看到旁边的宠物美容店，嘴角划过一丝微笑…</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DogDecorator</span> <span class=\"keyword\">extends</span> <span class=\"title\">Dog</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $dog;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(Dog $dog)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;dog = $dog;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>咨询了下，原来染毛只需要100块钱，嘿嘿</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DyeYellow</span> <span class=\"keyword\">extends</span> <span class=\"title\">DogDecorator</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cost</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;dog-&gt;cost() + <span class=\"number\">100</span>;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDescribe</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"string\">'黄白'</span>;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>于是，他给这只哈士奇染成了黄色…这样一来，虽然没买到秋田犬，但是只需要998就可以买到和秋田犬差不多的狗，还是很开心的…</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = <span class=\"keyword\">new</span> DyeYellow(<span class=\"keyword\">new</span> Husky());</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $a-&gt;cost();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $a-&gt;getDescribe();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 998</span></span><br><span class=\"line\"><span class=\"comment\">// 黄白</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/yellowHusky-1.jpg\" alt></p>\n<p>感到非常开心的他，在家附近的士多店买一根五羊2块钱，正要开始吃时，哈士奇一个飞扑，把他弄摔在地，手中的五羊以一个美妙的抛物线划过天际，口袋里仅剩的5毛钱掉了出来，望着哈士奇，哭笑不得~</p>\n<h2 id=\"完整代码\"><a href=\"#完整代码\" class=\"headerlink\" title=\"完整代码\"></a>完整代码</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Dog</span> </span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Husky</span> <span class=\"keyword\">extends</span> <span class=\"title\">Dog</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cost</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"number\">1000</span>;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDescribe</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"string\">'灰白'</span>;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Akitas</span> <span class=\"keyword\">extends</span> <span class=\"title\">Dog</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cost</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"number\">1500</span>;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDescribe</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"string\">'黄白'</span>;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DogDecorator</span> <span class=\"keyword\">extends</span> <span class=\"title\">Dog</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> $dog;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">(Dog $dog)</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">$this</span>-&gt;dog = $dog;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DyeYellow</span> <span class=\"keyword\">extends</span> <span class=\"title\">DogDecorator</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">cost</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;dog-&gt;cost() + <span class=\"number\">100</span>;&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getDescribe</span><span class=\"params\">()</span></span>&#123; <span class=\"keyword\">return</span> <span class=\"string\">'黄白'</span>;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$a = <span class=\"keyword\">new</span> DyeYellow(<span class=\"keyword\">new</span> Husky());</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $a-&gt;cost();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $a-&gt;getDescribe();</span><br></pre></td></tr></table></figure>","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP单例模式探索","url":"http://funsoul.org/2018/03/22/PHP单例模式探索/","content":"<h2 id=\"设计初衷\"><a href=\"#设计初衷\" class=\"headerlink\" title=\"设计初衷\"></a>设计初衷</h2><p>在讨论每个设计模式时，我们会反复思考设计的初衷是什么？真正理解后，用起来才能更加得心应手。单例模式是最早开始接触的模式之一，这篇文章将基于PHP语言做一些探索。</p>\n<p>在讨论单例模式之前，先聊聊面向对象，编程语言一开始是过程式，代表语言有C，后来出现了C++、Java等等面向对象式语言，对象的含义由此而生。说到面向对象，必谈三大特性，封装、继承和多态，这里不深入讨论，以后会着重谈谈。把数据和方法进行封装，我们得到类，类是抽象的，我们需要能做点事的，于是把类实例化得到对象。哪里需要这个类的数据，那就在哪里实例一个对象。看起来没什么问题，但是，在内存没那么多的时候，能不能在进程中只使用一个对象，能省则省嘛，于是，我们找到了单例模式。</p>\n<h2 id=\"模式\"><a href=\"#模式\" class=\"headerlink\" title=\"模式\"></a>模式</h2><p>在Java中，我们知道单例模式可以写成两种，分别是懒汉模式和饿汉模式，他们的区别在于对象实例化的时间，一个java类的完整的生命周期会经历加载、连接、初始化、使用、和卸载五个阶段，懒汉模式正如其名，在显示调用类的getInstance方法时（使用阶段），才会实例化对象。而饿汉模式早在java初始化时就已经实例化好了对象，故名饿汉。</p>\n<p>那么在PHP中如何使用单例模式呢？</p>\n<h3 id=\"懒汉模式\"><a href=\"#懒汉模式\" class=\"headerlink\" title=\"懒汉模式\"></a>懒汉模式</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Husky</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 定义私有静态变量</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 私有化构成方法</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 提供获取实例的公共方法  </span></span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">()</span></span>&#123;  </span><br><span class=\"line\">\t    <span class=\"keyword\">if</span>(!(<span class=\"keyword\">self</span>::$_instance <span class=\"keyword\">instanceof</span> <span class=\"keyword\">self</span>))&#123;  </span><br><span class=\"line\">\t        <span class=\"keyword\">self</span>::$_instance = <span class=\"keyword\">new</span> <span class=\"keyword\">self</span>();  </span><br><span class=\"line\">\t    &#125;  </span><br><span class=\"line\">\t    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$_instance;  </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"comment\">// 私有__clone方法，禁止复制对象  </span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__clone</span><span class=\"params\">()</span></span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">// 防止反序列化后创建对象</span></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span><span class=\"params\">()</span></span>&#123;&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"饿汉模式\"><a href=\"#饿汉模式\" class=\"headerlink\" title=\"饿汉模式\"></a>饿汉模式</h3><p>我们知道，在PHP中，静态变量只能被初始化为文字或常量，不能使用表达式。所以可以把静态属性初始化为整数或数组，但不能初始化为另一个变量或函数返回值，也不能指向一个对象。</p>\n<p>所以，饿汉模式也没办法写了:)</p>\n<h2 id=\"线程安全（web模式-cli模式）\"><a href=\"#线程安全（web模式-cli模式）\" class=\"headerlink\" title=\"线程安全（web模式/cli模式）\"></a>线程安全（web模式/cli模式）</h2><p>PHP在web模式下可以粗略的认为是单进程单线程的，当然，nginx/php-fpm确是多进程多线程。单次请求对于PHP来说，可以认为是单线程的，那么不存在线程安全问题。但是对于其他线程来说，比如读取数据库，文件，session来说，则需要加锁处理。</p>\n<p>在cli模式下，每次执行脚本都会新建一个进程，所以也不需要考虑线程安全问题。</p>\n<h2 id=\"单例复用-后期静态绑定\"><a href=\"#单例复用-后期静态绑定\" class=\"headerlink\" title=\"单例复用-后期静态绑定\"></a>单例复用-后期静态绑定</h2><p>设计模式的流行在很大一方面是因为人是懒惰的，能复用就复用，能少写就少写，于是，在我想创建下一个相同的单例类时，我想到了继承，于是有了下面的代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Akitas</span> <span class=\"keyword\">extends</span> <span class=\"title\">Husky</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们期望得到的是</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object(Husky)<span class=\"comment\">#1 (0) &#123;&#125;</span></span><br><span class=\"line\">object(Akitas)<span class=\"comment\">#2 (0) &#123;&#125;</span></span><br></pre></td></tr></table></figure>\n<p>但是，结果不尽人意，得到了</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object(Husky)<span class=\"comment\">#1 (0) &#123;&#125;</span></span><br><span class=\"line\">object(Husky)<span class=\"comment\">#1 (0) &#123;&#125;</span></span><br></pre></td></tr></table></figure>\n<p>那么，可以怎么修改这个类呢，我们想到了php5.3出的特性，后期静态绑定。修改一下代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Husky</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 定义私有静态变量</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">static</span> $_instance = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 私有化构成方法</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 提供获取实例的公共方法</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">static</span>::$_instance === <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">static</span>::$_instance = <span class=\"keyword\">new</span> <span class=\"keyword\">static</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">static</span>::$_instance;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 私有__clone方法，禁止复制对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__clone</span><span class=\"params\">()</span></span>&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 防止反序列化后创建对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span><span class=\"params\">()</span></span>&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Akitas</span> <span class=\"keyword\">extends</span> <span class=\"title\">Husky</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">static</span> $_instance = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>结果如预期所想，<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object(Husky)<span class=\"comment\">#1 (0) &#123;&#125;</span></span><br><span class=\"line\">object(Akitas)<span class=\"comment\">#2 (0) &#123;&#125;</span></span><br></pre></td></tr></table></figure></p>\n<p>thanks :)</p>\n","categories":["技术"],"tags":["PHP","设计模式","学习笔记"]},{"title":"PHP在Web服务上的探索","url":"http://funsoul.org/2018/03/20/PHP在Web服务上的探索/","content":"<h2 id=\"传统模式\"><a href=\"#传统模式\" class=\"headerlink\" title=\"传统模式\"></a>传统模式</h2><h3 id=\"cgi\"><a href=\"#cgi\" class=\"headerlink\" title=\"cgi\"></a>cgi</h3><p>早期的web程序其实都是一种cgi程序，cgi是什么？cgi程序又是什么？通用网关接口（Common Gateway Interface/CGI）是一种互联网技术，可以让一个客户端向服务器上的程序请求数据。CGI描述了服务器（nginx\\apache）和请求处理程序(php)之间传输数据的一种标准。这是一种标准、协议，不是程序。cgi程序是实现了cgi标准的程序。</p>\n<h3 id=\"fastcgi\"><a href=\"#fastcgi\" class=\"headerlink\" title=\"fastcgi\"></a>fastcgi</h3><p>cgi协议是这样的处理机制：请求来一个，便建起一个进程，这样的程序很容易实现，但是不好扩展，当并发量大了后，可能会有成千上万的进程，操作系统面对如此大的进程数，增加了进程上下文切换、新建以及销毁进程的开销，cpu资源占据居高不下，拖慢系统。内存上，由于进程处理完请求便销毁，地址空间无法共享与重用。</p>\n<p>现在的php-fpm采用的是fastcgi协议，与cgi不同，fastcgi使用持续的进程（1 master,n workers）来处理一连串的请求。这些进程由fastcgi服务器(php-fpm)管理，而不是web服务器。 当进来一个请求时，web服务器把环境变量和这个页面请求通过一个socket比如fastcgi进程与web服务器(都位于本地）或者一个TCP connection（fastcgi进程在远端的server farm）传递给fastcgi进程。</p>\n<h3 id=\"黄金搭档\"><a href=\"#黄金搭档\" class=\"headerlink\" title=\"黄金搭档\"></a>黄金搭档</h3><h4 id=\"LAMP\"><a href=\"#LAMP\" class=\"headerlink\" title=\"LAMP\"></a>LAMP</h4><p>php在apache中是以mod_php扩展的形式存在，必须依靠apache才能启动，当请求到达，apache判断是否是php程序，提交给php解释器进行处理，处理完并返回。</p>\n<h4 id=\"LNMP\"><a href=\"#LNMP\" class=\"headerlink\" title=\"LNMP\"></a>LNMP</h4><p>nginx可以配置资源类型，当请求到达时，比如/index.html，这是静态资源，服务器会到配置的web root文件系统中寻找，然后返回这个文件。如果请求的是/index.php，nginx知道必须把这个交给php解释器，这时候，根据cgi规范，把该有的数据（查询字符串、post数据，http header等等）发到相应的fastcgi进程进行处理。</p>\n<h4 id=\"LANMP\"><a href=\"#LANMP\" class=\"headerlink\" title=\"LANMP\"></a>LANMP</h4><p>LANMP使用nginx作为前端和代理服务器，利用nginx应对高并发的能力，真正的服务器可能有多个，比如apache。nginx把请求反向代理给后端的服务器。</p>\n<h2 id=\"Swoole常驻内存模式\"><a href=\"#Swoole常驻内存模式\" class=\"headerlink\" title=\"Swoole常驻内存模式\"></a>Swoole常驻内存模式</h2><p>php在这之前都是属于cgi程序，依赖于php-fpm。php-fpm是同步阻塞模式，虽然进程复用，但是PHP是短生命周期的，一次请求结束，php的变量和对象就会销毁。相较之下，swoole应运而生了。swoole的http server是常驻内存的，而且worker为异步非阻塞，可以处理更大的请求数。</p>\n<h3 id=\"swoole机制\"><a href=\"#swoole机制\" class=\"headerlink\" title=\"swoole机制\"></a>swoole机制</h3><p>swoole的reacter线程就好像nginx，异步非阻塞（epoll）的处理网络请求、协议，缓冲数据frame并拆分。然后把数据包通过unixsocket发送到worker（好像fpm的worker）进行处理。有时候我们需要处理一些IO耗时任务，可以通过投递task进程进行处理，比如消息队列，连接池。</p>\n<h3 id=\"nginx和swoole\"><a href=\"#nginx和swoole\" class=\"headerlink\" title=\"nginx和swoole\"></a>nginx和swoole</h3><p>一个很好的思路是，仍然使用nginx作为前端服务器，然后把请求反向代理到swoole服务器。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root /data/code/app/static;</span><br><span class=\"line\">location / &#123;</span><br><span class=\"line\">\tproxy_http_version 1.1;</span><br><span class=\"line\">\tproxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">\tproxy_pass http://127.0.0.1:9501;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"协程\"><a href=\"#协程\" class=\"headerlink\" title=\"协程\"></a>协程</h2><ul>\n<li>协作式</li>\n<li>抢占式任务</li>\n</ul>\n<p>进程和线程都是抢占式的，由操作系统调度上下文切换，保存上下文状态。</p>\n<p>协程更像是编译器的魔法，通过一些代码使得进程中的代码段能够分段执行，每次调度都会从yield开始。</p>\n<p>协程是用户态线程，理论上可以建起成百上千万个协程。相较于进程和线程，无需从用户态过渡到内核态，创建和切换的开销更低。</p>\n<h2 id=\"php-yield\"><a href=\"#php-yield\" class=\"headerlink\" title=\"php yield\"></a>php yield</h2><p>在之前的文章中，我粗略的介绍了yield的使用，yield的语义有生成器的意思，生成器的意思是，从一端把数据传到另一端。而协程的实现正是yield的双向通信。</p>\n<h2 id=\"swoole-coroutine\"><a href=\"#swoole-coroutine\" class=\"headerlink\" title=\"swoole coroutine\"></a>swoole coroutine</h2><p>swoole2.x已经完全在底层实现了协程调度，开发者在业务层无需再通过yield的关键字来显式执行调用，只需要以同步的方式编写代码，底层自动切换。</p>\n<h2 id=\"swoft微服务\"><a href=\"#swoft微服务\" class=\"headerlink\" title=\"swoft微服务\"></a>swoft微服务</h2><p>很多人由于PHP没有成熟的微服务框架而转到JAVA或者Go或者其他成熟的语言，swoole社区有一些人（swoft）把大家熟知的JAVA编程思想搬了过来，基于swoole2.x，全协程，AOP面向切面编程、服务治理，熔断、降级、负载、注册与发现，基于注解编程，看起来和JAVA非常像，通过composer把一切组件化。不过，1.0刚刚发布，需要开源社区的支持。看起来非常有前景。</p>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>最近利用业余时间基于swoole，做了两个有趣的项目，欢迎star：）</p>\n<ol>\n<li><a href=\"https://github.com/funsoul/funchat\" title=\"基于swoole websocket的聊天室\" target=\"_blank\" rel=\"noopener\">基于swoole websocket的聊天室</a></li>\n<li><a href=\"https://github.com/funsoul/funpinyin\" title=\"基于swoole http server的小程序游戏后端服务\" target=\"_blank\" rel=\"noopener\">基于swoole http server的小程序游戏后端服务</a></li>\n</ol>\n","categories":["技术"],"tags":["PHP","网络编程"]},{"title":"epoll学习笔记","url":"http://funsoul.org/2018/03/02/epoll学习笔记/","content":"<h2 id=\"流\"><a href=\"#流\" class=\"headerlink\" title=\"流\"></a>流</h2><p>流可以是文件,socket,pipe等能进行I/O操作的内核对象</p>\n<h2 id=\"I-O操作\"><a href=\"#I-O操作\" class=\"headerlink\" title=\"I/O操作\"></a>I/O操作</h2><ul>\n<li>read,从流中读取数据</li>\n<li>write,写数据到流中</li>\n</ul>\n<p>设想:客户端需要从socket中读取数据,但是服务端还没有返回,这时候该怎么办?</p>\n<h3 id=\"阻塞\"><a href=\"#阻塞\" class=\"headerlink\" title=\"阻塞\"></a>阻塞</h3><p>举个例子:等快递,快递没来,只能等快递打电话叫你.</p>\n<h3 id=\"非阻塞忙轮训\"><a href=\"#非阻塞忙轮训\" class=\"headerlink\" title=\"非阻塞忙轮训\"></a>非阻塞忙轮训</h3><p>接上例子:每隔一定单位时间打电话问快递来了没.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">while true &#123;</span><br><span class=\"line\">\tfor i in stream[]; &#123;</span><br><span class=\"line\">\t\tif i has data</span><br><span class=\"line\">\t\tread until unavailable</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"缓冲区\"><a href=\"#缓冲区\" class=\"headerlink\" title=\"缓冲区\"></a>缓冲区</h3><ul>\n<li>内核缓冲区</li>\n<li>用户缓冲区</li>\n</ul>\n<h2 id=\"非阻塞无差别轮训\"><a href=\"#非阻塞无差别轮训\" class=\"headerlink\" title=\"非阻塞无差别轮训\"></a>非阻塞无差别轮训</h2><p>为了避免CPU空转,可以引进了一个代理（一开始有一位叫做select的代理,后来又有一位叫做poll的代理,不过两者的本质是一样的）。这个代理比较厉害,可以同时观察许多流的I/O事件,在空闲的时候,会把当前线程阻塞掉,当有一个或多个流有I/O事件时,就从阻塞态中醒来,于是我们的程序就会轮询一遍所有的流（于是我们可以把“忙”字去掉了）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">while true &#123;</span><br><span class=\"line\">\tselect(streams[])</span><br><span class=\"line\">\tfor i in streams[] &#123;</span><br><span class=\"line\">\t\tif i has data</span><br><span class=\"line\">\t\tread until unavailable</span><br><span class=\"line\">\t&#125;\t\t</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"epoll\"><a href=\"#epoll\" class=\"headerlink\" title=\"epoll\"></a>epoll</h2><p>epoll可以理解为event poll,不同于忙轮询和无差别轮询,epoll之会把哪个流发生了怎样的I/O事件通知我们。此时我们对这些流的操作都是有意义的。</p>\n<h3 id=\"epoll-create\"><a href=\"#epoll-create\" class=\"headerlink\" title=\"epoll_create\"></a>epoll_create</h3><p>创建一个epoll对象，一般epollfd = epoll_create()</p>\n<h3 id=\"epoll-ctl-（epoll-add-epoll-del的合体），\"><a href=\"#epoll-ctl-（epoll-add-epoll-del的合体），\" class=\"headerlink\" title=\"epoll_ctl （epoll_add/epoll_del的合体），\"></a>epoll_ctl （epoll_add/epoll_del的合体），</h3><p>往epoll对象中增加/删除某一个流的某一个事件</p>\n<p>比如<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">epoll_ctl(epollfd, EPOLL_CTL_ADD, socket, EPOLLIN);//注册缓冲区非空事件，即有数据流入</span><br><span class=\"line\">epoll_ctl(epollfd, EPOLL_CTL_DEL, socket, EPOLLOUT);//注册缓冲区非满事件，即流可以被写入</span><br><span class=\"line\">epoll_wait(epollfd,...)等待直到注册的事件发生</span><br><span class=\"line\">（注：当对一个非阻塞流的读写发生缓冲区满或缓冲区空，write/read会返回-1，并设置errno=EAGAIN。而epoll只关心缓冲区非满和缓冲区非空事件）。</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"伪代码\"><a href=\"#伪代码\" class=\"headerlink\" title=\"伪代码\"></a>伪代码</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">while true &#123;</span><br><span class=\"line\">\tactive_stream[] = epoll_wait(epollfd)</span><br><span class=\"line\">\tfor i in active_stream[] &#123;</span><br><span class=\"line\">\t\tread or write till</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"epoll高效的本质\"><a href=\"#epoll高效的本质\" class=\"headerlink\" title=\"epoll高效的本质\"></a>epoll高效的本质</h2><ol>\n<li>减少用户态和内核态之间的文件句柄拷贝</li>\n<li>减少对可读可写文件句柄的遍历</li>\n</ol>\n","categories":["技术"],"tags":["学习笔记","网络编程"]},{"title":"【swoole】websocket聊天室","url":"http://funsoul.org/2018/03/02/【swoole】websocket聊天室/","content":"<p>昨天把聊天室的功能优化了一下,并加入了私聊.可以在<a href=\"http://funchat.funsoul.org\" title=\"Funchat\" target=\"_blank\" rel=\"noopener\">Funchat</a>体验一下,代码已经放到了<a href=\"https://github.com/funsoul/funchat\" title=\"funsoul/funchat\" target=\"_blank\" rel=\"noopener\">funsoul/funchat</a>.</p>\n","categories":["技术"],"tags":["PHP","Swoole","WebSocket"]},{"title":"【funcompare】PHP文本/Json差异对比工具","url":"http://funsoul.org/2018/02/28/【funcompare】PHP文本、Json差异对比工具/","content":"<h1 id=\"funcompare\"><a href=\"#funcompare\" class=\"headerlink\" title=\"funcompare\"></a>funcompare</h1><p>A tool compare text differences</p>\n<h1 id=\"Installation\"><a href=\"#Installation\" class=\"headerlink\" title=\"Installation\"></a>Installation</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">composer require <span class=\"string\">\"funsoul/funcompare: ~1.1\"</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"Usage\"><a href=\"#Usage\" class=\"headerlink\" title=\"Usage\"></a>Usage</h1><h3 id=\"compareText\"><a href=\"#compareText\" class=\"headerlink\" title=\"compareText()\"></a>compareText()</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Funsoul</span>\\<span class=\"title\">Funcompare</span>\\<span class=\"title\">Funcompare</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$old = <span class=\"string\">'A tool compare text differences is funny'</span>;</span><br><span class=\"line\">$new = <span class=\"string\">'A tool that compare text differences'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$fc = <span class=\"keyword\">new</span> Funcompare();</span><br><span class=\"line\">$res = $fc-&gt;compareText($old, $new);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $res;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// A tool &lt;span class=\"new-word\"&gt;that&lt;/span&gt; compare text differences &lt;span class=\"old-word\"&gt;is&lt;/span&gt; &lt;span class=\"old-word\"&gt;funny&lt;/span&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"compareJson\"><a href=\"#compareJson\" class=\"headerlink\" title=\"compareJson()\"></a>compareJson()</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Funsoul</span>\\<span class=\"title\">Funcompare</span>\\<span class=\"title\">Funcompare</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$old = <span class=\"string\">'[&#123;\"id\":1,\"name\":\"xxx\",\"age\":18,\"cart\":[&#123;\"id\":100,\"name\":\"rice\"&#125;]&#125;,&#123;\"id\":2,\"name\":\"aaa\",\"age\":18&#125;]'</span>;</span><br><span class=\"line\">$new = <span class=\"string\">'[&#123;\"id\":1,\"name\":\"yyy\",\"age\":20,\"cart\":[&#123;\"id\":100,\"name\":\"banana\"&#125;]&#125;,&#123;\"id\":2,\"name\":\"bbb\",\"age\":18&#125;]'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$fc = <span class=\"keyword\">new</span> Funcompare();</span><br><span class=\"line\">$res = $fc-&gt;compareJson($old, $new);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $res</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// [&#123;\"name\":&#123;\"old\":\"&lt;span class=\\\"old-word\\\"&gt;xxx&lt;/span&gt;\",\"new\":\"&lt;span class=\\\"new-word\\\"&gt;yyy&lt;/span&gt;\"&#125;,\"age\":&#123;\"old\":\"&lt;span class=\\\"old-word\\\"&gt;18&lt;/span&gt;\",\"new\":\"&lt;span class=\\\"new-word\\\"&gt;20&lt;/span&gt;\"&#125;,\"cart\":[&#123;\"name\":&#123;\"old\":\"&lt;span class=\\\"old-word\\\"&gt;rice&lt;/span&gt;\",\"new\":\"&lt;span class=\\\"new-word\\\"&gt;banana&lt;/span&gt;\"&#125;&#125;]&#125;,&#123;\"name\":&#123;\"old\":\"&lt;span class=\\\"old-word\\\"&gt;aaa&lt;/span&gt;\",\"new\":\"&lt;span class=\\\"new-word\\\"&gt;bbb&lt;/span&gt;\"&#125;&#125;]</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"name\"</span>:&#123;</span><br><span class=\"line\">            <span class=\"attr\">\"old\"</span>:<span class=\"string\">\"&lt;span class=\"</span>old-word<span class=\"string\">\"&gt;xxx&lt;/span&gt;\"</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"new\"</span>:<span class=\"string\">\"&lt;span class=\"</span>new-word<span class=\"string\">\"&gt;yyy&lt;/span&gt;\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"attr\">\"age\"</span>:&#123;</span><br><span class=\"line\">            <span class=\"attr\">\"old\"</span>:<span class=\"string\">\"&lt;span class=\"</span>old-word<span class=\"string\">\"&gt;18&lt;/span&gt;\"</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"new\"</span>:<span class=\"string\">\"&lt;span class=\"</span>new-word<span class=\"string\">\"&gt;20&lt;/span&gt;\"</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"attr\">\"cart\"</span>:[</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"attr\">\"name\"</span>:&#123;</span><br><span class=\"line\">                    <span class=\"attr\">\"old\"</span>:<span class=\"string\">\"&lt;span class=\"</span>old-word<span class=\"string\">\"&gt;rice&lt;/span&gt;\"</span>,</span><br><span class=\"line\">                    <span class=\"attr\">\"new\"</span>:<span class=\"string\">\"&lt;span class=\"</span>new-word<span class=\"string\">\"&gt;banana&lt;/span&gt;\"</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"name\"</span>:&#123;</span><br><span class=\"line\">            <span class=\"attr\">\"old\"</span>:<span class=\"string\">\"&lt;span class=\"</span>old-word<span class=\"string\">\"&gt;aaa&lt;/span&gt;\"</span>,</span><br><span class=\"line\">            <span class=\"attr\">\"new\"</span>:<span class=\"string\">\"&lt;span class=\"</span>new-word<span class=\"string\">\"&gt;bbb&lt;/span&gt;\"</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<h3 id=\"css\"><a href=\"#css\" class=\"headerlink\" title=\"css\"></a>css</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;<span class=\"selector-tag\">style</span>&gt;</span><br><span class=\"line\">    <span class=\"selector-class\">.new-word</span>&#123;<span class=\"attribute\">background</span>:<span class=\"built_in\">rgba</span>(245,255,178,1.00)&#125;</span><br><span class=\"line\">    <span class=\"selector-class\">.new-word</span><span class=\"selector-pseudo\">:after</span>&#123;<span class=\"attribute\">content</span>:<span class=\"string\">' '</span>; <span class=\"attribute\">background</span>:<span class=\"built_in\">rgba</span>(245,255,178,1.00)&#125;</span><br><span class=\"line\">    <span class=\"selector-class\">.old-word</span>&#123;<span class=\"attribute\">text-decoration</span>:none; <span class=\"attribute\">position</span>:relative&#125;</span><br><span class=\"line\">    <span class=\"selector-class\">.old-word</span><span class=\"selector-pseudo\">:after</span>&#123;</span><br><span class=\"line\">        <span class=\"attribute\">content</span>: <span class=\"string\">' '</span>;</span><br><span class=\"line\">        <span class=\"attribute\">font-size</span>: inherit;</span><br><span class=\"line\">        <span class=\"attribute\">display</span>: block;</span><br><span class=\"line\">        <span class=\"attribute\">position</span>: absolute;</span><br><span class=\"line\">        <span class=\"attribute\">right</span>: <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"attribute\">left</span>: <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"attribute\">top</span>: <span class=\"number\">55%</span>;</span><br><span class=\"line\">        <span class=\"attribute\">bottom</span>: <span class=\"number\">30%</span>;</span><br><span class=\"line\">        <span class=\"attribute\">border-top</span>: <span class=\"number\">1px</span> solid <span class=\"number\">#000</span>;</span><br><span class=\"line\">        <span class=\"attribute\">border-bottom</span>: <span class=\"number\">1px</span> solid <span class=\"number\">#000</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&lt;/style&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"wrapper\"><a href=\"#wrapper\" class=\"headerlink\" title=\"wrapper()\"></a>wrapper()</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Funsoul</span>\\<span class=\"title\">Funcompare</span>\\<span class=\"title\">Funcompare</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$old = <span class=\"string\">'A tool compare text differences is funny'</span>;</span><br><span class=\"line\">$new = <span class=\"string\">'A tool that compare text differences'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$fc = <span class=\"keyword\">new</span> Funcompare();</span><br><span class=\"line\">$res = $fc-&gt;wrapper(<span class=\"string\">'['</span>,<span class=\"string\">']'</span>,<span class=\"string\">'&lt;'</span>,<span class=\"string\">'&gt;'</span>)-&gt;compareText($old, $new);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $res;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// A tool &lt;that&gt; compare text differences [is] [funny]</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"License\"><a href=\"#License\" class=\"headerlink\" title=\"License\"></a>License</h1><p>MIT</p>\n","categories":["技术"],"tags":["PHP","composer"]},{"title":"【funcipher】PHP密文定制工具","url":"http://funsoul.org/2018/02/04/【funcipher】PHP密文定制工具/","content":"<h1 id=\"funcipher\"><a href=\"#funcipher\" class=\"headerlink\" title=\"funcipher\"></a>funcipher</h1><p>Custom random ciphertext</p>\n<h1 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"Install\"></a>Install</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">composer require <span class=\"string\">\"funsoul/funcipher: 2.0\"</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"Usage\"><a href=\"#Usage\" class=\"headerlink\" title=\"Usage\"></a>Usage</h1><p>Global Variable</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CIPHER_USE_LOWER</span><br><span class=\"line\">CIPHER_USE_CAPITAL</span><br><span class=\"line\">CIPHER_USE_NUMBER</span><br><span class=\"line\">CIPHER_USE_SPECIAL</span><br></pre></td></tr></table></figure>\n<h3 id=\"create\"><a href=\"#create\" class=\"headerlink\" title=\"create()\"></a>create()</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Funsoul</span>\\<span class=\"title\">Funcipher</span>\\<span class=\"title\">Funcipher</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$cipher = <span class=\"keyword\">new</span> Funcipher();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $cipher-&gt;create(<span class=\"number\">10</span>);</span><br><span class=\"line\"><span class=\"comment\">// ,+T=!V67|E</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"ignore\"><a href=\"#ignore\" class=\"headerlink\" title=\"ignore()\"></a>ignore()</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Funsoul</span>\\<span class=\"title\">Funcipher</span>\\<span class=\"title\">Funcipher</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$cipher = <span class=\"keyword\">new</span> Funcipher();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $cipher-&gt;ignore([<span class=\"string\">'a'</span>,<span class=\"number\">1</span>,<span class=\"number\">3</span>,<span class=\"number\">5</span>,<span class=\"number\">7</span>])-&gt;create(<span class=\"number\">10</span>);</span><br><span class=\"line\"><span class=\"comment\">// w0/22S0i2~</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"Customize-code\"><a href=\"#Customize-code\" class=\"headerlink\" title=\"Customize code\"></a>Customize code</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Funsoul</span>\\<span class=\"title\">Funcipher</span>\\<span class=\"title\">Funcipher</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$cipher = <span class=\"keyword\">new</span> Funcipher();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $cipher-&gt;ignore([<span class=\"number\">1</span>,<span class=\"number\">3</span>,<span class=\"number\">5</span>,<span class=\"number\">7</span>])-&gt;create(<span class=\"number\">10</span>,[CIPHER_USE_NUMBER]);</span><br><span class=\"line\"><span class=\"comment\">// 4288062890</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"License\"><a href=\"#License\" class=\"headerlink\" title=\"License\"></a>License</h1><p>MIT</p>\n","categories":["技术"],"tags":["PHP","composer"]},{"title":"【字符编码】PHP导出CSV中文乱码问题研究","url":"http://funsoul.org/2018/02/02/【字符编码】PHP导出CSV中文乱码问题研究/","content":"<p>没有踩过字符编码问题的程序生涯是不完整的，还记得曾经还踩过Apache+PHP+MySQL的编码问题，不过那时候没总结下来，今天遇到了导出文件的编码问题，一起来好好研究一下:)</p>\n<p>推荐一下这篇文章<a href=\"http://cenalulu.github.io/linux/character-encoding/\" title=\"十分钟搞清字符集和字符编码\" target=\"_blank\" rel=\"noopener\">十分钟搞清字符集和字符编码</a>，可以快速了解一下字符编码的知识</p>\n<h3 id=\"业务背景\"><a href=\"#业务背景\" class=\"headerlink\" title=\"业务背景\"></a>业务背景</h3><p>把数据查询结果导出到CSV，由于Laravel Excel内部实现方法的问题，载入大数据量时，容易爆内存，因此这里分了两种实现，小数据量则采用Laravel Excel，大数据量则使用无缓冲查询+Yield，详情可参考这篇文章<a href=\"http://funsoul.org/2018/02/01/【Yield】大数据下的应用/\" title=\"【Yield】大数据下的应用\">【Yield】大数据下的应用</a></p>\n<p>由于使用了Laravel Excel工具集，先来看看这个工具内部是如何实现编码兼容的<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ..\\vendor\\maatwebsite\\excel\\src\\Maatwebsite\\Excel\\Writers\\LaravelExcelWriter.php</span></span><br><span class=\"line\"><span class=\"comment\"># 约347行</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_download</span><span class=\"params\">(Array $headers = [])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Set the headers</span></span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;_setHeaders(</span><br><span class=\"line\">        $headers,</span><br><span class=\"line\">        [</span><br><span class=\"line\">            <span class=\"string\">'Content-Type'</span>        =&gt; <span class=\"keyword\">$this</span>-&gt;contentType,</span><br><span class=\"line\">            <span class=\"string\">'Content-Disposition'</span> =&gt; <span class=\"string\">'attachment; filename=\"'</span> . <span class=\"keyword\">$this</span>-&gt;filename . <span class=\"string\">'.'</span> . <span class=\"keyword\">$this</span>-&gt;ext . <span class=\"string\">'\"'</span>,</span><br><span class=\"line\">            <span class=\"string\">'Expires'</span>             =&gt; <span class=\"string\">'Mon, 26 Jul 1997 05:00:00 GMT'</span>, <span class=\"comment\">// Date in the past</span></span><br><span class=\"line\">            <span class=\"string\">'Last-Modified'</span>       =&gt; Carbon::now()-&gt;format(<span class=\"string\">'D, d M Y H:i:s'</span>),</span><br><span class=\"line\">            <span class=\"string\">'Cache-Control'</span>       =&gt; <span class=\"string\">'cache, must-revalidate'</span>,</span><br><span class=\"line\">            <span class=\"string\">'Pragma'</span>              =&gt; <span class=\"string\">'public'</span></span><br><span class=\"line\">        ]</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    ...</span><br><span class=\"line\">    ..</span><br><span class=\"line\">    .</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>通过区分不同的文件类型设置$this-&gt;contentType，但是这里是用来设置浏览器下载的header的，并不是保存为服务器文件，继续找。</p>\n<h3 id=\"查看PHPExcel对CSV格式的兼容性实现\"><a href=\"#查看PHPExcel对CSV格式的兼容性实现\" class=\"headerlink\" title=\"查看PHPExcel对CSV格式的兼容性实现\"></a>查看PHPExcel对CSV格式的兼容性实现</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ..\\vendor\\phpoffice\\phpexcel\\Classes\\PHPExcel\\Writer\\CSV.php</span></span><br><span class=\"line\"><span class=\"comment\"># 约116行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">$this</span>-&gt;_excelCompatibility) &#123;</span><br><span class=\"line\">\tfwrite($fileHandle, <span class=\"string\">\"\\xEF\\xBB\\xBF\"</span>);\t<span class=\"comment\">//\tEnforce UTF-8 BOM Header</span></span><br><span class=\"line\">\t<span class=\"keyword\">$this</span>-&gt;setEnclosure(<span class=\"string\">'\"'</span>);\t\t\t\t<span class=\"comment\">//\tSet enclosure to \"</span></span><br><span class=\"line\">\t<span class=\"keyword\">$this</span>-&gt;setDelimiter(<span class=\"string\">\";\"</span>);\t\t\t    <span class=\"comment\">//\tSet delimiter to a semi-colon</span></span><br><span class=\"line\">    <span class=\"keyword\">$this</span>-&gt;setLineEnding(<span class=\"string\">\"\\r\\n\"</span>);</span><br><span class=\"line\">\tfwrite($fileHandle, <span class=\"string\">'sep='</span> . <span class=\"keyword\">$this</span>-&gt;getDelimiter() . <span class=\"keyword\">$this</span>-&gt;_lineEnding);</span><br><span class=\"line\">&#125; <span class=\"keyword\">elseif</span> (<span class=\"keyword\">$this</span>-&gt;_useBOM) &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// Write the UTF-8 BOM code if required</span></span><br><span class=\"line\">\tfwrite($fileHandle, <span class=\"string\">\"\\xEF\\xBB\\xBF\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>发现$this-&gt;_useBOM这个配置项，默认是没有开启的。查看使用LaravelExcel下载的CSV文件的BOM确实没有支持UTF-8</p>\n<h3 id=\"laravel-Excel配置开启use-bom\"><a href=\"#laravel-Excel配置开启use-bom\" class=\"headerlink\" title=\"laravel Excel配置开启use_bom\"></a>laravel Excel配置开启use_bom</h3><p>config/excel.php，设置csv的use_bom为true，默认为false</p>\n<h3 id=\"查看BOM\"><a href=\"#查看BOM\" class=\"headerlink\" title=\"查看BOM\"></a>查看BOM</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">]$ head -c 3 file | hexdump -C</span><br><span class=\"line\"></span><br><span class=\"line\">00000000  ef bb bf                                          |...|</span><br><span class=\"line\">00000003</span><br></pre></td></tr></table></figure>\n<p>找到问题的关键了，在需要写入文件前，添加UTF-8的BOM即可<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fwrite($fp, <span class=\"string\">\"\\xEF\\xBB\\xBF\"</span>); <span class=\"comment\">// 添加 UTF-8 BOM</span></span><br></pre></td></tr></table></figure></p>\n","categories":["技术"],"tags":["PHP","乱码"]},{"title":"【Yield】大数据下的应用","url":"http://funsoul.org/2018/02/01/【Yield】大数据下的应用/","content":"<p>继上一篇文章<a href=\"http://funsoul.org/2017/12/27/【重构Hue】大数据处理的一些总结/\" title=\"【重构Hue】大数据处理的一些总结\">【重构Hue】大数据处理的一些总结</a>后,引起了一些思考.上篇文章提出了在大数据查询的情况下,分次读取是一种方案,但是这种方案并不完善,接下来,看看这样的情况吧. :)</p>\n<h4 id=\"SQL子查询嵌套\"><a href=\"#SQL子查询嵌套\" class=\"headerlink\" title=\"SQL子查询嵌套\"></a><strong>SQL子查询嵌套</strong></h4><p>什么是SQL子查询？类似这样的:<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> * <span class=\"keyword\">from</span></span><br><span class=\"line\">    (<span class=\"keyword\">SELECT</span> user_id,<span class=\"keyword\">name</span>,age</span><br><span class=\"line\">     <span class=\"keyword\">FROM</span> <span class=\"keyword\">user</span></span><br><span class=\"line\">     <span class=\"keyword\">WHERE</span> age = <span class=\"number\">18</span>)a</span><br><span class=\"line\"><span class=\"keyword\">LEFT</span> <span class=\"keyword\">JOIN</span></span><br><span class=\"line\">    (<span class=\"keyword\">SELECT</span> user_id,good_id</span><br><span class=\"line\">     <span class=\"keyword\">FROM</span> cart)b </span><br><span class=\"line\"><span class=\"keyword\">ON</span> a.user_id = b.user_id</span><br></pre></td></tr></table></figure></p>\n<p>上面的SQL查询出”18岁的用户购买了哪些商品”,直接查询是没有丝毫问题的.但是如果在这条SQL的外层再加一层SELECT呢?比如这样:<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> * <span class=\"keyword\">from</span></span><br><span class=\"line\">\t(<span class=\"keyword\">SELECT</span> * <span class=\"keyword\">from</span></span><br><span class=\"line\">\t\t(<span class=\"keyword\">SELECT</span> user_id,<span class=\"keyword\">name</span>,age</span><br><span class=\"line\">\t\t <span class=\"keyword\">FROM</span> <span class=\"keyword\">user</span></span><br><span class=\"line\">\t\t <span class=\"keyword\">WHERE</span> age = <span class=\"number\">18</span>) <span class=\"keyword\">AS</span> a</span><br><span class=\"line\">\t<span class=\"keyword\">LEFT</span> <span class=\"keyword\">JOIN</span></span><br><span class=\"line\">\t\t(<span class=\"keyword\">SELECT</span> user_id,good_id</span><br><span class=\"line\">\t\t <span class=\"keyword\">FROM</span> cart) <span class=\"keyword\">AS</span> b</span><br><span class=\"line\">\t<span class=\"keyword\">ON</span> a.user_id = b.user_id) <span class=\"keyword\">AS</span> c <span class=\"keyword\">limit</span> <span class=\"number\">0</span>,<span class=\"number\">1000</span></span><br></pre></td></tr></table></figure></p>\n<p>或许你已经察觉到了什么,是的,这条SQL会引发错误（[HY000] : AnalysisException: duplicated inline view colum<br>n alias: ‘user_id’ in inline view ‘c’）</p>\n<p>也就是说,如果想要分次查询大数据,必须在原始SQL的基础上多加一层限制（查询区间）.而对于子查询来说,这样极容易造成错误.有人说了,使用者给SELECT加查询字段而不是*,或者给相同的字段加别名都可以避免这个问题,是的,你没说错.但是,既然原本的语句没有问题,为何要多写一个版本呢?给使用者也新增了工作量.</p>\n<h4 id=\"缓冲与无缓冲\"><a href=\"#缓冲与无缓冲\" class=\"headerlink\" title=\"缓冲与无缓冲\"></a><strong>缓冲与无缓冲</strong></h4><p>在技术角度,有没有查询大数据更好的方案,这值得思考,我们知道,查询分为缓冲与无缓冲,默认情况下,使用缓冲模式,这意味着查询结果会立即从数据库服务器转移到PHP,然后保存在PHP的内存中.这种模式有一定的好处</p>\n<ul>\n<li>计算行数</li>\n<li>移动(查找)当前的结果指针</li>\n<li>在处理结果集时对相同的连接发出进一步的查询</li>\n</ul>\n<p>缺点显而易见,遇到大数据查询,需要大量的内存.相对之下,无缓冲模式执行查询时返回一个资源句柄,然后等待数据库服务器的获取,在PHP进程内占用内存较少,但是缺点也是相对的</p>\n<ul>\n<li>维持资源句柄,增加服务器负载</li>\n<li>获得完整结果集前,无法对相同进一步连接发送查询</li>\n</ul>\n<p>因此,根据不同的业务场景可以选择.</p>\n<h4 id=\"odbc计算行数\"><a href=\"#odbc计算行数\" class=\"headerlink\" title=\"odbc计算行数\"></a><strong>odbc计算行数</strong></h4><p>刚开始,我找到了这个[odbc_num_rows]函数,后来发现,怎么查都是返回-1,看看手册才知道,</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">odbc_num_rows be reliable for INSERT, UPDATE, and DELETE queries only.</span><br><span class=\"line\">Using odbc_num_rows() to determine the number of rows available after a SELECT will return -1 with many drivers.</span><br></pre></td></tr></table></figure>\n<p>那么怎么得到SELECT返回的数据行数呢?接着看</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">best_odbc_num_rows</span><span class=\"params\">($r1)</span>  </span>&#123;</span><br><span class=\"line\">\tob_start(); <span class=\"comment\">// block printing table with results</span></span><br><span class=\"line\">\t$number = (int)odbc_result_all($r1); </span><br><span class=\"line\">\tob_clean(); <span class=\"comment\">// block printing table with results</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> $number;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>哈哈,是不是相当机智:)</p>\n<h4 id=\"PDO查询每条记录最后几个字段为null\"><a href=\"#PDO查询每条记录最后几个字段为null\" class=\"headerlink\" title=\"PDO查询每条记录最后几个字段为null\"></a><strong>PDO查询每条记录最后几个字段为null</strong></h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$pdo = <span class=\"keyword\">new</span> \\PDO($dsn, $username,$password);</span><br><span class=\"line\">$pdo-&gt;setAttribute(\\PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">$result = $pdo-&gt;query($sql);</span><br></pre></td></tr></table></figure>\n<p>类似这种情况：<a href=\"https://stackoverflow.com/questions/22197884/pdo-select-fetch-last-columns-as-null\" target=\"_blank\" rel=\"noopener\">https://stackoverflow.com/questions/22197884/pdo-select-fetch-last-columns-as-null</a><br>一直找不到原因,可能是bug,也可能是用的姿势不对吧</p>\n<h4 id=\"Yield生成器\"><a href=\"#Yield生成器\" class=\"headerlink\" title=\"Yield生成器\"></a><strong>Yield生成器</strong></h4><ul>\n<li>PHP5.5开始支持</li>\n<li>是一个函数,返回值依次返回.更方便的实现Iterator接口</li>\n<li>可中断的函数,为了继续执行生成器中yield后的代码,你就需要调用$range-&gt;next()方法.这将再次启动生成器, 直到下一次yield语句出现.因此,连续调用next()和current()方法, 你就能从生成器里获得所有的值, 直到再没有yield语句出现.</li>\n</ul>\n<p>从数据库服务器到PHP进程,如果直接放进内存中,很容易造成内存不够,比如下面的代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$rs = odbc_exec($conn, $sql);</span><br><span class=\"line\"><span class=\"keyword\">while</span> ($row=odbc_fetch_array($rs)) &#123;</span><br><span class=\"line\">    $result[] = $row;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>那么,可不可以一点一点的取出来呢？Yield可以做到,<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">query</span><span class=\"params\">($conn, $sql)</span></span>&#123;</span><br><span class=\"line\">\t$rs = odbc_exec($conn, $sql);</span><br><span class=\"line\">\t<span class=\"keyword\">while</span> ($row=odbc_fetch_array($rs)) &#123;</span><br><span class=\"line\">\t    <span class=\"keyword\">yield</span> $row;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>然后,在需要的地方进行迭代<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">foreach</span>(query($conn, $sql) <span class=\"keyword\">as</span> $row)&#123;</span><br><span class=\"line\">\t<span class=\"comment\">// 业务处理</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>如果需要把数据导出到文件,不建议直接写文件,细想一下很容易明白,生成器是逐条返回的,如果逐条写入文件,那么频繁的打开关闭文件,性能消耗巨大,这时候可以使用一个$bucket装起来,达到一定数量后才做写文件操作.</p>\n<p>Yield在这篇文章中仅当生成器来用,我们知道,它的另一个概念【协程】更有意思,值得深入研究 :)</p>\n<h4 id=\"协程\"><a href=\"#协程\" class=\"headerlink\" title=\"协程\"></a><strong>协程</strong></h4><ul>\n<li>抢占式（操作系统控制、目前大多数操作系统，防止恶意程序占用）</li>\n<li>协作式（程序主动控制）</li>\n<li>协程的支持是在迭代生成器的基础上, 增加了可以回送数据给生成器的功能(调用者发送数据给被调用的生成器函数). 这就把生成器到调用者的单向通信转变为两者之间的双向通信.</li>\n</ul>\n<p>这里引用一下鸟哥的例子做简单的探讨,详情可以看看【<a href=\"http://www.laruence.com/2015/05/28/3038.html\" title=\"在PHP中使用协程实现多任务调度\" target=\"_blank\" rel=\"noopener\">在PHP中使用协程实现多任务调度</a>】<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">gen</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    $ret = (<span class=\"keyword\">yield</span> <span class=\"string\">'yield1'</span>);</span><br><span class=\"line\">    var_dump($ret);</span><br><span class=\"line\">    $ret = (<span class=\"keyword\">yield</span> <span class=\"string\">'yield2'</span>);</span><br><span class=\"line\">    var_dump($ret);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">$gen = gen();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 1、接收第一个yield返回的值</span></span><br><span class=\"line\">var_dump($gen-&gt;current());    <span class=\"comment\">// string(6) \"yield1\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 2、发送值回去给第一个yield并替代，执行到第二个yield，进行接收</span></span><br><span class=\"line\">var_dump($gen-&gt;send(<span class=\"string\">'ret1'</span>)); <span class=\"comment\">// string(4) \"ret1\"   (the first var_dump in gen)</span></span><br><span class=\"line\">                              <span class=\"comment\">// string(6) \"yield2\" (the var_dump of the -&gt;send() return value)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 3、发送值回去给第二个yield并替代，没有返回</span></span><br><span class=\"line\">var_dump($gen-&gt;send(<span class=\"string\">'ret2'</span>)); <span class=\"comment\">// string(4) \"ret2\"   (again from within gen)</span></span><br><span class=\"line\">                              <span class=\"comment\">// NULL               (the return value of -&gt;send())</span></span><br></pre></td></tr></table></figure></p>\n","categories":["技术"],"tags":["PHP","大数据"]},{"title":"拍一个视频作为2018的开始也不错","url":"http://funsoul.org/2018/01/17/拍一个视频作为2018的开始也不错/","content":"<p></p><h3>从零开始</h3><br>那天项目组开会，把今年（2018）年会MV的导演交给我做。本来我对自己并没有信心，看电影我就懂，真叫我制作一部电影（拍一部3分钟的MV），我完全没有头绪啊。况且珠玉在前，看了去年夺冠的MV，压力非常大。当时想的也是推脱，感觉接不下这个担子。但是，我最后还是接下了，我至今还记得大家看着我的表情，忘记是谁说的一句话了，“<strong>一个人说你行，或许还差一点，一群人说你行，那就是行</strong>”。<p></p>\n<p></p><h3>写个剧本</h3><br>前前后后想了4个剧本，<p></p>\n<ol><br>     <li>类似生活大爆炸的情景剧，大家一起聊科技，头脑风暴</li><br>     <li>访谈类节目，聊聊每个人对明朝的情感</li><br>     <li>逗比类，恶搞</li><br>     <li>去年冠军MV的续篇，刚好去年的男主角在</li><br></ol><br>真正成型的只有2和4，但是大家对2不是很感冒，最后选择了4，毕竟在游戏行业，大家都有一颗玩心:)但是正如前面说的，且不说超越去年，如何能做一个和去年不差多少的作品，真的很难呐~<br><br>剧本描述的是，相较去年男主一人拯救世界，今年的男主学会了团队作战，其实这也是现今电影的基调，团结这个命题永远都不会旧。在寻找伙伴的路上，发生了很多有趣的事情:)<br><h3>开拍了</h3><br>剧本写好了，大家也喜欢这个想法。那就开搞吧，拍电影要怎么拍？设备？道具？地点？<br><h4>设备</h4><br>听说公司有DV，那时候其他组（大概8个组）都还没想好剧本。我想，如果都用这个DV拍，那不是抢破头，果断先借了（最后我们用了两周），很机智。<br><h4>道具</h4><br><ol><br>     <li>一把USP水弹枪</li><br>     <li>4个3D眼镜（没借到墨镜，没想到3D眼镜的效果也不错）</li><br></ol><br>是的，没了。<br><h4>地点</h4><br><ol><br>     <li>会议室</li><br>     <li>11楼楼顶（上面风景非常好）</li><br>     <li>楼下门口</li><br></ol><br><h4>一台设备</h4><br>因为我们只有一台DV，要想拍出多机位的效果，必须分开来拍，这时候很考验拍摄的角度，场景的连接，演员的连贯性。<br><h3>忙</h3><br>大家都太忙了，拍摄过程基本利用中午和晚上的一点点时间，基本几个镜头就过。不过，特别感谢大家的极力配合，基本都能按照我的想法拍出来了。<br><h3>回到起点</h3><br>所有视频片段基本拍完了，到了最头疼的部分，视频制作。脑子里全是问号，一个视频是怎么剪辑在一起的？怎么加特效？文字？片头呢？配音？我们的剧本里是有一个高科技片段的，可以说，那一刻，我完全没有头绪。部门里其他人也表示爱莫能助，难道要请外援？或者更糟糕，放弃这个剧本。<br><h3>走走看</h3><br>我也不知道当时我是怎么想的，竟然冒出一个念头【学做视频】。现在我知道为什么了，或许，这就是我们做技术的初心【迎难】。写这篇文章的时候，我想到一个更好笑的说法，“<strong>技术部门拍视频不需要演技，只需要特效</strong>”，哈哈。<br><h4>PR</h4><br>是的，我开始学习了，第一个学的是PR，到网上找了2017 cc 绿色版，在<a href=\"http://doyoudo.com/p/5001015.html\" target=\"_blank\" rel=\"noopener\">doyoudo</a>看了8个基础视频，了解软件的大概功能，能做啥，制作流程，导入导出，简单的效果制作。我开始把片段连接起来，加一点过度效果，加一点音乐，屏蔽掉水印（网上下载的视频经常有水印），看这个<a href=\"https://www.bilibili.com/video/av11531776/\" target=\"_blank\" rel=\"noopener\">视频教程</a>。<br><br><strong>PR就像一条时间线，横向的，连接起每个片段，有层级关系，上层优先级大于下层（上面的元素会覆盖下面的）</strong>。<br><br>2017版的字幕和以前的不一样，看这个<a href=\"http://tieba.baidu.com/p/5090158850?traceid=\" target=\"_blank\" rel=\"noopener\">介绍</a>。字幕切记最后加，否则，当视频片段需要增删时会非常痛苦，要重新排时间帧。<br><h3>颜色</h3><br>颜色的搭配对我来说是个头疼的事情，推荐这个<a href=\"https://coolors.co/\" target=\"_blank\" rel=\"noopener\">coolors</a>。<br><h3>AE</h3><br>是的，在学习PR一周后，我开始学习AE了，也是找了2017绿色版，也是去<a href=\"http://doyoudo.com/p/5001016.html\" target=\"_blank\" rel=\"noopener\">doyoudo</a>看了8个基础视频，不过，这次看完后还是有点懵，不知道关键帧是什么鬼，为什么可以控制元素的移动，我又去看了几个AE的视频，学学其他效果怎么做的，有个模糊的认识，似懂非懂的状态，我不想浪费时间在学习上，找了个<a href=\"https://www.bilibili.com/video/av6241485/\" target=\"_blank\" rel=\"noopener\">钢铁侠触屏特效</a>学着做，有点感觉了。但是，如果按照这样子，每个视频、图片、特效都自己创造出来，我的特效遥遥无期啊，何年何月才能做出来呢。于是我想了个好办法，把别人做好的特效裁下来，贴上去不就好了（手动点赞）。<br><h4>视频抠像</h4><br>当时不知道原来做特效是这样的，拍的片段做起来有点难度，别人做的特效都是面向镜头的，我拍的是背对镜头，什么意思？意味着，我需要把人物扣出来，然后叠加到特效的上层，这里就涉及到抠像，推荐这个<a href=\"https://www.bilibili.com/video/av9643829/\" target=\"_blank\" rel=\"noopener\">视频</a>，使用roto笔刷一帧一帧的扣……是的，这个工作量比较大，不过幸好，这是有智能识别的，一般上一帧和下一帧差别不大的话，基本不用修改，而且我拍的片段不是很长，按照一秒25帧来扣的话，几秒钟的片段也不需要太久，当然了，如果要做的好一点，这是个体力活，需要细致一点。<br><br>使用的过程中有些体会，<strong>如果PR是横向的，那么AE就是纵向的</strong>。每一帧的层级关系决定了特效的效果，和之前一样，也是上层优于下层。<br><h4>视频转换工具</h4><br>AE的导出的视频非常大，一个9s的视频就要1G，AVI格式，这时候可以使用格式工厂转换成MP4，你会发现，也就几M:)<br><h3>音乐</h3><br>音效推荐网站，<a href=\"http://sc.chinaz.com/\" target=\"_blank\" rel=\"noopener\">站长之家</a><br><br>网易云音乐<br><h3>后记</h3><br><ol><br>     <li><a href=\"https://pan.baidu.com/s/1smaZUEh\" target=\"_blank\" rel=\"noopener\">视频传送门</a>，密码：xefl</li><br>     <li>电影工作者真是一个好开心的工作:)</li><br></ol>","categories":["技术"],"tags":["有趣","视频处理"]},{"title":"【PHP-ML】使用Apriori算法挖掘用户购物习惯","url":"http://funsoul.org/2018/01/12/【PHP-ML】使用Apriori算法挖掘用户购物习惯/","content":"<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/vendor/autoload.php'</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Phpml</span>\\<span class=\"title\">Association</span>\\<span class=\"title\">Apriori</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 4位用户购买清单</span></span><br><span class=\"line\">$samples = [</span><br><span class=\"line\">    [<span class=\"string\">'啤酒'</span>, <span class=\"string\">'尿布'</span>, <span class=\"string\">'儿童玩具'</span>],</span><br><span class=\"line\">    [<span class=\"string\">'尿布'</span>, <span class=\"string\">'儿童玩具'</span>,<span class=\"string\">'笔记本电脑'</span>],</span><br><span class=\"line\">    [<span class=\"string\">'啤酒'</span>,<span class=\"string\">'耳机'</span>, <span class=\"string\">'唇膏'</span>],</span><br><span class=\"line\">    [<span class=\"string\">'啤酒'</span>,<span class=\"string\">'唇膏'</span>, <span class=\"string\">'高跟鞋'</span>]</span><br><span class=\"line\">];</span><br><span class=\"line\">$labels  = [];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\"> * Apriori 参数</span></span><br><span class=\"line\"><span class=\"comment\"> * support支持度</span></span><br><span class=\"line\"><span class=\"comment\"> * confidence 自信度</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\">$associator = <span class=\"keyword\">new</span> Apriori($support = <span class=\"number\">0.5</span>, $confidence = <span class=\"number\">0.5</span>);</span><br><span class=\"line\">$associator-&gt;train($samples, $labels);</span><br><span class=\"line\"></span><br><span class=\"line\">$res = $associator-&gt;predict([<span class=\"string\">'啤酒'</span>]);</span><br><span class=\"line\">print_r($res);</span><br><span class=\"line\"><span class=\"comment\">// Array([0] =&gt; Array( [0] =&gt; 唇膏) )</span></span><br></pre></td></tr></table></figure>\n<p></p><h1>实践</h1><br>数据挖掘是从一个数据集中提取信息，并将其转换成可理解的结构，以进一步使用。本次实践模拟用户购买的商品清单，提取关联性，最后根据用户购买欲望推荐关联商品。该实例告诉我们，买啤酒的人想去买唇膏。<p></p>\n<p></p><h1>总结</h1><br><strong>定律</strong><p></p>\n<p><strong>1、如果一个集合是频繁项集，则它的所有子集都是频繁项集。</strong></p>\n<p>频繁项集的意思是，假设集合{‘啤酒’, ‘尿布’}是频繁项集，那么其中的‘啤酒’、‘尿布’同时出现在一条清单记录中的次数是大于或等于最小支持度的（构造参数中的support），则该集合的子集{‘啤酒’}、{‘尿布’}也必定大于或等于support，也就是说，它的子集也都是频繁项集。</p>\n<p><strong>2、如果一个集合不是频繁项集，则它的所有超集都不是频繁项集。</strong></p>\n<p>结合第一定律，反之亦然，如果集合{‘啤酒’}不是频繁项集，那么它的超集{‘啤酒’, ‘尿布’}也不是频繁项集。</p>\n<p>&nbsp;</p>\n<p>可以通过<span style=\"color: #ff0000;\">apriori</span>方法获取所有的频繁项集。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$res = $associator-&gt;apriori();</span><br><span class=\"line\">print_r($res);</span><br><span class=\"line\"><span class=\"keyword\">Array</span></span><br><span class=\"line\">(</span><br><span class=\"line\">    [<span class=\"number\">1</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">    (</span><br><span class=\"line\">        [<span class=\"number\">0</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 啤酒</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [<span class=\"number\">1</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 尿布</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [<span class=\"number\">2</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 儿童玩具</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [<span class=\"number\">5</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 唇膏</span><br><span class=\"line\">        )</span><br><span class=\"line\">    )</span><br><span class=\"line\"></span><br><span class=\"line\">    [<span class=\"number\">2</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">    (</span><br><span class=\"line\">        [<span class=\"number\">2</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 啤酒</span><br><span class=\"line\">            [<span class=\"number\">1</span>] =&gt; 唇膏</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [<span class=\"number\">3</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 尿布</span><br><span class=\"line\">            [<span class=\"number\">1</span>] =&gt; 儿童玩具</span><br><span class=\"line\">        )</span><br><span class=\"line\">    )</span><br><span class=\"line\">    [<span class=\"number\">3</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">    (</span><br><span class=\"line\">    )</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<h3>关联规则（为什么买啤酒的人想去买唇膏？）</h3>\n\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取生成的关联规则</span></span><br><span class=\"line\">$rules = $associator-&gt;getRules();</span><br><span class=\"line\">print_r($rules);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Array</span></span><br><span class=\"line\">(</span><br><span class=\"line\">    [<span class=\"number\">0</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">    (</span><br><span class=\"line\">        [antecedent] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 啤酒</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [consequent] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 唇膏</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [support] =&gt; <span class=\"number\">0.5</span></span><br><span class=\"line\">        [confidence] =&gt; <span class=\"number\">0.66666666666667</span></span><br><span class=\"line\">    )</span><br><span class=\"line\">    [<span class=\"number\">1</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">    (</span><br><span class=\"line\">        [antecedent] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 唇膏</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [consequent] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 啤酒</span><br><span class=\"line\">        )</span><br><span class=\"line\">    </span><br><span class=\"line\">        [support] =&gt; <span class=\"number\">0.75</span></span><br><span class=\"line\">        [confidence] =&gt; <span class=\"number\">1</span></span><br><span class=\"line\">    )</span><br><span class=\"line\">    [<span class=\"number\">2</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">    (</span><br><span class=\"line\">        [antecedent] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 尿布</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [consequent] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 儿童玩具</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [support] =&gt; <span class=\"number\">0.5</span></span><br><span class=\"line\">        [confidence] =&gt; <span class=\"number\">1</span></span><br><span class=\"line\">    )</span><br><span class=\"line\">    [<span class=\"number\">3</span>] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">    (</span><br><span class=\"line\">        [antecedent] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 儿童玩具</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [consequent] =&gt; <span class=\"keyword\">Array</span></span><br><span class=\"line\">        (</span><br><span class=\"line\">            [<span class=\"number\">0</span>] =&gt; 尿布</span><br><span class=\"line\">        )</span><br><span class=\"line\">        [support] =&gt; <span class=\"number\">0.5</span></span><br><span class=\"line\">        [confidence] =&gt; <span class=\"number\">1</span></span><br><span class=\"line\">    )</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<p>可以通过<span style=\"color: #ff0000;\">getRules</span>方法获取生成的关联规则。由上可知，一共生成了4组关联，每一组有4个属性，意思很明确，</p>\n<p>从以上的购物清单可知，存在4组关联，</p>\n<p><ul><br>     <li>买啤酒会去买唇膏</li><br>     <li>买唇膏会去买啤酒</li><br>     <li>买尿布会去买儿童玩具</li><br>     <li>买儿童玩具会去买尿布</li><br></ul><br>因为我们输入了“<strong>啤酒</strong>”，所以，推荐给我们“<strong>唇膏</strong>”。</p>\n<p></p><h3>大数据挖掘存在的局限</h3><br>wiki：<p></p>\n<p><blockquote>先验算法采用<a title=\"广度优先搜索\" href=\"https://zh.wikipedia.org/wiki/%E5%B9%BF%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2\" target=\"_blank\" rel=\"noopener\">广度优先搜索</a>算法进行搜索并采用<a title=\"树 (数据结构)\" href=\"https://zh.wikipedia.org/wiki/%E6%A0%91_(%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84)\" target=\"_blank\" rel=\"noopener\">树</a>结构来对候选项目集进行高效计数。它通过长度为<img src=\"https://wikimedia.org/api/rest_v1/media/math/render/svg/21363ebd7038c93aae93127e7d910fc1b2e2c745\" alt=\"k-1\">的候选项目集来产生长度为<img src=\"https://wikimedia.org/api/rest_v1/media/math/render/svg/c3c9a2c7b599b37105512c5d570edc034056dd40\" alt=\"k\">的候选项目集，然后从中删除包含不常见子模式的候选项。根据<a title=\"向下封闭性引理（页面不存在）\" href=\"https://zh.wikipedia.org/w/index.php?title=%E5%90%91%E4%B8%8B%E5%B0%81%E9%97%AD%E6%80%A7%E5%BC%95%E7%90%86&amp;action=edit&amp;redlink=1\" target=\"_blank\" rel=\"noopener\">向下封闭性引理</a>,该候选项目集包含所有长度为<img src=\"https://wikimedia.org/api/rest_v1/media/math/render/svg/c3c9a2c7b599b37105512c5d570edc034056dd40\" alt=\"k\">的频繁项目集。之后，就可以通过扫描交易数据库来决定候选项目集中的频繁项目集。</blockquote><br>在写demo的过程中也发现了这个问题，当商品数量多，清单条数大，生成的候选项集非常多，在筛选效率上存在一定的局限性。这时候或许就要选择别的算法了：）</p>\n","categories":["技术"],"tags":["PHP","学习笔记","PHP-ML","机器学习"]},{"title":"【PHP-ML】使用最小二乘法预测天气信息","url":"http://funsoul.org/2018/01/08/【PHP-ML】使用最小二乘法预测天气信息/","content":"<p></p><h3>项目地址</h3><br><a href=\"https://github.com/funsoul/php-ml/blob/master/LeastSquares.php\" target=\"_blank\" rel=\"noopener\">Github</a><p></p>\n<p></p><h3>训练数据</h3><br><a href=\"https://www.keyunzhan.com/lishitianqi/\" target=\"_blank\" rel=\"noopener\">客运站网</a>的历史天气信息<p></p>\n<p></p><h3>采集工具</h3><br><a href=\"https://querylist.cc/\" target=\"_blank\" rel=\"noopener\">QueryList</a><p></p>\n<p></p><h3 style=\"font-family: arial, helvetica, sans-serif; font-size: 12pt; color: #000000;\"><strong>output</strong></h3><p></p>\n<div style=\"font-family: arial, helvetica, sans-serif; font-size: 12pt; color: #000000;\"><img id=\"DWT170\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACQCAYAAACRfFAzAAAP3klEQVR4Ae1dTWrrsBb+3uPtwi30jr2AkMEFd+6hJ6XQDcRDQ6ALKAQyTDZQMJ14mPkVdFC8gIxv4dbryEOS5Z84ju3EsaXkFIodS5aPPn0+PpKOjv4DYAf6IwQMQ+C/VXlt+CEDC33Y1US6QghogUCVuO4LvJ8YsTXFY4m5LhaMYeGmxGYMjIXwszxN6QDcBZi4j9/L/xdwBQyyzDAvLAPH9kPxEmUX6IQQAFAhrvt7gvhzjs/YgvciaVVEahK8Am8OHGeGKCmmyPOj6X/fMXP4ver+CZ4EWbdYfcSwvJeUyKpcFy+ehfhjpS7QkRDIEOA2rvy3/V0Y+jub/+bnbLFzVRrc3YKx3cJN82bX1e+mdJUvP7oLtmMLN32+vfNDtgt9O5PH9sMdU/JUnpeXk8lPeTLsrh2Tksa1H6fA1x9sOae3f/CVKI2YkfzMk6KZwRBMisXta10bj1OpbYU8xax0fvMI/C9HQBLFstZgXn4V00fYq60kc+Fy91NO2jW8nyWc54243V0wBMWCNu+IntbCfNh8v8BDhJnMWsxF54QAcuKKTllOKokN73AFeHFXmJ9NoF+4t4Dk628Ku42HOwA/xVaQWtcLXhEmXNvOe3hhiuXT+bUgkJkK/hPvlO2zc4PPGJj8rnbSugOwwXzJO2DrdEThFfiIkEwCsEWhfK51EwsWIrzvi9P9oXTHFSOgmUHfvZN37R0Rql+1I55pXF1eTNt/wiQhbatLe+gqR27jjiyh6KiJUYYYS2dFtu3I7WHC42tMBTmuykpjuVWVTZ8xwmQkDhwAXkw+FCcHDuShwf6aF56wGojI+0BXZ7AGEoSIQMqgNQeqnTM+nmvF+FjRfJUJdt6tylghLneyQfwJGkK9VUqYUe8KcbnYyT81u2VGJUjK20PgIHFvDwaqsWkIHCSudf/LtHqQvDeGQIW4G+mcsOfQfWOoUHW1R6BCXAgnl779cLXHgQQ0EIEDY2fS0SVfnbA/1ku/aWx7dA7UCUBTvkTOOm6Mf/0/aeMY+KEgkW8ZAW28w7JGsH2Eaw+WupBEmD238RZLlwblNyKaPYMmABWQ13c8YOOO+CmorC4uyyJWBjO2Y/w/WyFczgOxIjnc+fb+9XF/l2Rn5RXNmVniLkTd6ldTj1uHTM6R/Sqqowoav5g8OEhwF6WxGWaI7gIcCiKibRU+l2lMCQfOLAK8NdSqJRH4hAdJ+Q3E2lZAH8EMIm4eHES6/+wvZ78sqJxY574km03BA0Qs/wfuHmQooO3qWZJ6/nnZilxJ6eYQ137AHWKU1nP+/YcEd0jb/qJNwon1hlex0PNcAktB5arnn2/ywjul4fTrnNXV4td93mFTebbf+IEHMUN9Zvtzjbr2sp6deoI4JtEMzzy2BNeKKx4Cjcc9A9T1UuZWP3hHMsAdL7eghFvdSpkEAuYQV2jX+3KzCS2cIAvVUE7t9EuRss1Nm7kj3D5PI7Ac/Zh+yZehzfMoTxUBc4ibalce4iEzFYUW/kEfX9s2GlfBpxZ2co3rzLuoekna+w+HNK0C88SjOcTFBu/RE9ZPPuwNH9e1wYOYcPL08bVto3EVubsTVraOu1hTWKkTibp/m0HEhbAxl/cMaxXcLF7CGWiGgZP2FW9wnC4atgi3C764BPBy+bnTfmo/q5ciuyNgYDywWusJmOzOmzkxagKi3QA4dxLSbwKinew0wdAGJ0017gQBSyM5ttY41Snffzeje26vouRkc3ttfhU11k/jkpPNVRBriEqYZeO2ckLR08YlJ5v+7Hdjpnx5r1vs1GOyEwo52fSmiI0hrhhn5bv1jOSEwl+cc30UyMmmN95Wt4vqr+jrKom/OORko0+b6tc5GwmbygRAQQ41SaBm107zUSgUyGf9yMmmCEjncyJuCpkiZRsEycmmDUqXzUPETfFto3FVU5CTjUJivCMRN8W+jcZV5CYnm/EIq55sDHEVaZTgGNgJhT+fnGwy9LU4MWsCotXqUj0nINo4j1CedpMUmmpccrLRQqVpLAQ52WjcOCRaPQL6aVxysqlvLUrJENCPuEI0vknfvLIkRw1DKenVxID8vcXq2cFK/OCbZz+pbNocj8sPvnwYLBDLJKTMfIXH+bt/a1P/vgUxpnPmum4ua7oX2+FQRXp2ztrLzzsovA41YZpadVDbdXJM7Qwa42TD39ZjTip9v8375fHhsEs62ew/D/iLf0n1Kl2RCBhF3HKjDRsJZnAnG/sRU9pvrtzkhV+a2rgFCQ+e9u+kUpngKDxX2dJqdu2STja5HZyIMKl9LL0vVOWqTnO7UQfbqSHMKNBmy9ZhbFy1oiH07Q4YtpGfbNwm29swjXu5SDBtNK5SV0ordvdZ6CJ/GgClj8BoSvArOhpF3EtGglFmwLG2VeTuTlhZajf5ZVjVJKJdPg+1iUHEPR4J5lDl+rzGSXtJJxsuq3oxMrkHjNSTPdOgkw722QBjg402bhsZhrFxm+wwSm/TVqfl0VTjkpONQYpvFFHJyWYU2Omh5yKgn8YlJ5tz2/Qm7tePuAL2w042x51QrsDJhtc9dbSJlw7Iv6b+HTRrynczz7dbcpaIJ7RdVH3TXneKWcQttcWwTih8qOqSTjZiHHnESD0laA34YS5xB3ZCGdzJxgDyjCmipjZuPSRquhXo1wmlMvhfEGFIJ5vCY+m0AQFDJyCOOVoPMwFxGScbWa/DDvKnDdZf40SIcRo3fwn7dUJpo3HVs5XW7+6z0MXJRj2NjocQMJi4/Tqh6Odkc6i56JpCwCjiVrTigE4o/NmXdLKp1G3gSD2KECYdDbVxj9l7w9i412g7mlInTTUuOdmYpPnGkJWcbMZAnZ55NgL6aVxysjm7UW+lAPNs3KPBQLjtq7GN27DdlRobZoztGG3rWstNA6d8bfivHizD1AofNWja7ornCe4izLjPguNgFgHei2tYTYcR1zji2v4rpl9LRANHeeGkOsfJprUTzc83Tt2ffRjK6PEUs4hr+3idfuFtNfzK1/6dbKoE2K4+hKsmYwu47gLr6Rdm5JRbBQqAfp2zg2Lyi9xEmOLr7Rlb2HiszXdaQmUCoFBM/042hcJLp9JVc2JNEAQAEtr/vQRP4YcxxJUmwhueL/QdbTPlq3A7b7soVUr1yOMuTL9mcFa8ktKvYR0Cs+cVmQ97cBlCXBuPUwuWtQbzCjUIGMKHGZ5FQxeun3DaRuOqYk93slElHDrKuBE/n+rN3GL1FmG6nuLRXmGrLh+69QavGULc4noy3kq5l1VfJmAbjavI3d0rrA2zpJng/XZ5PFVxg/04hYUffBNpKwAaQtyK3INf4KQ9x8lGkT4TvOJEw1/OJe5ZAMa4gcv/ahaNpqm3fqgd5B3F4YIi2ejVHjpE8Dwgg6Yal5xsbl2bNtWfnGyaEKJ0LRHQT+OSk42WRNFNKP2IKxCq65TwbaACFDZUgpocAIojD3puFyWqdjRSzbH66UadceXRlLjHQKkj9bF7xk/LRhXiGPFRccys39EqXSDRLF+FCwDQtkhOvEGcbNoKdOP5DCSuHHHgLoKLAT3+hnCykVwcp36mvQeGmQobzJ10AyVhKzIs0E9Uw+xTfqAFlR2tZtf4lC9jKNjXB2466dLl6neSOBrfZBhxC0hu5lj+ZggKU6SF1M6nipRtbryUk03p2T3Xr1T2Ffwwl7g9g99G46pHXsbJRpVOxzYImEtc28fTBIiX/ey92EbjKnJfxslmr7l6rt9e6cb/NIu4e5MTnEB9eYc1tSQn7WWdbMR+UQjX+Xq6IevXVH8d0/Vy6iAnG73a44CDyyjOV3tyaKpxyclGRw2nk0zkZKNTa5AsrREoTEDweXIGNuSofmsxKSMhUEWgZFPJSCqLnbtnU+hg15AMxyJU3lxatcK2H+5Y6O9sIm/ppaYXp8qVsTApmAq5KhaBKSwPFP0nx4TO9ELgIHGBDT5jYMKnU+mPENAQgRriAn//DRycS0NwSCR9Eaglrr4ik2SEAFBL3F/3pgXypOa8JQRqiCvDAcWf/Tiw3BKgVNdhEDhIXNt/wiSJ8E68HaYV6CknIVAaq6QJCH3GKscaIzXkuaqh5B6ybOGWiGxIJUjmG5ssIiebkz5SdNPYCBy0cccWip5PCDQhQMRtQojStUSAiKtls5BQTQgQcZsQonQtESDiatksJFQTAkTcJoQoXUsEiLhaNgsJ1YQAEbcJIUrXEgEirpbNQkI1IUDEbUKI0rVEgIirZbOQUE0IEHGbEKJ0LREg4mrZLCRUEwJmE5dHb2QL0Frkpma+vnSziWtie/AtAGr3r0jDYPFQWOn/ORummAhPW5kHjtYo9/HCsp99G9pWUod8Kig0aLuoXpqjoHHl285j3snNOdK3fi8IHm8ApQ1Y8TMtPtustKWSzCs/5bJMubnehO8cnmqUveIbKmXDDwv3Pu5lT7WZKjuXT953SHsJGUMf9l5R9T+VDN1MFBHx3HHgzD/ri6aUTgiky17SpTuM7RZueTmP+i1iirE8IF4lxpgIypzeL87DnW+rsvhRPkOV13VZkFgPV4hpVlkfZ9uFeGf2zg/ZLvRtWT93sWMF2eWzT5FHllstq1jPY+fHnpm3ASu1w7HybjOtoHEl2ePSZ/wv8oA2Nh6nFpLoHWrx7/bPFxLrHr/Ue7Jd4S1KMAlChK8eEL1htVWJ5x7TJfMfK6giN+8RSvF2ttssjW+R+v0DWPepdJt3RMkET36uW09bzSy3XnWceYbDuTXL7+fbRTlw+P8yBv8ydfsi5SVd+1mFuPUV/gUeI8Ty1tlnnon9Cu7wkHMB29UbosSChQhv/bEWsB9whwT//tZLCKjPuDQnguKmv3yv348YlveSjkLIFzEuvAjHSh48jW8XRfHbamHv0DmT2vfua4bnI4S0/Vd4PzHiiYf14hvOULuLCNKu4f0s4TzLb4LY1qlYda51n9ZC626+X+Ahwkx9Por56Fx7BDpo3C3+fCWwvFcUvrblCroLrL0fLOdzzGcRkkmw96lLyV9U0eUS6n9t/+ArseBlsU9dLAo71ADyi5BkKtnGw91+cUrrviJ8muA0bau0erfO2b4kjb/VdlEUTeggVB00LsB7xjOEWK8ZvKy4BNHsGSv4CIMJuI0slJiwd6dYczst27ZUEscL1mBpAWq70ay42hNuWy5xzwIwFgCIsZxFuFvfp3dsMF/+BsvKThAtIyRBALZArvlTrcu17duA2jYbDlP14yMrvBpJhNlzarePuB2WEsuk440F0zjWq7/NHnrX0R0d8ncwFUx6F+tlPW0kob48ShkHgU6mwjgi9vNUtf+uMDGcfEitn9KplDEQaGkq0CdWh0+kvjIMy48r07i8x7+Gl8WkjrG8yETBEf3Cp53TTmplJDBNy+6Ol3mnUV08dr/Kc+SYf1n2On6QfiKloW1eziEZjpSvS9L/AQC+Kv1oHkjSAAAAAElFTkSuQmCC\" data-zim-uri=\"DWT170\"></div><br><h3>总结</h3><br><div data-marker=\"__QUOTED_TEXT__\">1、结合实际业务学习PHP-ML，这个demo抓取客运站网上前一周的最高气温作为样本数据进行训练，预测未来一天的最高气温。</div><br><div data-marker=\"__QUOTED_TEXT__\">2、写的很简单，可以继续扩展结合更多的因素寻求最优解，当然预测结果不可尽信，毕竟天气是综合多方因素得到的结果：）</div><br><div data-marker=\"__QUOTED_TEXT__\">3、最小二乘法是统计学中的一种回归分析，根据已知的确定的数据，求得未知的近似值。如下图，蓝色点为支撑分析的数据，红色线为拟合后的结果。</div><br><div data-marker=\"__QUOTED_TEXT__\"><img id=\"DWT133\" src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPIAAACWCAYAAADkDdXoAAAgAElEQVR4Ae1dCZxNZf//nnPvHUu2IbJlIowlL41588bYsmUJWV4plSwVkVS2SIiyU5GyvlmSXv7IOgkZy3gNRYxsETKGQTKIufee8//8nuuambvNPXPP3GXm93w+93Puec6zfp/zO8/z/J7fIt29e1cFB0aAEQhpBOSQbj03nhFgBAQCTMj8IjACuQABJuRcMIjcBUaACZnfAUYgFyDAhJwLBpG7wAgwIfM7wAjkAgSYkHPBIHIXGAEmZC/egX379uHEiRNepOQkjEBgEDAGptrQqvXq1auQZf7mhdao5a3W8tuZt8abextABDZvllG0aBimTTPo3gomZN0h5QLzKgIbN8p4/XUjrlxxjUByMnDnDnD+vOvnvsTy0toX9DgvI5ABgcmTDYiPlxATI6NHDyXDE9vfnj0V1K9vRqVK+qs3MCE7we0coaoqkpKScPfuXeTLl885AcfkaQR+/VXCzJkGDBhgRevWEjp1shHx2rUyDAagXbt0oq5aVX8iJvCZkL18BVNTU2GxWJiQvcQrLyWbN0/Gf/4jo2BBFTNmWEXXaXndrZsRkgRcupSGIkVyFhEmZC/wlSQJkZGReOCBB7xIzUnyGgKDBysoXBjo3Tt95i1RAhg0yAqjETlOxIS3xPrIWb92mzZtQsmSJREdHZ11Yk7BCAQAAeZaBwB0rpIR0BsBJmS9EeXyGIEAIMCEDGDHjh0YPXo0bt26JYZg5cqVmDp1KpYuXRqAIeEqGQHtCDCzC0CVKlWwfv163L59WzC09uzZg+nTp2tHk3MwAgFCgGdkAGXLls10rFS9enWMGjUKgwYNAp0hW61WbN++HatWrcLx48cDNFRcLSPgHgGekV1g07dvXxE7YsQIXLlyBQaDAU2bNmWutQusOCo4EGBCBrB582bExcWJPfK4ceOwYMECKIqCS5cuoQQdCHJgBIIcAT5HdjFAaWlpgqjDw8PFUz5HdgESRwUVArxHdjEcYWFhsBOxi8cclUcQSEqShDbTzp2Sbj3evl3G++8bcO+ARLdymZB1g5ILym0IrFolY9EiGTNmZF9/eMsWGcOGGXDjhg0d+k9aUrGx+pIe75Fz29vH/dENgR49rLh+HXj22XQZaq2Fjx5twE8/SYiOVtG1q4Lx463Ytk1Cy5bZL9NVG3iP7AoVhzjeIzsAwrdeI7Bjh4wffpAwbJgVhQp5nU1zQn3nd83Vh0YG+znytWvXQqPB3MqgQaBxYwUffuieiKXDh2Fs1QqGCRN8ajMvrb2Az36OXLx4cS9ScxJGIGsE5C1bYBg3DrR2tw4cCKV376wzeUjBhOwBHH7ECOiKgKJA/uorGEj8N18+WCdNgtKsmS5VMCHrAiMXwgh4QODWLRimTIG8YgXUiAhY6FqjhocM2h8xIWvHjHMwAl4hIF2+DMPw4ZDi4qDWrw/zzp3Agw96lVdrIiZkrYhxekYgCwSkY8dgGDoUdFW6doXl8GGgQIEscvn2mAnZN/w4tx8RuHsXsFqBggX9WKmGqgQDa/RoIDUV1jffxK2vV6NAoewLk2ioGnz8pAUtThswBCwWoHZtE6pWNeGvvwLWDOeKiYG1cCFMtWrBMGIErBMmwHzkCPZFvYbS5QqgVy//zJX+qcW5+yEVYz9HrlSpEvgIKnBDpwqT0BJsV9/bQeUoCoTtac2l3bxpY2B9+62NgfXf/0KtVu1+MbR6MJuhu0z1/Qoc/jAhOwDi6pbPkV2h4t84Mit76JBZLK31sEpMRPzEEybh3uXnn80oVsy7/kjJyTAMGwZpzx6oTz4J8+7dgAv5ggYNVJw9a0Z4eM4YpHdsLS+tHRHh+6BFIH9+wB0Rk2O0IkXCsGmTd680zcQkqJeaKomZM6tOS0ePwtihA4yNGkF9+GGYDx+GZfFil0RsL6tkSVXYtbbf5+SVZ+ScRJfL9hsCFy4AtJy9dMm7KsmVy8GDZpHH04lQJgbW0KFQXnwRwn2Ed9X4LRUTst+g5opyEoHJk63o109BlSreL2XJOwT9nAIxsBYtgmHmTMEit06ZAqVRI6dkwRTBhBxMoxFibbl923Y8Sv6NAh1oD62FiF229+ZNKKPHIO2blTDWjIRp7VqolSq5TBpskd5tKIKt1dyegCOQkCChdOkwvPJK6M8FxMAyvvwyTI8/jjO7klHmaiJeKb01ZIiYXgYmZC9IgkzikhlcuwF7L7Lk+iR0rkvCGbQvDdUg/fQTjK1bw9ikCdQqVQQDy7x4GZq0KYoXX9RX8d8VRhcvSujb14itW30nw9D/nLpCKAfiChcuDCOt3zgIBJ58ko5X0nDPPmFIoSJv3AjD2LHAzZuwDh8OpUeP+wysatVUrF5t8Ut/vvtOwuLFMpKSgGbNfPtw8JvpxZCRW1VHI/ZeZMv1STxxe3Oq8yRkYTJlo3SzGYb58yF//rlgYFmmTIEaYAZW9+4K/vzTirZtfSNiQoMJORvvBGcJDALJyRLq1jWhRg0VW7aYRSNmzzZgzx4Js2dbXAt1pKbCMH48pNWr8UfBysCX61C6/iOB6YBDreT8fPhwm2N0h0eab31fnGuukjMwAtoQoP04ySyTIbvUVIC89vz9t62M2bNlrFwp4+DBzK+ydPHifQaWlJKCGS/vR8SvP2DInMraKg+R1Jl7HyKN5maGDgJnz0r47DODT4oOly9L+PprGcuXy/jHP1RcuiSBTNVSWLbMgnnzLGjUyLY8lQ4cgLFNGxibNrUxsI4cgWXhQrToXBRt2ih+YWIFYnR4aR0I1PNQnWSMfcUKGXfuAEOGZG8ZWbasijVrLChUSMWVKxJWr5bRsqVN8OPxx1XQTzCwxowRWgqODCyC259MrEAMLxNyIFDPQ3X27KmIZXD79r4xdJ5+2p5fRceO9/7bGVhz5gBFisAyfTrUmJg8hG56V5mQ07Fw+4/VGN1Ck+WDp55SQD9vAykzpKRIeOghD6KW9xhYMkleVa4My7p1QpXQ2zpyYzreI3sxqqzG6AVIOiUZONCIiAgT1q1zfjWlpKR0Btb16zDv3QvL+vV5nogJeme0dBoQLibvIfDjjzaGlC89f+ABVSj6201c0d46ed0BmGMaI7lyDFafqg3zr7/C8uWXcH3e5EvtoZuXCTl0xy6oWk6K+p06GdGzpxG//pp9LQrSYrpyJQ3NmyuQN2zAtQpRSOvyPHZVfhURynl8UmCYk0TI4MEG/OtfJhB3O68GJuS8OvI695s0oMi/Ua9eCh59NPP+9vx5Cf36GYXS/9NPG8VxlNvq09JQaM50mGrUEKZ0vn5qIR4vdAbFBvVAYqIFa9bYBEEy5iePhz//LGHatPTXmSTAgsq2V8YG58B/duLmBajsxM0LkDwkITeidAxF5m927ybpLBV79jgQ5I0bMIwZA5kYV5GRsM6efX/vS7O9J1VJOo567jkjKlRQcfKkrdyGDU1ITJRAZnwiIjJ/WDw0NWQfMdcawGeffYbY2FisX79eDOS8efNw4cIFFC1aFIMHDw7ZwQ2Whr/yikL6Cfj3vxWcOCGhTp10wpLOnIHhvfcgJSRAbdYM5oQEp71vRiKmmZaIlDSvdu0yk+cVcRw1d65FiG7a+yzLNuKnvCQNNnWqQbgypY9JbgxMyAAGDhyIxMTE++ObkJCAuXPnYtCgQbhD3BYOPiFAtqvGjbMJgzz2mI2QpPh4GEeNAv74A0rfvjb7V15oQ6SlAadPS8L6JalQEiETsb78cuYjrq1bzUIabOlSGeXLq5g40QBixu3Y4bAScNGz/fsllCkDlCsXOkTPhOwwkGlpaQgLCxOx4eHhuE7e8qxWbN++HWfPnsVjjz2GyMhIh1x86y0CxMASXghv34Z15Ego3bp5Xjc7FEwMrc8+I5FMlWRA3AbSOB0yxCgclcfGWvDGG6RllDVhHjwooUEDEypXVpGYmDXRu22Anx8wITsATkR89562fEpKCkqUKAH7OXJ0dLRDar71CoG0NBhmzYI8fz5QqhQsc+ZAjYryKqtjos6djWLvS9pPNGt6Cp9+asHJkxIaNlTQpImnlOnPypWDkOeuVy9rok/PFfh/TMhC8H6ZsP4xduxYfPDBB+jQoYO4NmrUCCYvlnuBH8YgbUFGBlbNmrBs3gy1QgWfGvvsswqKFpWRwRa82/K6dcu83HabMMMD2gYkJITOTGxvOnOt7Uh4uDLX2gM4Lh7dZ2AdOAC1dWtYyKF30aIuUmqPyrZhAe1VhVSO9IO3kGo2NzbYEPjkEwNGNE4AmjSFsW1bqNHRMB89Cssnn+hGxC1bkvhmGMjWFYfMCDAhZ8YjZO4OH5ZQvboJkyb5x9ufW2BUFfKqVWg3Ogq99/bGsYavCwK2vvMOfHGzQJY/ihULyyRzffWqJHwp8UGC82jwHtkZk5CIITFIOob5+GMDBgywunWlkmOdcWBgyQvn4oBaF507a9+Xumrj2bM2KyDkQcIe4uLMIFvaJUvaY/hqR4AJ2Y5EiF1Jv5d8h5FgBO0b/Rb++ktYoBQSWMTA+v57qOXLoyKAitCHiKkvH39sE/ckgwD2QH6f3Pl+sqfJq1deWnsx8vZz5Gvk9StIAjk0O3YsTfy89SToS9Ol06dh7NIFprp1AVmG+eBBWNasEUTsTbkk0RUXZ3vdvv9expdfyk7uUUn6qmZNE2jbQL6ZMhKxN3Xk5TQ8I3sx+vZz5GDzjawTI9gjAtLu3TYJrKQkKK++Css332Rr79uqlRFJSZI42unRwygUGurVM2cS1yQ57FOnJBw7JqFWrfSZ2GMD+aFAgGfkXPQi/P67hHLlwvD88z5+n8mJ2dKlMEVHwzhgAKyvvQbz8eOYW2wINm2xSb1phY32ziSNRQoMY8ZY0b+/FTVrZibWhQstINHKLl30W6JrbWeopvdxxEO127mz3TduAH/+CZw75/p4hvbS5KupUCGgcWMFsbEypk2zoESJe3jcvQvDjBnCEyFKl4Zl/nyodeqIhzRL9u9vBC3pr19P86iN5ArdqVNJ1tomb01E7CqQ14qYmMzE7SodxzkjwITsjEnIxpDIYny82Ukf2N4hOr4hM7IkrHbggIRffpHQsaOMjjGXYRw7FhJJXtWqBcv27VDLlrVnE1eSPSbuOAlmZdRGypTIw82ZMxJmzZLx+uvaXJ96KJIfZUCACTkDGKH89/p1CEYR6XucOpXmsiulS6sgBYL8+VVxxHts3W/ovGgw5HcToTz7LCwHD7plC5MSwrRprmdSl5U5RH7+uYxZswwwmyWQDDQHfRFgQtYXz4CVRup8Dz6ogmxdefI1R4bcpV27YBw+GvWSk6HQ/nfVKs+ZdOgVOSGnozKakTnojwDLWnuB6YYNG3D+/Hl0795dGBvwIktAkni0pEEMrK+/hmHmTLE2to4aBaVDh4C0kyvVHwGekb3AlLwxVqtWDQ9olEYgn0WkCF+woBeV6JDE5d7VzsBasgSCgbVgAdTatXWojYsIJgT4+MmL0SBCLlSokGb/yC1bmlChQhjI/5HfQ0oKjAMHwlSrFqRDh2DZsgXmrVvvEzEtc8mVCzGhOIQ+AkzIPo4hWW8kqSVXgWZkIhjynuAuUF5PzykfpSFuMy2dswrSiRMwduoEU4MGUAsUsElgLV/uxIVes0bGSy8Z0aePvosysslAJnX8KjaaFSh54DkTsg+DTJJKMTEm1K9vcvniknDDmTNpqFjRNQWSl8JatUwYN86zBtMLLxiFkAeZfXUXiIFleuopGDt2hNqkiTDibp082e26nixgkCuX7t2zz4l21ZaxYw0gKS5S5uDgPwTcvxn+a0PI1lS8uIqYGEVYZ3RlSITi7HLQ330n33cFau8wHQfRcRGp5ZUtG+b25X/xRUUYbLdbn6R9N2kB0VQuJLBq14bxrbdAXghJB9j65psQwsr2ilxcySDdpk0W9OnjvFzYvFlGZKRJeD2krKRpNWKEwSs94H/+0ya9FR3t+uPloikcpQMCTMg+gEhSTnQu+/XXns9FyZ9v1662WfW339KX4V27KkhNTUNUlIqrV20E46o5b75pxYYNFpQqpYrl9RPRCr4oNxVyZCQMCxbAsmQJzPv3Q2nZ0lV2zXFkRZLEPf/3P1tbp0wxYPp0A+bNy/p1IVM8J06YhS9izRVzhmwjoO8GKdvNyN0Zaea2ESGZWXWeqcjec7VqZlSpYns2apQB+/ZJ+OYbi1BVvI9OSgpMI0di2+nNSJBicGV1HIo/loUFuvuZvf8zdKgVTz6pokED22xNHxIS63Q0Oet9iZwypxHgc2QvEPb3OTIta2lG3LnTjCeeUCEdPw7DkCGQEhOhdO6M2yPGIM1YEIULe9F4TpInEOAZ2WGYaYn77bcGdOlivW+JQpZlkClc8jzhj7BunUUcWf3rr+9haDgOuHIFSv/+sKxeLfa++QDQL2MgHV/iGD/zjPOeN2M6/p87EWBCdhhX2g/OmGHAyZPA9OnecXQXLZJx5AiZ3bEK5pVDkdpuFQXVdn+FmtOnCzcK1okToTRv7rEMYnx17GgUx1hnz5o9Own3WBI/DFUEmJAdRo70ZolLS4wob8P77xuRkmLzbZRtw+Z37thUCL/6CihfHpYVK6DWqOFVE0hyjPaxf/9N9qyc9+BeFcKJQhoBJmSH4aPjk7VrPXOhHbJgwQKLENqgvFqDlJICw8iRkLZtg1q/Psy7dpH2g9ZiMHGid6sHzQVzhpBAgAlZh2Fq1UpBq1baCpKOHYNh6FDQVenaFZbDhyFUlzIUQ14E9+6V0bSp4lGjKUMW/ptHEcj6YDCPAqN3twcPNqB1ayPS1n0PU6NGMHbtCqVdO5sE1oQJTkRM9b/zjhHt2hnxxRcsJaX3eOS28nhG9seIKgrClizFrNSJMCSZYJ0+FUqzZlnWTM7H4uMlREV5v1/PslBOkCsRyNXnyB71czUMZ8Zz5HPniqFqVVX45c2yiJs3YZg6FfKKFbhVsgwO9f4c/3y5WpbZOAEjoBWBXLu0/vRTAwoXDgNp+fga7OfIGzeGIzraJIzQeSpTunwZxl69YKpTB2QPmhhYYXHbmIg9gcbPfELA97c8m9WTqtv585KQHSbZXlIE0DNcvGjzwEDHQnqFhx9WQZYeIyNdc6elX3+FsX17GGNioJYpA/Phw7AsXox0M5XOLSEfRxERJuzcmS6D7Zwq+GPee8+ADh2MIAYdB/8jEJA9Mr20pOr22GMqevdWQIygfv2smDlTvyOUCROsomyy/qhXIFOtycnOXxx5yxYYRo8GvcWkeaTck8Dypt6DByUkJ9t0mhs21K+t3tStZ5ply2TRDzJU8I9/hG4/9MTEn2UFhJCrVAHozLVZMwVEaGRXuUYNfQdfliHKzjEwSYXwP/8RQhy0YSbdX+WppzRXRxYl+/aVBB6aMwdRho0bLfjjDybiQA1JrmZ2ZRfU+Ph4/P333yhXrhwiIyORydE5MbDGj4e8ejXUihVhnTkTajVmYGUXa86nDwIB2yPr0/ycKeXLL790Kli+dg3Gl1+G6fHHISUlwRwfDwsZdGcidsKKI/yPQECW1v7vprYa79y5g9jYWLRv3x7VLBZEfPghyp0/j9vdukFJSEB+u9kPbcU6pU5MJKN+EP6QnB5yBCOgAYGQW1qTllGnTkah5D5ypH7MMSfMYmOxomdP9CheHPtat0ZinTqoUaOGWG6XLPkQ3nrLiHz5VEyZkr020H6S9I5Jp/jChbSsLPM4NY8jGIGMCITcjHz6tCR0de1maDJ2xuf/igJlwQJcmzQJ+QsUwMmoKJg3bEDypk2oVrIkoqKiRBWXL0uYO1cmN8H44AOb9QxXdZNTNUpDs65jCA9XhYkfshhCvoA5MAK+IBByhNy+vYK4OLOTE2w6xhkyxIjBg62Z7EVt3SoLw3F0HNWihRtRx9RUGwOLHHdXrYqf3n0Xf4aHY1CbNi6xJbM9q1ZZhO6xKyKlTETE1auHwWRScfy4WTjvJncudleiZOueLIBwYAT0QCDkCJk67Urnl0zFxsVJqFBBzkTI27dLOHRIwtatElq0SIfs7bcNuP17MuY+8DYMCQlQGzQQDCwykuWNCbu2bd18FO5VQbMsOUsjn0w0gzdqZBIuSekcmixncmAE9EQg5AiZTPEoiuSkQE8+d8m8bKtWmc+jR4ywiiVsy5bphKcmJKDzFx/gEetxXB/wEoocnEdUpyeuoBn32DGzcEFKRurJhjRJhflCxGTwnn46N1XXfnNhgUEgJI6fyPLF8OEG/Pe/MmrXDhPuQ8mNaMZAhEP2n2nZmzFQfKdOitinyhs3wlSvHsJ69sTDw7vj6PrTKDLtA/xxpQDKlzfhuef0/a6RXWvyjEiz8vr1FixZ4mywgMRUyUj9u+9mvVGmWT0iIswr+9IZMeD/uR8Bfd/cHMJr505Z2NEijw1EqGTQ3euZzWyGYf58yJ9/LrwuWKZOhdqwISoAqAAb0f/1F3DtmoQzZ3KoAx6KPXfO5hKmUCH6pnrmgJM8Os3IWbmY8VAdP8qlCPj1+ImMxBHBkJcDLYGsQ06ebBB7Y1oie6We6MDAsn76qZDEclfvuXMSiJPsysRsRjXGnLCkeeAA7e2ztrdFONBHzE/GPN1BxfFBiIBfl9bPPGNC1aom/PSTNk0fWpq+/75VuGYhDF26D70HrnTxYroEVkoKzHv3wrJunUcipqwVKrgmYnpmV2PUSsR0RHb8eNZ9rVtXddrz03l5//5GnDqVnp9wYCK+N9B8yYSA3wh56FCD4B7TntXVrJepVdm4kfbvh6lFCxibNIFapQrMR47AsnAhBIcpG+U5Zvnf/2SxN/dWv5m0gJo0MaFxY5NXXhQd65szx4AFC2Txc3zG94yAIwJ+2yPv3i0LXdUtWyz3XaM4Nub//s+WRotrEmJgGcaMAW7dgnXECCgvvOB5ynas1Mv7xERZzI579kjo2NF1puXLZaSkSMI0Le3lGzVSEBGRvea8/bYVxYqp6NcvndvuulaOZQQAv+2RScGf9qG0jHQVaP9XrFiYYOScOmUGKfG7DWlpMMyeDXnePNC5r2XiRKgxMW6TOz4gR2rkb7hPH2tm30qOCe/dk/ZTsWIlkJr6L5AdLRLscAx0xFSkSJhgRiUmmnNWhdKxcr7P8wj4bUYuWdIzM4f2f+PGWUEc5HLl3BCxnYG1di3UypVh2bQJKk15GsOYMQZ8+63NcfiwYZ45xfaiTSb5/h7dHpfxSgIgM2daQJ4XH33UTfszZuD/jICOCPiNkF21+dYtCMEJ+7MhQ5yJigh754pkPBP3Lox790Jt1kwwsO47HrZn1nB99VVbPV266Lts7dtX3/I0dImT5nEE/MbscsR56lQDSpQIw9Kl7psgJSTgep2nEDWwPn68+riwAW0hXWEf1QjJpA4JZ/DM6TgqfB+qCLinohzuEe2J6TzYldE9ecMGIYFl7N0bN/79KjpHnYNx1LsAiUppDGTYr0ULE374IftdVRQF+/fvx1+0PODACAQhAgFbWpMuMS1F74tUEgNr1izI8+cDpUrBMns21Oho1AIQD2fRRm+x3LzZpkxRtaqM5s2zt/TN7jmyt23kdIyArwgEjJCp4YKIb9wQx0d0jERmc7LLwHIHxKBBVsEBb9Mme0TsrlyOZwSCCYHsrzd97IV05gyM3bvDFBWFkz+lokGRAzj88dpscaE9NYWET+hcmrjmHBiB3IqA3wlZ2rMHpmbNYHz6aah16woG1jvhixB/KBwkc8yBEWAEtCPgn6W1qgrzsYZJk4Dbt2EdORJKt273RZ7mzrVi3z4FTz/Ny1/tQ8g5GAEgZwnZkYE1Zw7Ue3avMoJfsqSKtm1ZiCIjJvyfEdCCQM4RssUCEy2fy5SBZetWcdXSME7LCDAC3iOQc4RsNMK8bZv3LQnilFarFdu3b0elSpVQvHjxIG4pNy2vIuB3ZlewAU3WNkg1kUzuuAsGgwFNmzZlInYHEMcHHIE8T8ikOtmtmxG9e2dtMyvgo8UNYATcIJDnCTk6WkX9+iqefZaZbW7eEY4OAQRybo8cAp2nJj7yiIrt29lQfIgMFzfTDQJ5fkZ2gwtHMwIhhQATckgNFzeWEXCNABOya1wyxaoq+W86jltkCYEDIxCECDAhezkohQsXhpHcRnBgBIIQASZkLwZFkiSULVsW+ciwGAdGIAgRYEIOwkHhJjECWhFgQtaKGKdnBIIQASbkIBwUbhIjoBWBHCXkuLg4re3RnN4fdZw/fx5//vmn5rZpzeCPvvijjl9++YXx0jD4ZNjxNnk49CHkKCFfd3RifK+hR48eddnk5ORkXLt2TXgcjI2VxdWe0F0ed3VcvHgR7p65K8tdfFpaGsxm19Jf7vK4i79w4QJu3Lhh71amq9b2/vHHH0hNTc1Uhv3GXf3u6qCP1c2bN+3ZM13dleUunsqxkP9XF8FdHnfxZ8+edfuSu+uLu7J+//13/E3Otl0Ed3nc1XH69GncIdeYLoK7stzF0xiShp0vQVeXMdOmTQOdudrDuXPnUIH8hToEd/FExCaTCfHxRbBjhwGNGyv3vTu4y+Mu/urVq4LLXKhQIYfayXWNtnbt27dPmMItU6YMHnroIZTMYABMa1kpKSkoWLAgHiBvdg4hO2VROVSeY9Ba1uXLl0FHbAVc+MPRWtalS5dAnivz58/v2CzN2NPHPTw83OWJgdZ20ce9RIkSCHPhXDuQZSUlJYl3it59e3jppZdQqlQp+22WV10J2VNtRN9Hj0qoXl2FnMU6YNMmGeS9cdIkK4LB+iX5fiLijY6O9tRFfsYIBAyBLEhKv3aRo/KoKBM++ihrdcHWrRUcPmwOCiLWDwEuiRHIOQRyRFRp0aJFOHHiBIoUKYIRI0bgzJkz2Lt3LkymB1Ghwru69IaWgpMmTRKzZPfu3cWebOLEiWI/NXDgQNAyOBQCMZ+++eYbDBo0CJGRkWLp+cUXXwjshg4dKpys+9qPHTt2IDY2Vuzpxo4dCzKUQIHJKnMAAAO9SURBVNjRvuydd94RS1df6yBvHKNHjxZirG3btkXz5s1B7wGNfcuWLRGjwVtmVm3ZunWrKLdPnz6gvm3btg2PPvooaDmqRzhw4AC+++47sdWgOkiib/LkyaA+DhkyRGwb9Khn3bp1SEhIQK1atdC1a1fQuBPfo2PHjppXfzkyI7/wwgv4+OOPceXKFdC+ZObMmVi6dBQ+/TQcVars0QMDsdcZPnw4jhw5IsqjF7VmzZp4++238cknn+hShz8KefLJJ1GvXj2BFdVHWFG/Hn74YezcuVOXJlAdH330ERo0aCAIesWKFYK46MVfsGCBLnWQN47x48dj6tSpoPKJR3Hs2DHQh2Px4sW61EGFkNuen3/+WfzofunSpaKOQ4cO6ebSh97ZGjVqoH///ihWrBiWLVuGdu3a4bnnnsNXX32lS1/oFOTHH38UdXTp0gXEBCXewrhx4zCP3AVrDLoRMn3dqSGkWEDMBGLqEPeydOnSglNITJnKlSuDuH2+BPo40EtCs0rGQBxJsqn14IMP6n70QQwSWl3kRMjI4KDyCT+qi2aY3377TZcqaTyIi7xlyxY0adIEhBWVT3jRjKlXIK7s888/jxYtWogXMyIiAiTeSj+9An3oaJa0B/qAUCCmKhGDHoFwIW71gAEDcPjwYYEXxek5JqdOnRL+xGjmp8mHxqRixYrZXoHpRsjEQl+zZo34ChOh0TKLliM0iER0ROi0HCaury+BllH0JXMMxIyijwcdL7jiljqm13L/xBNPoGrVqlqyZDstETYddemBlb0RhP2wYcPE8p0+dMQNpfIJLy2cUXt57q40i9FsTIYKaTyoDj0DzcakhUbbAjpJyDgpUF8ynib4Ui/147XXXhOz5a5duwRGVL6eY0K4161bF6+++qoo1z4m2W13jnCt33rrLTED0BHEm2++Kb76K1euFHFTpkwRR0zZbbA9H304aNl28uRJ9OvXT+zB3nvvPfHR6NWrl9h32NMG85WEAWiWoWMyIjb6CC5fvlxgRR9CPRQ1lixZgvXr14sVUfv27cVM/OGHH4qPLM0GNHP6Guglp37Qh5S2ODRr0vjQvrJ69epiWeprHfb89GGismkZSktregfoAzhq1Ch7Ep+udEoRHx8vVpg0IdEeecKECQIv2iOXL1/ep/Ltman9NNGRZdY33ngDI0eOFI9o4ujQoYM9mVfXHCFkr2rmRIwAI6AbArotrXVrERfECDACmhFgQtYMGWdgBIIPASbk4BsTbhEjoBkBJmTNkHEGRiD4EPh/yJLPnBOQ/YgAAAAASUVORK5CYII=\" data-zim-uri=\"DWT133\"></div><br><div data-marker=\"__QUOTED_TEXT__\">4、PHP-ML必须使用PHP7.1+，看了下源码，确实使用了强类型，declare(strict_types=1)。</div>","categories":["技术"],"tags":["PHP","学习笔记","PHP-ML","机器学习"]},{"title":"【重构Hue】大数据处理的一些总结","url":"http://funsoul.org/2017/12/27/【重构Hue】大数据处理的一些总结/","content":"<p>最近做了一个项目，是重构大数据开源查询工具Hue。在这里记下一些重构过程中遇到的问题以及解决思路。</p>\n<p>首先，感谢Hue为我们带来如此便利好用的工具。重构的目的只是为了在原来的基础上添加一些额外的功能，比如基于数据库的权限控制、离线导出任务等等。</p>\n<h2 id=\"使用技术栈\"><a href=\"#使用技术栈\" class=\"headerlink\" title=\"使用技术栈\"></a>使用技术栈</h2><p>依旧是熟悉的Laravel+Vue，框架细节不多说，结合业务来看。</p>\n<h2 id=\"功能\"><a href=\"#功能\" class=\"headerlink\" title=\"功能\"></a>功能</h2><p>原来Hue有的基本查询、历史查询等等都有，加上我们新增的权限控制、数据导出、离线任务。</p>\n<h2 id=\"过程以及遇到一些有趣的问题\"><a href=\"#过程以及遇到一些有趣的问题\" class=\"headerlink\" title=\"过程以及遇到一些有趣的问题\"></a>过程以及遇到一些有趣的问题</h2><p>数据库数据表怎么拿？<br>权限控制怎么做？<br>切库怎么切？<br>离线任务是啥？需要哪些东西？<br>大数据下载需要注意哪些问题？为什么内存会爆了？<br>为什么Laravel的Excel服务搞不定大数据？解决办法是什么？<br>浏览器下载文件是怎么做的？最佳实践是什么？<br>….</p>\n<h2 id=\"数据库数据表怎么拿？\"><a href=\"#数据库数据表怎么拿？\" class=\"headerlink\" title=\"数据库数据表怎么拿？\"></a>数据库数据表怎么拿？</h2><p>这问题为什么要拿出来讨论，咋一看似乎没有那么难，很容易找出答案，但是，真的没那么简单。玩MySQL玩多了，知道MySQL有个叫<span style=\"color: #ff0000;\">infomation_schema</span>的东西，它是一个信息数据库，默认生成，是一个view。通过这个数据库，可以很容易得到所有数据库以及数据库下的数据表，还有表里的信息。然而，在impala里，是没有这么方便的东西的，要想拿到所有数据库，那就show databases，要想拿到表，那就show tables in database，要想拿到所有数据库以及库里的表，那得写个foreach，在内网环境下，我算了下平均时间，我本地获取到并显示到浏览器中约用时6秒，时间随库表的增加而上升。目前没有找到好的解决办法，只能在拿到后做个定时缓存，避免长时间等待。如果有好的办法，请不吝赐教：）</p>\n<h2 id=\"权限控制怎么做？\"><a href=\"#权限控制怎么做？\" class=\"headerlink\" title=\"权限控制怎么做？\"></a>权限控制怎么做？</h2><p>对数据库做权限控制，也就是说，用户查不到自己没有权限的库。怎么知道用户想查哪个库呢？这里推荐一下<span style=\"color: #ff0000;\">PHPSQLParser</span>，在github搜一下就找到了，解析SQL非常强大，数据结构也很清晰。这样一来，我们就可以在用户输入的地方（查询、下载、离线任务）控制权限。</p>\n<h2 id=\"切库怎么切？\"><a href=\"#切库怎么切？\" class=\"headerlink\" title=\"切库怎么切？\"></a>切库怎么切？</h2><p>这个问题很有趣，刚开始是这么做的，用户点了界面上的数据库，我们就做use database，然后，用户输入SQL点执行，我们就execute。其实这样做是不对的：）<br>原因在于，每次HTTP请求都是无状态的，而且又不知道FPM分配到了哪个worker进程上，每次执行完PHP脚本即刻释放，进程又进入下一次等待，两次请求相互独立。</p>\n<p>解决办法有至少两种，我就说我知道的两种吧：<br>1、使用缓存，把用户点击的数据库缓存起来，当用户执行SQL时，自动use。<br>2、把SQL和数据库一起发到服务端。</p>\n<h2 id=\"离线任务是啥？需要哪些东西？\"><a href=\"#离线任务是啥？需要哪些东西？\" class=\"headerlink\" title=\"离线任务是啥？需要哪些东西？\"></a>离线任务是啥？需要哪些东西？</h2><p>这里的离线任务是指把耗时的下载任务后台执行，下载完后提供给用户下载。</p>\n<p>既然是下载任务，那就做一个队列，先进先出，暂时不做优先队列。<br>后台执行，那就是常驻内存，守护进程，supervisor监控。<br>守护进程可能需要做一个资源连接池，避免数据库连接超时断开。<br>下载需要的工具后面会说到。</p>\n<h2 id=\"大数据下载需要注意哪些问题？为什么内存会爆了？\"><a href=\"#大数据下载需要注意哪些问题？为什么内存会爆了？\" class=\"headerlink\" title=\"大数据下载需要注意哪些问题？为什么内存会爆了？\"></a>大数据下载需要注意哪些问题？为什么内存会爆了？</h2><p>如果有个SQL是查询一万条数据，或许不大，那如果是十万条，一百万条呢？千万级别，亿级别？这么大的数据，一次性加到内存中，肯定会内存溢出，有人说了，把PHP默认限制内存写成无限制，内存买大点，应该可以吧….额，当然啦，有钱说了算，但是不够现实….</p>\n<p>那有什么好办法没有，有的，那就是分次读取，分片写入（我自创的说法，看看就好）<br>分次读取：设置一个分页值，比如，100页数据分10页，每页就是10条数据。在这里，我设置为10000，那么无论查询的数据有多大，我每次只会把1万条加到内存中，也就是分次读取。<br>分片写入：写文件也是同理，这里我分1000行为一次，逐次追加到文件尾，数据一片一片的，一片1000行，也就是分片写入。</p>\n<h2 id=\"为什么Laravel的Excel服务搞不定大数据？解决办法是什么？\"><a href=\"#为什么Laravel的Excel服务搞不定大数据？解决办法是什么？\" class=\"headerlink\" title=\"为什么Laravel的Excel服务搞不定大数据？解决办法是什么？\"></a>为什么Laravel的Excel服务搞不定大数据？解决办法是什么？</h2><p>因为导出的数据需要转成csv/xls格式，因此我找到了laravel excel，API非常方便，文档也友好，可是，在这里却用不上。因为在较大数据下，这个工具会爆内存，内部实现的问题吧，只好用原生的写法。再者，xls格式有限制，不管是65535还是多少，也不符合需求。那么就是fputcsv了，实现起来也简单。</p>\n<h2 id=\"浏览器下载文件是怎么做的？最佳实践是什么？\"><a href=\"#浏览器下载文件是怎么做的？最佳实践是什么？\" class=\"headerlink\" title=\"浏览器下载文件是怎么做的？最佳实践是什么？\"></a>浏览器下载文件是怎么做的？最佳实践是什么？</h2><p>以前都是用工具，用插件，没有思考过这个东西，原来也挺有趣的：）</p>\n<p>一开始我们是这么做的，客户端是AJAX，服务端返回一堆二进制，客户端做转换，用了一个插件，实现起来非常恶心。而且，xls格式还乱码，各种格式编码试过了无效，果断弃了。<br>看了一篇<span style=\"color: #0000ff;\"><a style=\"color: #0000ff;\" href=\"https://laravel-china.org/topics/6027/laravel-excel-uses-the-ajax-request-and-cannot-download-it-scheme-vue-axios-excel\" target=\"_blank\" rel=\"noopener\">讨论</a></span>，和我们遇到的问题一样，</p>\n<h2 id=\"结合讨论\"><a href=\"#结合讨论\" class=\"headerlink\" title=\"结合讨论\"></a>结合讨论</h2><blockquote>\n<p>2.保存在服务器，然后前端请求下载<br>未尝试，应该可行。<br>I was able to solve the problem. I’m using ‘store’ method to save the file on the server, and then I send the response (the path to the file):</p>\n</blockquote>\n<p>export.done(function (data) {<br>window.location.href = data;<br>});</p>\n<p>And the file can be donwloaded.</p>\n<p>3.直接在新窗口打开，可以成功下载 尝试可行，需重新拼接url<br>window.location.href= queryString;</p>\n<blockquote>\n</blockquote>\n<h2 id=\"最佳实践\"><a href=\"#最佳实践\" class=\"headerlink\" title=\"最佳实践\"></a>最佳实践</h2><ol>\n<li>保存文件到服务端，返回文件路径</li>\n<li>客户端拿到文件路径，请求API下载</li>\n</ol>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>这个系统大致功能已经推出，还有一些优化点需要研究一下</p>\n<ol>\n<li>数据库表获取问题</li>\n<li>大数据查询有没有更好的实现方式</li>\n<li>如果不是队列下载，而是并行下载，会不会更快一点</li>\n<li>如果下载文件发生在hadoop的节点机，然后下载完后去把文件copy过来，会不会更好一点<br>…..</li>\n</ol>\n","categories":["技术"],"tags":["PHP","大数据"]},{"title":"【问题排查】PHP-FPM模式下提示缺失lib","url":"http://funsoul.org/2017/12/14/【问题排查】PHP-FPM模式下提示缺失lib/","content":"<h2 id=\"php-fpm-conf\"><a href=\"#php-fpm-conf\" class=\"headerlink\" title=\"php-fpm.conf\"></a>php-fpm.conf</h2><p>设置worker为1，方便strace</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"keyword\">global</span>]</span><br><span class=\"line\">pid = /usr/local/php/var/run/php-fpm.pid</span><br><span class=\"line\">error_log = /usr/local/php/var/<span class=\"built_in\">log</span>/php-fpm.<span class=\"built_in\">log</span></span><br><span class=\"line\">log_level = notice</span><br><span class=\"line\">[www]</span><br><span class=\"line\">listen = /tmp/php-cgi.sock</span><br><span class=\"line\">listen.backlog = -<span class=\"number\">1</span></span><br><span class=\"line\">listen.allowed_clients = <span class=\"number\">127.0</span>.<span class=\"number\">0.1</span></span><br><span class=\"line\">listen.owner = www</span><br><span class=\"line\">listen.group = www</span><br><span class=\"line\">listen.<span class=\"keyword\">mode</span> = <span class=\"number\">0666</span></span><br><span class=\"line\">user = www</span><br><span class=\"line\">group = www</span><br><span class=\"line\">pm = static</span><br><span class=\"line\">pm.max_children = <span class=\"number\">1</span></span><br><span class=\"line\">pm.start_servers = <span class=\"number\">1</span></span><br><span class=\"line\">pm.min_spare_servers = <span class=\"number\">1</span></span><br><span class=\"line\">pm.max_spare_servers = <span class=\"number\">1</span></span><br><span class=\"line\">request_terminate_timeout = <span class=\"number\">100</span></span><br><span class=\"line\">request_slowlog_timeout = <span class=\"number\">0</span></span><br><span class=\"line\">slowlog = var/<span class=\"built_in\">log</span>/slow.<span class=\"built_in\">log</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"ps-ef-grep-php-fpm\"><a href=\"#ps-ef-grep-php-fpm\" class=\"headerlink\" title=\"ps -ef | grep php-fpm\"></a>ps -ef | grep php-fpm</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root       6598      1  0 10:45 ?        00:00:00 php-fpm: master process (/usr/<span class=\"built_in\">local</span>/php/etc/php-fpm.conf)                                                                    </span><br><span class=\"line\">www        6599   6598  0 10:45 ?        00:00:00 php-fpm: pool www</span><br></pre></td></tr></table></figure>\n<h2 id=\"sudo-strace-p-6599\"><a href=\"#sudo-strace-p-6599\" class=\"headerlink\" title=\"sudo strace -p 6599\"></a>sudo strace -p 6599</h2><p>查看worker进程系统调用，找到问题行</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">open</span>(<span class=\"string\">\"/lib64/tls/libssl.so.1.0.0\"</span>, O_RDONLY) = -<span class=\"number\">1</span> ENOENT (No such <span class=\"keyword\">file</span> <span class=\"built_in\">or</span> directory) </span><br><span class=\"line\"><span class=\"keyword\">open</span>(<span class=\"string\">\"/lib64/libssl.so.1.0.0\"</span>, O_RDONLY) = -<span class=\"number\">1</span> ENOENT (No such <span class=\"keyword\">file</span> <span class=\"built_in\">or</span> directory) </span><br><span class=\"line\"><span class=\"keyword\">open</span>(<span class=\"string\">\"/usr/lib64/tls/libssl.so.1.0.0\"</span>, O_RDONLY) = -<span class=\"number\">1</span> ENOENT (No such <span class=\"keyword\">file</span> <span class=\"built_in\">or</span> directory) </span><br><span class=\"line\"><span class=\"keyword\">open</span>(<span class=\"string\">\"/usr/lib64/libssl.so.1.0.0\"</span>, O_RDONLY) = -<span class=\"number\">1</span> ENOENT (No such <span class=\"keyword\">file</span> <span class=\"built_in\">or</span> directory</span><br></pre></td></tr></table></figure>\n<p>发现系统中确实没有libssl.so.1.0.0，只有libssl.so.1.0.1e，一般而言都会向下兼容，设置软链接</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo ln -s /usr/lib64/libssl.so.1.0.1e /usr/lib64/tls/libssl.so.1.0.0</span><br></pre></td></tr></table></figure>\n<p>再次执行，刚刚出现的“libssl”缺失已经不见了，出现了新的lib缺失</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">open</span>(<span class=\"string\">\"/lib64/tls/libcrypto.so.1.0.0\"</span>, O_RDONLY) = -<span class=\"number\">1</span> ENOENT (No such <span class=\"keyword\">file</span> <span class=\"built_in\">or</span> directory)</span><br><span class=\"line\"><span class=\"keyword\">open</span>(<span class=\"string\">\"/lib64/libcrypto.so.1.0.0\"</span>, O_RDONLY) = -<span class=\"number\">1</span> ENOENT (No such <span class=\"keyword\">file</span> <span class=\"built_in\">or</span> directory)</span><br><span class=\"line\"><span class=\"keyword\">open</span>(<span class=\"string\">\"/usr/lib64/tls/libcrypto.so.1.0.0\"</span>, O_RDONLY) = -<span class=\"number\">1</span> ENOENT (No such <span class=\"keyword\">file</span> <span class=\"built_in\">or</span> directory)</span><br><span class=\"line\"><span class=\"keyword\">open</span>(<span class=\"string\">\"/usr/lib64/libcrypto.so.1.0.0\"</span>, O_RDONLY) = -<span class=\"number\">1</span> ENOENT (No such <span class=\"keyword\">file</span> <span class=\"built_in\">or</span> directory)</span><br></pre></td></tr></table></figure>\n<p>同上，找到系统中存在的libcrypto.so.1.0.1e，并设置软链接</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo ln -s /usr/lib64/libcrypto.so.1.0.1e /usr/lib64/libcrypto.so.1.0.0</span><br></pre></td></tr></table></figure>\n<p>问题解决~ :)</p>\n","categories":["技术"],"tags":["问题排查","PHP"]},{"title":"详解PHP连接Impala安装与配置","url":"http://funsoul.org/2017/12/08/详解PHP连接Impala安装与配置/","content":"<h3 id=\"Impala的SQL语法参考\"><a href=\"#Impala的SQL语法参考\" class=\"headerlink\" title=\"Impala的SQL语法参考\"></a>Impala的SQL语法参考</h3><p><a href=\"https://www.cloudera.com/documentation/enterprise/latest/topics/impala_langref_sql.html\" target=\"_blank\" rel=\"noopener\">https://www.cloudera.com/documentation/enterprise/latest/topics/impala_langref_sql.html</a></p>\n<h3 id=\"PHP通过Thrift连接Impala\"><a href=\"#PHP通过Thrift连接Impala\" class=\"headerlink\" title=\"PHP通过Thrift连接Impala\"></a>PHP通过Thrift连接Impala</h3><h4 id=\"安装thrift服务\"><a href=\"#安装thrift服务\" class=\"headerlink\" title=\"安装thrift服务\"></a>安装thrift服务</h4><ul>\n<li>Thrift最初由Facebook开发用做系统内各语言之间的RPC通信.</li>\n<li>Thrift是一款可伸缩跨语言的服务开发框架, 该框架已经开源并且加入的Apache项目.</li>\n<li>Thrift主要功能是: 通过自定义的Interface Definition Language(IDL), 可以创建基于RPC的客户端和服务端的服务代码.</li>\n<li>数据和服务代码的生成是通过Thrift内置的代码生成器来实现的, Thrift的跨语言性体现在:它可以生成C++/Java/Python/PHP/Ruby/Erlang/Perl/Haskell/C#/Cocoa/JavaScript/Node.js/Smalltalk/OCaml/Delphi等语言的代码,且它们之间可以进行透明的通信.</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost tools]<span class=\"comment\"># rpm -ivh thrift-0.9.0-28.1.i686.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\">warning: thrift-0.9.0-28.1.i686.rpm: Header V3 DSA/SHA1 Signature, key ID a949b429: NOKEY</span><br><span class=\"line\">error: Failed dependencies:</span><br><span class=\"line\">libc.so.6 is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libc.so.6(GLIBC_2.0) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libc.so.6(GLIBC_2.1) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libc.so.6(GLIBC_2.1.3) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libc.so.6(GLIBC_2.3) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libc.so.6(GLIBC_2.3.4) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libc.so.6(GLIBC_2.4) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libgcc_s.so.1 is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libgcc_s.so.1(GCC_3.0) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libm.so.6 is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libstdc++.so.6 is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libstdc++.so.6(CXXABI_1.3) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libstdc++.so.6(CXXABI_1.3.1) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libstdc++.so.6(GLIBCXX_3.4) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libstdc++.so.6(GLIBCXX_3.4.11) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\">libstdc++.so.6(GLIBCXX_3.4.9) is needed by thrift-0.9.0-28.1.i686</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#报错, 缺少相关依赖.</span></span><br><span class=\"line\"><span class=\"comment\">#解决libc.so.6依赖:</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost tools]<span class=\"comment\"># yum list glibc*</span></span><br><span class=\"line\">[root@localhost tools]<span class=\"comment\"># yum install glibc.i686</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#解决libgcc_s.so.1依赖:到https://rpmfind.net/linux/rpm2html/search.php?query=libgcc_s.so.1下载相关依赖rpm包</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost tools]<span class=\"comment\"># rpm -ivh libgcc-4.4.7-18.el6.x86_64.rpm</span></span><br><span class=\"line\">[root@localhost tools]<span class=\"comment\"># rpm -ivh libgcc-4.4.7-18.el6.i686.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#解决libstdc++.so.6依赖:</span></span><br><span class=\"line\"><span class=\"comment\">#到https://rpmfind.net/linux/rpm2html/search.php?query=libstdc++.so.6下载相关依赖rpm包</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost tools]<span class=\"comment\"># rpm -ivh libstdc++-4.4.7-18.el6.i686.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#最后重新安装即可:</span></span><br><span class=\"line\">[root@localhost tools]<span class=\"comment\"># rpm -ivh thrift-0.9.0-28.1.i686.rpm</span></span><br><span class=\"line\">        warning: thrift-0.9.0-28.1.i686.rpm: Header V3 DSA/SHA1 Signature, key ID a949b429: NOKEY</span><br><span class=\"line\">        Preparing...                <span class=\"comment\">########################################### [100%]</span></span><br><span class=\"line\">           1:thrift                 <span class=\"comment\">########################################### [100%]</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"检查是否安装成功\"><a href=\"#检查是否安装成功\" class=\"headerlink\" title=\"检查是否安装成功\"></a>检查是否安装成功</h4><p>a. 首先创建Thrift的语法规则文件, 命名为server.thrift, 内容如下:</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">struct message</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    i32 seqId,</span><br><span class=\"line\">    <span class=\"built_in\">string</span> content</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">service serDemo</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    void <span class=\"keyword\">put</span>(message msg)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>b. 然后shell下执行命令:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># thrift -gen php server.thrift</span></span><br></pre></td></tr></table></figure>\n<p>该语句用于创建php服务框架, 创建成功后会在该目录下生成gen-php文件夹.</p>\n<h4 id=\"impala的SQL查询参考\"><a href=\"#impala的SQL查询参考\" class=\"headerlink\" title=\"impala的SQL查询参考\"></a>impala的SQL查询参考</h4><p><a href=\"http://www.cloudera.com/documentation/archive/impala/2-x/2-1-x/topics/impala_select.html\" target=\"_blank\" rel=\"noopener\">http://www.cloudera.com/documentation/archive/impala/2-x/2-1-x/topics/impala_select.html</a></p>\n<h4 id=\"连接PHP例子参考\"><a href=\"#连接PHP例子参考\" class=\"headerlink\" title=\"连接PHP例子参考\"></a>连接PHP例子参考</h4><p><a href=\"https://github.com/Automattic/php-thrift-sql\" target=\"_blank\" rel=\"noopener\">https://github.com/Automattic/php-thrift-sql</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># git clone https://github.com/Automattic/php-thrift-sql.git</span></span><br><span class=\"line\"><span class=\"comment\"># cd php-thrift-sql/</span></span><br><span class=\"line\"><span class=\"comment\"># php -c php.ini build.php  【重新生成ThriftSQL.phar文件】</span></span><br><span class=\"line\"><span class=\"comment\"># vim test.php</span></span><br></pre></td></tr></table></figure>\n<p>内容如下:</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">// Load this lib</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">'/ThriftSQL.phar'</span>;</span><br><span class=\"line\"><span class=\"comment\">// 1.Try out a Hive query</span></span><br><span class=\"line\">$hive = <span class=\"keyword\">new</span> \\ThriftSQL\\Hive(<span class=\"string\">'192.168.8.207'</span>, <span class=\"number\">21050</span>);</span><br><span class=\"line\">$hiveTables = $hive</span><br><span class=\"line\">    -&gt;setSasl(<span class=\"keyword\">false</span>) <span class=\"comment\">// To turn SASL auth off, on by default</span></span><br><span class=\"line\">    -&gt;connect()</span><br><span class=\"line\">    -&gt;queryAndFetchAll(<span class=\"string\">'SHOW TABLES'</span>);</span><br><span class=\"line\">print_r($hiveTables);</span><br><span class=\"line\"><span class=\"comment\">// 2.Try out an Impala query</span></span><br><span class=\"line\">$impala = <span class=\"keyword\">new</span> \\ThriftSQL\\Impala(<span class=\"string\">'192.168.8.207'</span>);</span><br><span class=\"line\">$impalaTables = $impala</span><br><span class=\"line\">    -&gt;connect()</span><br><span class=\"line\">    -&gt;queryAndFetchAll(<span class=\"string\">'SHOW TABLES'</span>);</span><br><span class=\"line\">print_r($impalaTables);</span><br><span class=\"line\"><span class=\"comment\">// 3.Try out an Impala query</span></span><br><span class=\"line\">$impalaDatas = $impala</span><br><span class=\"line\">    -&gt;connect()</span><br><span class=\"line\">    -&gt;queryAndFetchAll(<span class=\"string\">'select * from db_mcfx_log.t_log_sdk_log_user'</span>);</span><br><span class=\"line\">print_r($impalaDatas);</span><br><span class=\"line\"><span class=\"comment\">// 4.Don't forget to clear the client and close socket.</span></span><br><span class=\"line\">$hive-&gt;disconnect();</span><br><span class=\"line\">$impala-&gt;disconnect();</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>然后执行test.php</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># php test.php</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"使PHP通过ODBC连接Impala-方法1\"><a href=\"#使PHP通过ODBC连接Impala-方法1\" class=\"headerlink\" title=\"使PHP通过ODBC连接Impala(方法1)\"></a>使PHP通过ODBC连接Impala(方法1)</h3><h4 id=\"安装ODBC相关软件包以及ImpalaODBC驱动\"><a href=\"#安装ODBC相关软件包以及ImpalaODBC驱动\" class=\"headerlink\" title=\"安装ODBC相关软件包以及ImpalaODBC驱动\"></a>安装ODBC相关软件包以及ImpalaODBC驱动</h4><h5 id=\"系统版本\"><a href=\"#系统版本\" class=\"headerlink\" title=\"系统版本\"></a>系统版本</h5><p>centos6，别用centos7，很多lib不兼容，经常会看到这样的错误，解决起来非常棘手，即使下载安装了i686相关的包也不行。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">libxxx()(64bit) is needed by xxx</span><br></pre></td></tr></table></figure>\n<h4 id=\"使用ODBC连接数据库-分为两个主要部分\"><a href=\"#使用ODBC连接数据库-分为两个主要部分\" class=\"headerlink\" title=\"使用ODBC连接数据库, 分为两个主要部分:\"></a>使用ODBC连接数据库, 分为两个主要部分:</h4><ul>\n<li>安装ODBC管理程序(例如unixODBC/iODBC等), 这里管理程序选择unixODBC</li>\n<li>安装每个数据库对应的ODBC驱动程序, 而Impala的ODBC驱动则参考Cloudera-ODBC-Driver-for-Impala-Install-Guide</li>\n</ul>\n<h4 id=\"ClouderaImpalaODBC到Cloudera官网下载\"><a href=\"#ClouderaImpalaODBC到Cloudera官网下载\" class=\"headerlink\" title=\"ClouderaImpalaODBC到Cloudera官网下载:\"></a>ClouderaImpalaODBC到Cloudera官网下载:</h4><p><a href=\"https://downloads.cloudera.com/connectors/impala-2.5.15.1015/Linux/EL6/ClouderaImpalaODBC-2.5.15.1015-1.el6.x86_64.rpm\" target=\"_blank\" rel=\"noopener\">https://downloads.cloudera.com/connectors/impala-2.5.15.1015/Linux/EL6/ClouderaImpalaODBC-2.5.15.1015-1.el6.x86_64.rpm</a></p>\n<h4 id=\"若已安装其他版本则先卸载原来安装的\"><a href=\"#若已安装其他版本则先卸载原来安装的\" class=\"headerlink\" title=\"若已安装其他版本则先卸载原来安装的\"></a>若已安装其他版本则先卸载原来安装的</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># rpm -q ClouderaImpalaODBC</span></span><br><span class=\"line\"><span class=\"comment\"># rpm -e ClouderaImpalaODBC-2.5.30.1011-1.x86_64</span></span><br><span class=\"line\"><span class=\"comment\"># yum install -y unixODBC*</span></span><br><span class=\"line\"><span class=\"comment\"># rpm -ivh ClouderaImpalaODBC-2.5.15.1015-1.el6.x86_64.rpm</span></span><br></pre></td></tr></table></figure>\n<p>使用odbcinst命令查看unixODBC配置文件路径.<br>不同版本的unixODBC配置文件路径是不同的, 如果是源代码方式安装unixODBC, 也可以通过编译参数–sysconfdir指定.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]<span class=\"comment\"># odbcinst -j</span></span><br><span class=\"line\">unixODBC 2.2.14</span><br><span class=\"line\">DRIVERS............: /etc/odbcinst.ini</span><br><span class=\"line\">SYSTEM DATA SOURCES: /etc/odbc.ini</span><br><span class=\"line\">FILE DATA SOURCES..: /etc/ODBCDataSources</span><br><span class=\"line\">USER DATA SOURCES..: /root/.odbc.ini</span><br><span class=\"line\">SQLULEN Size.......: 8</span><br><span class=\"line\">SQLLEN Size........: 8</span><br><span class=\"line\">SQLSETPOSIROW Size.: 8</span><br></pre></td></tr></table></figure>\n<h4 id=\"增加环境变量-注意重启后失效-可在-etc-profile里面改使永久生效\"><a href=\"#增加环境变量-注意重启后失效-可在-etc-profile里面改使永久生效\" class=\"headerlink\" title=\"增加环境变量(注意重启后失效, 可在/etc/profile里面改使永久生效)\"></a>增加环境变量(注意重启后失效, 可在/etc/profile里面改使永久生效)</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># export LD_LIBRARY_PATH=/usr/local/lib:/opt/cloudera/impalaodbc/lib/64</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"动态编译pdo-odbc扩展\"><a href=\"#动态编译pdo-odbc扩展\" class=\"headerlink\" title=\"动态编译pdo-odbc扩展\"></a>动态编译pdo-odbc扩展</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]<span class=\"comment\"># cd /home/xxx/php-7.1.3 # 根据自己的PHP源码路径</span></span><br><span class=\"line\">[root@localhost php-7.1.3]<span class=\"comment\"># cd ext/pdo_odbc/</span></span><br><span class=\"line\">[root@localhost pdo_odbc]<span class=\"comment\"># /application/php/bin/phpize</span></span><br><span class=\"line\">[root@localhost pdo_odbc]<span class=\"comment\"># ./configure --help </span></span><br><span class=\"line\"><span class=\"comment\"># 注意，PHP多版本共存下需要指定PHP</span></span><br><span class=\"line\">[root@localhost pdo_odbc]<span class=\"comment\"># ./configure --with-php-config=/xxx/bin/php-config --with-pdo-odbc=unixODBC,/usr/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># configure: error: Cannot find header file(s) for pdo_odbc</span></span><br><span class=\"line\"><span class=\"comment\"># 完全安装好unixODBC和unixODBC-devel</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost pdo_odbc]<span class=\"comment\"># make &amp;&amp; make install</span></span><br><span class=\"line\"><span class=\"comment\"># 编辑php.ini加入pdo_odbc.so扩展</span></span><br><span class=\"line\">[root@localhost pdo_odbc]<span class=\"comment\"># vim /xxx/php.ini</span></span><br><span class=\"line\">extension = pdo_odbc.so</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启php查看配置如下:</span></span><br><span class=\"line\">[root@localhost pdo_odbc]<span class=\"comment\"># /etc/init.d/php-fpm restart</span></span><br><span class=\"line\">[root@localhost pdo_odbc]<span class=\"comment\"># php -i |grep odbc</span></span><br><span class=\"line\">PDO drivers =&gt; mysql, sqlite, odbc</span><br><span class=\"line\">LD_LIBRARY_PATH =&gt; /usr/<span class=\"built_in\">local</span>/lib:/opt/cloudera/impalaodbc/lib/64</span><br><span class=\"line\"><span class=\"variable\">$_SERVER</span>[<span class=\"string\">'LD_LIBRARY_PATH'</span>] =&gt; /usr/<span class=\"built_in\">local</span>/lib:/opt/cloudera/impalaodbc/lib/64</span><br></pre></td></tr></table></figure>\n<h4 id=\"动态编译odbc扩展\"><a href=\"#动态编译odbc扩展\" class=\"headerlink\" title=\"动态编译odbc扩展\"></a>动态编译odbc扩展</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]<span class=\"comment\"># cd /home/xxx/php-7.1.3</span></span><br><span class=\"line\">[root@localhost php-7.1.3]<span class=\"comment\"># cd ext/odbc/</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># /application/php/bin/phpize</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># ./configure --help</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># ./configure --with-php-config=/xxx/php7.1.3/bin/php-config --with-unixODBC=/usr/</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># make</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># make install</span></span><br><span class=\"line\">Installing shared extensions:     /xxx/php7.1.3/lib/php/extensions/no-debug-non-zts-20160303/</span><br><span class=\"line\">root@localhost odbc]<span class=\"comment\"># ll /xxx/php7.1.3/lib/php/extensions/no-debug-non-zts-20160303/</span></span><br><span class=\"line\">total 5556</span><br><span class=\"line\">-rwxr-xr-x 1 root root  350680 Mar 24 15:42 memcached.so</span><br><span class=\"line\">-rwxr-xr-x 1 root root  255310 Mar 24 15:00 memcache.so</span><br><span class=\"line\">-rwxr-xr-x 1 root root  173215 Jun 12 09:24 odbc.so</span><br><span class=\"line\">-rwxr-xr-x 1 root root 3020972 Mar 24 14:23 opcache.a</span><br><span class=\"line\">-rwxr-xr-x 1 root root 1750437 Mar 24 14:23 opcache.so</span><br><span class=\"line\">-rwxr-xr-x 1 root root  126680 May 23 14:04 pdo_odbc.so</span><br><span class=\"line\"><span class=\"comment\"># 编辑php.ini加入odbc.so扩展</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># vim /xxx/php/lib/php.ini</span></span><br><span class=\"line\">extension = odbc.so</span><br><span class=\"line\"><span class=\"comment\"># 重启php查看配置信息:</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># /etc/init.d/php-fpm restart</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># php -i |grep odbc</span></span><br><span class=\"line\">odbc</span><br><span class=\"line\">odbc.allow_persistent =&gt; On =&gt; On</span><br><span class=\"line\">odbc.check_persistent =&gt; On =&gt; On</span><br><span class=\"line\">odbc.default_cursortype =&gt; Static cursor =&gt; Static cursor</span><br><span class=\"line\">odbc.default_db =&gt; no value =&gt; no value</span><br><span class=\"line\">odbc.default_pw =&gt; no value =&gt; no value</span><br><span class=\"line\">odbc.default_user =&gt; no value =&gt; no value</span><br><span class=\"line\">odbc.defaultbinmode =&gt; <span class=\"built_in\">return</span> as is =&gt; <span class=\"built_in\">return</span> as is</span><br><span class=\"line\">odbc.defaultlrl =&gt; <span class=\"built_in\">return</span> up to 4096 bytes =&gt; <span class=\"built_in\">return</span> up to 4096 bytes</span><br><span class=\"line\">odbc.max_links =&gt; Unlimited =&gt; Unlimited</span><br><span class=\"line\">odbc.max_persistent =&gt; Unlimited =&gt; Unlimited</span><br><span class=\"line\">PDO drivers =&gt; mysql, sqlite, odbc</span><br><span class=\"line\">LD_LIBRARY_PATH =&gt; /usr/<span class=\"built_in\">local</span>/lib:/opt/cloudera/impalaodbc/lib/64</span><br><span class=\"line\">PWD =&gt; /xxx/php-7.1.3/ext/odbc</span><br><span class=\"line\"><span class=\"variable\">$SERVER</span>[<span class=\"string\">'LD_LIBRARY_PATH'</span>] =&gt; /usr/<span class=\"built_in\">local</span>/lib:/opt/cloudera/impalaodbc/lib/64</span><br><span class=\"line\"><span class=\"variable\">$_SERVER</span>[<span class=\"string\">'PWD'</span>] =&gt; /xxx/php-7.1.3/ext/odbc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注意, 如果configure编译的时候出现报错如下:</span></span><br><span class=\"line\">checking <span class=\"keyword\">for</span> Adabas support... cp: cannot <span class=\"built_in\">stat</span> <span class=\"string\">'/usr/local/lib/odbclib.a'</span>: No such file or directory</span><br><span class=\"line\">configure: error: ODBC header file <span class=\"string\">'/usr/local/incl/sqlext.h'</span> not found!</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 那么可进行修改configure配置文件:</span></span><br><span class=\"line\">[root@localhost odbc]<span class=\"comment\"># sed -ri 's@^ *test +\"\\$PHP.\" *= *\"no\" *&amp;&amp; *PHP_.=yes *$@#&amp;@g' configure</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"修改-etc-odbc-ini替换为如下-注意！！下文所有的配置文件的每行都一定要保持左对齐！\"><a href=\"#修改-etc-odbc-ini替换为如下-注意！！下文所有的配置文件的每行都一定要保持左对齐！\" class=\"headerlink\" title=\"修改/etc/odbc.ini替换为如下:(注意！！下文所有的配置文件的每行都一定要保持左对齐！)\"></a>修改/etc/odbc.ini替换为如下:(注意！！下文所有的配置文件的每行都一定要保持左对齐！)</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ODBC]</span><br><span class=\"line\"></span><br><span class=\"line\">Specify any <span class=\"keyword\">global</span> ODBC configuration here such <span class=\"keyword\">as</span> ODBC tracing.</span><br><span class=\"line\">[ODBC Data Sources]</span><br><span class=\"line\">#Cloudera Hive <span class=\"number\">32</span>-bit=Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive <span class=\"number\">32</span>-bit</span><br><span class=\"line\">impala=Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala <span class=\"number\">64</span>-bit</span><br><span class=\"line\">[impala]</span><br><span class=\"line\"></span><br><span class=\"line\">Description: DSN Description.</span><br><span class=\"line\">This key <span class=\"keyword\">is</span> not necessary <span class=\"built_in\">and</span> <span class=\"keyword\">is</span> <span class=\"keyword\">only</span> <span class=\"keyword\">to</span> give <span class=\"keyword\">a</span> description of the data <span class=\"keyword\">source</span>.</span><br><span class=\"line\">Description=Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala (<span class=\"number\">64</span>-bit) DSN</span><br><span class=\"line\"></span><br><span class=\"line\">Driver: The location where the ODBC driver <span class=\"keyword\">is</span> installed <span class=\"keyword\">to</span>.</span><br><span class=\"line\">Driver=/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/lib/<span class=\"number\">64</span>/libclouderaimpalaodbc64.<span class=\"keyword\">so</span></span><br><span class=\"line\"></span><br><span class=\"line\">The DriverUnicodeEncoding setting <span class=\"keyword\">is</span> <span class=\"keyword\">only</span> used <span class=\"keyword\">for</span> SimbaDM</span><br><span class=\"line\">When <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"number\">1</span>, SimbaDM runs in UTF-<span class=\"number\">16</span> <span class=\"keyword\">mode</span>.</span><br><span class=\"line\">When <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"number\">2</span>, SimbaDM runs in UTF-<span class=\"number\">8</span> <span class=\"keyword\">mode</span>.</span><br><span class=\"line\">#DriverUnicodeEncoding=<span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">Values <span class=\"keyword\">for</span> HOST, PORT, KrbFQDN, <span class=\"built_in\">and</span> KrbServiceName should <span class=\"keyword\">be</span> <span class=\"keyword\">set</span> here.</span><br><span class=\"line\">They can also <span class=\"keyword\">be</span> specified <span class=\"keyword\">on</span> the connection <span class=\"built_in\">string</span>.</span><br><span class=\"line\">HOST=xxx</span><br><span class=\"line\">PORT=xxx</span><br><span class=\"line\">Database=default</span><br><span class=\"line\"></span><br><span class=\"line\">The authentication mechanism.</span><br><span class=\"line\"><span class=\"number\">0</span> - No authentication (NOSASL)</span><br><span class=\"line\"><span class=\"number\">1</span> - Kerberos authentication (SASL)</span><br><span class=\"line\"><span class=\"number\">2</span> - Username authentication (SASL)</span><br><span class=\"line\"><span class=\"number\">3</span> - Username/password authentication (NOSASL <span class=\"built_in\">or</span> SASL depending <span class=\"keyword\">on</span> UseSASL configuration)</span><br><span class=\"line\">AuthMech=<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">to</span> use SASL <span class=\"keyword\">for</span> authentication.</span><br><span class=\"line\">Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">to</span> not use SASL.</span><br><span class=\"line\">When using Kerberos authentication (SASL) <span class=\"built_in\">or</span> Username authentication (SASL) SASL <span class=\"keyword\">is</span> always used</span><br><span class=\"line\"><span class=\"built_in\">and</span> this configuration <span class=\"keyword\">is</span> ignored. SASL <span class=\"keyword\">is</span> always not used <span class=\"keyword\">for</span> No authentication (NOSASL).</span><br><span class=\"line\">UseSASL=<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">Kerberos related settings.</span><br><span class=\"line\">KrbFQDN=</span><br><span class=\"line\">KrbRealm=</span><br><span class=\"line\">KrbServiceName=</span><br><span class=\"line\"></span><br><span class=\"line\">Username/password authentication with SASL settings.</span><br><span class=\"line\">UID=hdfs</span><br><span class=\"line\">PWD=</span><br><span class=\"line\"></span><br><span class=\"line\">Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">to</span> disable SSL.</span><br><span class=\"line\">Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">to</span> enable SSL.</span><br><span class=\"line\">SSL=<span class=\"number\">0</span></span><br><span class=\"line\">CAIssuedCertNamesMismatch=<span class=\"number\">1</span></span><br><span class=\"line\">TrustedCerts=/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/lib/<span class=\"number\">64</span>/cacerts.pem</span><br><span class=\"line\"></span><br><span class=\"line\">General settings</span><br><span class=\"line\">TSaslTransportBufSize=<span class=\"number\">1000</span></span><br><span class=\"line\">RowsFetchedPerBlock=<span class=\"number\">10000</span></span><br><span class=\"line\">SocketTimeout=<span class=\"number\">0</span></span><br><span class=\"line\">StringColumnLength=<span class=\"number\">32767</span></span><br><span class=\"line\">UseNativeQuery=<span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"修改-etc-odbcins-ini替换为如下\"><a href=\"#修改-etc-odbcins-ini替换为如下\" class=\"headerlink\" title=\"修改/etc/odbcins.ini替换为如下:\"></a>修改/etc/odbcins.ini替换为如下:</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ODBC Drivers]</span><br><span class=\"line\">Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala <span class=\"number\">64</span>-bit=Installed</span><br><span class=\"line\">#[Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive <span class=\"number\">32</span>-bit]</span><br><span class=\"line\">#Description=Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive (<span class=\"number\">32</span>-bit)</span><br><span class=\"line\">#Driver=/<span class=\"keyword\">opt</span>/cloudera/hiveodbc/lib/<span class=\"number\">32</span>/libclouderahiveodbc32.<span class=\"keyword\">so</span></span><br><span class=\"line\"></span><br><span class=\"line\">The option below <span class=\"keyword\">is</span> <span class=\"keyword\">for</span> using unixODBC when compiled with -DSQL_WCHART_CONVERT.</span><br><span class=\"line\">Execute <span class=\"string\">'odbc_config --cflags'</span> <span class=\"keyword\">to</span> determine <span class=\"keyword\">if</span> you need <span class=\"keyword\">to</span> uncomment it.</span><br><span class=\"line\">IconvEncoding=UCS-<span class=\"number\">4</span>LE</span><br><span class=\"line\">[Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala <span class=\"number\">64</span>-bit]</span><br><span class=\"line\">Description=Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala (<span class=\"number\">64</span>-bit)</span><br><span class=\"line\">Driver=/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/lib/<span class=\"number\">64</span>/libclouderaimpalaodbc64.<span class=\"keyword\">so</span></span><br><span class=\"line\"></span><br><span class=\"line\">The option below <span class=\"keyword\">is</span> <span class=\"keyword\">for</span> using unixODBC when compiled with -DSQL_WCHART_CONVERT.</span><br><span class=\"line\">Execute <span class=\"string\">'odbc_config --cflags'</span> <span class=\"keyword\">to</span> determine <span class=\"keyword\">if</span> you need <span class=\"keyword\">to</span> uncomment it.</span><br><span class=\"line\">IconvEncoding=UCS-<span class=\"number\">4</span>LE</span><br></pre></td></tr></table></figure>\n<h4 id=\"修改-etc-cloudera-impalaodbc-ini\"><a href=\"#修改-etc-cloudera-impalaodbc-ini\" class=\"headerlink\" title=\"修改/etc/cloudera.impalaodbc.ini\"></a>修改/etc/cloudera.impalaodbc.ini</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Driver]</span><br><span class=\"line\"></span><br><span class=\"line\">- Note that this default DriverManagerEncoding of UTF-<span class=\"number\">32</span> <span class=\"keyword\">is</span> <span class=\"keyword\">for</span> iODBC.</span><br><span class=\"line\">- unixODBC uses UTF-<span class=\"number\">16</span> by default.</span><br><span class=\"line\">- If unixODBC was compiled with -DSQL_WCHART_CONVERT, then UTF-<span class=\"number\">32</span> <span class=\"keyword\">is</span> the correct value.</span><br><span class=\"line\">##   Execute <span class=\"string\">'odbc_config --cflags'</span> <span class=\"keyword\">to</span> determine <span class=\"keyword\">if</span> you need UTF-<span class=\"number\">32</span> <span class=\"built_in\">or</span> UTF-<span class=\"number\">16</span> <span class=\"keyword\">on</span> unixODBC</span><br><span class=\"line\"></span><br><span class=\"line\">- SimbaDM can <span class=\"keyword\">be</span> used with UTF-<span class=\"number\">8</span> <span class=\"built_in\">or</span> UTF-<span class=\"number\">16</span>.</span><br><span class=\"line\">##   The DriverUnicodeEncoding setting will cause SimbaDM <span class=\"keyword\">to</span> run in UTF-<span class=\"number\">8</span> when <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"number\">2</span> <span class=\"built_in\">or</span> UTF-<span class=\"number\">16</span> when <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"number\">1</span>.</span><br><span class=\"line\">DriverManagerEncoding=UTF-<span class=\"number\">32</span></span><br><span class=\"line\">ErrorMessagesPath=/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/ErrorMessages</span><br><span class=\"line\">LogLevel=<span class=\"number\">0</span></span><br><span class=\"line\">LogPath=</span><br><span class=\"line\"></span><br><span class=\"line\">- Uncomment the ODBCInstLib corresponding <span class=\"keyword\">to</span> the Driver Manager being used.</span><br><span class=\"line\">- Note that the path <span class=\"keyword\">to</span> your ODBC Driver Manager must <span class=\"keyword\">be</span> specified in LD_LIBRARY_PATH (LIBPATH <span class=\"keyword\">for</span> AIX).</span><br><span class=\"line\">- Note that AIX <span class=\"built_in\">has</span> <span class=\"keyword\">a</span> different format <span class=\"keyword\">for</span> specifying its shared libraries.</span><br><span class=\"line\">Generic ODBCInstLib</span><br><span class=\"line\">#   iODBC</span><br><span class=\"line\">#ODBCInstLib=libiodbcinst.<span class=\"keyword\">so</span></span><br><span class=\"line\">#   SimbaDM / unixODBC</span><br><span class=\"line\">ODBCInstLib=libodbcinst.<span class=\"keyword\">so</span></span><br><span class=\"line\"></span><br><span class=\"line\">AIX specific ODBCInstLib</span><br><span class=\"line\">#   iODBC</span><br><span class=\"line\">#ODBCInstLib=libiodbcinst.<span class=\"keyword\">a</span>(libiodbcinst.<span class=\"keyword\">so</span>.<span class=\"number\">2</span>)</span><br><span class=\"line\">#   SimbaDM</span><br><span class=\"line\">#ODBCInstLib=libodbcinst.<span class=\"keyword\">a</span>(odbcinst.<span class=\"keyword\">so</span>)</span><br><span class=\"line\">#   unixODBC</span><br><span class=\"line\">#ODBCInstLib=libodbcinst.<span class=\"keyword\">a</span>(libodbcinst.<span class=\"keyword\">so</span>.<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n<h4 id=\"测试连接impala\"><a href=\"#测试连接impala\" class=\"headerlink\" title=\"测试连接impala\"></a>测试连接impala</h4><p>因为在/etc/odbc.ini我们设定的DSN名称为impala, 所以执行如下语句:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]<span class=\"comment\"># isql -v 'impala'</span></span><br><span class=\"line\">        +---------------------------------------+</span><br><span class=\"line\">        | Connected!                            |</span><br><span class=\"line\">        |                                       |</span><br><span class=\"line\">        | sql-statement                         |</span><br><span class=\"line\">        | <span class=\"built_in\">help</span> [tablename]                      |</span><br><span class=\"line\">        | quit                                  |</span><br><span class=\"line\">        |                                       |</span><br><span class=\"line\">        +---------------------------------------+</span><br></pre></td></tr></table></figure>\n<h3 id=\"PHP通过ODBC连接Impala-方法2\"><a href=\"#PHP通过ODBC连接Impala-方法2\" class=\"headerlink\" title=\"PHP通过ODBC连接Impala(方法2)\"></a>PHP通过ODBC连接Impala(方法2)</h3><h4 id=\"安装ODBC相关软件包以及ImpalaODBC驱动-1\"><a href=\"#安装ODBC相关软件包以及ImpalaODBC驱动-1\" class=\"headerlink\" title=\"安装ODBC相关软件包以及ImpalaODBC驱动\"></a>安装ODBC相关软件包以及ImpalaODBC驱动</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># yum install -y unixODBC*</span></span><br><span class=\"line\"><span class=\"comment\"># rpm -ivh ClouderaImpalaODBC-2.5.15.1015-1.el6.x86_64.rpm</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"新建存放配置的目录\"><a href=\"#新建存放配置的目录\" class=\"headerlink\" title=\"新建存放配置的目录\"></a>新建存放配置的目录</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]<span class=\"comment\"># mkdir /home/xxx/config_odbc</span></span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># cd /home/xxx/config_odbc</span></span><br><span class=\"line\">[root@localhost config_odbc]<span class=\"comment\"># mkdir odbc</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"创建环境变量文件common-env\"><a href=\"#创建环境变量文件common-env\" class=\"headerlink\" title=\"创建环境变量文件common.env\"></a>创建环境变量文件common.env</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost config_odbc]# <span class=\"keyword\">vim</span> common.env</span><br><span class=\"line\"></span><br><span class=\"line\">CONFIG_DIR=$(readlink -<span class=\"keyword\">f</span> $(dirname $&#123;BASH_SOURCE[<span class=\"number\">0</span>]&#125;))</span><br><span class=\"line\">ODBC_CONFIG_DIR=$&#123;CONFIG_DIR&#125;/odbc</span><br><span class=\"line\">export ODBCINI=$&#123;ODBC_CONFIG_DIR&#125;/odbc.ini</span><br><span class=\"line\">export ODBCSYSINI=$&#123;ODBC_CONFIG_DIR&#125;</span><br><span class=\"line\">export CLOUDERAIMPALAINI=$&#123;ODBC_CONFIG_DIR&#125;/cloudera.impalaodbc.ini</span><br><span class=\"line\">export CLOUDERAHIVEINI=$&#123;ODBC_CONFIG_DIR&#125;/cloudera.hiveodbc.ini</span><br><span class=\"line\">export LD_LIBRARY_PATH=/usr/local/li<span class=\"variable\">b:</span>/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/lib/<span class=\"number\">64</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"创建配置odbc-odbc-ini\"><a href=\"#创建配置odbc-odbc-ini\" class=\"headerlink\" title=\"创建配置odbc/odbc.ini\"></a>创建配置odbc/odbc.ini</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost config_odbc]# <span class=\"keyword\">vim</span> odbc/odbc.ini    【注意里面包含了ODBC连接hive和impala的配置】</span><br><span class=\"line\"></span><br><span class=\"line\">[ODBC]</span><br><span class=\"line\"># Specify any <span class=\"keyword\">global</span> ODBC configuration here such <span class=\"keyword\">as</span> ODBC tracing.</span><br><span class=\"line\">[ODBC Data Sources]</span><br><span class=\"line\">#Cloudera Hive <span class=\"number\">32</span>-bit=Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive <span class=\"number\">32</span>-bit</span><br><span class=\"line\">hive=Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive <span class=\"number\">64</span>-bit</span><br><span class=\"line\">impala=Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala <span class=\"number\">64</span>-bit</span><br><span class=\"line\">[hive]</span><br><span class=\"line\"># Description: DSN Description.</span><br><span class=\"line\"># This key <span class=\"keyword\">is</span> not necessary <span class=\"built_in\">and</span> <span class=\"keyword\">is</span> <span class=\"keyword\">only</span> <span class=\"keyword\">to</span> give <span class=\"keyword\">a</span> description of the data <span class=\"keyword\">source</span>.</span><br><span class=\"line\">Description=Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive (<span class=\"number\">64</span>-bit) DSN</span><br><span class=\"line\"># Driver: The location where the ODBC driver <span class=\"keyword\">is</span> installed <span class=\"keyword\">to</span>.</span><br><span class=\"line\">Driver=/<span class=\"keyword\">opt</span>/cloudera/hiveodbc/lib/<span class=\"number\">64</span>/libclouderahiveodbc64.<span class=\"keyword\">so</span></span><br><span class=\"line\"># When using No Service Discovery, specify the IP address <span class=\"built_in\">or</span> host name of the Hive server.</span><br><span class=\"line\"># When using ZooKeeper <span class=\"keyword\">as</span> the Service Discovery Mode, specify <span class=\"keyword\">a</span> comma-separated <span class=\"keyword\">list</span> of ZooKeeper</span><br><span class=\"line\"># servers in the following forma<span class=\"variable\">t:</span></span><br><span class=\"line\">#       &lt;zk_host1:zk_port1&gt;,&lt;zk_host2:zk_port2&gt;,...</span><br><span class=\"line\">HOST=<span class=\"number\">192.168</span>.<span class=\"number\">11.9</span></span><br><span class=\"line\"># The TCP port Hive server <span class=\"keyword\">is</span> listening. This <span class=\"keyword\">is</span> not required when using ZooKeeper <span class=\"keyword\">as</span> the service</span><br><span class=\"line\"># discovery <span class=\"keyword\">mode</span> <span class=\"keyword\">as</span> the port <span class=\"keyword\">is</span> specified in the HOST connection attribute.</span><br><span class=\"line\">PORT=<span class=\"number\">10000</span></span><br><span class=\"line\"># The name of the database schema <span class=\"keyword\">to</span> use when <span class=\"keyword\">a</span> schema <span class=\"keyword\">is</span> not explicitly specified in <span class=\"keyword\">a</span> query.</span><br><span class=\"line\">Schema=default</span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">to</span> when connecting directory <span class=\"keyword\">to</span> Hive Server <span class=\"number\">2</span> (No Service Discovery).</span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">to</span> <span class=\"keyword\">do</span> Hive Server <span class=\"number\">2</span> service discovery using ZooKeeper.</span><br><span class=\"line\"># Note service discovery <span class=\"keyword\">is</span> not support when using Hive Server <span class=\"number\">1</span>.</span><br><span class=\"line\">ServiceDiscoveryMode=<span class=\"number\">0</span></span><br><span class=\"line\"># The namespace <span class=\"keyword\">on</span> ZooKeeper under which Hive Server <span class=\"number\">2</span> znodes are added. Required <span class=\"keyword\">only</span> when doing</span><br><span class=\"line\"># HS2 service discovery with ZooKeeper (ServiceDiscoveryMode=<span class=\"number\">1</span>).</span><br><span class=\"line\">ZKNamespace=</span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">if</span> you are connecting <span class=\"keyword\">to</span> Hive Server <span class=\"number\">1</span>. Set <span class=\"keyword\">to</span> <span class=\"number\">2</span> <span class=\"keyword\">if</span> you are connecting <span class=\"keyword\">to</span> Hive Server <span class=\"number\">2</span>.</span><br><span class=\"line\">HiveServerType=<span class=\"number\">2</span></span><br><span class=\"line\"># The authentication mechanism <span class=\"keyword\">to</span> use <span class=\"keyword\">for</span> the connection.</span><br><span class=\"line\">#   Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">for</span> No Authentication</span><br><span class=\"line\">#   Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">for</span> Kerberos</span><br><span class=\"line\">#   Set <span class=\"keyword\">to</span> <span class=\"number\">2</span> <span class=\"keyword\">for</span> User Name</span><br><span class=\"line\">#   Set <span class=\"keyword\">to</span> <span class=\"number\">3</span> <span class=\"keyword\">for</span> User Name <span class=\"built_in\">and</span> Password</span><br><span class=\"line\"># Note <span class=\"keyword\">only</span> No Authentication <span class=\"keyword\">is</span> supported when connecting <span class=\"keyword\">to</span> Hive Server <span class=\"number\">1</span>.</span><br><span class=\"line\">AuthMech=<span class=\"number\">2</span></span><br><span class=\"line\"># The Thrift transport <span class=\"keyword\">to</span> use <span class=\"keyword\">for</span> the connection.</span><br><span class=\"line\">#    Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">for</span> Binary</span><br><span class=\"line\">#    Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">for</span> SASL</span><br><span class=\"line\">#    Set <span class=\"keyword\">to</span> <span class=\"number\">2</span> <span class=\"keyword\">for</span> HTTP</span><br><span class=\"line\"># Note <span class=\"keyword\">for</span> Hive Server <span class=\"number\">1</span> <span class=\"keyword\">only</span> Binary can <span class=\"keyword\">be</span> used.</span><br><span class=\"line\">ThriftTransport=<span class=\"number\">1</span></span><br><span class=\"line\"># When this option <span class=\"keyword\">is</span> enabled (<span class=\"number\">1</span>), the driver does not transform the queries emitted by <span class=\"keyword\">an</span></span><br><span class=\"line\"># application, <span class=\"keyword\">so</span> the native query <span class=\"keyword\">is</span> used.</span><br><span class=\"line\"># When this option <span class=\"keyword\">is</span> disabled (<span class=\"number\">0</span>), the driver transforms the queries emitted by <span class=\"keyword\">an</span> application <span class=\"built_in\">and</span></span><br><span class=\"line\"># converts them into <span class=\"keyword\">an</span> equivalent from in HiveQL.</span><br><span class=\"line\">UseNativeQuery=<span class=\"number\">0</span></span><br><span class=\"line\"># Set the UID with the user name <span class=\"keyword\">to</span> use <span class=\"keyword\">to</span> access Hive when using AuthMech <span class=\"number\">2</span> <span class=\"keyword\">to</span> <span class=\"number\">8</span>.</span><br><span class=\"line\">UID=hdfs</span><br><span class=\"line\"># The following <span class=\"keyword\">is</span> settings used when using Kerberos authentication (AuthMech <span class=\"number\">1</span> <span class=\"built_in\">and</span> <span class=\"number\">10</span>)</span><br><span class=\"line\"># The fully qualified host name part of the of the Hive Server <span class=\"number\">2</span> Kerberos service principal.</span><br><span class=\"line\"># For example <span class=\"keyword\">if</span> the service principal name of you Hive Server <span class=\"number\">2</span> i<span class=\"variable\">s:</span></span><br><span class=\"line\">#   hive/myhs2.mydomain.com@EXAMPLE.COM</span><br><span class=\"line\"># Then <span class=\"keyword\">set</span> KrbHostFQDN <span class=\"keyword\">to</span> myhs2.mydomain.<span class=\"keyword\">com</span></span><br><span class=\"line\">KrbHostFQDN=_HOST</span><br><span class=\"line\"># The service name part of the of the Hive Server <span class=\"number\">2</span> Kerberos service principal.</span><br><span class=\"line\"># For example <span class=\"keyword\">if</span> the service principal name of you Hive Server <span class=\"number\">2</span> i<span class=\"variable\">s:</span></span><br><span class=\"line\">#   hive/myhs2.mydomain.com@EXAMPLE.COM</span><br><span class=\"line\"># Then <span class=\"keyword\">set</span> KrbServiceName <span class=\"keyword\">to</span> hive</span><br><span class=\"line\">KrbServiceName=hive</span><br><span class=\"line\"># The realm part of the of the Hive Server <span class=\"number\">2</span> Kerberos service principal.</span><br><span class=\"line\"># For example <span class=\"keyword\">if</span> the service principal name of you Hive Server <span class=\"number\">2</span> i<span class=\"variable\">s:</span></span><br><span class=\"line\">#   hive/myhs2.mydomain.com@EXAMPLE.COM</span><br><span class=\"line\"># Then <span class=\"keyword\">set</span> KrbRealm <span class=\"keyword\">to</span> EXAMPLE.COM</span><br><span class=\"line\">KrbRealm=</span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">to</span> enable SSL. Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">to</span> disable.</span><br><span class=\"line\">SSL=<span class=\"number\">0</span></span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">to</span> enable two-way SSL. Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">to</span> disable. You must enable SSL in order <span class=\"keyword\">to</span></span><br><span class=\"line\"># use two-way SSL.</span><br><span class=\"line\">TwoWaySSL=<span class=\"number\">0</span></span><br><span class=\"line\"># The <span class=\"keyword\">file</span> containing the client certificate in PEM format. This <span class=\"keyword\">is</span> required when using two-way SSL.</span><br><span class=\"line\">ClientCert=</span><br><span class=\"line\"># The client private key. This <span class=\"keyword\">is</span> used <span class=\"keyword\">for</span> two-way SSL authentication.</span><br><span class=\"line\">ClientPrivateKey=</span><br><span class=\"line\"># The password <span class=\"keyword\">for</span> the client private key. Password <span class=\"keyword\">is</span> <span class=\"keyword\">only</span> required <span class=\"keyword\">for</span> password protected</span><br><span class=\"line\"># client private key.</span><br><span class=\"line\">ClientPrivateKeyPassword=</span><br><span class=\"line\">[impala]</span><br><span class=\"line\"># Description: DSN Description.</span><br><span class=\"line\"># This key <span class=\"keyword\">is</span> not necessary <span class=\"built_in\">and</span> <span class=\"keyword\">is</span> <span class=\"keyword\">only</span> <span class=\"keyword\">to</span> give <span class=\"keyword\">a</span> description of the data <span class=\"keyword\">source</span>.</span><br><span class=\"line\">Description=Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala (<span class=\"number\">64</span>-bit) DSN</span><br><span class=\"line\"># Driver: The location where the ODBC driver <span class=\"keyword\">is</span> installed <span class=\"keyword\">to</span>.</span><br><span class=\"line\">Driver=/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/lib/<span class=\"number\">64</span>/libclouderaimpalaodbc64.<span class=\"keyword\">so</span></span><br><span class=\"line\"># The DriverUnicodeEncoding setting <span class=\"keyword\">is</span> <span class=\"keyword\">only</span> used <span class=\"keyword\">for</span> SimbaDM</span><br><span class=\"line\"># When <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"number\">1</span>, SimbaDM runs in UTF-<span class=\"number\">16</span> <span class=\"keyword\">mode</span>.</span><br><span class=\"line\"># When <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"number\">2</span>, SimbaDM runs in UTF-<span class=\"number\">8</span> <span class=\"keyword\">mode</span>.</span><br><span class=\"line\">#DriverUnicodeEncoding=<span class=\"number\">2</span></span><br><span class=\"line\"># Values <span class=\"keyword\">for</span> HOST, PORT, KrbFQDN, <span class=\"built_in\">and</span> KrbServiceName should <span class=\"keyword\">be</span> <span class=\"keyword\">set</span> here.</span><br><span class=\"line\"># They can also <span class=\"keyword\">be</span> specified <span class=\"keyword\">on</span> the connection <span class=\"built_in\">string</span>.</span><br><span class=\"line\">HOST=<span class=\"number\">192.168</span>.<span class=\"number\">11.10</span></span><br><span class=\"line\">PORT=<span class=\"number\">21050</span></span><br><span class=\"line\">Database=default</span><br><span class=\"line\"># The authentication mechanism.</span><br><span class=\"line\"># <span class=\"number\">0</span> - No authentication (NOSASL)</span><br><span class=\"line\"># <span class=\"number\">1</span> - Kerberos authentication (SASL)</span><br><span class=\"line\"># <span class=\"number\">2</span> - Username authentication (SASL)</span><br><span class=\"line\"># <span class=\"number\">3</span> - Username/password authentication (NOSASL <span class=\"built_in\">or</span> SASL depending <span class=\"keyword\">on</span> UseSASL configuration)</span><br><span class=\"line\">AuthMech=<span class=\"number\">3</span></span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">to</span> use SASL <span class=\"keyword\">for</span> authentication.</span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">to</span> not use SASL.</span><br><span class=\"line\"># When using Kerberos authentication (SASL) <span class=\"built_in\">or</span> Username authentication (SASL) SASL <span class=\"keyword\">is</span> always used</span><br><span class=\"line\"># <span class=\"built_in\">and</span> this configuration <span class=\"keyword\">is</span> ignored. SASL <span class=\"keyword\">is</span> always not used <span class=\"keyword\">for</span> No authentication (NOSASL).</span><br><span class=\"line\">UseSASL=<span class=\"number\">0</span></span><br><span class=\"line\"># Kerberos related settings.</span><br><span class=\"line\">KrbFQDN=</span><br><span class=\"line\">KrbRealm=</span><br><span class=\"line\">KrbServiceName=</span><br><span class=\"line\"># Username/password authentication with SASL settings.</span><br><span class=\"line\">UID=hdfs</span><br><span class=\"line\">PWD=</span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">0</span> <span class=\"keyword\">to</span> disable SSL.</span><br><span class=\"line\"># Set <span class=\"keyword\">to</span> <span class=\"number\">1</span> <span class=\"keyword\">to</span> enable SSL.</span><br><span class=\"line\">SSL=<span class=\"number\">0</span></span><br><span class=\"line\">CAIssuedCertNamesMismatch=<span class=\"number\">1</span></span><br><span class=\"line\">TrustedCerts=/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/lib/<span class=\"number\">64</span>/cacerts.pem</span><br><span class=\"line\"># General settings</span><br><span class=\"line\">TSaslTransportBufSize=<span class=\"number\">1000</span></span><br><span class=\"line\">RowsFetchedPerBlock=<span class=\"number\">10000</span></span><br><span class=\"line\">SocketTimeout=<span class=\"number\">0</span></span><br><span class=\"line\">StringColumnLength=<span class=\"number\">32767</span></span><br><span class=\"line\">UseNativeQuery=<span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"创建配置odbc-odbcinst-ini\"><a href=\"#创建配置odbc-odbcinst-ini\" class=\"headerlink\" title=\"创建配置odbc/odbcinst.ini\"></a>创建配置odbc/odbcinst.ini</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost config_odbc]# <span class=\"keyword\">vim</span> odbc/odbcinst.ini    【注意里面包含了ODBC连接hive和impala的配置】</span><br><span class=\"line\"></span><br><span class=\"line\">[ODBC Drivers]</span><br><span class=\"line\">Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive <span class=\"number\">64</span>-bit=Installed</span><br><span class=\"line\">Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala <span class=\"number\">64</span>-bit=Installed</span><br><span class=\"line\">#[Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive <span class=\"number\">32</span>-bit]</span><br><span class=\"line\">#Description=Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive (<span class=\"number\">32</span>-bit)</span><br><span class=\"line\">#Driver=/<span class=\"keyword\">opt</span>/cloudera/hiveodbc/lib/<span class=\"number\">32</span>/libclouderahiveodbc32.<span class=\"keyword\">so</span></span><br><span class=\"line\">[Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive <span class=\"number\">64</span>-bit]</span><br><span class=\"line\">Description=Cloudera ODBC Driver <span class=\"keyword\">for</span> Apache Hive (<span class=\"number\">64</span>-bit)</span><br><span class=\"line\">Driver=/<span class=\"keyword\">opt</span>/cloudera/hiveodbc/lib/<span class=\"number\">64</span>/libclouderahiveodbc64.<span class=\"keyword\">so</span></span><br><span class=\"line\">## The option below <span class=\"keyword\">is</span> <span class=\"keyword\">for</span> using unixODBC when compiled with -DSQL_WCHART_CONVERT.</span><br><span class=\"line\">## Execute <span class=\"string\">'odbc_config --cflags'</span> <span class=\"keyword\">to</span> determine <span class=\"keyword\">if</span> you need <span class=\"keyword\">to</span> uncomment it.</span><br><span class=\"line\"># IconvEncoding=UCS-<span class=\"number\">4</span>LE</span><br><span class=\"line\">[Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala <span class=\"number\">64</span>-bit]</span><br><span class=\"line\">Description=Cloudera ODBC Driver <span class=\"keyword\">for</span> Impala (<span class=\"number\">64</span>-bit)</span><br><span class=\"line\">Driver=/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/lib/<span class=\"number\">64</span>/libclouderaimpalaodbc64.<span class=\"keyword\">so</span></span><br><span class=\"line\">## The option below <span class=\"keyword\">is</span> <span class=\"keyword\">for</span> using unixODBC when compiled with -DSQL_WCHART_CONVERT.</span><br><span class=\"line\">## Execute <span class=\"string\">'odbc_config --cflags'</span> <span class=\"keyword\">to</span> determine <span class=\"keyword\">if</span> you need <span class=\"keyword\">to</span> uncomment it.</span><br><span class=\"line\"># IconvEncoding=UCS-<span class=\"number\">4</span>LE</span><br></pre></td></tr></table></figure>\n<h4 id=\"创建配置odbc-cloudera-impalaodbc-ini\"><a href=\"#创建配置odbc-cloudera-impalaodbc-ini\" class=\"headerlink\" title=\"创建配置odbc/cloudera.impalaodbc.ini\"></a>创建配置odbc/cloudera.impalaodbc.ini</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost config_odbc]# <span class=\"keyword\">vim</span> odbc/cloudera.impalaodbc.ini    【注意里面包含了ODBC连接hive和impala的配置】</span><br><span class=\"line\"></span><br><span class=\"line\">[Driver]</span><br><span class=\"line\">## - Note that this default DriverManagerEncoding of UTF-<span class=\"number\">32</span> <span class=\"keyword\">is</span> <span class=\"keyword\">for</span> iODBC.</span><br><span class=\"line\">## - unixODBC uses UTF-<span class=\"number\">16</span> by default.</span><br><span class=\"line\">## - If unixODBC was compiled with -DSQL_WCHART_CONVERT, then UTF-<span class=\"number\">32</span> <span class=\"keyword\">is</span> the correct value.</span><br><span class=\"line\">##   Execute <span class=\"string\">'odbc_config --cflags'</span> <span class=\"keyword\">to</span> determine <span class=\"keyword\">if</span> you need UTF-<span class=\"number\">32</span> <span class=\"built_in\">or</span> UTF-<span class=\"number\">16</span> <span class=\"keyword\">on</span> unixODBC</span><br><span class=\"line\">## - SimbaDM can <span class=\"keyword\">be</span> used with UTF-<span class=\"number\">8</span> <span class=\"built_in\">or</span> UTF-<span class=\"number\">16</span>.</span><br><span class=\"line\">##   The DriverUnicodeEncoding setting will cause SimbaDM <span class=\"keyword\">to</span> run in UTF-<span class=\"number\">8</span> when <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"number\">2</span> <span class=\"built_in\">or</span> UTF-<span class=\"number\">16</span> when <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"number\">1</span>.</span><br><span class=\"line\">DriverManagerEncoding=UTF-<span class=\"number\">32</span></span><br><span class=\"line\">ErrorMessagesPath=/<span class=\"keyword\">opt</span>/cloudera/impalaodbc/ErrorMessages</span><br><span class=\"line\">LogLevel=<span class=\"number\">0</span></span><br><span class=\"line\">LogPath=</span><br><span class=\"line\">## - Uncomment the ODBCInstLib corresponding <span class=\"keyword\">to</span> the Driver Manager being used.</span><br><span class=\"line\">## - Note that the path <span class=\"keyword\">to</span> your ODBC Driver Manager must <span class=\"keyword\">be</span> specified in LD_LIBRARY_PATH (LIBPATH <span class=\"keyword\">for</span> AIX).</span><br><span class=\"line\">## - Note that AIX <span class=\"built_in\">has</span> <span class=\"keyword\">a</span> different format <span class=\"keyword\">for</span> specifying its shared libraries.</span><br><span class=\"line\"># Generic ODBCInstLib</span><br><span class=\"line\">#   iODBC</span><br><span class=\"line\">#ODBCInstLib=libiodbcinst.<span class=\"keyword\">so</span></span><br><span class=\"line\">#   SimbaDM / unixODBC</span><br><span class=\"line\">ODBCInstLib=libodbcinst.<span class=\"keyword\">so</span></span><br><span class=\"line\"># AIX specific ODBCInstLib</span><br><span class=\"line\">#   iODBC</span><br><span class=\"line\">#ODBCInstLib=libiodbcinst.<span class=\"keyword\">a</span>(libiodbcinst.<span class=\"keyword\">so</span>.<span class=\"number\">2</span>)</span><br><span class=\"line\">#   SimbaDM</span><br><span class=\"line\">#ODBCInstLib=libodbcinst.<span class=\"keyword\">a</span>(odbcinst.<span class=\"keyword\">so</span>)</span><br><span class=\"line\">#   unixODBC</span><br><span class=\"line\">#ODBCInstLib=libodbcinst.<span class=\"keyword\">a</span>(libodbcinst.<span class=\"keyword\">so</span>.<span class=\"number\">1</span>)</span><br></pre></td></tr></table></figure>\n<h4 id=\"创建配置cloudera-hiveodbc-ini\"><a href=\"#创建配置cloudera-hiveodbc-ini\" class=\"headerlink\" title=\"创建配置cloudera.hiveodbc.ini\"></a>创建配置cloudera.hiveodbc.ini</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost config_odbc]# <span class=\"keyword\">vim</span> odbc/cloudera.hiveodbc.ini    【注意里面包含了ODBC连接hive和impala的配置】</span><br><span class=\"line\"></span><br><span class=\"line\">[Driver]</span><br><span class=\"line\">ErrorMessagesPath=/<span class=\"keyword\">opt</span>/cloudera/hiveodbc/ErrorMessages/</span><br><span class=\"line\">LogLevel=<span class=\"number\">0</span></span><br><span class=\"line\">LogPath=</span><br><span class=\"line\">SwapFilePath=/tmp</span><br></pre></td></tr></table></figure>\n<h4 id=\"进行测试\"><a href=\"#进行测试\" class=\"headerlink\" title=\"进行测试\"></a>进行测试</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost config_odbc]<span class=\"comment\"># source common.env</span></span><br><span class=\"line\">        [root@localhost config_odbc]<span class=\"comment\"># isql -v 'impala'</span></span><br><span class=\"line\">        +---------------------------------------+</span><br><span class=\"line\">        | Connected!                            |</span><br><span class=\"line\">        |                                       |</span><br><span class=\"line\">        | sql-statement                         |</span><br><span class=\"line\">        | <span class=\"built_in\">help</span> [tablename]                      |</span><br><span class=\"line\">        | quit                                  |</span><br><span class=\"line\">        |                                       |</span><br><span class=\"line\">        +---------------------------------------+</span><br></pre></td></tr></table></figure>\n<p>注意前提是, 连接的IP的端口已经开启了此机器的访问权限, 否则会出现如下错误:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost config_odbc]<span class=\"comment\"># isql -v 'impala'</span></span><br><span class=\"line\">        [S1000][unixODBC][Cloudera][ImpalaODBC] (100) Error from the Impala Thrift API: connect() failed: Connection timed out</span><br><span class=\"line\">        [ISQL]ERROR: Could not SQLConnect</span><br></pre></td></tr></table></figure>\n<h4 id=\"运行php进行测试\"><a href=\"#运行php进行测试\" class=\"headerlink\" title=\"运行php进行测试\"></a>运行php进行测试</h4><p>1)如果是安装odbc扩展的, 如下:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure --prefix=<span class=\"variable\">$php_root</span> --with-config-file-path=/etc --with-mysql=<span class=\"variable\">$mysql_root</span> --with-pdo-mysql=<span class=\"variable\">$mysql_root</span>/bin/mysql_config --with-mysqli=<span class=\"variable\">$mysql_root</span>/bin/mysql_config --with-iconv-dir=/usr/<span class=\"built_in\">local</span> --with-freetype-dir --with-jpeg-dir --with-png-dir --<span class=\"built_in\">enable</span>-gd-native-ttf --<span class=\"built_in\">enable</span>-zip --with-zlib --with-gd --<span class=\"built_in\">disable</span>-rpath --<span class=\"built_in\">enable</span>-bcmath --<span class=\"built_in\">enable</span>-shmop --<span class=\"built_in\">enable</span>-sysvsem --with-curl --with-curlwrappers --<span class=\"built_in\">enable</span>-mbstring --with-mcrypt --<span class=\"built_in\">disable</span>-ipv6 --<span class=\"built_in\">enable</span>-static --<span class=\"built_in\">enable</span>-maintainer-zts --<span class=\"built_in\">enable</span>-sockets --<span class=\"built_in\">enable</span>-soap --with-openssl --without-pdo-sqlite --<span class=\"built_in\">enable</span>-fpm --with-unixODBC=/usr/</span><br></pre></td></tr></table></figure>\n<p>那么, 就用面向过程的写法:</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]<span class=\"comment\"># vim test-php-odbc-impala.php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$conn = odbc_connect(<span class=\"string\">\"impala\"</span>, <span class=\"string\">\"\"</span>, <span class=\"string\">\"\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"开始时间:\"</span> . time() . <span class=\"string\">\"\\r\\n\"</span>;</span><br><span class=\"line\">$sql = <span class=\"string\">\"select * from db_mcfx_log.t_log_sdk_log_pay\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"准备执行sql语句: $sql\\r\\n\"</span>;</span><br><span class=\"line\">$rs = odbc_exec($conn, $sql);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"语句执行完成, 准备开始获取结果集\\r\\n\"</span>;</span><br><span class=\"line\">$result = [];</span><br><span class=\"line\"><span class=\"keyword\">while</span> ($row=odbc_fetch_array($rs)) &#123;</span><br><span class=\"line\">    $result[] = $row;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"结果获取完毕\\r\\n\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"总记录数量: \"</span> . sizeof($result) . <span class=\"string\">\"\\r\\n\"</span>;</span><br><span class=\"line\">odbc_close($conn);</span><br><span class=\"line\">var_dump($conn);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"结束时间: \"</span> . time() . <span class=\"string\">\"\\r\\n\"</span>;</span><br></pre></td></tr></table></figure>\n<p>2)如果是安装pdo_odbc扩展的, 那么就用面向过程的方法如下测试:</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$dbh= <span class=\"keyword\">new</span> PDO(<span class=\"string\">'odbc:impala'</span>, <span class=\"string\">''</span>, <span class=\"string\">''</span>);</span><br><span class=\"line\">$sql = <span class=\"string\">\"select count(*) from db_mcfx_log.t_log_sdk_log_pay\"</span>;</span><br><span class=\"line\">$stmt = $dbh-&gt;prepare(<span class=\"string\">\"$sql\"</span>);</span><br><span class=\"line\">$stmt-&gt;execute();</span><br><span class=\"line\"><span class=\"keyword\">while</span> ($row = $stmt-&gt;fetch()) &#123;</span><br><span class=\"line\">    print_r($row);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">unset</span>($dbh); <span class=\"keyword\">unset</span>($stmt);</span><br></pre></td></tr></table></figure>\n<p>3)注意:</p>\n<p>如果PHP开启了开机自启动, 那么可能会出现连接odbc报错说库文件找不到.<br>这时候, 可以重启PHP那么就可以解决了, 原因暂时未明.</p>\n<h3 id=\"php常用ODBC函数集\"><a href=\"#php常用ODBC函数集\" class=\"headerlink\" title=\"php常用ODBC函数集\"></a>php常用ODBC函数集</h3><ol>\n<li>ODBC连接类函数<br> odbc_connect函数: 打开一个ODBC连接<br> odbc_close函数: 关闭一个已经打开的ODBC连接<br> odbc_close_all函数: 关闭所有已经打开的ODBC连接<br> odbc_pconnect函数: 打开一个持续有效的ODBC连接</li>\n<li>ODBC操作类函数<br> odbc_commit函数: 更新所有处于未决状态的操作<br> odbc_do函数: 在打开的ODBC连接上执行SQL语句<br> odbc_exec函数: 执行SQL语句<br> odbc_execute函数: 执行一个预置的SQL语句<br> odbc_free_result函数: 释放传回资料所占用的内存<br> odbc_prepare函数: 预置SQL语句的执行<br> odbc_rollback函数: 撤销所有处于未决状态的操作</li>\n<li>ODBC信息获取类函数<br> odbc_columnprivileges函数: 列出给定表的列和相关的权限<br> odbc_columns函数: 列出指定表的列的名称<br> odbc_cursor函数: 获取光标的名称<br> odbc_data_source函数: 返回连接数据库的信息<br> odbc_error函数: 获取最后的错误代码<br> odbc_errormsg函数: 获取最后的错误信息<br> odbc_fetch_array函数: 获取结果集数组<br> odbc_fetch_into函数: 获取传回的指定列<br> odbc_fetch_object函数: 返回结果集到对象<br> odbc_fetch_row函数: 获取传回的一列<br> odbc_field_len函数: 获取字段的长度<br> odbc_field_name函数: 获取字段的名称<br> odbc_field_num函数: 获取字段的序号<br> odbc_field_precision函数: 获取字段的长度<br> odbc_field_scale函数: 获取字段的浮点数<br> odbc_field_type函数: 获取字段的资料类型<br> odbc_foreignkeys函数: 返回特定表的外来键<br> odbc_gettypeinfo函数: 返回数据库的类型信息<br> odbc_longreadlen函数: 设定传回栏的最大值<br> odbc_num_fields函数: 获取字段数目<br> odbc_num_rows函数: 获取传回的列数目<br> odbc_primarykeys函数: 返回列的名字作为表的主键<br> odbc_procedurecolumns函数: 返回检索过程的参数信息<br> odbc_procedures函数: 获取存在于特定数据源中的进程信息<br> odbc_result_all函数: 传回HTML表格信息<br> odbc_result函数: 获取结果数据<br> odbc_specialcolumns函数: 返回一个表中在传送更新时可以自动更新的列<br> odbc_statistics函数: 获取表的状态及其索引<br> odbc_tableprivileges函数: 列出表格和每个表格关联的权限<br> odbc_tables函数: 获取特定数据库上的表的名称<br> odbc_autocommit函数: 开启或关闭自动更新<br> odbc_binmode函数: 设定二进制的数据处理方式<br> odbc_next_result函数: 检查下一个结果集是否可用<br> odbc_setoption函数: 调整ODBC设定</li>\n</ol>\n","categories":["技术"],"tags":["PHP","impala"]},{"title":"安装impala-shell遇到的问题","url":"http://funsoul.org/2017/12/05/安装impala-shell遇到的问题/","content":"<h3 id=\"下载rpm包\"><a href=\"#下载rpm包\" class=\"headerlink\" title=\"下载rpm包\"></a>下载rpm包</h3><p> <a href=\"http://archive.cloudera.com/cdh5/redhat/6/x86_64/cdh/5.4.9/RPMS/x86_64/\" target=\"_blank\" rel=\"noopener\">impala-shell-2.2.0+cdh5.4.9+0-1.cdh5.4.9.p0.30.el6.x86_64.rpm</a></p>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># yum install python-setuptools</span><br><span class=\"line\"># rpm -ivh impala-shell-2.2.0+cdh5.4.9+0-1.cdh5.4.9.p0.30.el6.x86_64.rpm</span><br></pre></td></tr></table></figure>\n<h4 id=\"报错\"><a href=\"#报错\" class=\"headerlink\" title=\"报错\"></a>报错</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">error: Failed dependencies: libpython2.6.so.1.0()(64bit) is needed by impala-shell-2.2.0+cdh5.4.9+0-1.cdh5.4.9.p0.30.el6.x86_64.rpm</span><br></pre></td></tr></table></figure>\n<h4 id=\"下载并安装\"><a href=\"#下载并安装\" class=\"headerlink\" title=\"下载并安装\"></a>下载并安装</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -Uvh lib64python2.6-2.6.6-1mdv2011.0.x86_64.rpm</span><br></pre></td></tr></table></figure>\n<h3 id=\"连接\"><a href=\"#连接\" class=\"headerlink\" title=\"连接\"></a>连接</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># impala-shell</span><br></pre></td></tr></table></figure>\n<h4 id=\"报错-1\"><a href=\"#报错-1\" class=\"headerlink\" title=\"报错\"></a>报错</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">···</span><br><span class=\"line\">···</span><br><span class=\"line\">ImportError: libsasl2.so.2: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>\n<h4 id=\"检查sasl\"><a href=\"#检查sasl\" class=\"headerlink\" title=\"检查sasl\"></a>检查sasl</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -qa | grep sasl</span><br><span class=\"line\">rpm -ql cyrus-sasl-lib</span><br></pre></td></tr></table></figure>\n<p>发现 libsasl2.so.3被 cyrus-sasl-lib 安装在了 /usr/lib64/.这个目录下</p>\n<h4 id=\"重装sasl\"><a href=\"#重装sasl\" class=\"headerlink\" title=\"重装sasl\"></a>重装sasl</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip uninstall sasl</span><br><span class=\"line\">pip install sasl</span><br></pre></td></tr></table></figure>\n<p>pip不存在</p>\n<h4 id=\"安装pip\"><a href=\"#安装pip\" class=\"headerlink\" title=\"安装pip\"></a>安装pip</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yun install -y pip</span><br><span class=\"line\">Nothing to do</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装epel扩展源\"><a href=\"#安装epel扩展源\" class=\"headerlink\" title=\"安装epel扩展源\"></a>安装epel扩展源</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum -y install epel-release</span><br><span class=\"line\">yum -y install python-pip</span><br></pre></td></tr></table></figure>\n<h4 id=\"卸载sasl\"><a href=\"#卸载sasl\" class=\"headerlink\" title=\"卸载sasl\"></a>卸载sasl</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip uninstall sasl</span><br></pre></td></tr></table></figure>\n<p>无法删除</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cannot uninstall requirement sasl, not installed</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装sasl\"><a href=\"#安装sasl\" class=\"headerlink\" title=\"安装sasl\"></a>安装sasl</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install sasl</span><br><span class=\"line\"></span><br><span class=\"line\">sasl/saslwrapper.cpp:8:22: fatal error: pyconfig.h: No such file or directory</span><br><span class=\"line\">#include &quot;pyconfig.h&quot;</span><br><span class=\"line\">^</span><br><span class=\"line\">compilation terminated.</span><br><span class=\"line\">error: command &apos;gcc&apos; failed with exit status 1</span><br></pre></td></tr></table></figure>\n<h4 id=\"继续找问题，回到这一步\"><a href=\"#继续找问题，回到这一步\" class=\"headerlink\" title=\"继续找问题，回到这一步\"></a>继续找问题，回到这一步</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ImportError: libsasl2.so.2: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>\n<h4 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Sometimes these version problems can be resolved by creating a symbolic link with another version of the same library. If you have libsasl2.so installed, create a linked file libsasl2.so.2 for the same:</span><br><span class=\"line\"></span><br><span class=\"line\">sudo ln -s /usr/lib64/libsasl2.so /usr/lib64/libsasl2.so.2</span><br></pre></td></tr></table></figure>","categories":["技术"],"tags":["问题排查","impala"]},{"title":"PHP中两个数组怎样才算相等？","url":"http://funsoul.org/2017/11/15/PHP中两个数组怎样才算相等？/","content":"<p>今天遇到一个有趣的问题，两个数组，判断他们是否是相等的（元素个数、元素均一样），至于元素顺序是否也要一样？下面的判断给出了答案。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>];</span><br><span class=\"line\">$b = [<span class=\"number\">2</span>,<span class=\"number\">1</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>];</span><br><span class=\"line\">$c = [<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>];</span><br><span class=\"line\">var_dump($a==$c); <span class=\"comment\">// true</span></span><br><span class=\"line\">var_dump($a==$b); <span class=\"comment\">// false</span></span><br><span class=\"line\">var_dump(array_diff($a,$b)); <span class=\"comment\">// empty =&gt; true</span></span><br></pre></td></tr></table></figure>\n<p>可以发现，如果使用“==”做判断，如果两个数组的顺序不等，那么这两个数组竟然不是一样的了，这时可以使用array_diff来做判断。<br>array_diff是以a数组为基准，找出a数组中不存在于b数组的差值，既然两个数组元素是一样的，那当然没问题。<br>可以认为他们是除了顺序之外相等的两个数组。可是这么处理也是有问题的，接着看</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = [<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>];</span><br><span class=\"line\">$b = [<span class=\"number\">2</span>,<span class=\"number\">1</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>];</span><br><span class=\"line\">var_dump(array_diff($a,$b)); <span class=\"comment\">// empty =&gt; true</span></span><br></pre></td></tr></table></figure>\n<p>是的，这样也是emtpy。严谨起见，可以这样，</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$res = <span class=\"keyword\">empty</span>(array_diff($a,$b)) &amp;&amp; <span class=\"keyword\">empty</span>(array_diff($b,$a));</span><br></pre></td></tr></table></figure>","categories":["技术"],"tags":["PHP"]},{"title":"【Phalcon】请求volt与请求json的性能压测对比","url":"http://funsoul.org/2017/03/07/【Phalcon】请求volt与请求json的性能压测对比/","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近比较忙，没有太多时间更新博客。不过，公司要求实习生每天都写日报，一周完结的时候还要写周报。我便把每天遇到的问题和思考都记在了日志中，也算是小型博客了。在最近的工作中，遇到了一些痛点。我想把解决这些痛点的经过写下来。</p>\n<p>使用Phalcon，模板引擎Volt是一个亮点，我们不需要写原生的PHP代码，当然如果逻辑很复杂，Volt无法满足我们的需求，可以使用原生。</p>\n<h2 id=\"Phalcon的模板渲染流程是这样的，\"><a href=\"#Phalcon的模板渲染流程是这样的，\" class=\"headerlink\" title=\"Phalcon的模板渲染流程是这样的，\"></a>Phalcon的模板渲染流程是这样的，</h2><h3 id=\"路由\"><a href=\"#路由\" class=\"headerlink\" title=\"路由\"></a>路由</h3><p> =&gt; 控制器(如indexController) ，使用setVars把变量发到视图</p>\n<p> =&gt; views，存放所有视图</p>\n<p> =&gt; views/index.volt</p>\n<p> =&gt; views/index/</p>\n<p> =&gt; views/index/index.volt，视图文件</p>\n<p>这样一来，只需要在最终的视图文件中写HTML即可，但是调试起来并不是非常友好，至少在PHPStorm里面不会语法高亮。</p>\n<p>回到渲染过程，可以把PHP逻辑写成Volt模板语句。一个页面就生成并返回到浏览器了。</p>\n<p>但是，这里的痛点也开始出现了。有时候，在页面DOM生成的时候，整个页面还未加载完成，我们希望根据服务端传来的数据，使用JS改变页面的呈现。比如，我们希望保存中国的省份信息在一个JS变量中，然后把它循环输出到页面中。以前我们可以直接把PHP变量发送到JS中保存，现在不奏效了。使用setVars保存的变量，并不能发送到JS中。有人说，可以使用PHP输出JS变量，这个还未尝试过，而且我会告诉你，即使这样做能行，也不能很好的解决我所描述的业务。</p>\n<h2 id=\"请求JSON\"><a href=\"#请求JSON\" class=\"headerlink\" title=\"请求JSON\"></a>请求JSON</h2><p>这是一个类似微博时间线的业务，如果我使用刚才说的方法，使用PHP输出JS变量（实现起来应该很简单），那么，第一次加载的时候，可以做成一个包含时间线数据的JSON，以及一个空的HTML和一堆JS模板，在页面加载的时候，JS读取变量数据，填充到预先写好的JS模板，再渲染到Body中，看似没问题，渲染页面的工作交给了JS，服务端只负责取数据，不负责渲染HTML。那么，SEO呢？搜索引擎是不知道JSON数据里面的信息有什么关系的，所以，对爬虫并不友好。尽管对开发人员来说，只需要写一套JS模板就可以了，是一件多么开心的事情~</p>\n<h2 id=\"结合Volt和JSON\"><a href=\"#结合Volt和JSON\" class=\"headerlink\" title=\"结合Volt和JSON\"></a>结合Volt和JSON</h2><p>第二种方法，大多数人都会这样做。还是使用Volt在服务端渲染HTML，输出到浏览器，当我请求下一页的时候，使用JSON返回数据，前端有一套由JS写的逻辑一样的模板，然后使用高效一点的模板引擎，填充到模板中，最后输出到页面（局部动态刷新）。这里有一个痛点，那就是，同一套逻辑，PHP写一遍，JS一遍，维护起来也相当麻烦。不过效率很高，看下面的压测数据。</p>\n<h2 id=\"完全使用Volt\"><a href=\"#完全使用Volt\" class=\"headerlink\" title=\"完全使用Volt\"></a>完全使用Volt</h2><p>第三种方法，AJAX这一步，我请求一个webapi，而不是ajaxapi，什么意思？其实返回数据是一个包含HTML标签的页面。具体怎么做？在indexController里面定义一个nextPageAction，然后在views/index/中新建一个nextPage.volt，里面是index中抽出来的时间线业务模板。我只需要在nextPageAction中获取数据，并setVars到nextPage.volt中，返回。我就能得到一个渲染好的模板，直接append到页面中即可。是不是非常简单！这样一来，只有一套模板代码，维护简单，也很开心。但是，正如我刚刚说，返回数据原本应该只有JSON，现在多了HTML标签，体积大了，是否会造成一些影响？想不出来，用数据说话把！</p>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><ul>\n<li>ubuntu 16.04</li>\n<li>64位</li>\n<li>CPU:2</li>\n<li>内存：4G</li>\n<li>硬盘(SCSI)：20G</li>\n<li>Apache</li>\n<li>PHP 7.0.14</li>\n<li>MySQL 5.6</li>\n<li>Apache Bench 2.3</li>\n</ul>\n<h2 id=\"压测前准备：\"><a href=\"#压测前准备：\" class=\"headerlink\" title=\"压测前准备：\"></a>压测前准备：</h2><p>使用浏览器登录网站，到审查元素中 -&gt; network -&gt; cookies<br>获取所需cookie。</p>\n<p>请求的时间线数据是相同的第二页。</p>\n<h2 id=\"开始压测：\"><a href=\"#开始压测：\" class=\"headerlink\" title=\"开始压测：\"></a>开始压测：</h2><h3 id=\"一、请求Volt\"><a href=\"#一、请求Volt\" class=\"headerlink\" title=\"一、请求Volt\"></a>一、请求Volt</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ab -n 100 -H <span class=\"string\">\"Cookie:key=value;key=value\"</span> http://localhost/index/timeline</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/20170307235446889.jpg\" alt></p>\n<p>在上一个基础上加10个并发</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ab -n 100 -c 10 -H <span class=\"string\">\"Cookie:key=value;key=value\"</span> http://localhost/index/timeline</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/20170307235503952.jpg\" alt></p>\n<p>2000请求，200并发</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ab -n 2000 -c 200 -H <span class=\"string\">\"Cookie:key=value;key=value\"</span> http://localhost/index/timeline</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/20170307235516635.jpg\" alt></p>\n<h3 id=\"二、请求Json\"><a href=\"#二、请求Json\" class=\"headerlink\" title=\"二、请求Json\"></a>二、请求Json</h3><p>100请求，10并发</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ab -n 100 -c 10 -H <span class=\"string\">\"Cookie:key=value;key=value\"</span> http://localhost/index/timeline</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/20170307235529197.jpg\" alt></p>\n<p>2000请求，200并发</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ab -n 2000 -c 200 -H <span class=\"string\">\"Cookie:key=value;key=value\"</span> http://localhost/index/timeline</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/20170307235552891.jpg\" alt></p>\n<h3 id=\"2000请求，并发200对比\"><a href=\"#2000请求，并发200对比\" class=\"headerlink\" title=\"2000请求，并发200对比\"></a>2000请求，并发200对比</h3><table>\n<thead>\n<tr>\n<th></th>\n<th style=\"text-align:right\">请求Volt</th>\n<th style=\"text-align:center\">请求json</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Time taken for tests        (seconds)</td>\n<td style=\"text-align:right\">70.096</td>\n<td style=\"text-align:center\">63.901</td>\n</tr>\n<tr>\n<td>Total transferred           (bytes)</td>\n<td style=\"text-align:right\">43890000</td>\n<td style=\"text-align:center\">11228000</td>\n</tr>\n<tr>\n<td>HTML transferred        ( bytes )</td>\n<td style=\"text-align:right\">43298000</td>\n<td style=\"text-align:center\">10578000</td>\n</tr>\n<tr>\n<td>Requests per second    [#/sec] (mean)</td>\n<td style=\"text-align:right\">28.53</td>\n<td style=\"text-align:center\">31.30</td>\n</tr>\n<tr>\n<td>Time per request          [ms] (mean)</td>\n<td style=\"text-align:right\">7009.527</td>\n<td style=\"text-align:center\">6390.073</td>\n</tr>\n<tr>\n<td>Time per request       [ms] (mean,across all concurrent requests)</td>\n<td style=\"text-align:right\">35.048</td>\n<td style=\"text-align:center\">31.950</td>\n</tr>\n<tr>\n<td>Transfer rate            [Kbytes/sec] received</td>\n<td style=\"text-align:right\">611.47</td>\n<td style=\"text-align:center\">171.59</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h2><ol>\n<li>数据（包含HTML）比原来（JSON串）大4倍以上；</li>\n<li>网络传输效率比原来低三倍以上；</li>\n</ol>\n<p>考虑到网络延时情况，实时性，数据量大、效率要求高的地方，如时间线，应该优先使用JSON传输数据。其他的可以考虑使用请求volt方法，提高开发效率。</p>\n","categories":["技术"],"tags":["PHP","Phlacon","Apache Bench"]},{"title":"【Phalcon】路由拆分","url":"http://funsoul.org/2016/12/15/【Phalcon】路由拆分/","content":"<h2 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h2><p>去年使用过PHP的Flight框架编写api，Flight框架非常简单，只需要花一点点时间看官方文档即可上手写代码，原生支持Restful风格。刚开始没觉得什么，只要有需求则加一个路由，由于项目不大，总共也不超过10个。</p>\n<p>最近在使用Phalcon，项目规模中等，在路由（routes.php）那里遇到了本文所关注的痛点，几十个路由放在一个文件中，而且还会继续往里加，当达到一定的数量级，如果有一天，我想改其中某一个路由（名称忘了或者记不清），则需要滚动鼠标刷半天才找到。代码混乱，所有的controller/action都放在这里管理。</p>\n<p>如下</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 首页</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">$router-&gt;add(</span><br><span class=\"line\">    <span class=\"string\">\"/\"</span>,</span><br><span class=\"line\">    [</span><br><span class=\"line\">        <span class=\"string\">\"controller\"</span> =&gt; <span class=\"string\">\"index\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"action\"</span>     =&gt; <span class=\"string\">\"index\"</span>,</span><br><span class=\"line\">    ]</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 用户信息</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">$router-&gt;add(</span><br><span class=\"line\">    <span class=\"string\">\"/user/info\"</span>,</span><br><span class=\"line\">    [</span><br><span class=\"line\">        <span class=\"string\">\"controller\"</span> =&gt; <span class=\"string\">\"user\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"action\"</span>     =&gt; <span class=\"string\">\"info\"</span>,</span><br><span class=\"line\">    ]</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 添加商品到购物车</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">$router-&gt;add(</span><br><span class=\"line\">    <span class=\"string\">\"/shopcart/add\"</span>,</span><br><span class=\"line\">    [</span><br><span class=\"line\">        <span class=\"string\">\"controller\"</span> =&gt; <span class=\"string\">\"shopcart\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"action\"</span>     =&gt; <span class=\"string\">\"add\"</span>,</span><br><span class=\"line\">    ]</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n<h2 id=\"正文\"><a href=\"#正文\" class=\"headerlink\" title=\"正文\"></a>正文</h2><p>既然有痛点，那就想解决办法</p>\n<p>Phalcon通常的项目结构大概是这样的</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">app/                                   <span class=\"comment\">#应用程序</span></span><br><span class=\"line\">     cache/                            <span class=\"comment\">#缓存文件</span></span><br><span class=\"line\">          data/                             <span class=\"comment\">#缓存数据</span></span><br><span class=\"line\">          metaData/                         <span class=\"comment\">#缓存元数据</span></span><br><span class=\"line\">          models/                           <span class=\"comment\">#缓存模型</span></span><br><span class=\"line\">          views/                            <span class=\"comment\">#缓存视图</span></span><br><span class=\"line\">          volt/                             <span class=\"comment\">#缓存volt模版文件</span></span><br><span class=\"line\">     config/                           <span class=\"comment\">#配置文件</span></span><br><span class=\"line\">          config.example.php                <span class=\"comment\">#配置文件（加载环境配置，返回所有配置）</span></span><br><span class=\"line\">          development.example.php           <span class=\"comment\">#开发环境配置（定义debug模式等）</span></span><br><span class=\"line\">          env.php                           <span class=\"comment\">#配置文件（定义基路径，定义全局变量，设置环境异常模式）      </span></span><br><span class=\"line\">          nginx.example.conf                <span class=\"comment\">#nginx配置</span></span><br><span class=\"line\">          routes.php                        <span class=\"comment\">#返回路由配置</span></span><br><span class=\"line\">          timezones.php                     <span class=\"comment\">#返回时区配置</span></span><br><span class=\"line\">     controllers/                           <span class=\"comment\">#控制器</span></span><br><span class=\"line\">     library/                               <span class=\"comment\">#类库文件（工具类，启动文件）</span></span><br><span class=\"line\">          Badges/                           <span class=\"comment\">#</span></span><br><span class=\"line\">          Github/                           <span class=\"comment\">#</span></span><br><span class=\"line\">          Http/                             <span class=\"comment\">#</span></span><br><span class=\"line\">          Mail/                             <span class=\"comment\">#</span></span><br><span class=\"line\">          Markdown/                         <span class=\"comment\">#</span></span><br><span class=\"line\">          Mvc/                              <span class=\"comment\">#</span></span><br><span class=\"line\">          Notifications/                    <span class=\"comment\">#</span></span><br><span class=\"line\">          Paginator/                        <span class=\"comment\">#</span></span><br><span class=\"line\">          Queue/                            <span class=\"comment\">#</span></span><br><span class=\"line\">          Search/                           <span class=\"comment\">#</span></span><br><span class=\"line\">          Utils/                            <span class=\"comment\">#</span></span><br><span class=\"line\">          Bootstrap.php                     <span class=\"comment\">#启动文件</span></span><br><span class=\"line\">     logs/                                  <span class=\"comment\">#日志文件</span></span><br><span class=\"line\">     models/                                <span class=\"comment\">#模型类</span></span><br><span class=\"line\">     views/                                 <span class=\"comment\">#视图（volt模版）</span></span><br><span class=\"line\">docs/                                  <span class=\"comment\">#项目说明文档 </span></span><br><span class=\"line\">opsfiles/                              <span class=\"comment\">#运维工具配置文件</span></span><br><span class=\"line\"><span class=\"keyword\">public</span>/                                <span class=\"comment\">#公共目录</span></span><br><span class=\"line\">     css/                              <span class=\"comment\">#样式文件</span></span><br><span class=\"line\">     fonts/                            <span class=\"comment\">#字体文件</span></span><br><span class=\"line\">     icon/                             <span class=\"comment\">#图标文件</span></span><br><span class=\"line\">     js/                               <span class=\"comment\">#javascript脚本</span></span><br><span class=\"line\">     .htaccess                         <span class=\"comment\">#路由重写规则（指向该目录下的index.php）</span></span><br><span class=\"line\">     <span class=\"number\">505.</span>html                          <span class=\"comment\">#服务器异常展示文件</span></span><br><span class=\"line\">     index.php                         <span class=\"comment\">#引导文件（框架先从这里开始执行）</span></span><br><span class=\"line\">schemas/                               <span class=\"comment\">#sql文件</span></span><br><span class=\"line\">scripts/                               <span class=\"comment\">#服务器脚本</span></span><br><span class=\"line\">test/                                  <span class=\"comment\">#单元测试</span></span><br><span class=\"line\">.env.example                           <span class=\"comment\">#用户专属环境配置</span></span><br><span class=\"line\">.htaccess                              <span class=\"comment\">#路由重写规则（指向public目录下的index.php）</span></span><br><span class=\"line\">.htrouter.php                          <span class=\"comment\">#与.htaccess文件功能一样，包含public目录下的index.php</span></span><br><span class=\"line\">composer.json                          <span class=\"comment\">#依赖管理文件</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"加载流程\"><a href=\"#加载流程\" class=\"headerlink\" title=\"加载流程\"></a>加载流程</h3><h4 id=\"index-php\"><a href=\"#index-php\" class=\"headerlink\" title=\"index.php\"></a>index.php</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1.</span>/<span class=\"keyword\">public</span>/index.php</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">app</span>\\<span class=\"title\">library</span>\\<span class=\"title\">Bootstrap</span>;</span><br><span class=\"line\">使用命名空间的方式，划分程序块</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">include_once</span> realpath(dirname(dirname(<span class=\"keyword\">__FILE__</span>))) . <span class=\"string\">'/app/config/env.php'</span>;</span><br><span class=\"line\"><span class=\"keyword\">include_once</span> BASE_DIR . <span class=\"string\">'app/library/Bootstrap.php'</span>;</span><br><span class=\"line\">第一行，包含配置文件，配置文件中有BASE_DIR的定义，APPLICATION_ENV的定义</span><br><span class=\"line\">第二行，包含引导文件</span><br><span class=\"line\"></span><br><span class=\"line\">$bootstrap = <span class=\"keyword\">new</span> Bootstrap();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (APPLICATION_ENV == ENV_TESTING) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $bootstrap-&gt;run();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> $bootstrap-&gt;run();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">声明Bootstrap对象，开始执行</span><br></pre></td></tr></table></figure>\n<p>找到Bootstrap.php，初始化路由的代码如下</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Initialize the Router.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">initRouter</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">\t    $router = <span class=\"keyword\">include</span> BASE_DIR . <span class=\"string\">'app/routes/routes.php'</span>;</span><br><span class=\"line\">\t    ...</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>可以发现，路由是这样包含进框架的，去到我们的routes.php，把原来的路由拆分成各自模块的文件，然后包含进routes.php，这样做的好处是，模块化管理，便于查找和修改。</p>\n<h4 id=\"routes-php\"><a href=\"#routes-php\" class=\"headerlink\" title=\"routes.php\"></a>routes.php</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Phalcon</span>\\<span class=\"title\">Mvc</span>\\<span class=\"title\">Router</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$router = <span class=\"keyword\">new</span> Router(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">$router-&gt;removeExtraSlashes(<span class=\"keyword\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * loader the urls</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">$urls = [</span><br><span class=\"line\">    <span class=\"string\">'index'</span>,</span><br><span class=\"line\">    <span class=\"string\">'shopcart'</span>,</span><br><span class=\"line\">    <span class=\"string\">'user'</span>,</span><br><span class=\"line\">];</span><br><span class=\"line\"><span class=\"keyword\">foreach</span> ($urls <span class=\"keyword\">as</span> $url)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">include</span> BASE_DIR.<span class=\"string\">'app/routes/'</span>.$url.<span class=\"string\">'.php'</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">return</span> $router;</span><br></pre></td></tr></table></figure>\n<h4 id=\"user-php\"><a href=\"#user-php\" class=\"headerlink\" title=\"user.php\"></a>user.php</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 用户信息</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">$router-&gt;add(</span><br><span class=\"line\">    <span class=\"string\">\"/user/info\"</span>,</span><br><span class=\"line\">    [</span><br><span class=\"line\">        <span class=\"string\">\"controller\"</span> =&gt; <span class=\"string\">\"user\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"action\"</span>     =&gt; <span class=\"string\">\"info\"</span>,</span><br><span class=\"line\">    ]</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n","categories":["技术"],"tags":["PHP","Phlacon"]},{"title":"【CSS】图片无法自适应高宽bug排查过程","url":"http://funsoul.org/2016/11/29/【CSS】图片无法自适应高宽bug排查过程/","content":"<h2 id=\"前置知识\"><a href=\"#前置知识\" class=\"headerlink\" title=\"前置知识\"></a>前置知识</h2><h3 id=\"css如何做图片自适应高宽？\"><a href=\"#css如何做图片自适应高宽？\" class=\"headerlink\" title=\"css如何做图片自适应高宽？\"></a>css如何做图片自适应高宽？</h3><ul>\n<li><div>块设置固定高宽</div></li>\n<li><div>子元素设置百分比</div></li>\n</ul>\n<p>如下</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-id\">#container</span>&#123;</span><br><span class=\"line\">     <span class=\"attribute\">border</span>:<span class=\"number\">1px</span> solid;</span><br><span class=\"line\">     <span class=\"attribute\">height</span>:<span class=\"number\">180px</span>;</span><br><span class=\"line\">     <span class=\"attribute\">width</span>:<span class=\"number\">380px</span>;   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"selector-id\">#container</span> <span class=\"selector-tag\">img</span>&#123;</span><br><span class=\"line\">     <span class=\"attribute\">height</span>:<span class=\"number\">100%</span>;</span><br><span class=\"line\">     <span class=\"attribute\">width</span>:<span class=\"number\">100%</span>;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"container\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">\"#\"</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"imgs/p2.jpg\"</span> /&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>如图所示</p>\n<p><img src=\"/images/20161110164135461.jpg\" alt=\"p1\"></p>\n<h2 id=\"bug描述\"><a href=\"#bug描述\" class=\"headerlink\" title=\"bug描述\"></a>bug描述</h2><p>业务代码和以上demo有一点区别：</p>\n<ol>\n<li>container宽度固定</li>\n<li>container高度按内容垂直延伸</li>\n</ol>\n<p>按照上面的写法，开始修改我的代码，一切进行的很顺利。然而，当我打开浏览器一看，吓一跳！</p>\n<p>大概长这样：</p>\n<p><img src=\"/images/20161110165150270.jpg\" alt></p>\n<p>刚开始，我把问题定位在标签style的优先级大于style样式表，开始改。<br>后来，应该是别的元素样式冲突了？（使用的是bootstrap）<br>最后，我在火狐的调试工具中发现了一个单词</p>\n<p>container-&gt;static</p>\n<p><img src=\"/images/20161110170007159.jpg\" alt></p>\n<p>img-&gt;static</p>\n<p><img src=\"/images/20161110170032534.jpg\" alt></p>\n<p>a-&gt;absolute</p>\n<p><img src=\"/images/20161110170050712.jpg\" alt></p>\n<p>原来，在样式表中，有这么一个定义</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-id\">#container</span> <span class=\"selector-tag\">a</span>&#123;</span><br><span class=\"line\">  <span class=\"attribute\">position</span>: absolute;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这是啥意思？回顾一下<strong>absolute</strong>的含义</p>\n<blockquote>\n<p>生成绝对定位的元素，相对于 static 定位以外的第一个父元素进行定位。<br>元素的位置通过 “left”, “top”, “right” 以及 “bottom” 属性进行规定。</p>\n</blockquote>\n<p>结果很明了了，由于我的container的高度是按内容垂直延伸的，所以图片的高度等于内容的高度。</p>\n","categories":["技术"],"tags":["问题排查","css"]},{"title":"基于Bootstrap+jQuery写前端分页工具","url":"http://funsoul.org/2016/11/23/基于Bootstrap+jQuery写前端分页工具/","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>为啥名字叫【前端分页工具】？因为我实在想不到什么好名字，如果想要更加贴切的理解这个工具，应该从业务来看</p>\n<p>业务是这样的，有一个数据从后台传到前台，因为数据量不大，因此传过来之后直接显示即可，但是=。=所谓的数据量不大，最多也达到成百上千条，不可能全部显示出来，那么就需要分页</p>\n<p>常规的分页是利用Ajax，通过传页偏移量到后台，后台查询数据库再返回数据，可以实现无刷新分页，拿到的数据也是最新的</p>\n<h3 id=\"前端分页\"><a href=\"#前端分页\" class=\"headerlink\" title=\"前端分页\"></a>前端分页</h3><ul>\n<li>优点：一次传输数据，避免用户反复请求服务器，减少网络带宽、服务器调度压力、数据库查询、缓存查询压力</li>\n<li>缺点：有新数据无法实时更新，除非用户重新请求数据</li>\n</ul>\n<h3 id=\"过程\"><a href=\"#过程\" class=\"headerlink\" title=\"过程\"></a>过程</h3><p>刚开始我不希望造轮子，想尽快完成，于是找了很久Bootstrap的工具，找到了一个BootstrapTable,这个插件很强大，除了可以使用常规的方式分页，还可以指定数据（json），进行前端分页</p>\n<p>但是，这个是表格分页，也就是说，如果不是表格那就没用了，刚好…我的业务就不是表格..那么只能看插件源码修改了，改的面目全非后，上个厕所回来，想到了更好的办法，于是删除…</p>\n<p>解决办法：先思考分页是为了什么？呈现想看的页面，隐藏不想看的。没错，可以利用CSS的display属性</p>\n<h2 id=\"版本\"><a href=\"#版本\" class=\"headerlink\" title=\"版本\"></a>版本</h2><ul>\n<li>Bootstrap-3.3.0</li>\n<li>jQuery-1.11.3</li>\n</ul>\n<h2 id=\"开始编写\"><a href=\"#开始编写\" class=\"headerlink\" title=\"开始编写\"></a>开始编写</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//上一页</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">previous</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//当前页-1</span></span><br><span class=\"line\">        new_page = <span class=\"built_in\">parseInt</span>($(<span class=\"string\">'#current_page'</span>).val()) - <span class=\"number\">1</span>;</span><br><span class=\"line\">        go_to_page(new_page);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//下一页</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">next</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//当前页+1</span></span><br><span class=\"line\">        new_page = <span class=\"built_in\">parseInt</span>($(<span class=\"string\">'#current_page'</span>).val()) + <span class=\"number\">1</span>;</span><br><span class=\"line\">        go_to_page(new_page);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//跳转某一页</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">go_to_page</span>(<span class=\"params\">page_num</span>)</span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">'.page_link[longdesc='</span> + page_num +<span class=\"string\">']'</span>).parent().addClass(<span class=\"string\">'active'</span>).siblings(<span class=\"string\">'.active'</span>).removeClass(<span class=\"string\">'active'</span>);</span><br><span class=\"line\">        <span class=\"comment\">//获取隐藏域中页数大小（每页多少条数据）</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> show_per_page = <span class=\"built_in\">parseInt</span>($(<span class=\"string\">'#show_per_page'</span>).val());</span><br><span class=\"line\">        <span class=\"comment\">//得到元素从哪里开始的片数（点击页 * 页大小）如点击第5页，5条/页。则开始为25</span></span><br><span class=\"line\">        start_from = page_num * show_per_page;</span><br><span class=\"line\">        <span class=\"comment\">//得到结束片的元素数量，如果开始为25，5条/页，则结束为30</span></span><br><span class=\"line\">        end_on = start_from + show_per_page;</span><br><span class=\"line\">        <span class=\"comment\">//隐藏所有子div元素的内容,显示具体片数据，如显示25~30</span></span><br><span class=\"line\">        $(<span class=\"string\">'#datas'</span>).children().css(<span class=\"string\">'display'</span>, <span class=\"string\">'none'</span>).slice(start_from, end_on).css(<span class=\"string\">'display'</span>, <span class=\"string\">'inline-block'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//每页显示的数目</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> show_per_page = <span class=\"number\">10</span>;</span><br><span class=\"line\">        <span class=\"comment\">//获取总数据的数量</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> number_of_items = $(<span class=\"string\">'#datas'</span>).children().size();</span><br><span class=\"line\">        <span class=\"comment\">//计算页数</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> number_of_pages = <span class=\"built_in\">Math</span>.ceil(number_of_items/show_per_page);</span><br><span class=\"line\">        <span class=\"comment\">//在页数区域内则做页偏移</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>( (page_num &gt;= <span class=\"number\">2</span>) &amp;&amp; (page_num &lt;= (number_of_pages - <span class=\"number\">3</span>)) )&#123;</span><br><span class=\"line\">            <span class=\"comment\">//生成分页-&gt;上一页</span></span><br><span class=\"line\">            <span class=\"keyword\">var</span> page_info = <span class=\"string\">'&lt;li&gt;&lt;a class=\"previous_link\" href=\"javascript:previous();\"&gt;&amp;laquo;&lt;/a&gt;&lt;/li&gt;'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">var</span> p = page_num;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> i = page_num - <span class=\"number\">2</span>;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> j = page_num + <span class=\"number\">2</span>;</span><br><span class=\"line\">            <span class=\"comment\">//生成分页-&gt;前2页</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(page_num &gt; i)&#123;</span><br><span class=\"line\">                page_info += <span class=\"string\">'&lt;li&gt;&lt;a class=\"page_link\" href=\"javascript:go_to_page('</span> + i +<span class=\"string\">')\" longdesc=\"'</span> + i +<span class=\"string\">'\"&gt;'</span>+ (i + <span class=\"number\">1</span>) +<span class=\"string\">'&lt;/a&gt;&lt;/li&gt;'</span>;</span><br><span class=\"line\">                i++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//生成分页-&gt;当前页</span></span><br><span class=\"line\">            page_info += <span class=\"string\">'&lt;li&gt;&lt;a class=\"page_link\" href=\"javascript:go_to_page('</span> + page_num +<span class=\"string\">')\" longdesc=\"'</span> + page_num +<span class=\"string\">'\"&gt;'</span>+ (page_num + <span class=\"number\">1</span>) +<span class=\"string\">'&lt;/a&gt;&lt;/li&gt;'</span>;</span><br><span class=\"line\">            <span class=\"comment\">//生成分页-&gt;后2页</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(p &lt; j)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(p == number_of_pages)&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                page_info += <span class=\"string\">'&lt;li&gt;&lt;a class=\"page_link\" href=\"javascript:go_to_page('</span> + (p + <span class=\"number\">1</span>) +<span class=\"string\">')\" longdesc=\"'</span> + (p + <span class=\"number\">1</span>) +<span class=\"string\">'\"&gt;'</span>+ (p + <span class=\"number\">2</span>) +<span class=\"string\">'&lt;/a&gt;&lt;/li&gt;'</span>;</span><br><span class=\"line\">                p++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">//生成分页-&gt;下一页</span></span><br><span class=\"line\">            page_info += <span class=\"string\">'&lt;li&gt;&lt;a class=\"next_link\" href=\"javascript:next();\"&gt;&amp;raquo;&lt;/a&gt;&lt;/li&gt;'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//加载分页</span></span><br><span class=\"line\">            $(<span class=\"string\">'.pagination'</span>).html(page_info);</span><br><span class=\"line\">            $(<span class=\"string\">'.page_link[longdesc='</span> + page_num +<span class=\"string\">']'</span>).parent().addClass(<span class=\"string\">'active'</span>).siblings(<span class=\"string\">'.active'</span>).removeClass(<span class=\"string\">'active'</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123; <span class=\"comment\">//否则不偏移</span></span><br><span class=\"line\">            <span class=\"comment\">//激活某一页，使得显示某一页</span></span><br><span class=\"line\">            $(<span class=\"string\">'.page_link[longdesc='</span> + page_num +<span class=\"string\">']'</span>).parent().addClass(<span class=\"string\">'active'</span>).siblings(<span class=\"string\">'.active'</span>).removeClass(<span class=\"string\">'active'</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//更新隐藏域中当前页</span></span><br><span class=\"line\">        $(<span class=\"string\">'#current_page'</span>).val(page_num);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//每页显示的数目</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> show_per_page = <span class=\"number\">10</span>;</span><br><span class=\"line\">        <span class=\"comment\">//获取话题数据的数量</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> number_of_items = $(<span class=\"string\">'#datas'</span>).children().size();</span><br><span class=\"line\">        <span class=\"comment\">//计算页数</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> number_of_pages = <span class=\"built_in\">Math</span>.ceil(number_of_items/show_per_page);</span><br><span class=\"line\">        <span class=\"comment\">//设置隐藏域默认值</span></span><br><span class=\"line\">        $(<span class=\"string\">'#current_page'</span>).val(<span class=\"number\">0</span>);</span><br><span class=\"line\">        $(<span class=\"string\">'#show_per_page'</span>).val(show_per_page);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//生成分页-&gt;上一页</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> page_info = <span class=\"string\">'&lt;li&gt;&lt;a class=\"previous_link\" href=\"javascript:previous();\"&gt;&amp;laquo;&lt;/a&gt;&lt;/li&gt;'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> current_link = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"comment\">//生成分页-&gt;页数</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(number_of_pages &gt; current_link)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(current_link == <span class=\"number\">5</span>)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            page_info += <span class=\"string\">'&lt;li&gt;&lt;a class=\"page_link\" href=\"javascript:go_to_page('</span> + current_link +<span class=\"string\">')\" longdesc=\"'</span> + current_link +<span class=\"string\">'\"&gt;'</span>+ (current_link + <span class=\"number\">1</span>) +<span class=\"string\">'&lt;/a&gt;&lt;/li&gt;'</span>;</span><br><span class=\"line\">            current_link++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//生成分页-&gt;下一页</span></span><br><span class=\"line\">        page_info += <span class=\"string\">'&lt;li&gt;&lt;a class=\"next_link\" href=\"javascript:next();\"&gt;&amp;raquo;&lt;/a&gt;&lt;/li&gt;'</span>;</span><br><span class=\"line\">        <span class=\"comment\">//加载分页</span></span><br><span class=\"line\">        $(<span class=\"string\">'.pagination'</span>).html(page_info);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//生成分页-&gt;左侧总数</span></span><br><span class=\"line\">        $(<span class=\"string\">\"#data-total-page\"</span>).html(show_per_page+<span class=\"string\">\"条/页，共\"</span>+number_of_pages+<span class=\"string\">\"页\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//激活第一页，使得显示第一页</span></span><br><span class=\"line\">        $(<span class=\"string\">'#data-pagination li'</span>).eq(<span class=\"number\">1</span>).addClass(<span class=\"string\">'active'</span>);</span><br><span class=\"line\">        <span class=\"comment\">//隐藏该对象下面的所有子元素</span></span><br><span class=\"line\">        $(<span class=\"string\">'#datas'</span>).children().css(<span class=\"string\">'display'</span>, <span class=\"string\">'none'</span>);</span><br><span class=\"line\">        <span class=\"comment\">//显示第n（show_per_page）元素</span></span><br><span class=\"line\">        $(<span class=\"string\">'#datas'</span>).children().slice(<span class=\"number\">0</span>, show_per_page).css(<span class=\"string\">'display'</span>, <span class=\"string\">'inline-block'</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure>\n<p>HTML</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;!-- 数据 --&gt;</span><br><span class=\"line\">&lt;div id=&quot;datas&quot;&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    foreach($data as $v)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        echo &apos;&lt;div class=&quot;data&quot;&gt;</span><br><span class=\"line\">                &lt;div class=&quot;data-info&quot;&gt;</span><br><span class=\"line\">                    &lt;div class=&quot;data-name&quot;&gt;&apos; + $v[&apos;name&apos;] + &apos;&lt;/div&gt;</span><br><span class=\"line\">                    &lt;div class=&quot;data-blog&quot;&gt;&apos; + $v[&apos;blog&apos;] + &apos;&lt;/div&gt;</span><br><span class=\"line\">                &lt;/div&gt;</span><br><span class=\"line\">            &lt;/div&gt;</span><br><span class=\"line\">        &apos;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">                  </span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">&lt;!-- 分页 --&gt;</span><br><span class=\"line\">&lt;input type=&quot;hidden&quot; id=&quot;current_page&quot; value=&quot;0&quot;&gt;</span><br><span class=\"line\">&lt;input type=&quot;hidden&quot; id=&quot;show_per_page&quot; value=&quot;0&quot;&gt;</span><br><span class=\"line\">&lt;div id=&quot;data-page-info&quot;&gt;</span><br><span class=\"line\">    &lt;div id=&quot;data-total-page&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\">    &lt;div id=&quot;data-pagination&quot;&gt;</span><br><span class=\"line\">        &lt;ul class=&quot;pagination&quot;&gt;&lt;/ul&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"效果如下\"><a href=\"#效果如下\" class=\"headerlink\" title=\"效果如下\"></a>效果如下</h2><p><img src=\"/images/20161123170010888.jpg\" alt></p>\n<h2 id=\"动态切换\"><a href=\"#动态切换\" class=\"headerlink\" title=\"动态切换\"></a>动态切换</h2><p><img src=\"/images/20161123170142889.jpg\" alt></p>\n","categories":["技术"],"tags":["css","js"]},{"title":"通过Swoole理解Websocket","url":"http://funsoul.org/2016/11/02/通过Swoole理解Websocket/","content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>HTTP特点：</p>\n<h3 id=\"无连接\"><a href=\"#无连接\" class=\"headerlink\" title=\"无连接\"></a>无连接</h3><p>限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。</p>\n<h3 id=\"无状态\"><a href=\"#无状态\" class=\"headerlink\" title=\"无状态\"></a>无状态</h3><p>无状态是指协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。即我们给服务器发送 HTTP 请求之后，服务器根据请求，会给我们发送数据过来，但是，发送完，不会记录任何信息。</p>\n<p>现在，很多网站为了实现<strong>服务器推技术</strong>，通常的解决办法是使用客户端（浏览器）做<strong>AJAX轮询</strong></p>\n<h2 id=\"什么是AJAX轮询？\"><a href=\"#什么是AJAX轮询？\" class=\"headerlink\" title=\"什么是AJAX轮询？\"></a>什么是AJAX轮询？</h2><p>浏览器每间隔一定时间向服务器发送AJAX请求，询问是否有新的数据，如果有，则返回给客户端。一般像下面的代码这样（JQuery描述）</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> link=&#123; 　　　　　　　  <span class=\"comment\">//AJAX执行的配置对象</span></span><br><span class=\"line\">  type:<span class=\"string\">\"GET\"</span>,　　　　　　  <span class=\"comment\">//设置请求方式，默认为GET，</span></span><br><span class=\"line\">  <span class=\"keyword\">async</span>:<span class=\"literal\">true</span>,　　　　　　  <span class=\"comment\">//设置是否异步，默认为异步</span></span><br><span class=\"line\">  url:<span class=\"string\">\"getNewData.php\"</span>,  <span class=\"comment\">//请求的链接</span></span><br><span class=\"line\">  dataType:<span class=\"string\">\"json\"</span>,　　　　<span class=\"comment\">//设置数据的返回格式</span></span><br><span class=\"line\">  success:<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">msg</span>)</span>&#123;</span><br><span class=\"line\">   　　 <span class=\"comment\">//在这里处理返回的数据</span></span><br><span class=\"line\">   　　setTimeout(<span class=\"string\">\"link()\"</span>,<span class=\"number\">300</span>);<span class=\"comment\">//每隔0.3s建立一次新的请求</span></span><br><span class=\"line\">  &#125;<span class=\"comment\">//成功时的回调函数</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$.ajax(link);　　　　　　　　　　<span class=\"comment\">//执行ajax请求。</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"这样会引发什么问题\"><a href=\"#这样会引发什么问题\" class=\"headerlink\" title=\"这样会引发什么问题?\"></a>这样会引发什么问题?</h2><p>浏览器需要不断的向服务器发出请求，然而HTTP request的header是非常长的，里面包含的数据可能只是一个很小的值，这样会占用很多的带宽和服务器资源。</p>\n<h2 id=\"Comet\"><a href=\"#Comet\" class=\"headerlink\" title=\"Comet\"></a>Comet</h2><p>比较新的技术去做轮询的效果是Comet，Comet有两种常用的方式</p>\n<ol>\n<li>基于AJAX long-polling</li>\n<li>基于 Iframe 及 htmlfile 的流（streaming）</li>\n</ol>\n<h3 id=\"基于AJAX-long-polling与传统的-AJAX-应用不同之处：\"><a href=\"#基于AJAX-long-polling与传统的-AJAX-应用不同之处：\" class=\"headerlink\" title=\"基于AJAX long-polling与传统的 AJAX 应用不同之处：\"></a>基于AJAX long-polling与传统的 AJAX 应用不同之处：</h3><ol>\n<li>服务器端会阻塞请求直到有数据传递或超时才返回。 </li>\n<li>客户端 JavaScript响应处理函数会在处理完服务器返回的信息后，再次发出请求，重新建立连接。</li>\n<li>当客户端处理接收的数据、重新建立连接时，服务器端可能有新的数据到达；这些信息会被服务器端保存直到客户端重新建立连接，客户端会一次把当前服务器端所有的信息取回。</li>\n</ol>\n<h3 id=\"基于-Iframe-及-htmlfile-的流（streaming）\"><a href=\"#基于-Iframe-及-htmlfile-的流（streaming）\" class=\"headerlink\" title=\"基于 Iframe 及 htmlfile 的流（streaming）\"></a>基于 Iframe 及 htmlfile 的流（streaming）</h3><p>iframe 是很早就存在的一种 HTML 标记， 通过在 HTML 页面里嵌入一个隐蔵帧，然后将这个隐蔵帧的 SRC 属性设为对一个长连接的请求，服务器端就能源源不断地往客户端输入数据。</p>\n<p>尽管Comet这种技术可达到双向通信，但依然需要发出请求，而且在Comet中，普遍采用了长链接，这也会大量消耗服务器带宽和资源。</p>\n<p>面对这种状况，HTML5定义了WebSocket协议，能更好的节省服务器资源和带宽并达到实时通讯。</p>\n<h2 id=\"什么是WebSocket？\"><a href=\"#什么是WebSocket？\" class=\"headerlink\" title=\"什么是WebSocket？\"></a>什么是WebSocket？</h2><p>一种在单个 TCP 连接上进行全双工通讯的协议。</p>\n<p>WebSocket 是独立的、创建在 TCP 上的协议，和 HTTP 的唯一关联是使用 HTTP 协议的101状态码进行协议切换，使用的 TCP 端口是80，可以用于绕过大多数防火墙的限制。<br>WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端直接向客户端推送数据而不需要客户端进行请求，在 WebSocket API 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并允许数据进行双向传送。</p>\n<h3 id=\"优势\"><a href=\"#优势\" class=\"headerlink\" title=\"优势\"></a>优势</h3><p>服务器与客户端之间交换的数据包档头很小，大概只有2字节。（早期版本7.0）</p>\n<h3 id=\"举个栗子\"><a href=\"#举个栗子\" class=\"headerlink\" title=\"举个栗子\"></a>举个栗子</h3><p>今天使用swoole写了基于Websocket的聊天室，正好用来作为例子</p>\n<h4 id=\"浏览器请求\"><a href=\"#浏览器请求\" class=\"headerlink\" title=\"浏览器请求\"></a>浏览器请求</h4><p><img src=\"/images/20161102233522038.jpg\" alt></p>\n<h4 id=\"服务器响应\"><a href=\"#服务器响应\" class=\"headerlink\" title=\"服务器响应\"></a>服务器响应</h4><p><img src=\"/images/20161102233537476.jpg\" alt></p>\n<h4 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h4><p>在请求中的“Sec-WebSocket-Key”是随机的，服务器端会用这些数据来构造出一个SHA-1的信息摘要。<br>把“Sec-WebSocket-Key”加上一个魔幻字符串“258EAFA5-E914-47DA-95CA-C5AB0DC85B11”。使用SHA-1加密，之后进行BASE-64编码，将结果做为“Sec-WebSocket-Accept”头的值，返回给客户端。</p>\n","categories":["技术"],"tags":["PHP","学习笔记","Swoole","WebSocket"]},{"title":"【翻译】Modding Minecraft with PHP – Buildings from Code!","url":"http://funsoul.org/2016/10/28/【翻译】Modding Minecraft with PHP – Buildings from Code!/","content":"<h2 id=\"使用PHP修改《我的世界》——从代码层构建\"><a href=\"#使用PHP修改《我的世界》——从代码层构建\" class=\"headerlink\" title=\"使用PHP修改《我的世界》——从代码层构建\"></a>使用PHP修改《我的世界》——从代码层构建</h2><pre><code>—— Christopher Pitt  2016/10/18\n</code></pre><p>原文：<a href=\"https://www.sitepoint.com/modding-minecraft-with-php-buildings-from-code/\" title=\"原文\" target=\"_blank\" rel=\"noopener\">Modding Minecraft with PHP – Buildings from Code!</a></p>\n<h2 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h2><p>早上翻译了一篇文章，关于PHP在游戏方面的应用，其中有些知识点我是完全没有涉略过的，关于yield，promise，这些使用的比较少，通过这篇文章，能够对这些知识点有个大概的认识，还能顺便练习一下英语，文中有翻译得不好的地方请大力指出，thanks~</p>\n<h2 id=\"正文\"><a href=\"#正文\" class=\"headerlink\" title=\"正文\"></a>正文</h2><p>我一直想改造《我的世界》，遗憾的是，对于重新学习Java（这款游戏用Java写的），我一点兴趣也没有，直到最近，尽管这看起来是必须的。</p>\n<p><img src=\"/images/20161028143452958\" alt></p>\n<p>多亏了顽强的毅力，在没有真正熟知Java的情况下，我发现了一种修改《我的世界》的方法。有一些技巧和注意事项可以让我们使用高效简单的PHP去实现所有我们想要的修改。</p>\n<p>这只是此次探险之旅的一半，在另一篇文章中<a href=\"https://www.sitepoint.com/javascript-3d-minecraft-editor/\" title=\"原文\" target=\"_blank\" rel=\"noopener\">《Building a JavaScript 3D Minecraft Editor》</a>，我们将看到一个整洁的立体（3D）的使用JavaScript构造的《我的世界》编辑器。如果这听起来像是你想要学习的东西，一定要看看这个帖子。</p>\n<p>本教程中大部分代码可以在<a href=\"https://github.com/assertchris-tutorials/tutorial-php-minecraft-mod\" title=\"github\" target=\"_blank\" rel=\"noopener\">tutorial-php-minecraft-mod</a>中找到，我已经在最新版本的Chrome测试了所有的JavaScript代码，和在PHP 7.0中测试了所有的PHP代码。我不能保证它会在其他浏览器看起来完全相同，或在其他版本的PHP中同样奏效，但是核心的概念是一样的。</p>\n<h2 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h2><p>正如你将看到的，我们将在PHP和Minecraft服务器之间传递负载。我们需要一个脚本来运行我们需要的插件功能。我们可以使用传统的while循环来实现。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">while (true) &#123;</span><br><span class=\"line\">    // listen for player requests</span><br><span class=\"line\">    // make changes to the game</span><br><span class=\"line\"></span><br><span class=\"line\">    sleep(1);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>…或许我们可以做一些更有趣的事情。</p>\n<p>我非常喜欢AMPHP。这是一个异步的PHP库的集合，包括HTTP服务器，客户端，和一个事件循环。别担心，如果你不熟悉这些，我们慢慢来。</p>\n<p>首先创建一个文件，这个文件包含一个事件循环，和一个监听事件的函数。在此之前，我们需要安装事件循环和文件系统依赖库：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">composer require amphp/amp</span><br><span class=\"line\">composer require amphp/file</span><br></pre></td></tr></table></figure>\n<p>然后，启动一个事件循环，并检查以确保按预期运行：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">require</span> <span class=\"keyword\">__DIR__</span> . <span class=\"string\">\"/vendor/autoload.php\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">Amp\\run(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Amp\\repeat(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// listen for player requests</span></span><br><span class=\"line\">        <span class=\"comment\">// make changes to the game</span></span><br><span class=\"line\">    &#125;, <span class=\"number\">1000</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>这类似于无限循环，除了一点，它是非阻塞的。这意味着我们能执行更多的并发操作，在等待操作的时候，通常会阻塞这个进程。</p>\n<h2 id=\"谈谈Promises\"><a href=\"#谈谈Promises\" class=\"headerlink\" title=\"谈谈Promises\"></a>谈谈Promises</h2><p>除了这个包装器代码，AMPHP还提供了一个简洁的基于promise的接口。你可能已经熟悉这个概念（来自JavaScript），但这里有一个简单的例子：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$eventually = asyncOperation();</span><br><span class=\"line\"></span><br><span class=\"line\">$eventually</span><br><span class=\"line\">    -&gt;then(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($data)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// do something with $data</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    -&gt;catch(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">(Exception $e)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// oops, something went wrong!</span></span><br><span class=\"line\">    &#125;);</span><br></pre></td></tr></table></figure>\n<p>Promises是一种表示我们还没有的数据的方式 - 结果值。它可能是一些比较慢的操作（如文件系统操作或HTTP请求）。</p>\n<p>关键在于，我们不能立即获得结果值。取代在前台等待结果（这将传统上阻止进程）的方式是，我们在后台等待它。当在后台等待时，我们可以在前台进行其他有意义的工作。</p>\n<p>在AMPHP中应用Promises的进阶是，使用<a href=\"https://medium.com/async-php/co-operative-php-multitasking-ce4ef52858a0#.xuc45ucsk\" title=\"原文\" target=\"_blank\" rel=\"noopener\">生成器</a>。在我看来这是一个有点过激的解释，请原谅我。</p>\n<p>生成器是迭代器的语法简化。也就是说，它们减少了我们需要写入的代码量，以便对数组中尚未定义的值进行迭代。此外，它们使得可以将数据发送到生成这些值的函数（在生成它们时）。对这个模式有感觉了吗？</p>\n<p>生成器允许我们根据需要构建下一个数组项。Promises代表最终值。 因此，我们可以重新使用生成器来生成步骤（或行为）的列表，这些步骤根据需要执行。</p>\n<p>通过看一些代码可能更容易理解：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Amp</span>\\<span class=\"title\">File</span>\\<span class=\"title\">Driver</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getContents</span><span class=\"params\">(Driver $files, $path, $previous)</span> </span>&#123;</span><br><span class=\"line\">    $next = <span class=\"keyword\">yield</span> $files-&gt;mtime($path);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($previous !== $next) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">yield</span> $files-&gt;get($path);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>让我们考虑一下如何在同步执行中工作：</p>\n<ol>\n<li>调用 getContents</li>\n<li>调用 \\$files-&gt;mtime($path) (想象这只是一个对filemtime的代理)</li>\n<li>等待filemtime返回</li>\n<li>调用 \\$files-&gt;get($path) (想象这只是一个对file_get_contents的代理)</li>\n<li>等待 file_get_contents 返回</li>\n</ol>\n<p>有了Promises，我们可以避免阻塞，代价是几个新的闭包：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getContents</span><span class=\"params\">($files, $path, $previous)</span> </span>&#123;</span><br><span class=\"line\">    $files-&gt;mtime($path)-&gt;then(</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($next)</span> <span class=\"title\">use</span> <span class=\"params\">($previous)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($previous !== $next) &#123;</span><br><span class=\"line\">                $files-&gt;get($path)-&gt;then(</span><br><span class=\"line\">                    <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($data)</span> </span>&#123;</span><br><span class=\"line\">                        <span class=\"comment\">// do something with $data</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                )</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// do something with null</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>由于promises是可链接的，我们可以将其减少为：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getContents</span><span class=\"params\">($files, $path, $previous)</span> </span>&#123;</span><br><span class=\"line\">    $files-&gt;mtime($path)-&gt;then(</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($next)</span> <span class=\"title\">use</span> <span class=\"params\">($previous)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($previous !== $next) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> $files-&gt;get($path);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// do something with null</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    )-&gt;then(</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">($data)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">// do something with data</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我不知道你怎么看，但这似乎对我来说很乱。那么生成器如何适应这种情况？那么，AMPHP使用yield关键字来鉴定promise。让我们再看看getContents函数：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getContents</span><span class=\"params\">(Driver $files, $path, $previous)</span> </span>&#123;</span><br><span class=\"line\">    $next = <span class=\"keyword\">yield</span> $files-&gt;mtime($path);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($previous !== $next) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">yield</span> $files-&gt;get($path);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>\\$ files-&gt; mtime（\\$ path）返回一个promise。而不是等待查找完成，函数停止运行，因为它遇到yield关键字。过一段时间后，通知AMPHP启动操作完成，并恢复该功能。</p>\n<p>然后，如果时间戳不匹配，files-&gt; get（$ path）获取内容。这是另一个阻塞操作，因此yield会再次暂停该函数。当读取文件时，AMPHP将再次启动此函数（返回文件内容）。</p>\n<p>此代码看起来类似于同步替代，但是（显式地）使用promises和生成器使其无阻塞。</p>\n<p>AMPHP与Promises A +规范略有不同，因为AMPHP Promises不支持then方法。其他PHP实现方法有，如React / Promise和Guzzle Promises。 重要的是理解promises的核心原理，以及它们如何与生成器对接，以支持这种简洁的异步语法。</p>\n<h2 id=\"监听日志\"><a href=\"#监听日志\" class=\"headerlink\" title=\"监听日志\"></a>监听日志</h2><p>上次我写的Minecraft，它是关于使用一个Minecraft房子的门触发真实的闹钟。在这里，我们简要介绍了从Minecraft服务器获取数据的过程，以及PHP。</p>\n<p>我们花了更长的时间到那里，正是时候，但从本质上说,我们做同样的事情。让我们看看识别玩家命令的代码：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">define(<span class=\"string\">\"LOG_PATH\"</span>, <span class=\"string\">\"/path/to/logs/latest.log\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$files = Amp\\File\\filesystem();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// get reference data</span></span><br><span class=\"line\"></span><br><span class=\"line\">$commands = [];</span><br><span class=\"line\">$timestamp = <span class=\"keyword\">yield</span> $filesystem-&gt;mtime(LOG_PATH);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// listen for player requests</span></span><br><span class=\"line\"></span><br><span class=\"line\">Amp\\repeat(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> <span class=\"title\">use</span> <span class=\"params\">($files, &amp;$commands, &amp;$timestamp)</span> </span>&#123;</span><br><span class=\"line\">    $contents = <span class=\"keyword\">yield</span> from getContents(</span><br><span class=\"line\">        $files, LOG_PATH, $timestamp</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($contents)) &#123;</span><br><span class=\"line\">        $lines = array_reverse(explode(PHP_EOL, $contents));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($lines <span class=\"keyword\">as</span> $line) &#123;</span><br><span class=\"line\">            $isCommand = stristr($line, <span class=\"string\">\"&gt; &gt;\"</span>) !== <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            $isNotRepeat = !in_array($line, $commands);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> ($isCommand &amp;&amp; $isNotRepeat) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// execute mod command</span></span><br><span class=\"line\"></span><br><span class=\"line\">                array_push($commands, $line);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">print</span> <span class=\"string\">\"executing: \"</span> . $line . PHP_EOL;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;, <span class=\"number\">500</span>);</span><br></pre></td></tr></table></figure>\n<p>我们首先得到参考文件的时间戳。 我们使用这个来确定文件是否已经改变（在getContents函数中）。 我们还创建一个空列表，其中我们将存储所有已经执行的命令。 这个列表将帮助我们避免执行相同的命令两次。</p>\n<p>你需要将/path/to/logs/latest.log替换为Minecraft服务器日志文件的路径。 我建议运行独立的Minecraft服务器，把logs/latest.log放在根目录。</p>\n<p>我们告诉Amp\\ repeat每500毫秒运行一次这个闭包。在那段时间，我们检查文件更改。如果时间戳发生了变化，我们将日志文件的行拆分成一个数组，并将其反转（以便我们首先读取最新的消息）。</p>\n<p>如果一行包含“&gt;&gt;”（如果玩家输入“&gt; some command”会发生这种情况），我们假设该行包含一个命令指令。</p>\n<p><img src=\"/images/20161028144548441.jpg\" alt></p>\n<h2 id=\"构建蓝图\"><a href=\"#构建蓝图\" class=\"headerlink\" title=\"构建蓝图\"></a>构建蓝图</h2><p>Minecraft中最耗时的事情之一是建造大型结构。 如果我可以计划他们（使用一些swanky 3D JavaScript builder），然后使用一个特殊的命令把它们放在“世界”上将会容易得多。</p>\n<p>我们可以使用略微<a href=\"https://codepen.io/assertchris/full/dpVQdY\" title=\"原文\" target=\"_blank\" rel=\"noopener\">修改的版本</a>，我在其他上述帖子中介绍的生成器生成自定义块展示位置列表：</p>\n<p><img src=\"/images/20161028144623285.jpg\" alt></p>\n<p>目前，这个建筑师只允许放置污垢块。 它生成的数组结构是放置的每个脏块的x，y和z坐标（在初始场景渲染后）。 我们可以将它复制到我们一直在工作的PHP脚本。 我们还应该弄清楚如何确定构建我们设计的任何结构的确切命令：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$isCommand = stristr($line, <span class=\"string\">\"&gt; &gt;\"</span>) !== <span class=\"keyword\">false</span>;</span><br><span class=\"line\">$isNotRepeat = !in_array($line, $commands);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> ($isCommand &amp;&amp; $isNotRepeat) &#123;</span><br><span class=\"line\">    array_push($commands, $line);</span><br><span class=\"line\">    executeCommand($line);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ...later</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">executeCommand</span><span class=\"params\">($raw)</span> </span>&#123;</span><br><span class=\"line\">    $command = trim(</span><br><span class=\"line\">        substr($raw, stripos($raw, <span class=\"string\">\"&gt; &gt;\"</span>) + <span class=\"number\">3</span>)</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($command === <span class=\"string\">\"build\"</span>) &#123;</span><br><span class=\"line\">        $blocks = [</span><br><span class=\"line\">            <span class=\"comment\">// ...from the 3D builder</span></span><br><span class=\"line\">        ];</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($block <span class=\"keyword\">as</span> $block) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// ... place each block</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>每次我们收到一个命令，我们可以将其传递给execute Command函数。 在那里我们从第二个“&gt;”提取到行的结尾。我们现在只需要识别构建命令。</p>\n<h2 id=\"服务器通信\"><a href=\"#服务器通信\" class=\"headerlink\" title=\"服务器通信\"></a>服务器通信</h2><p>监听日志是一回事，但是我们如何与服务器通信？独立服务器启动管理聊天服务器（称为RCON）。这是相同的管理其他游戏的聊天服务器，，如反恐精英。</p>\n<p>结果有人已经建立了一个RCON客户端（虽然阻塞），最近我写了一个很好的包装。 我们可以安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">composer require theory/builder</span><br></pre></td></tr></table></figure>\n<p>让我为这个库很大而道歉。我包含了一个版本的Minecraft独立服务器，以便我可以构建库的自动化测试。感觉真棒…</p>\n<p>我们需要配置我们的独立服务器，以便我们可以进行RCON连接。 将以下内容添加到与服务器jar包位于同一文件夹中的server.properties文件：</p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">enable-query=true</span><br><span class=\"line\">enable-rcon=true</span><br><span class=\"line\">query.port=<span class=\"number\">25565</span></span><br><span class=\"line\">rcon.port=<span class=\"number\">25575</span></span><br><span class=\"line\">rcon.password=password</span><br></pre></td></tr></table></figure>\n<p>重新启动后，我们应该能够使用类似于以下代码连接到服务器：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$builder = <span class=\"keyword\">new</span> Client(<span class=\"string\">\"127.0.0.1\"</span>, <span class=\"number\">25575</span>, <span class=\"string\">\"password\"</span>);</span><br><span class=\"line\">$builder-&gt;exec(<span class=\"string\">\"/say hello world\"</span>);</span><br></pre></td></tr></table></figure>\n<p>我们可以改进我们的execute Command函数来构建一个完整的结构：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">executeCommand</span><span class=\"params\">($builder, $raw)</span> </span>&#123;</span><br><span class=\"line\">    $command = trim(</span><br><span class=\"line\">        substr($raw, stripos($raw, <span class=\"string\">\"&gt; &gt;\"</span>) + <span class=\"number\">3</span>)</span><br><span class=\"line\">    );</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (stripos($command, <span class=\"string\">\"build\"</span>) === <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        $parts = explode(<span class=\"string\">\" \"</span>, $command);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (count($parts) &lt; <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">print</span> <span class=\"string\">\"invalid coordinates\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        $x = $parts[<span class=\"number\">1</span>];</span><br><span class=\"line\">        $y = $parts[<span class=\"number\">2</span>];</span><br><span class=\"line\">        $z = $parts[<span class=\"number\">3</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">        $blocks = [</span><br><span class=\"line\">            <span class=\"comment\">// ...from the 3D builder</span></span><br><span class=\"line\">        ];</span><br><span class=\"line\"></span><br><span class=\"line\">        $builder-&gt;exec(<span class=\"string\">\"/say building...\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> ($blocks <span class=\"keyword\">as</span> $block) &#123;</span><br><span class=\"line\">            $dx = $block[<span class=\"number\">0</span>] + $x;</span><br><span class=\"line\">            $dy = $block[<span class=\"number\">1</span>] + $y;</span><br><span class=\"line\">            $dz = $block[<span class=\"number\">2</span>] + $z;</span><br><span class=\"line\"></span><br><span class=\"line\">            $builder-&gt;exec(</span><br><span class=\"line\">                <span class=\"string\">\"/setblock &#123;$dx&#125; &#123;$dy&#125; &#123;$dz&#125; dirt\"</span></span><br><span class=\"line\">            );</span><br><span class=\"line\"></span><br><span class=\"line\">            usleep(<span class=\"number\">500000</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>新改进的execute Command函数检查命令（ 类似于&lt; player_name &gt; &gt; build的消息）是否以单词“build”开始。</p>\n<p>如果构建器是非阻塞的，那么最好使用yield new Amp\\Pause（500），而不是usleep（500000）。 我们还需要将executeCommand作为一个生成函数，我们称之为生成函数，这意味着使用yield executeCommand（…）。</p>\n<p>如果是，则命令由空格拆分，以获取应构建设计的x，y和z坐标。 然后它需要我们从设计器生成的数组，并将每个块放在“世界”上。</p>\n<p><img src=\"/images/20161028144649786.jpg\" alt></p>\n<h2 id=\"千里之行，始于足下\"><a href=\"#千里之行，始于足下\" class=\"headerlink\" title=\"千里之行，始于足下\"></a>千里之行，始于足下</h2><p>你可以想象的到，可能会有许多有趣的扩展将从这个我们刚刚创建的简单的类似的脚本中诞生。设计者可以扩展，以创建由许多不同种类和配置块组成的架构。</p>\n<p>这个插件脚本可以扩展为通过JSON API接收更新，以便设计人员可以提交自己命名的设计，并且构建命令可以精确指定玩家想要构建的设计。</p>\n<p>我会把这些想法作为你的练习。不要忘记查看伴随的JavaScript帖子，如果你有任何想分享的想法或意见，欢迎评论！</p>\n","categories":["技术"],"tags":["PHP","翻译"]},{"title":"Oracle中的exists和in","url":"http://funsoul.org/2016/09/19/Oracle中的exists和in/","content":"<h2 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h2><p>今天有一个业务，前台是一个供用户选择条件进行查询的功能。选择完毕后点击查询，前台使用get方式发送打包好的参数列表到后台（Controller），持久层拿到参数列表后拼装到SQL中，使用jdbc连接oracle拿数据。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>当条件过大（据说有7000多个数据），出现第一个问题，413 FULL HEAD ERROR。很明显是数据量过大，而使用的又是get方式传输，get请求的数据会附在URL之后（就是把数据放置在HTTP协议头中），以?分割URL和传输数据，参数之间以&amp;相连。如：login.action?name=cym&amp;password=idontknow。如果数据是英文字母/数字，原样发送，如果是空格，转换为+，如果是中文/其他字符，则直接把字符串用BASE64加密。GET方式提交的数据依据浏览器而定，IE环境下的URL长度限制为2083，理论上POST没有限制，可传较大量的数据。</p>\n<p>第二个问题出现在SQL，拼接字符串中使用的where…in..，JDBC会抛出“java.sql.SQLException: ORA-01795: 列表中的最大表达式数为 1000”这个异常。没想到oracle还有这种限制，据说11g后不存在这个限制。</p>\n<h2 id=\"解决方案\"><a href=\"#解决方案\" class=\"headerlink\" title=\"解决方案\"></a>解决方案</h2><h3 id=\"一、使用临时表\"><a href=\"#一、使用临时表\" class=\"headerlink\" title=\"一、使用临时表\"></a>一、使用临时表</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> * <span class=\"keyword\">FROM</span> t <span class=\"keyword\">WHERE</span> <span class=\"keyword\">id</span> <span class=\"keyword\">IN</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">id</span> <span class=\"keyword\">FROM</span> temp)</span><br></pre></td></tr></table></figure>\n<p>建立一个表来存储传入参数，取数据的时候先从临时表中遍历取参数，然后再将取出的参数拿去作为in条件</p>\n<h3 id=\"二、使用exists\"><a href=\"#二、使用exists\" class=\"headerlink\" title=\"二、使用exists\"></a>二、使用exists</h3><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> * <span class=\"keyword\">FROM</span> a <span class=\"keyword\">WHERE</span> <span class=\"keyword\">EXISTS</span>( <span class=\"keyword\">SELECT</span> <span class=\"number\">1</span> <span class=\"keyword\">FROM</span> b <span class=\"keyword\">WHERE</span> a.employee_id=b.employee_id)</span><br></pre></td></tr></table></figure>\n<h2 id=\"对比\"><a href=\"#对比\" class=\"headerlink\" title=\"对比\"></a>对比</h2><ul>\n<li>IN比 EXISTS 的可读性更好</li>\n<li>EXISTS 比IN 的表达性更好（更适合复杂的语句）</li>\n</ul>\n<p>二者之间性能没有差异（但对于某些数据库来说性能差异会非常大）</p>\n","categories":["技术"],"tags":["Oracle"]},{"title":"procedure在Mysql和Sql Server中使用的一些区别","url":"http://funsoul.org/2015/12/17/procedure在Mysql和Sql Server中使用的一些区别/","content":"<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><ul>\n<li>MySQL 5.6.20</li>\n</ul>\n<h2 id=\"写在前\"><a href=\"#写在前\" class=\"headerlink\" title=\"写在前\"></a>写在前</h2><p>近日，一个好友@随风飘散，问我一个关于procedure在MySQL中使用出现的一些问题。在解决后做一个简单的总结：</p>\n<h2 id=\"正文\"><a href=\"#正文\" class=\"headerlink\" title=\"正文\"></a>正文</h2><p>下面这段代码来自SQL Server，意思是创建一个procedure， 查询表test_user所有的记录。</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> getUsers</span><br><span class=\"line\"><span class=\"keyword\">AS</span></span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> * <span class=\"keyword\">FROM</span> test_user</span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">EXECUTE</span>    getUsers</span><br></pre></td></tr></table></figure>\n<p>将这段代码原封不动的复制到MySQL中执行</p>\n<p><img src=\"/images/20151217113258531.jpg\" alt></p>\n<p>可以看出，很明显是语法不正确出现的问题。经查阅相关文档，得出以下代码段</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">DROP</span> <span class=\"keyword\">PROCEDURE</span> <span class=\"keyword\">IF</span> <span class=\"keyword\">EXISTS</span> getUsers;</span><br><span class=\"line\">DELIMITER //</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">PROCEDURE</span> getUsers()</span><br><span class=\"line\"><span class=\"keyword\">BEGIN</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> * <span class=\"keyword\">FROM</span> test_user;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">END</span></span><br><span class=\"line\">//</span><br><span class=\"line\">DELIMITER ;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CALL</span>  getUsers();</span><br></pre></td></tr></table></figure>\n<p>执行结果如下：</p>\n<p><img src=\"/images/20151217120502176.jpg\" alt></p>\n<p>可以看出，procedure 在 <strong>sql server</strong> 和 <strong>mysql</strong> 中使用的差别还是很大的， 有几个重要的区别：</p>\n<ol>\n<li>使用分隔符包含存储过程</li>\n<li>不再需要AS</li>\n<li>使用CALL代替EXECUTE</li>\n</ol>\n<p>解决了这个问题，甚是感觉到自己实践不足，遇到的问题太少，希望自己能遇到更多的问题，提高自己的同时，帮助更多的人解决问题。</p>\n","categories":["技术"],"tags":["数据库"]},{"title":"【PHP7】- 编译安装与新特性初体验","url":"http://funsoul.org/2015/12/03/【PHP7】- 编译安装与新特性初体验/","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>今天是世界上最好的语言革命性的一天，PHP7问世了！实际上我使用php只有一年半多一点，但是却被深深地吸引住，所以也容我感慨一下吧。</p>\n<p>大一下学期，我们学校开始教Java（我的专业方向就是Java），那时班上的很多同学早在上学期就自学了Java，而且学的非常好。我跟着课程的进度一步步的下载，安装，配置环境，然后写一些简单的程序，调试。这个过程非常煎熬，因为在配置环境的时候就出现了很多问题，使用eclipse来写代码，由于当时电脑配置并不好，所以写代码的时候总是会出现“未响应”，然后卡顿很长时间，更不用说MyEclipse了。苦闷的心情还历历在目~</p>\n<p>当时学校还为我们开设了一门PHP课程，我第一次使用的时候感觉很神奇，弱类型的概念还不是很清晰，只是觉得不需要再去考虑变量的类型，php为我们都处理好了。而且网上PHP的环境非常多，其中xampp就是一个著名的跨平台环境，一键安装，可以马上看到自己的代码运行的结果，我可以更关注自己写的逻辑和正确性，不得不说实在是太好用了。最后这门课需要结合另一门jQuery课做一个课程设计，我一个星期就敲出来了，还为我们赢得了不少掌声。就这样，一直用到现在，与php牵连在了一起。</p>\n<h2 id=\"正文\"><a href=\"#正文\" class=\"headerlink\" title=\"正文\"></a>正文</h2><h3 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h3><ul>\n<li>Ubuntu 14.04</li>\n</ul>\n<h3 id=\"准备PHP源码\"><a href=\"#准备PHP源码\" class=\"headerlink\" title=\"准备PHP源码\"></a>准备PHP源码</h3><p><a href=\"http://php.net/get/php-7.0.0.tar.gz/from/a/mirror\" target=\"_blank\" rel=\"noopener\">http://php.net/get/php-7.0.0.tar.gz/from/a/mirror</a></p>\n<p>1.解压源码并重命名为php-7<br>2.安装依赖项</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install libxml2-dev</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装依赖项\"><a href=\"#安装依赖项\" class=\"headerlink\" title=\"安装依赖项\"></a>安装依赖项</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get  install  build-essential</span><br><span class=\"line\">sudo apt-get install openssl </span><br><span class=\"line\">sudo apt-get install libssl-dev </span><br><span class=\"line\">sudo apt-get install make</span><br><span class=\"line\">sudo apt-get install curl</span><br><span class=\"line\">sudo apt-get install libcurl4-gnutls-dev</span><br><span class=\"line\">sudo apt-get install libjpeg-dev</span><br><span class=\"line\">sudo apt-get install libpng-dev</span><br><span class=\"line\">sudo apt-get install libmcrypt-dev</span><br><span class=\"line\">sudo apt-get install libreadline6 libreadline6-dev</span><br></pre></td></tr></table></figure>\n<h4 id=\"编译配置\"><a href=\"#编译配置\" class=\"headerlink\" title=\"编译配置\"></a>编译配置</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure（注意斜杠前的点）</span><br><span class=\"line\"></span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/php --with-config-file-path=/usr/<span class=\"built_in\">local</span>/php/etc --<span class=\"built_in\">enable</span>-fpm --with-fpm-user=www --with-fpm-group=www --with-mysqli --with-pdo-mysql --with-iconv-dir --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --<span class=\"built_in\">enable</span>-xml --<span class=\"built_in\">disable</span>-rpath --<span class=\"built_in\">enable</span>-bcmath --<span class=\"built_in\">enable</span>-shmop --<span class=\"built_in\">enable</span>-sysvsem --<span class=\"built_in\">enable</span>-inline-optimization --with-curl --<span class=\"built_in\">enable</span>-mbregex --<span class=\"built_in\">enable</span>-mbstring --with-mcrypt --<span class=\"built_in\">enable</span>-ftp --with-gd --<span class=\"built_in\">enable</span>-gd-native-ttf --with-openssl --with-mhash --<span class=\"built_in\">enable</span>-pcntl --<span class=\"built_in\">enable</span>-sockets --with-xmlrpc --<span class=\"built_in\">enable</span>-zip --<span class=\"built_in\">enable</span>-soap --without-pear --with-gettext --<span class=\"built_in\">disable</span>-fileinfo --<span class=\"built_in\">enable</span>-maintainer-zts  </span><br><span class=\"line\"></span><br><span class=\"line\">./configure --prefix=/usr/<span class=\"built_in\">local</span>/php --<span class=\"built_in\">enable</span>-fpm --<span class=\"built_in\">enable</span>-inline-optimization --<span class=\"built_in\">disable</span>-debug --<span class=\"built_in\">disable</span>-rpath --<span class=\"built_in\">enable</span>-shared --<span class=\"built_in\">enable</span>-opcache  --with-mysql --with-mysqli --with-mysql-sock  --<span class=\"built_in\">enable</span>-pdo --with-pdo-mysql --with-gettext --<span class=\"built_in\">enable</span>-mbstring --with-iconv --with-mcrypt --with-mhash --with-openssl --<span class=\"built_in\">enable</span>-bcmath --<span class=\"built_in\">enable</span>-soap --with-libxml-dir --<span class=\"built_in\">enable</span>-pcntl --<span class=\"built_in\">enable</span>-shmop --<span class=\"built_in\">enable</span>-sysvmsg --<span class=\"built_in\">enable</span>-sysvsem --<span class=\"built_in\">enable</span>-sysvshm --<span class=\"built_in\">enable</span>-sockets --with-curl --with-zlib --<span class=\"built_in\">enable</span>-zip --<span class=\"built_in\">enable</span>-bz2 --with-readline --without-sqlite3 --without-pdo-sqlite --with-pear --with-libdir=/lib/x86_64-linux-gnu --with-gd --with-jpeg-dir=/usr/lib --<span class=\"built_in\">enable</span>-gd-native-ttf --<span class=\"built_in\">enable</span>-xml</span><br></pre></td></tr></table></figure>\n<h4 id=\"安装-PHP\"><a href=\"#安装-PHP\" class=\"headerlink\" title=\"安装 PHP\"></a>安装 PHP</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make &amp;&amp; make <span class=\"built_in\">test</span>      （这个过程可能会慢一点，视配置而定，我的虚拟机为单处理器+2G内存）</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/20151203232056485.jpg\" alt></p>\n<p>这里可能会出现这个问题，save一下就好了，也就是输入字母s即可，如果开源精神爆棚（我我我），可以输入y，然后输入自己的邮箱。啦啦啦~</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make &amp;&amp; sudo make install   （这里可能需要输入你的root账户密码）</span><br><span class=\"line\">php -v</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/20151203232255760.jpg\" alt></p>\n<p>到这里已经完成php7的安装，接下来就可以尽情的使用PHP7了！</p>\n<h2 id=\"PHP7新特性\"><a href=\"#PHP7新特性\" class=\"headerlink\" title=\"PHP7新特性\"></a>PHP7新特性</h2><p>php7与以前的版本相比有哪些让人兴奋的新特性，我们来体验一番~</p>\n<h3 id=\"宇宙飞船运算符\"><a href=\"#宇宙飞船运算符\" class=\"headerlink\" title=\"宇宙飞船运算符\"></a>宇宙飞船运算符</h3><p>新增运算符Combined comparison Operator ‘&lt;=&gt;’ 吼吼~</p>\n<p><img src=\"/images/20151203231855632.jpg\" alt></p>\n<p>代码变少了，小于则返回-1，大于返回1，等于返回0，简单易懂，非常爽~</p>\n<h3 id=\"Return-Type-Declarations\"><a href=\"#Return-Type-Declarations\" class=\"headerlink\" title=\"Return Type Declarations\"></a>Return Type Declarations</h3><p>返回类型声明 和Scalar Type Declarations 标量类型声明</p>\n<p><img src=\"/images/20151203231720195.jpg\" alt></p>\n<p>对于C/C++/java系的看到这个肯定开心爆了，还可以通过declare(strict_type = 1);开启严格模式，这时php将不会帮你自动转换类型，而是报错。</p>\n<h3 id=\"更多的Error变为可捕获的Exception\"><a href=\"#更多的Error变为可捕获的Exception\" class=\"headerlink\" title=\"更多的Error变为可捕获的Exception\"></a>更多的Error变为可捕获的Exception</h3><p><img src=\"/images/20151203231410865.jpg\" alt></p>\n<p>在php7前未定义函数是致命错误Fatal error，这样会使整个脚本中止，程序无法继续运行下去。但是现在可以通过捕获错误-&gt;处理错误，让程序继续执行下去，大大提高了异常处理能力。</p>\n<h3 id=\"性能提升\"><a href=\"#性能提升\" class=\"headerlink\" title=\"性能提升\"></a>性能提升</h3><p><img src=\"/images/20151203231219865.png\" alt></p>\n<p>可以看出，php7比php5提高不止100%的性能。升级后该省多少机器啊！</p>\n<h2 id=\"最后再说两句\"><a href=\"#最后再说两句\" class=\"headerlink\" title=\"最后再说两句\"></a>最后再说两句</h2><p>听说PHP7.1将会重启JIT计划，PHP本来就不适合密集计算，开启JIT后，性能，效率又会有多大的提升？很难想象~再加上swoole，yaf等等优秀的开源框架，PHP社区只会越来越繁荣。简单，门槛低，性能好，这应该就是未来编程语言的走向，人人编程的设想也不会是梦吧~</p>\n<p>感谢开源，感谢自己的坚持~</p>\n<p>本文所有例子皆得到验证，亲测可用。</p>\n<p>本文安装教程参考了<a href=\"http://www.oschina.net/question/2010961_242272\" target=\"_blank\" rel=\"noopener\">http://www.oschina.net/question/2010961_242272</a></p>\n<p>本文PHP7新特性参考了鸟哥的分享与博客<a href=\"http://www.laruence.com/\" target=\"_blank\" rel=\"noopener\">http://www.laruence.com/</a></p>\n","categories":["技术"],"tags":["PHP","PHP7"]},{"title":"【Swoole入门】异步毫秒定时器","url":"http://funsoul.org/2015/11/28/【Swoole入门】异步毫秒定时器/","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>前几天在朋友圈看到一个俄罗斯工程师为了给他老婆实时报到情况写了一个自动化脚本，通过定时任务来触发。比如晚上9点了，他的服务器上还有正在运行的SSH进程，就给他老婆发一条短信，“今晚加班晚点回家”，多么温馨的故事啊。碰巧我正在学习swoole扩展，特此记录一下。</p>\n<h2 id=\"定时器\"><a href=\"#定时器\" class=\"headerlink\" title=\"定时器\"></a>定时器</h2><p>一般的定时器是怎么实现的呢？我总结如下：</p>\n<ol>\n<li>使用Crontab工具，写一个shell脚本，在脚本中调用PHP文件，然后定期执行该脚本；</li>\n<li>ignore_user_abort()和set_time_limit()配合使用；</li>\n<li>pcntl_alarm;</li>\n<li>swoole异步毫秒定时器</li>\n</ol>\n<h2 id=\"swoole异步毫秒定时器\"><a href=\"#swoole异步毫秒定时器\" class=\"headerlink\" title=\"swoole异步毫秒定时器\"></a>swoole异步毫秒定时器</h2><h3 id=\"Timer定时器\"><a href=\"#Timer定时器\" class=\"headerlink\" title=\"Timer定时器\"></a>Timer定时器</h3><p>swoole内置定时器，通过函数addtimer即可在server中添加一个定时器，参数单位为毫秒，该定时器会在建立之后，按照预先设定好的时间间隔，每到对应的时间就会调用一次回调函数onTimer。看代码：</p>\n<p><img src=\"/images/20151128020847375.jpg\" alt></p>\n<p>执行过程：</p>\n<p><img src=\"/images/20151128021004126.jpg\" alt></p>\n<h3 id=\"swoole-timer-add定时器\"><a href=\"#swoole-timer-add定时器\" class=\"headerlink\" title=\"swoole_timer_add定时器\"></a>swoole_timer_add定时器</h3><p>swoole_timer_add($interval,$callback)</p>\n<p>$interval：时间间隔，单位毫秒，不能同时存在同样时间间隔的两个定时器（据官方文档，即将废弃）</p>\n<p><strong>注意点</strong></p>\n<ol>\n<li>swoole_server中不能使用。</li>\n<li>定时器必须在全异步模式下使用，同步阻塞代码下不可使用，比如sleep,file_get_contents，这些会阻塞timer，使之不能在预定时间间隔下执行。</li>\n</ol>\n<p><img src=\"/images/20151128021727238.jpg\" alt></p>\n<p><img src=\"/images/20151128021830709.jpg\" alt></p>\n<h3 id=\"Tick定时器\"><a href=\"#Tick定时器\" class=\"headerlink\" title=\"Tick定时器\"></a>Tick定时器</h3><p>swoole_timer_tick函数</p>\n<p>设置一个间隔时钟定时器，与after定时器不同的是tick定时器会持续触发，直到调用swoole_timer_clear清除。与swoole_timer_add不同的是tick定时器可以存在多个相同间隔时间的定时器。</p>\n<p><img src=\"/images/20151128021727238.jpg\" alt></p>\n<p><img src=\"/images/20151128023519283.jpg\" alt></p>\n<p>定时器的作用非常重要，在实际工作中常常通过定时器任务检测服务器状况，数据库备份，心跳检测，消息订阅等等。</p>\n","categories":["技术"],"tags":["PHP","学习笔记","Swoole"]},{"title":"记第一次参加比赛的经历","url":"http://funsoul.org/2014/06/01/记第一次参加比赛的经历/","content":"<h2 id=\"Blog-For-Power\"><a href=\"#Blog-For-Power\" class=\"headerlink\" title=\"Blog For +Power\"></a>Blog For +Power</h2><h3 id=\"写在最前\"><a href=\"#写在最前\" class=\"headerlink\" title=\"写在最前\"></a>写在最前</h3><p>一直想对这学年的学习做一个总结，但是由于学业和比赛几乎把我大部分的时间占去，以至于我现在才能真正静下心来好好做个总结。就先从数码之星这个比赛开始吧。</p>\n<h3 id=\"比赛\"><a href=\"#比赛\" class=\"headerlink\" title=\"比赛\"></a>比赛</h3><p>老实说，当初我没想过要参加这个比赛，事实上，数码之星是个综合性的比赛，这个比赛涵盖了景观设计，平面设计，影视动画，以及我参加的网站美工四个类别。现在看来，当初的决定充满戏剧化和不可思议······</p>\n<h3 id=\"部门任务\"><a href=\"#部门任务\" class=\"headerlink\" title=\"部门任务\"></a>部门任务</h3><p>大一第二学期刚开始的时候，我的部长（第一学期加入了计算机协会软件部）就交给我一项任务，让我负责计协黑板报（一个技术分享平台）的前台开发，需求是，必须做瀑布流布局（像国外的Pinterest，国内的花瓣网那样的布局）。我接到这个任务的时候还没考虑好是否要参加数码之星这个比赛，我决定要报名这个比赛，是在我做出瀑布流的第二天。</p>\n<h3 id=\"瀑布流布局\"><a href=\"#瀑布流布局\" class=\"headerlink\" title=\"瀑布流布局\"></a>瀑布流布局</h3><p>那天我接到任务后就开始尝试上网看看是否能找到我想要的信息，当我打开Pinterest的时候，我被那流水般的布局深深的吸引住，不禁感叹创造这个布局的人，对于浏览者来说，第一眼的感受往往决定了停留的时间和下次到访的时间，访客不愿看太多的文字性的东西，图片的合理摆放更容易让浏览者第一眼捕捉到想要的信息，但是老旧的摆放方式，浏览者已经厌倦了，一个个整齐划一的方块，每一张图片都被限死在毫无特点的方格里。创新的步伐不会因此而停止，这时候，瀑布流出现了！全新的布局方式，仅仅把每一张图片的宽固定好，图片的高任其伸长，乍看之下，参差不齐，但是却有前所未有的视觉感受。在响应式设计下，触屏用户的感受更佳，在移动应用的交互环境当中，通过向上滑动进行滚屏的操作已经成为最基本的用户习惯，而且所需要的操作精准程度远远低于点击链接或按钮。不得不说，这简直是棒极了！</p>\n<p>以下是我实现瀑布流的一些经过：</p>\n<h4 id=\"初试瀑布流\"><a href=\"#初试瀑布流\" class=\"headerlink\" title=\"初试瀑布流\"></a>初试瀑布流</h4><p> <img src=\"/images/20151017010407310.jpg\" alt></p>\n<h4 id=\"瀑布流第二阶段\"><a href=\"#瀑布流第二阶段\" class=\"headerlink\" title=\"瀑布流第二阶段\"></a>瀑布流第二阶段</h4><p><img src=\"/images/20151017010435743.jpg\" alt></p>\n<h4 id=\"瀑布流实现\"><a href=\"#瀑布流实现\" class=\"headerlink\" title=\"瀑布流实现\"></a>瀑布流实现</h4><p><img src=\"/images/20151017010459553.jpg\" alt></p>\n<h4 id=\"瀑布流实现代码\"><a href=\"#瀑布流实现代码\" class=\"headerlink\" title=\"瀑布流实现代码\"></a>瀑布流实现代码</h4><p><img src=\"/images/20151017010521612.jpg\" alt></p>\n<h3 id=\"这是一个博客\"><a href=\"#这是一个博客\" class=\"headerlink\" title=\"这是一个博客\"></a>这是一个博客</h3><p>在实现了大致的布局后，我抱着试试看的态度（当时只有我们这个小组是大一的参赛者，其余小组都是大三的师兄师姐），报名了这个比赛。在实现了瀑布流后，我们试图让它跑起来，成为真正的博客，于是我们决定用php+mysql这对黄金组合，把用户分享的图片通过保存地址的方式储存在数据表，浏览者浏览的时候，我们用php实现数据的输出</p>\n<h3 id=\"附上代码\"><a href=\"#附上代码\" class=\"headerlink\" title=\"附上代码\"></a>附上代码</h3><p><img src=\"/images/20151017010537445.jpg\" alt></p>\n<h2 id=\"一些遗憾\"><a href=\"#一些遗憾\" class=\"headerlink\" title=\"一些遗憾\"></a>一些遗憾</h2><p>我们很快就完成了用户浏览的效果，但是，由于当时时间比较赶，而且技术尚未成熟，我们没有做AJAX异步加载，这是我们后来最感到遗憾的，不过相信以后我们能够在计协黑板报上推出，给用户更佳的体验</p>\n<h2 id=\"比赛过程\"><a href=\"#比赛过程\" class=\"headerlink\" title=\"比赛过程\"></a>比赛过程</h2><p>我们很幸运的进入了决赛，当时参加比赛的有二十来支队伍，然而入围的只有四组，在这四组里面，我们占有一席。我们感觉到无比兴奋，似乎努力没有白费，这对我们意义重大，我们有信心能拿到好成绩。然后是投票选出了人气奖，最后决赛。我们准备的很充分，很成功的演示了我们的作品。</p>\n<h2 id=\"走上领奖台\"><a href=\"#走上领奖台\" class=\"headerlink\" title=\"走上领奖台\"></a>走上领奖台</h2><p>我现在仍然记得，颁奖前几天我们完全不知道结果如何，队友一直在猜测，相对来说，我还是比较释然，走到这里，我已经很满足了，因为我们现在才大一，相信以后会走得更远。当主持人宣读我们得到了三等奖和人气奖时，我们几乎不敢相信自己的耳朵，但事实是，我们真的得奖了，而且是两个奖，是的，我们没有在做梦，我们在圆梦。</p>\n<p><img src=\"/images/20140601.jpg\" alt></p>\n<h2 id=\"得来不易的心得\"><a href=\"#得来不易的心得\" class=\"headerlink\" title=\"得来不易的心得\"></a>得来不易的心得</h2><p>起初的部门任务到最后比赛得奖，学到的东西太多了。技术上，我收获了比同龄人更宝贵的项目经验，CSS样式选择器的使用，盒子模型，响应式设计,javascript(jQuery)的熟悉度，php + mysql的组合使用。这些无论哪项技术都是可以开一个专栏来详细讲解的，而现在我获得的宝贵实践经验都与这些技术息息相关，这无疑对我日后在Web方面的开发造成重要影响。团队上，只能说，团队的力量可以造就你不平凡的一生，也可以毁灭你不平凡的一生，然后和他们一样变得平凡。这次项目中，我切实地认识到了队友的重要性！</p>\n<h2 id=\"方向\"><a href=\"#方向\" class=\"headerlink\" title=\"方向\"></a>方向</h2><p>通过这次比赛，让我找到了自己的方向，这是不可思议的，很少有人能在大一就找到自己的方向。不可置疑，我比任何人都清楚的认识到自己日后该走的路是怎样的，而且我很信奉乔布斯的一句话：在年轻的时候就必须要找到自己的所爱（方向），如果你还没有找到，请继续找，不要停下找寻的步伐，你只有找到自己的所爱（方向），你才会去爱你所爱，你只有做你所爱，你才会变得动力十足。</p>\n<h2 id=\"放在最后\"><a href=\"#放在最后\" class=\"headerlink\" title=\"放在最后\"></a>放在最后</h2><p>这句话一直是我的人生信条：  </p>\n<p><strong>stay hungry,stay foolish</strong></p>\n","categories":["技术"],"tags":["PHP","有趣","js"]},{"title":"C Sharp连接Access数据库出现的问题","url":"http://funsoul.org/2014/03/29/C Sharp 连接Access数据库出现的问题/","content":"<p>这两天在做数据库，发现一个很多网友都头疼的问题，就是C#连接Access数据库的时候显示“不可识别的数据库类型”。</p>\n<p>很多人在做Access数据库的时候总是默认保存它的后缀名“.accedb”，然后用Provider=Microsoft.Jet.OLEDB.4.0;Data Source=…去连接Access数据库。</p>\n<p>首先第一个问题就是C#是不识别后缀“.accedb”的，因此只能将该格式转换为C#识别的“.mdb”。</p>\n<p>然后很多人会发现还是提示“不可识别的数据库类型”！其实原因就在于“Provider=Microsoft.Jet.OLEDB.4.0;Data Source=…”。因为那个 Microsoft.Jet.OLEDB.4.0， 是针对低版本的 Access 使用的。</p>\n<p>只需要把</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Microsoft.Jet.OLEDB.4.0</span><br></pre></td></tr></table></figure>\n<p>改为</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Microsoft.ACE.OLEDB.12.0</span><br></pre></td></tr></table></figure>\n<p>数据源就可以正常的输出啦！</p>\n","categories":["技术"],"tags":["C Sharp","问题排查"]},{"title":"categories","url":"http://funsoul.org/categories/index.html","content":"","categories":[],"tags":[]},{"title":"about","url":"http://funsoul.org/about/index.html","content":"<ul>\n<li>家乡在祖国大陆最南端</li>\n<li>大学在北回归线之上(高中虽然学理科,但是当了地理课代表..不知道在哪?找地图查去!!)</li>\n<li>小学三年级参加班里的创意比赛,做了个在水里能跑的微型快艇拿了第三名,第一名是用破布做的拖把…第二名?好像是用旧塑料瓶子做的盆栽…</li>\n<li>高中看了丹布朗的《数字城堡》,从此与代码产生牵引</li>\n<li>第一个程序是在C4droid写的打印1~10</li>\n<li>喜欢看福尔摩斯,东野圭吾,阿加莎克里斯蒂</li>\n<li>爱看辩论(国辨,星辩,奇葩说..)</li>\n<li>我的邮件：<a href=\"mailto:cyanming2016@gmail.com\" target=\"_blank\" rel=\"noopener\">cyanming2016@gmail.com</a></li>\n<li>我的Github：funsoul</li>\n<li>我的微信公众号：有趣的EOF</li>\n</ul>\n<p><img src=\"/images/qrcode_for_gh_8acc4f179089_258.jpg\" alt></p>\n","categories":[],"tags":[]},{"title":"projects","url":"http://funsoul.org/project/index.html","content":"","categories":[],"tags":[]},{"title":"links","url":"http://funsoul.org/links/index.html","content":"","categories":[],"tags":[]},{"title":"search","url":"http://funsoul.org/search/index.html","content":"","categories":[],"tags":[]},{"title":"tags","url":"http://funsoul.org/tags/index.html","content":"","categories":[],"tags":[]}]